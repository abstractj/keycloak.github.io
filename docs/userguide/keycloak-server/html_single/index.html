<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">Keycloak Reference Guide</title><link rel="stylesheet" href="css/jbossorg.css" type="text/css"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL-NS Stylesheets V1.74.0"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><div class="book" lang="en-US"><div class="titlepage"><div><p xmlns:d="http://docbook.org/ns/docbook" id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><div><h1 class="title"><a id="d4e1"/>Keycloak Reference Guide</h1></div><div><h2 class="subtitle">SSO for Web Apps and REST Services</h2></div><div><p class="releaseinfo">1.6.0.Final</p></div></div><hr/></div><div class="toc"><dl><dt><span class="preface"><a href="#preface">Preface</a></span></dt><dt><span class="chapter"><a href="#license">1. License</a></span></dt><dt><span class="chapter"><a href="#Overview">2. Overview</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e46">2.1. Key Concepts in Keycloak</a></span></dt><dt><span class="section"><a href="#d4e54">2.2. How Does Security Work in Keycloak?</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e65">2.2.1. Permission Scopes</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#server-installation">3. Installation and Configuration of Keycloak Server</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e70">3.1. Installation</a></span></dt><dd><dl><dt><span class="section"><a href="#server_install">3.1.1. Install Standalone Server</a></span></dt><dt><span class="section"><a href="#overlay_install">3.1.2. Install on existing WildFly 9.0.1.Final</a></span></dt><dt><span class="section"><a href="#d4e108">3.1.3. Install on existing JBoss EAP 6.4.0.GA</a></span></dt><dt><span class="section"><a href="#d4e113">3.1.4. Install Development Bundle</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e129">3.2. Configuring the Server</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e136">3.2.1. Relational Database Configuration</a></span></dt><dt><span class="section"><a href="#d4e211">3.2.2. MongoDB based model</a></span></dt><dt><span class="section"><a href="#d4e240">3.2.3. JSON File based model</a></span></dt><dt><span class="section"><a href="#d4e252">3.2.4. Outgoing Server HTTP Requests</a></span></dt><dt><span class="section"><a href="#ssl_modes">3.2.5. SSL/HTTPS Requirement/Modes</a></span></dt><dt><span class="section"><a href="#d4e339">3.2.6. SSL/HTTPS Setup</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e409">3.3. Adding Keycloak server in Domain Mode</a></span></dt><dt><span class="section"><a href="#d4e426">3.4. Installing Keycloak Server as Root Context</a></span></dt></dl></dd><dt><span class="chapter"><a href="#providers">4. Providers and SPIs</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e444">4.1. Implementing a SPI</a></span></dt><dt><span class="section"><a href="#d4e455">4.2. Registering provider implementations</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e458">4.2.1. Register a provider using Modules</a></span></dt><dt><span class="section"><a href="#d4e469">4.2.2. Register a provider using file-system</a></span></dt><dt><span class="section"><a href="#d4e476">4.2.3. Configuring a provider</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e482">4.3. Available SPIs</a></span></dt></dl></dd><dt><span class="chapter"><a href="#openshift">5. Running Keycloak Server on OpenShift</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e553">5.1. Create Keycloak instance with the web tool</a></span></dt><dt><span class="section"><a href="#d4e566">5.2. Create Keycloak instance with the command-line tool</a></span></dt><dt><span class="section"><a href="#d4e573">5.3. Next steps</a></span></dt></dl></dd><dt><span class="chapter"><a href="#admin-permissions">6. Master Admin Access Control</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e590">6.1. Global Roles</a></span></dt><dt><span class="section"><a href="#d4e604">6.2. Realm Specific Roles</a></span></dt></dl></dd><dt><span class="chapter"><a href="#per-realm-admin-permissions">7. Per Realm Admin Access Control</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e642">7.1. Realm Roles</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d4e675">8. Adapters</a></span></dt><dd><dl><dt><span class="section"><a href="#adapter-config">8.1. General Adapter Config</a></span></dt><dt><span class="section"><a href="#jboss-adapter">8.2. JBoss/Wildfly Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#jboss-adapter-installation">8.2.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="#d4e910">8.2.2. Required Per WAR Configuration</a></span></dt><dt><span class="section"><a href="#d4e923">8.2.3. Securing WARs via Keycloak Subsystem</a></span></dt></dl></dd><dt><span class="section"><a href="#tomcat-adapter">8.3. Tomcat 6, 7 and 8 Adapters</a></span></dt><dd><dl><dt><span class="section"><a href="#tomcat-adapter-installation">8.3.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="#d4e958">8.3.2. Required Per WAR Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#jetty9-adapter">8.4. Jetty 9.x Adapters</a></span></dt><dd><dl><dt><span class="section"><a href="#jetty9-adapter-installation">8.4.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="#jetty9_per_war">8.4.2. Required Per WAR Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#jetty8-adapter">8.5. Jetty 8.1.x Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#jetty8-adapter-installation">8.5.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="#d4e1020">8.5.2. Required Per WAR Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1024">8.6. Java Servlet Filter Adapter</a></span></dt><dt><span class="section"><a href="#fuse-adapter">8.7. JBoss Fuse and Apache Karaf Adapter</a></span></dt><dt><span class="section"><a href="#javascript-adapter">8.8. Javascript Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e1100">8.8.1. Session status iframe</a></span></dt><dt><span class="section"><a href="#d4e1105">8.8.2. Older browsers</a></span></dt><dt><span class="section"><a href="#d4e1113">8.8.3. JavaScript Adapter reference</a></span></dt></dl></dd><dt><span class="section"><a href="#spring-boot-adapter">8.9. Spring Boot Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#spring-boot-adapter-installation">8.9.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="#spring-boot-adapter-configuration">8.9.2. Required Spring Boot Adapter Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#spring-security-adapter">8.10. Spring Security Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e1243">8.10.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="#d4e1248">8.10.2. Spring Security Configuration</a></span></dt><dt><span class="section"><a href="#d4e1267">8.10.3. Naming Security Roles</a></span></dt><dt><span class="section"><a href="#d4e1273">8.10.4. Client to Client Support</a></span></dt><dt><span class="section"><a href="#d4e1285">8.10.5. Spring Boot Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#installed-applications">8.11. Installed Applications</a></span></dt><dd><dl><dt><span class="section"><a href="#installed-applications-url">8.11.1. http://localhost</a></span></dt><dt><span class="section"><a href="#installed-applications-urn">8.11.2. urn:ietf:wg:oauth:2.0:oob</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1302">8.12. Logout</a></span></dt><dt><span class="section"><a href="#multi_tenancy">8.13. Multi Tenancy</a></span></dt><dt><span class="section"><a href="#jaas-adapter">8.14. JAAS plugin</a></span></dt></dl></dd><dt><span class="chapter"><a href="#identity-broker">9. Identity Broker</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e1377">9.1. Overview</a></span></dt><dt><span class="section"><a href="#d4e1409">9.2. Configuration</a></span></dt><dt><span class="section"><a href="#d4e1480">9.3. Social Identity Providers</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e1483">9.3.1. Google</a></span></dt><dt><span class="section"><a href="#d4e1552">9.3.2. Facebook</a></span></dt><dt><span class="section"><a href="#d4e1622">9.3.3. Twitter</a></span></dt><dt><span class="section"><a href="#d4e1675">9.3.4. Github</a></span></dt><dt><span class="section"><a href="#d4e1727">9.3.5. LinkedIn</a></span></dt><dt><span class="section"><a href="#d4e1783">9.3.6. StackOverflow</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1825">9.4. SAML v2.0 Identity Providers</a></span></dt><dt><span class="section"><a href="#d4e1889">9.5. OpenID Connect v1.0 Identity Providers</a></span></dt><dt><span class="section"><a href="#d4e1948">9.6. Retrieving Tokens from Identity Providers</a></span></dt><dt><span class="section"><a href="#d4e1961">9.7. Automatically Select and Identity Provider</a></span></dt><dt><span class="section"><a href="#d4e1973">9.8. Mapping/Importing SAML and OIDC Metadata</a></span></dt><dt><span class="section"><a href="#d4e1978">9.9. Mapping/Importing User profile data from Social Identity Provider</a></span></dt><dt><span class="section"><a href="#d4e1986">9.10. User Session Data</a></span></dt><dt><span class="section"><a href="#d4e1994">9.11. Examples</a></span></dt></dl></dd><dt><span class="chapter"><a href="#themes">10. Themes</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2002">10.1. Theme types</a></span></dt><dt><span class="section"><a href="#d4e2011">10.2. Configure theme</a></span></dt><dt><span class="section"><a href="#d4e2025">10.3. Default themes</a></span></dt><dt><span class="section"><a href="#d4e2029">10.4. Creating a theme</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2070">10.4.1. Stylesheets</a></span></dt><dt><span class="section"><a href="#d4e2084">10.4.2. Scripts</a></span></dt><dt><span class="section"><a href="#d4e2094">10.4.3. Images</a></span></dt><dt><span class="section"><a href="#d4e2101">10.4.4. Messages</a></span></dt><dt><span class="section"><a href="#d4e2110">10.4.5. Modifying HTML</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e2119">10.5. Deploying themes</a></span></dt><dt><span class="section"><a href="#d4e2148">10.6. SPIs</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2151">10.6.1. Account SPI</a></span></dt><dt><span class="section"><a href="#d4e2159">10.6.2. Login SPI</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#recaptcha">11. Recaptcha Support on Registration</a></span></dt><dt><span class="chapter"><a href="#d4e2179">12. Email</a></span></dt><dd><dl><dt><span class="section"><a href="#email-config">12.1. Email Server Config</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2194">12.1.1. Enable SSL or TLS</a></span></dt><dt><span class="section"><a href="#d4e2200">12.1.2. Authentication</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#access-types">13. Client Access Types</a></span></dt><dt><span class="chapter"><a href="#roles">14. Roles</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2233">14.1. Composite Roles</a></span></dt></dl></dd><dt><span class="chapter"><a href="#direct-access-grants">15. Direct Access Grants</a></span></dt><dt><span class="chapter"><a href="#service-accounts">16. Service Accounts</a></span></dt><dt><span class="chapter"><a href="#cors">17. CORS</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2298">17.1. Handling CORS Yourself</a></span></dt></dl></dd><dt><span class="chapter"><a href="#timeouts">18. Cookie settings, Session Timeouts, and Token Lifespans</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2307">18.1. Remember Me</a></span></dt><dt><span class="section"><a href="#session-timeouts">18.2. Session Timeouts</a></span></dt><dt><span class="section"><a href="#token-timeouts">18.3. Token Timeouts</a></span></dt><dt><span class="section"><a href="#offline-access">18.4. Offline Access</a></span></dt></dl></dd><dt><span class="chapter"><a href="#admin-rest-api">19. Admin REST API</a></span></dt><dt><span class="chapter"><a href="#events">20. Events</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2362">20.1. Event types</a></span></dt><dt><span class="section"><a href="#d4e2384">20.2. Event Listener</a></span></dt><dt><span class="section"><a href="#d4e2395">20.3. Event Store</a></span></dt><dt><span class="section"><a href="#d4e2401">20.4. Configure Events Settings for Realm</a></span></dt></dl></dd><dt><span class="chapter"><a href="#user_federation">21. User Federation SPI and LDAP/AD Integration</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2414">21.1. LDAP and Active Directory Plugin</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2420">21.1.1. Edit Mode</a></span></dt><dt><span class="section"><a href="#d4e2436">21.1.2. Other config options</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e2461">21.2. Sync of LDAP users to Keycloak</a></span></dt><dt><span class="section"><a href="#ldap_mappers">21.3. LDAP/Federation mappers</a></span></dt><dt><span class="section"><a href="#d4e2513">21.4. Writing your own User Federation Provider</a></span></dt></dl></dd><dt><span class="chapter"><a href="#kerberos">22. Kerberos brokering</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2555">22.1. Setup of Kerberos server</a></span></dt><dt><span class="section"><a href="#d4e2570">22.2. Setup and configuration of Keycloak server</a></span></dt><dt><span class="section"><a href="#d4e2599">22.3. Setup and configuration of client machines</a></span></dt><dt><span class="section"><a href="#d4e2606">22.4. Example setups</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2609">22.4.1. Keycloak and FreeIPA docker image</a></span></dt><dt><span class="section"><a href="#d4e2615">22.4.2. ApacheDS testing Kerberos server</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e2620">22.5. Credential delegation</a></span></dt><dt><span class="section"><a href="#d4e2636">22.6. Troubleshooting</a></span></dt></dl></dd><dt><span class="chapter"><a href="#export-import">23. Export and Import</a></span></dt><dt><span class="chapter"><a href="#admin-recovery">24. Recovering the Master Admin User</a></span></dt><dt><span class="chapter"><a href="#server_cache">25. Server Cache</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2710">25.1. Disabling Caches</a></span></dt><dt><span class="section"><a href="#d4e2720">25.2. Clear Caches</a></span></dt><dt><span class="section"><a href="#d4e2723">25.3. Cache Config</a></span></dt></dl></dd><dt><span class="chapter"><a href="#saml">26. SAML SSO</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2804">26.1. SAML Entity Descriptor</a></span></dt><dt><span class="section"><a href="#d4e2811">26.2. IDP Initiated Login</a></span></dt></dl></dd><dt><span class="chapter"><a href="#security_vulnerabilities">27. Security Vulnerabilities</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2823">27.1. SSL/HTTPS Requirement</a></span></dt><dt><span class="section"><a href="#d4e2829">27.2. CSRF Attacks</a></span></dt><dt><span class="section"><a href="#d4e2835">27.3. Clickjacking</a></span></dt><dt><span class="section"><a href="#d4e2841">27.4. Compromised Access Codes</a></span></dt><dt><span class="section"><a href="#d4e2844">27.5. Compromised access and refresh tokens</a></span></dt><dt><span class="section"><a href="#d4e2848">27.6. Open redirectors</a></span></dt><dt><span class="section"><a href="#d4e2852">27.7. Password guess: brute force attacks</a></span></dt><dt><span class="section"><a href="#d4e2859">27.8. Password database compromised</a></span></dt><dt><span class="section"><a href="#d4e2862">27.9. SQL Injection attacks</a></span></dt><dt><span class="section"><a href="#d4e2865">27.10. Limiting Scope</a></span></dt></dl></dd><dt><span class="chapter"><a href="#clustering">28. Clustering</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2884">28.1. Configure a shared database</a></span></dt><dt><span class="section"><a href="#d4e2887">28.2. Configure Infinispan</a></span></dt><dt><span class="section"><a href="#d4e2907">28.3. Start in HA mode</a></span></dt><dt><span class="section"><a href="#d4e2915">28.4. Enabling cluster security</a></span></dt><dt><span class="section"><a href="#d4e2926">28.5. Troubleshooting</a></span></dt></dl></dd><dt><span class="chapter"><a href="#applicationClustering">29. Application Clustering</a></span></dt><dd><dl><dt><span class="section"><a href="#stateless-token-store">29.1. Stateless token store</a></span></dt><dt><span class="section"><a href="#relative-uri-optimization">29.2. Relative URI optimization</a></span></dt><dt><span class="section"><a href="#admin-url-configuration">29.3. Admin URL configuration</a></span></dt><dt><span class="section"><a href="#registration-app-nodes">29.4. Registration of application nodes to Keycloak</a></span></dt><dt><span class="section"><a href="#refresh-token-each-req">29.5. Refresh token in each request</a></span></dt></dl></dd><dt><span class="chapter"><a href="#proxy">30. Keycloak Security Proxy</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e3037">30.1. Proxy Install and Run</a></span></dt><dt><span class="section"><a href="#d4e3045">30.2. Proxy Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e3049">30.2.1. Basic Config</a></span></dt><dt><span class="section"><a href="#d4e3105">30.2.2. Application Config</a></span></dt><dt><span class="section"><a href="#d4e3175">30.2.3. Header Names Config</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e3199">30.3. Keycloak Identity Headers</a></span></dt></dl></dd><dt><span class="chapter"><a href="#custom-user-attributes">31. Custom User Attributes</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e3231">31.1. In admin console</a></span></dt><dt><span class="section"><a href="#d4e3251">31.2. In registration page</a></span></dt><dt><span class="section"><a href="#d4e3270">31.3. In user account profile page</a></span></dt></dl></dd><dt><span class="chapter"><a href="#mappers">32. OIDC Token and SAML Assertion Mappings</a></span></dt><dt><span class="chapter"><a href="#auth_spi">33. Custom Authentication, Registration, and Required Actions</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e3298">33.1. Terms</a></span></dt><dt><span class="section"><a href="#d4e3326">33.2. Algorithm Overview</a></span></dt><dt><span class="section"><a href="#auth_spi_walkthrough">33.3. Authenticator SPI Walk Through</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e3358">33.3.1. Packaging Classes and Deployment</a></span></dt><dt><span class="section"><a href="#d4e3366">33.3.2. Implementing an Authenticator</a></span></dt><dt><span class="section"><a href="#d4e3387">33.3.3. Implementing an AuthenticatorFactory</a></span></dt><dt><span class="section"><a href="#d4e3400">33.3.4. Adding Authenticator Form</a></span></dt><dt><span class="section"><a href="#adding_authenticator">33.3.5. Adding Authenticator to a Flow</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e3420">33.4. Required Action Walkthrough</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e3423">33.4.1. Packaging Classes and Deployment</a></span></dt><dt><span class="section"><a href="#d4e3431">33.4.2. Implement the RequiredActionProvider</a></span></dt><dt><span class="section"><a href="#d4e3440">33.4.3. Implement the RequiredActionFactory</a></span></dt><dt><span class="section"><a href="#d4e3445">33.4.4. Enable Required Action</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e3448">33.5. Modifying/Extending the Registration Form</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e3451">33.5.1. Implementation FormAction Interface</a></span></dt><dt><span class="section"><a href="#d4e3469">33.5.2. Packaging the Action</a></span></dt><dt><span class="section"><a href="#d4e3477">33.5.3. Adding FormAction to the Registration Flow</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e3482">33.6. Modifying Forgot Password/Credential Flow</a></span></dt><dt><span class="section"><a href="#client_authentication">33.7. Authentication of clients</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e3494">33.7.1. Default implementations</a></span></dt><dt><span class="section"><a href="#d4e3528">33.7.2. Implement your own client authenticator</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#Migration_from_older_versions">34. Migration from older versions</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e3557">34.1. Migrate database</a></span></dt><dt><span class="section"><a href="#d4e3569">34.2. Migrate keycloak-server.json</a></span></dt><dt><span class="section"><a href="#d4e3573">34.3. Migrate providers</a></span></dt><dt><span class="section"><a href="#d4e3576">34.4. Migrate themes</a></span></dt><dt><span class="section"><a href="#d4e3579">34.5. Migrate application</a></span></dt><dt><span class="section"><a href="#d4e3582">34.6. Version specific migration</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e3584">34.6.1. Migrating to 1.6.0.Final</a></span></dt><dt><span class="section"><a href="#d4e3600">34.6.2. Migrating to 1.5.0.Final</a></span></dt><dt><span class="section"><a href="#d4e3612">34.6.3. Migrating to 1.3.0.Final</a></span></dt><dt><span class="section"><a href="#d4e3640">34.6.4. Migrating from 1.2.0.Beta1 to 1.2.0.RC1</a></span></dt><dt><span class="section"><a href="#d4e3653">34.6.5. Migrating from 1.1.0.Final to 1.2.0.Beta1</a></span></dt><dt><span class="section"><a href="#d4e3702">34.6.6. Migrating from 1.1.0.Beta2 to 1.1.0.Final</a></span></dt><dt><span class="section"><a href="#d4e3709">34.6.7. Migrating from 1.1.0.Beta1 to 1.1.0.Beta2</a></span></dt><dt><span class="section"><a href="#d4e3719">34.6.8. Migrating from 1.0.x.Final to 1.1.0.Beta1</a></span></dt><dt><span class="section"><a href="#d4e3725">34.6.9. Migrating from 1.0 RC-1 to RC-2</a></span></dt><dt><span class="section"><a href="#d4e3729">34.6.10. Migrating from 1.0 Beta 4 to RC-1</a></span></dt><dt><span class="section"><a href="#d4e3733">34.6.11. Migrating from 1.0 Beta 1 to Beta 4</a></span></dt><dt><span class="section"><a href="#d4e3747">34.6.12. Migrating from 1.0 Alpha 4 to Beta 1</a></span></dt><dt><span class="section"><a href="#d4e3761">34.6.13. Migrating from 1.0 Alpha 2 to Alpha 3</a></span></dt><dt><span class="section"><a href="#d4e3768">34.6.14. Migrating from 1.0 Alpha 1 to Alpha 2</a></span></dt></dl></dd></dl></dd></dl></div>

   

   

   <div class="preface" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="preface"/>Preface</h2></div></div></div>
      
      <p>
         In some of the example listings, what is meant to be displayed on one line does not fit
         inside the available page width. These lines have been broken up. A '\' at the end of a
         line means that a break has been introduced to fit in the page, with the following lines
         indented. So:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
Let's pretend to have an extremely \
long line that \
does not fit
This one is short
</pre><p>
         Is really:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
Let's pretend to have an extremely long line that does not fit
This one is short
</pre><p>
      </p>
   </div>

    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="license"/>Chapter 1. License</h2></div></div></div>
    
    <p>Keycloak codebase is distributed under the ASL 2.0 license. It does not distribute any thirdparty libraries that are
        GPL. It does ship thirdparty libraries licensed under
        Apache ASL 2.0 and LGPL.
    </p>
</div>

    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="Overview"/>Chapter 2. Overview</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e46">2.1. Key Concepts in Keycloak</a></span></dt><dt><span class="section"><a href="#d4e54">2.2. How Does Security Work in Keycloak?</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e65">2.2.1. Permission Scopes</a></span></dt></dl></dd></dl></div>
    

    <p>
        Keycloak is an SSO solution for web apps, mobile and RESTful web services.  It is an authentication server where users
        can centrally login, logout, register, and manage their user accounts.  The Keycloak admin UI can manage roles
        and role mappings for any application secured by Keycloak.  The Keycloak Server can also be used to perform
        social logins via the user's favorite social media site i.e. Google, Facebook, Twitter etc.
    </p>
    <p>


    </p>
    <p>
        Features:
        </p><div class="itemizedlist"><ul><li>
                SSO and Single Log Out for browser applications
            </li><li>
                Social Login.  Enable Google, GitHub, Facebook, Twitter social login with no code required.
            </li><li>
                LDAP and Active Directory support.
            </li><li>
                Optional User Registration
            </li><li>
                Password and TOTP support (via Google Authenticator).  Client cert auth coming soon.
            </li><li>
                Forgot password support.  User can have an email sent to them
            </li><li>
                Reset password/totp.  Admin can force a password reset, or set up a temporary password.
            </li><li>
                Not-before revocation policies per realm, application, or user.
            </li><li>
                User session management.  Admin can view user sessions and what applications/clients have an access token.  Sessions can be invalidated
                per realm or per user.
            </li><li>
                Pluggable theme and style support for user facing screens. Login, grant pages, account mgmt, and admin console all
                can be styled, branded, and tailored to your application and organizational needs.
            </li><li>
                Integrated Browser App to REST Service token propagation
            </li><li>
                OAuth Bearer token auth for REST Services
            </li><li>
                OAuth 2.0 Grant requests
            </li><li>
                OpenID Connect Support.
            </li><li>
                SAML Support.
            </li><li>
                CORS Support
            </li><li>
                CORS Web Origin management and validation
            </li><li>
                Completely centrally managed user and role mapping metadata.  Minimal configuration at the application side
            </li><li>
                Admin Console for managing users, roles, role mappings, clients, user sessions and allowed CORS web origins.
            </li><li>
                Account Management console that allows users to manage their own account, view their open sessions, reset passwords, etc.
            </li><li>
                Deployable as a WAR, appliance, or on Openshift.  Completely clusterable.
            </li><li>
                Multitenancy support.  You can host and manage multiple realms for multiple organizations.   In the same auth server
                and even within the same deployed application.
            </li><li>
                Identity brokering/chaining.  You can make the Keycloak server a child IDP to another SAML 2.0 or OpenID Connect IDP.
            </li><li>
                Token claim, assertion, and attribute mappings.  You can map user attributes, roles, and role names however you want
                into a OIDC ID Token, Access Token, SAML attribute statements, etc.  This feature allows you to basically
                tailor however you want auth responses to look.
            </li><li>
                Supports JBoss AS7, EAP 6.x, Wildfly, Tomcat 7, Tomcat 8, Jetty 9.1.x, Jetty 9.2.x, Jetty 8.1.x, and Pure JavaScript applications.  Plans to support Node.js, RAILS, GRAILS, and other non-Java deployments
            </li></ul></div><p>
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e46"/>2.1. Key Concepts in Keycloak</h2></div></div></div>
        
        <p>
            The core concept in Keycloak is a <span class="emphasis"><em>Realm</em></span>.  A realm secures and manages security metadata
            for a set of users and registered clients.  Users can be created within a specific realm
            within the Administration console.  Roles (permission types) can be defined at the realm level and you can also
            set up user role mappings to assign these permissions to specific users.
        </p>
        <p>
            A <span class="emphasis"><em>client</em></span> is a service that is secured by a realm. You will often use Client for every Application secured by Keycloak. When a user browses an
            application's web site, the application can redirect the user agent to the Keycloak Server and request a login.
            Once a user is logged in, they can visit any other client (application) managed by the realm and not have to re-enter
            credentials.  This also hold true for logging out.  Roles can also be defined at the client level and
            assigned to specific users.  Depending on the client type, you may also be able to view and manage
            user sessions from the administration console.
        </p>
        <p>
            In admin console there is switch <span class="emphasis"><em>Consent required</em></span> specified when creating/editing client. When on, the client is not immediately granted
            all permissions of the user.  In addition to requesting the login credentials of the user, the Keycloak Server
            will also display a grant page asking the user if it is ok to grant allowed permissions to the client.  The granted consents are saved
            and every user can see his granted consents in Account Management UI and he can also revoke them for particular client. Also admin can see and revoke the grants
            of particular user in Keycloak Admin Console UI.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e54"/>2.2. How Does Security Work in Keycloak?</h2></div></div></div>
        
        <p>
            Keycloak uses <span class="emphasis"><em>access tokens</em></span> to secure web invocations.  Access tokens contains security metadata specifying the
            identity of the user as well as the role mappings for that user.  The format of these tokens is a Keycloak
            extension to the <a class="ulink" href="http://tools.ietf.org/html/draft-ietf-oauth-json-web-token-14">JSON Web Token</a> specification.  Each realm  has a private and public key pair
            which it uses to digitally sign the access token using the <a class="ulink" href="http://tools.ietf.org/html/draft-ietf-jose-json-web-signature-19">JSON Web Signature</a> specification.
            Applications can verify the integrity of the digitally signed
            access token using the public key of the realm.  The protocols used to obtain this token is defined by the
            <a class="ulink" href="http://tools.ietf.org/html/rfc6749">OAuth 2.0</a> specification.
        </p>
        <p>
            The interesting thing about using these <span class="emphasis"><em>smart</em></span> access tokens is that applications themselves are completely stateless
            as far as security metadata goes.  All the information they need about the user is contained in the token and there's
            no need for them to store any security metadata locally other than the public key of the realm.
        </p>
        <p>
            Signed access tokens can also be propagated by REST client requests within an <code class="literal">Authorization</code>
            header.  This is great for distributed integration as applications can request a login from a client to obtain
            an access token, then invoke any aggregated REST invocations to other services using that access token.  So,
            you have a distributed security model that is centrally managed, yet does not require a Keycloak Server hit
            per request, only for the initial login.
        </p>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e65"/>2.2.1. Permission Scopes</h3></div></div></div>
            
            <p>
                Each client is configured with a set of permission scopes.  These are a set
                of roles that a client is allowed to ask permission for.  Access tokens are always
                granted at the request of a specific client.  This also holds true for SSO.  As you visit
                different sites, the application will redirect back to the Keycloak Server via the OAuth 2.0 protocol to obtain an access
                token specific to that application (client).  The role mappings contained within the token are the intersection
                between the set of user role mappings and the permission scope of the client.  So,
                access tokens are tailor made for each client and contain only the information required
                for by them.
            </p>
        </div>
    </div>
</div>

    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="server-installation"/>Chapter 3. Installation and Configuration of Keycloak Server</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e70">3.1. Installation</a></span></dt><dd><dl><dt><span class="section"><a href="#server_install">3.1.1. Install Standalone Server</a></span></dt><dt><span class="section"><a href="#overlay_install">3.1.2. Install on existing WildFly 9.0.1.Final</a></span></dt><dt><span class="section"><a href="#d4e108">3.1.3. Install on existing JBoss EAP 6.4.0.GA</a></span></dt><dt><span class="section"><a href="#d4e113">3.1.4. Install Development Bundle</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e129">3.2. Configuring the Server</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e136">3.2.1. Relational Database Configuration</a></span></dt><dt><span class="section"><a href="#d4e211">3.2.2. MongoDB based model</a></span></dt><dt><span class="section"><a href="#d4e240">3.2.3. JSON File based model</a></span></dt><dt><span class="section"><a href="#d4e252">3.2.4. Outgoing Server HTTP Requests</a></span></dt><dt><span class="section"><a href="#ssl_modes">3.2.5. SSL/HTTPS Requirement/Modes</a></span></dt><dt><span class="section"><a href="#d4e339">3.2.6. SSL/HTTPS Setup</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e409">3.3. Adding Keycloak server in Domain Mode</a></span></dt><dt><span class="section"><a href="#d4e426">3.4. Installing Keycloak Server as Root Context</a></span></dt></dl></div>
    

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e70"/>3.1. Installation</h2></div></div></div>
        
        <p>
            Keycloak Server has three downloadable distributions.
        </p>
        <p>
            </p><div class="itemizedlist"><ul><li>
                    <code class="literal">keycloak-1.6.0.Final.[zip|tar.gz]</code> - Standalone server
                </li><li>
                    <code class="literal">keycloak-overlay-1.6.0.Final.[zip|tar.gz]</code> - Installer for WildFly or JBoss EAP
                </li><li>
                    <code class="literal">keycloak-demo-1.6.0.Final.[zip|tar.gz]</code> - Development bundle including WildFly, Keycloak, examples and documentation
                </li></ul></div><p>
        </p>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="server_install"/>3.1.1. Install Standalone Server</h3></div></div></div>
            
            <p>
                For production and for non-JavaEE developers we recommend using the standalone Keycloak server. All you need to
                do is to download <code class="literal">keycloak-1.6.0.Final.zip</code> or  <code class="literal">keycloak-1.6.0.Final.tar.gz</code>,
                unpackage and start to have a Keycloak server up and running.
            </p>

            <p>
                To install first download either the zip or tar.gz and extract. Then start by running either:
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">keycloak-1.6.0.Final/bin/standalone.sh</pre><p>
                or:
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">keycloak-1.6.0.Final/bin/standalone.bat</pre><p>
            </p>
            <p>
                Once the server is started log into the admin console at
                <a class="ulink" href="http://localhost:8080/auth/admin/index.html">http://localhost:8080/auth/admin/index.html</a>
                (username: <span class="emphasis"><em>admin</em></span> and password: <span class="emphasis"><em>admin</em></span>). Keycloak will then prompt you to
                enter in a new password.
            </p>
        </div>


        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="overlay_install"/>3.1.2. Install on existing WildFly 9.0.1.Final</h3></div></div></div>
            
            <p>
                Keycloak can be installed into an existing WildFly 9.0.0.Final server. To do this download
                <code class="literal">keycloak-overlay-1.6.0.Final.zip</code> or <code class="literal">keycloak-overlay-1.6.0.Final.tar.gz</code>.
                Once downloaded extract into the root directory of your WildFly installation. To start WildFly with Keycloak
                run:
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;WILDFLY_HOME&gt;/bin/standalone.sh --server-config=standalone-keycloak.xml</pre><p>
                or:
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;WILDFLY_HOME&gt;/bin/standalone.bat --server-config=standalone-keycloak.xml</pre><p>
            </p>
            <p>
                Once the server is started log into the admin console at
                <a class="ulink" href="http://localhost:8080/auth/admin/index.html">http://localhost:8080/auth/admin/index.html</a>
                (username: <span class="emphasis"><em>admin</em></span> and password: <span class="emphasis"><em>admin</em></span>). Keycloak will then prompt you to
                enter in a new password.
            </p>
            <p>
                To add Keycloak to other sever configurations (standalone.xml, standalone-ha.xml, etc.) start the server with
                the desired server-config. If you are running the server in standalone mode run:
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">cd &lt;WILDFLY_HOME&gt;/bin
                    ./jboss-cli.sh -c --file=keycloak-install.cli</pre><p>
                Or if you are running in clustering (HA) mode (by having used -c standalone-ha.xml) then run:
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">cd &lt;WILDFLY_HOME&gt;/bin
                    ./jboss-cli.sh -c --file=keycloak-install-ha.cli</pre><p>
                You may see exceptions in the server log, but after restarting the server they should be gone.
                You can restart the server with:
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;WILDFLY_HOME&gt;/bin/jboss-cli.sh -c :reload</pre><p>
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e108"/>3.1.3. Install on existing JBoss EAP 6.4.0.GA</h3></div></div></div>
            
            <p>
                Same procedure as WildFly 9.0.1.Final, but download <code class="literal">keycloak-overlay-eap6-1.6.0.Final.zip</code> or <code class="literal">keycloak-overlay-eap6-1.6.0.Final.tar.gz</code>.
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e113"/>3.1.4. Install Development Bundle</h3></div></div></div>
            
            <p>
                The demo bundle contains everything you need to get started with Keycloak including documentation and examples.
                To install it first download <code class="literal">keycloak-demo-1.6.0.Final.zip</code> or
                <code class="literal">keycloak-demo-1.6.0.Final.tar.gz</code>. Once downloaded extract it inside
                <code class="literal">keycloak-demo-1.6.0.Final</code> you'll find <code class="literal">keycloak</code> which contains
                a full WildFly 9.0.0.Final server with Keycloak Server and Adapters included. You'll also find <code class="literal">docs</code>
                and <code class="literal">examples</code> which contains everything you need to get started developing applications that use Keycloak.
            </p>
            <p>
                To start WildFly with Keycloak run:
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">keycloak-1.6.0.Final/bin/standalone.sh</pre><p>
                or:
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">keycloak-1.6.0.Final/bin/standalone.bat</pre><p>
            </p>
            <p>
                Once the server is started log into the admin console at
                <a class="ulink" href="http://localhost:8080/auth/admin/index.html">http://localhost:8080/auth/admin/index.html</a>
                (username: <span class="emphasis"><em>admin</em></span> and password: <span class="emphasis"><em>admin</em></span>). Keycloak will then prompt you to
                enter in a new password.
            </p>
        </div>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e129"/>3.2. Configuring the Server</h2></div></div></div>
        
        <p>
            Although the Keycloak Server is designed to run out of the box, there's some things you'll need
            to configure before you go into production.  Specifically:
            </p><div class="itemizedlist"><ul><li>
                    Configuring Keycloak to use a production database.
                </li><li>
                    Setting up SSL/HTTPS
                </li><li>
                    Enforcing HTTPS connections
                </li></ul></div><p>
        </p>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e136"/>3.2.1. Relational Database Configuration</h3></div></div></div>
            
            <p>
                You might want to use a better relational database for Keycloak like PostgreSQL or MySQL.  You might also
                want to tweak the configuration settings of the datasource.  Please see the <a class="ulink" href="https://docs.jboss.org/author/display/WFLY8/DataSource+configuration">Wildfly</a>
                documentation on how to do this.
            </p>
            <p>
                Keycloak runs on a Hibernate/JPA backend which is configured in the
                <code class="literal">standalone/configuration/keycloak-server.json</code>.
                By default the setting is like this:
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"connectionsJpa": {
    "default": {
        "dataSource": "java:jboss/datasources/KeycloakDS",
        "databaseSchema": "update"
    }
},
</pre><p>
                Possible configuration options are:
                </p><div class="variablelist"><dl><dt><span class="term">dataSource</span></dt><dd>
                            <p>
                                JNDI name of the dataSource
                            </p>
                        </dd><dt><span class="term">jta</span></dt><dd>
                            <p>
                                boolean property to specify if datasource is JTA capable
                            </p>
                        </dd><dt><span class="term">driverDialect</span></dt><dd>
                            <p>
                                Value of Hibernate dialect. In most cases you don't need to specify this property as dialect will be
                                autodetected by Hibernate.
                            </p>
                        </dd><dt><span class="term">databaseSchema</span></dt><dd>
                            <p>
                                Specify if schema should be updated or validated. Valid values are "update" and "validate" ("update is default).
                            </p>
                        </dd><dt><span class="term">showSql</span></dt><dd>
                            <p>
                                Specify whether Hibernate should show all SQL commands in the console (false by default)
                            </p>
                        </dd><dt><span class="term">formatSql</span></dt><dd>
                            <p>
                                Specify whether Hibernate should format SQL commands (true by default)
                            </p>
                        </dd><dt><span class="term">schema</span></dt><dd>
                            <p>
                                Specify the database schema to use
                            </p>
                        </dd></dl></div><p>
            </p>
            <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e172"/>3.2.1.1. Tested databases</h4></div></div></div>
                
                <p>
                    Here is list of RDBMS databases and corresponding JDBC drivers, which were tested with Keycloak. Note that Hibernate dialect
                    is usually set automatically according to your database, but in some cases, you must manually set the proper dialect,
                    as the default dialect may not work correctly. You can setup dialect by adding property <code class="literal">driverDialect</code>
                    to the <code class="literal">keycloak-server.json</code> into <code class="literal">connectionsJpa</code> section (see above).
                    </p><div class="table"><a id="d4e178"/><p class="title"><b>Table 3.1. Tested databases</b></p><div class="table-contents">
                        <table summary="Tested databases" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th align="left">Database</th><th align="left">JDBC driver</th><th align="left">Hibernate Dialect</th></tr></thead><tbody><tr><td align="left">H2 1.3.161</td><td align="left">H2 1.3.161</td><td align="left">auto</td></tr><tr><td align="left">MySQL 5.5</td><td align="left">MySQL Connector/J 5.1.25</td><td align="left">auto</td></tr><tr><td align="left">PostgreSQL 9.2</td><td align="left">JDBC4 Postgresql Driver, Version 9.3-1100</td><td align="left">auto</td></tr><tr><td align="left">Oracle 11g R1</td><td align="left">Oracle JDBC Driver v11.1.0.7</td><td align="left">auto</td></tr><tr><td align="left">Microsoft SQL Server 2012</td><td align="left">Microsoft SQL Server JDBC Driver 4.0.2206.100</td><td align="left">org.hibernate.dialect.SQLServer2008Dialect</td></tr><tr><td align="left">Sybase ASE 15.7</td><td align="left">JDBC(TM)/7.07 ESD #5 (Build 26792)/P/EBF20686</td><td align="left">auto</td></tr></tbody></table>
                    </div></div><p><br class="table-break"/>
                </p>
            </div>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e211"/>3.2.2. MongoDB based model</h3></div></div></div>
            
            <p>
                Keycloak provides <a class="ulink" href="http://www.mongodb.com">MongoDB</a> based model implementation, which means that your identity data will be saved
                in MongoDB instead of traditional RDBMS. To configure Keycloak to use Mongo open <code class="literal">standalone/configuration/keycloak-server.json</code>
                in your favourite editor, then change:

</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"eventsStore": {
    "provider": "jpa",
    "jpa": {
        "exclude-events": [ "REFRESH_TOKEN" ]
    }
},

"realm": {
    "provider": "jpa"
},

"user": {
    "provider": "${keycloak.user.provider:jpa}"
},
</pre><p>

                to:

                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"eventsStore": {
    "provider": "mongo",
    "mongo": {
        "exclude-events": [ "REFRESH_TOKEN" ]
    }
},

"realm": {
    "provider": "mongo"
},

"user": {
    "provider": "mongo"
},
</pre><p>

                And at the end of the file add the snippet like this where you can configure details about your Mongo database:
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"connectionsMongo": {
    "default": {
        "host": "127.0.0.1",
        "port": "27017",
        "db": "keycloak",
        "connectionsPerHost": 100,
        "databaseSchema": "update"
    }
}
</pre><p>

                All configuration options are optional. Default values for host and port are localhost and 27017. Default name of database
                is <code class="literal">keycloak</code> . You can also specify properties <code class="literal">user</code> and <code class="literal">password</code>
                if you want authenticate against your MongoDB. If user and password are not specified, Keycloak will connect
                unauthenticated to your MongoDB.
            </p>
            <p>Finally there is set of optional configuration options, which can be used to specify connection-pooling capabilities of Mongo client. Supported int options are:
                <code class="literal">connectionsPerHost</code>, <code class="literal">threadsAllowedToBlockForConnectionMultiplier</code>, <code class="literal">maxWaitTime</code>, <code class="literal">connectTimeout</code>
                <code class="literal">socketTimeout</code>. Supported boolean options are: <code class="literal">socketKeepAlive</code>, <code class="literal">autoConnectRetry</code>.
                Supported long option is <code class="literal">maxAutoConnectRetryTime</code>. See <a class="ulink" href="http://api.mongodb.org/java/2.11.4/com/mongodb/MongoClientOptions.html">Mongo documentation</a>
                for details about those options and their default values.
            </p>
            <p>
                Alternatively, you can configure MongoDB using a MongoDB <a class="ulink" href="http://docs.mongodb.org/manual/reference/connection-string/">connection URI</a>.
                In this case, you define all information concerning the connection and authentication within the URI, as described in the MongoDB documentation.
                Please note that the database specified within the URI is only used for authentication. To change the database used by keycloak you have to set
                <code class="literal">db</code> property as before. Therefore, a configuration like the
                following
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"connectionsMongo": {
    "default": {
        "uri": "mongodb://user:password@127.0.0.1/authentication",
        "db": "keycloak"
    }
}
</pre><p>
                will authenticate the user against the authentication database, but store all keycloak related data in the keycloak database.

            </p>
            <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e236"/>3.2.2.1. MongoDB Replica Sets</h4></div></div></div>
                
                <p>
                    In order to use a mongo replica set for Keycloak, one has to use URI based configuration, which supports the
                    definition of replica sets out of the box: <code class="literal">mongodb://host1:27017,host2:27017,host3:27017/</code>.
                </p>
            </div>
        </div>
        
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e240"/>3.2.3. JSON File based model</h3></div></div></div>
            
            <p>
                Keycloak provides a JSON file based model implementation, which means that your identity data will be saved
                in a flat JSON text file instead of traditional RDBMS.  The performance of this implementaion is likely to
                be slower because it reads and writes the entire file with each call to the Keycloak REST API.  But it is 
                very useful in development to see exactly what is being saved.  <span class="emphasis"><em>It is not recommended for 
                production.</em></span>
            </p>
            <p>
                Note that this only applies to realm and user data.  There is currently no file implementation for
                event persistence.  So you will need to use JPA or Mongo for that.
            </p>
            <p>    
                To configure Keycloak to use file persistence open <code class="literal">standalone/configuration/keycloak-server.json</code>
                in your favourite editor.  Change the realm and user providers and disable caching.  Change:

</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"realm": {
    "provider": "jpa"
},

"user": {
    "provider": "jpa"
},
    
"userSessions": {
    "provider" : "mem"
},
    
"realmCache": {
    "provider": "mem"
},

"userCache": {
    "provider": "mem",
    "mem": {
        "maxSize": 20000
    }
},
</pre><p>

                to:

                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"realm": {
    "provider": "file"
},

"user": {
    "provider": "file"
},
                    
"userSessions": {
    "provider" : "mem"
},
                    
"realmCache": {
    "provider": "none"
},

"userCache": {
    "provider": "none",
},
</pre><p>

You can also change the location of the data file by adding a connectionsFile snippet:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"connectionsFile": {
   "default" : {
        "directory": "/mydirectory",
        "fileName": "myfilename.json"
    }
}
</pre><p>

All configuration options are optional. Default value for directory is <code class="literal">${jboss.server.data.dir}</code>. Default file name
                is <code class="literal">keycloak-model.json</code>.
            </p>
        </div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e252"/>3.2.4. Outgoing Server HTTP Requests</h3></div></div></div>
            
            <p>
                Keycloak server needs to invoke on remote HTTP endpoints to do things like backchannel logouts and other
                management functions.  Keycloak maintains a HTTP client connection pool which has various configuration
                settings you can specify before boot time.  This is configured in the
                <code class="literal">standalone/configuration/keycloak-server.json</code>.
                By default the setting is like this:
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    "connectionsHttpClient": {
        "default": {
            "disable-trust-manager": true
        }
    },
</pre><p>
                Possible configuration options are:
                </p><div class="variablelist"><dl><dt><span class="term">establish-connection-timeout-millis</span></dt><dd>
                            <p>
                                Timeout for establishing a socket connection.
                            </p>
                        </dd><dt><span class="term">socket-timeout-millis</span></dt><dd>
                            <p>
                                If an outgoing request does not receive data for this amount of time, timeout the connection.
                            </p>
                        </dd><dt><span class="term">connection-pool-size</span></dt><dd>
                            <p>
                                How many connections can be in the pool.
                            </p>
                        </dd><dt><span class="term">max-pooled-per-route</span></dt><dd>
                            <p>
                                How many connections can be pooled per host.
                            </p>
                        </dd><dt><span class="term">disable-trust-manager</span></dt><dd>
                            <p>
                                If true, HTTPS server certificates are not verified.  If you set this to false, you must
                                configure a truststore.
                            </p>
                        </dd><dt><span class="term">disable-cookies</span></dt><dd>
                            <p>
                                <code class="literal">true</code> by default.  When set to true, this will disable any cookie
                                caching.
                            </p>
                        </dd><dt><span class="term">hostname-verification-policy</span></dt><dd>
                            <p>
                                <code class="literal">WILDCARD</code> by default.  For HTTPS requests, this verifies the hostname
                                of the server's certificate.  <code class="literal">ANY</code> means that the hostname is not verified.
                                <code class="literal">WILDCARD</code> Allows wildcards in subdomain names i.e. *.foo.com.
                                <code class="literal">STRICT</code> CN must match hostname exactly.
                            </p>
                        </dd><dt><span class="term">truststore</span></dt><dd>
                            <p>
                                The value is the file path to a Java keystore file.  If
                                you prefix the path with <code class="literal">classpath:</code>, then the truststore will be obtained
                                from the deployment's classpath instead.
                                HTTPS
                                requests need a way to verify the host of the server they are talking to. This is
                                what the trustore does. The keystore contains one or more trusted
                                host certificates or certificate authorities.
                            </p>
                        </dd><dt><span class="term">truststore-password</span></dt><dd>
                            <p>
                                Password for the truststore keystore.
                                This is
                                <span class="emphasis"><em>REQUIRED</em></span>
                                if
                                <code class="literal">truststore</code>
                                is set.
                            </p>
                        </dd><dt><span class="term">client-keystore</span></dt><dd>
                            <p>
                                This is the file path to a Java keystore file.
                                This keystore contains client certificate for two-way SSL.
                            </p>
                        </dd><dt><span class="term">client-keystore-password</span></dt><dd>
                            <p>
                                Password for the client keystore.
                                This is
                                <span class="emphasis"><em>REQUIRED</em></span>
                                if
                                <code class="literal">client-keystore</code>
                                is set.
                            </p>
                        </dd><dt><span class="term">client-key-password</span></dt><dd>
                            <p>
                                <span class="emphasis"><em>Not supported yet, but we will support in future versions.</em></span>
                                Password for the client's key.
                                This is
                                <span class="emphasis"><em>REQUIRED</em></span>
                                if
                                <code class="literal">client-keystore</code>
                                is set.
                            </p>
                        </dd></dl></div><p>
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="ssl_modes"/>3.2.5. SSL/HTTPS Requirement/Modes</h3></div></div></div>
            
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2>
                <p>
                    Keycloak is not set up by default to handle SSL/HTTPS in either the
                    war distribution or appliance.  It is highly recommended that you either enable SSL on the Keycloak server
                    itself or on a reverse proxy in front of the Keycloak server.
                </p>
            </div>
            <p>
                Keycloak can run out of the box without SSL so long as you stick to private IP addresses like
                localhost, 127.0.0.1, 10.0.x.x, 192.168.x.x, and 172..16.x.x.  If you try to access Keycloak from a
                non-IP adress you will get an error.
            </p>
            <p>
                Keycloak has 3 SSL/HTTPS modes which you can set up in the admin console under the Settings-&gt;Login page
                and the <code class="literal">Require SSL</code> select box.  Each adapter config should mirror this server-side
                setting.  See adapter config section for more details.
                </p><div class="variablelist"><dl><dt><span class="term">external</span></dt><dd>
                            <p>
                                Keycloak can run out of the box without SSL so long as you stick to private IP addresses like
                                localhost, 127.0.0.1, 10.0.x.x, 192.168.x.x, and 172..16.x.x.  If you try to access Keycloak from a
                                non-IP adress you will get an error.
                            </p>
                        </dd><dt><span class="term">none</span></dt><dd>
                            <p>
                                Keycloak does not require SSL.
                            </p>
                        </dd><dt><span class="term">all</span></dt><dd>
                            <p>
                                Keycloak requires SSL for all IP addresses.
                            </p>
                        </dd></dl></div><p>
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e339"/>3.2.6. SSL/HTTPS Setup</h3></div></div></div>
            

            <p>
                First enable SSL on Keycloak or on a reverse proxy in front of Keycloak. Then configure the Keycloak Server to enforce HTTPS connections.
            </p>

            <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e342"/>3.2.6.1. Enable SSL on Keycloak</h4></div></div></div>
                
                <p>
                    The following things need to be done
                    </p><div class="itemizedlist"><ul><li>
                            Generate a self signed or third-party signed certificate and import it into a Java keystore
                            using <code class="literal">keytool</code>.
                        </li><li>
                            Enable Wildfly to use this certificate and turn on SSL/HTTPS.
                        </li></ul></div><p>
                </p>
                <div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e349"/>3.2.6.1.1. Creating the Certificate and Java Keystore</h5></div></div></div>
                    
                    <p>
                        In order to allow HTTPS connections, you need to obtain a self signed or third-party signed certificate
                        and import it into a Java keystore before you can enable HTTPS in the web container you are deploying
                        the Keycloak Server to.
                    </p>
                    <div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d4e352"/>3.2.6.1.1.1. Self Signed Certificate</h6></div></div></div>
                        
                        <p>
                            In development, you will probably not have a third party signed certificate available to test
                            a Keycloak deployment so you'll need to generate a self-signed on.  Generate one is very easy
                            to do with the <code class="literal">keytool</code> utility that comes with the Java jdk.
                        </p>
                        <p>
    </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    $ keytool -genkey -alias localhost -keyalg RSA -keystore keycloak.jks -validity 10950
        Enter keystore password: secret
        Re-enter new password: secret
        What is your first and last name?
        [Unknown]:  localhost
        What is the name of your organizational unit?
        [Unknown]:  Keycloak
        What is the name of your organization?
        [Unknown]:  Red Hat
        What is the name of your City or Locality?
        [Unknown]:  Westford
        What is the name of your State or Province?
        [Unknown]:  MA
        What is the two-letter country code for this unit?
        [Unknown]:  US
        Is CN=localhost, OU=Keycloak, O=Test, L=Westford, ST=MA, C=US correct?
        [no]:  yes
    </pre><p>
                        </p>
                        <p>
                            You should answer <code class="literal">What is your first and last name ?</code> question with
                            the DNS name of the machine you're installing the server on.  For testing purposes,
                            <code class="literal">localhost</code> should be used.  After executing this command, the
                            <code class="literal">keycloak.jks</code> file will be generated in the same directory as you executed
                            the <code class="literal">keytool</code> command in.
                        </p>
                        <p>
                            If you want a third-party signed certificate, but don't have one, you can obtain one for free
                            at <a class="ulink" href="http://cacert.org">cacert.org</a>.  You'll have to do a little set up first
                            before doing this though.
                        </p>
                        <p>
                            The first thing to do is generate a Certificate Request:
    </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    $ keytool -certreq -alias yourdomain -keystore keycloak.jks &gt; keycloak.careq
    </pre><p>
                        </p>
                        <p>
                             Where <code class="literal">yourdomain</code> is a DNS name for which this certificate is generated for.
                             Keytool generates the request:
    </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    -----BEGIN NEW CERTIFICATE REQUEST-----
    MIIC2jCCAcICAQAwZTELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAk1BMREwDwYDVQQHEwhXZXN0Zm9y
    ZDEQMA4GA1UEChMHUmVkIEhhdDEQMA4GA1UECxMHUmVkIEhhdDESMBAGA1UEAxMJbG9jYWxob3N0
    MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAr7kck2TaavlEOGbcpi9c0rncY4HhdzmY
    Ax2nZfq1eZEaIPqI5aTxwQZzzLDK9qbeAd8Ji79HzSqnRDxNYaZu7mAYhFKHgixsolE3o5Yfzbw1
    29Rvy+eUVe+WZxv5oo9wolVVpdSINIMEL2LaFhtX/c1dqiqYVpfnvFshZQaIg2nL8juzZcBjj4as
    H98gIS7khql/dkZKsw9NLvyxgJvp7PaXurX29fNf3ihG+oFrL22oFyV54BWWxXCKU/GPn61EGZGw
    Ft2qSIGLdctpMD1aJR2bcnlhEjZKDksjQZoQ5YMXaAGkcYkG6QkgrocDE2YXDbi7GIdf9MegVJ35
    2DQMpwIDAQABoDAwLgYJKoZIhvcNAQkOMSEwHzAdBgNVHQ4EFgQUQwlZJBA+fjiDdiVzaO9vrE/i
    n2swDQYJKoZIhvcNAQELBQADggEBAC5FRvMkhal3q86tHPBYWBuTtmcSjs4qUm6V6f63frhveWHf
    PzRrI1xH272XUIeBk0gtzWo0nNZnf0mMCtUBbHhhDcG82xolikfqibZijoQZCiGiedVjHJFtniDQ
    9bMDUOXEMQ7gHZg5q6mJfNG9MbMpQaUVEEFvfGEQQxbiFK7hRWU8S23/d80e8nExgQxdJWJ6vd0X
    MzzFK6j4Dj55bJVuM7GFmfdNC52pNOD5vYe47Aqh8oajHX9XTycVtPXl45rrWAH33ftbrS8SrZ2S
    vqIFQeuLL3BaHwpl3t7j2lMWcK1p80laAxEASib/fAwrRHpLHBXRcq6uALUOZl4Alt8=
    -----END NEW CERTIFICATE REQUEST-----
     </pre><p>
                        </p>
                        <p>
                            Send this ca request to your CA.  The CA will issue you a signed certificate and send it to you.
                            Before you import your new cert, you must obtain and import the root certificate of the CA.
                            You can download the cert from CA (ie.: root.crt) and import as follows:
    </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    $ keytool -import -keystore keycloak.jks -file root.crt -alias root
    </pre><p>
                        </p>
                        <p>
                            Last step is import your new CA generated certificate to your keystore:
    </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    $ keytool -import -alias yourdomain -keystore keycloak.jks -file your-certificate.cer
    </pre><p>
                        </p>
                    </div>
                </div>
                <div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e374"/>3.2.6.1.2. Installing the keystore to WildFly</h5></div></div></div>
                    
                    <p>
                        Now that you have a Java keystore with the appropriate certificates, you need to configure your
                        Wildfly installation to use it.  First step is to move the keystore file to a directory
                        you can reference in configuration.  I like to put it in <code class="literal">standalone/configuration</code>.
                        Then you need to edit <code class="literal">standalone/configuration/standalone.xml</code> to enable SSL/HTTPS.
                    </p>
                    <p>
                        To the <code class="literal">security-realms</code> element add:
                        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;security-realm name="UndertowRealm"&gt;
        &lt;server-identities&gt;
            &lt;ssl&gt;
                &lt;keystore path="keycloak.jks" relative-to="jboss.server.config.dir" keystore-password="secret" /&gt;
            &lt;/ssl&gt;
        &lt;/server-identities&gt;
    &lt;/security-realm&gt;</pre><p>
                    </p>
                    <p>
                        Find the element <code class="literal">&lt;server name="default-server"&gt;</code> (it's a child element of <code class="literal">&lt;subsystem xmlns="urn:jboss:domain:undertow:1.0"&gt;</code>) and add:
                        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;https-listener name="https" socket-binding="https" security-realm="UndertowRealm"/&gt;
    </pre><p>
                    </p>
                    <p>
                        Check the <a class="ulink" href="https://docs.jboss.org/author/display/WFLY8/Undertow+(web)+subsystem+configuration">Wildfly Undertow</a> documentation for more information on fine tuning the socket connections.
                    </p>
                </div>
            </div>

            <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e388"/>3.2.6.2. Enable SSL on a Reverse Proxy</h4></div></div></div>
                
                <p>
                    Follow the documentation for your web server to enable SSL and configure reverse proxy for Keycloak.
                    It is important that you make sure the web server sets the <code class="literal">X-Forwarded-For</code> and
                    <code class="literal">X-Forwarded-Proto</code> headers on the requests made to Keycloak. Next you need to enable
                    <code class="literal">proxy-address-forwarding</code> on the Keycloak http connector. Assuming that your reverse
                    proxy doesn't use port 8443 for SSL you also need to configure what port http traffic is redirected to.
                </p>

                <div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e394"/>3.2.6.2.1. Configure WildFly</h5></div></div></div>
                    

                    <p>
                        Open <code class="literal">standalone/configuration/standalone.xml</code> in your favorite editor.
                    </p>

                    <p>
                        First add <code class="literal">proxy-address-forwarding</code> and <code class="literal">redirect-socket</code> to
                        the <code class="literal">http-listener</code> element:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;subsystem xmlns="urn:jboss:domain:undertow:1.1"&gt;
    ...
    &lt;http-listener name="default" socket-binding="http"
        proxy-address-forwarding="true" redirect-socket="proxy-https"/&gt;
    ...
&lt;/subsystem&gt;
</pre><p>
                    </p>
                    <p>
                        Then add a new <code class="literal">socket-binding</code> element to the <code class="literal">socket-binding-group</code> element:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;socket-binding-group name="standard-sockets" default-interface="public"
    port-offset="${jboss.socket.binding.port-offset:0}"&gt;
    ...
    &lt;socket-binding name="proxy-https" port="443"/&gt;
    ...
&lt;/socket-binding-group&gt;
</pre><p>
                    </p>
                    <p>
                        Check the <a class="ulink" href="https://docs.jboss.org/author/display/WFLY8/Undertow+(web)+subsystem+configuration">WildFly</a> documentation for more information.
                    </p>
                </div>
            </div>

        </div>

    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e409"/>3.3. Adding Keycloak server in Domain Mode</h2></div></div></div>
        
        <p>
            In domain mode, you start the server with the "domain" command instead of the "standalone" command.  In this case, the Keycloak subsystem is
            defined in domain/configuration/domain.xml instead of standalone/configuration.standalone.xml.  Inside domain.xml, you will see more than one
            profile.  A Keycloak subsystem can be defined in zero or more of those profiles.
        </p>
        <p>
            To enable Keycloak for a server profile edit domain/configuration/domain.xml. To the <code class="literal">extensions</code>
            element add the Keycloak extension:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;extensions&gt;
    ...
    &lt;extension module="org.keycloak.keycloak-subsystem"/&gt;
&lt;/extensions&gt;
</pre><p>
            Then you need to add the server to the required server profiles. By default WildFly starts two servers
            in the main-server-group which uses the full profile. To add Keycloak for this profile add the Keycloak
            subsystem to the <code class="literal">profile</code> element with <code class="literal">name</code> full:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;profile name="full"&gt;
    ...
    &lt;subsystem xmlns="urn:jboss:domain:keycloak:1.0"&gt;
        &lt;auth-server name="main-auth-server"&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
            &lt;web-context&gt;auth&lt;/web-context&gt;
        &lt;/auth-server&gt;
    &lt;/subsystem&gt;
</pre><p>
        </p>
        <p>
            To configure the server copy <code class="literal">standalone/configuration/keycloak-server.json</code> to
            <code class="literal">domain/servers/&lt;SERVER NAME&gt;/configuration</code>. The configuration should be identical
            for all servers in a group.
        </p>
        <p>
            Follow the <a class="link" href="#clustering" title="Chapter 28. Clustering">Clustering</a> section of the documentation to configure Keycloak
            for clustering. In domain mode it doesn't make much sense to not configure Keycloak in cluster mode.
        </p>
        <p>
            To deploy custom providers and themes you should deploys these as modules and make sure the modules are
            available to all servers in the group. See <a class="link" href="#providers" title="Chapter 4. Providers and SPIs">Providers</a> and
            <a class="link" href="#themes" title="Chapter 10. Themes">Themes</a> sections for more information on how to do this.
        </p>
    </div>
    
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e426"/>3.4. Installing Keycloak Server as Root Context</h2></div></div></div>
        
        <p>
            The Keycloak server can be installed as the default web application.  In doing so, the server can be referenced at <code class="literal">http://mydomain.com/</code> instead of <code class="literal">http://mydomain.com/auth</code>.
        </p>
        <p>
            To do this, add the <code class="literal">default-web-module</code> attribute in the Undertow subystem in standalone.xml.
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;subsystem xmlns="urn:jboss:domain:undertow:2.0"&gt;
            &lt;server name="default-server"&gt;
                &lt;host name="default-host" alias="localhost" default-web-module="keycloak-server.war"&gt;
                    &lt;location name="/" handler="welcome-content"/&gt;
                &lt;/host&gt;
</pre><p>
        </p>
        <p>
            <code class="literal">keycloak-server.war</code> is the runtime name of the Keycloak server application. Note that the WAR file does not exist as a file. If its name changes (ie. <code class="literal">keycloak-server.war</code>) in the future, find its new name from the Keycloak log entry with <code class="literal">runtime-name:</code>.
        </p>
        <p>
             </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2>
                 If you have run your server before altering the root context, your database
                 will contain references to the old /auth context. Your clients may also have incorrect
                 references.  To fix this on the server side, you will need to <a class="link" href="#export-import" title="Chapter 23. Export and Import">export 
                 your database to json, make corrections, and then import.</a>  Client-side keycloak.json 
                 files will need to be updated manually as well.
             </div><p>
        </p>
        
    </div>
</div>

    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="providers"/>Chapter 4. Providers and SPIs</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e444">4.1. Implementing a SPI</a></span></dt><dt><span class="section"><a href="#d4e455">4.2. Registering provider implementations</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e458">4.2.1. Register a provider using Modules</a></span></dt><dt><span class="section"><a href="#d4e469">4.2.2. Register a provider using file-system</a></span></dt><dt><span class="section"><a href="#d4e476">4.2.3. Configuring a provider</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e482">4.3. Available SPIs</a></span></dt></dl></div>
    

    <p>
        Keycloak is designed to cover most use-cases without requiring custom code, but we also want it to be
        customizable. To achive this Keycloak has a number of SPIs which you can implement your own providers for.
    </p>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e444"/>4.1. Implementing a SPI</h2></div></div></div>
        
        <p>
            To implement an SPI you need to implement it's ProviderFactory and Provider interfaces. You also need to
            create a provider-configuration file. For example to implement the Event Listener SPI you need to implement
            EventListenerProviderFactory and EventListenerProvider and also provide the file
            <code class="literal">META-INF/services/org.keycloak.events.EventListenerProviderFactory</code>
        </p>
        <p>
            For example to implement the Event Listener SPI you start by implementing EventListenerProviderFactory:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">{
package org.acme.provider;

import ...

public class MyEventListenerProviderFactory implements EventListenerProviderFactory {

    private List&lt;Event&gt; events;

    public String getId() {
        return "my-event-listener";
    }

    public void init(Config.Scope config) {
        int max = config.getInt("max");
        events = new MaxList(max);
    }

    public EventListenerProvider create(KeycloakSession session) {
        return new MyEventListenerProvider(events);
    }

    public void close() {
        events = null;
    }

}
}</pre><p>
            The example uses an imagined MaxList which has a maximum size and is concurrency safe. When the maximum size is reached
            and new entries are added the oldest entry is removed. Keycloak creates a single instance of
            EventListenerProviderFactory which makes it possible to store state for multiple requests. EventListenerProvider
            instances are created by calling create on the factory for each requests so these should be light-weight.
        </p>
        <p>
            Next you would implement EventListenerProvider:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">{
package org.acme.provider;

import ...

public class MyEventListenerProvider implements EventListenerProvider {

    private List&lt;Event&gt; events;

    public MyEventListenerProvider(List&lt;Event&gt; events) {
        this.events = events;
    }

    @Override
    public void onEvent(Event event) {
        events.add(event);
    }

    @Override
    public void close() {

    }

}
}</pre><p>
        </p>
        <p>
            The file <code class="literal">META-INF/services/org.keycloak.events.EventListenerProviderFactory</code> should
            contain the full name of your ProviderFactory implementation:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">org.acme.provider.MyEventListenerProviderFactory</pre><p>
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e455"/>4.2. Registering provider implementations</h2></div></div></div>
        
        <p>
            Keycloak can load provider implementations from JBoss Modules or directly from the file-system. Using Modules
            is recommended as you can control exactly what classes are available to your provider. Any providers loaded
            from the file-system uses a classloader with the Keycloak classloader as its parent.
        </p>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e458"/>4.2.1. Register a provider using Modules</h3></div></div></div>
            
            <p>
                To register a provider using Modules first create a module. To do this you can either use the jboss-cli
                script or manually create a folder inside KEYCLOAK_HOME/modules and add your jar and a <code class="literal">module.xml</code>.
                For example to add the event listener sysout example provider using the jboss-cli script execute:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">{
    KEYCLOAK_HOME/bin/jboss-cli.sh --command="module add --name=org.keycloak.examples.event-sysout --resources=target/event-listener-sysout-example.jar --dependencies=org.keycloak.keycloak-core,org.keycloak.keycloak-model-api,org.keycloak.keycloak-events-api"
}</pre><p>
                Or to manually create it start by creating the folder <code class="literal">KEYCLOAK_HOME/modules/org/keycloak/examples/event-sysout/main</code>.
                Then copy <code class="literal">event-listener-sysout-example.jar</code> to this folder and create <code class="literal">module.xml</code>
                with the following content:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">{
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;module xmlns="urn:jboss:module:1.1" name="org.keycloak.examples.event-sysout"&gt;
    &lt;resources&gt;
        &lt;resource-root path="event-listener-sysout-example.jar"/&gt;
    &lt;/resources&gt;
    &lt;dependencies&gt;
        &lt;module name="org.keycloak.keycloak-core"/&gt;
        &lt;module name="org.keycloak.keycloak-model-api"/&gt;
        &lt;module name="org.keycloak.keycloak-events-api"/&gt;
    &lt;/dependencies&gt;
&lt;/module&gt;
}</pre><p>
            </p>
            <p>
                Once you've created the module you need to register this module with Keycloak. This is done by editing
                keycloak-server.json and adding it to the providers:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">{
    "providers": [
        ...
        "module:org.keycloak.examples.event-sysout"
    ]
}</pre><p>
            </p>
        </div>


        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e469"/>4.2.2. Register a provider using file-system</h3></div></div></div>
            
            <p>
                To register your provider simply copy the JAR including the ProviderFactory and Provider classes and the
                provider configuration file to <code class="literal">standalone/configuration/providers</code>.
            </p>
            <p>
                You can also define multiple provider class-path if you want to create isolated class-loaders. To do this
                edit keycloak-server.json and add more classpath entries to the providers array. For example:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">{
    "providers": [
        "classpath:provider1.jar;lib-v1.jar",
        "classpath:provider2.jar;lib-v2.jar"
    ]
}</pre><p>
                The above example will create two separate class-loaders for providers. The classpath entries follow the
                same syntax as Java classpath, with ';' separating multiple-entries. Wildcard is also supported allowing
                loading all jars (files with .jar or .JAR extension) in a folder, for example:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">{
    "providers": [
        "classpath:/home/user/providers/*"
    ]
}</pre><p>
            </p>
        </div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e476"/>4.2.3. Configuring a provider</h3></div></div></div>
            
            <p>
                You can pass configuration options to your provider by setting them in <code class="literal">keycloak-server.json</code>.
                For example to set the max value for <code class="literal">my-event-listener</code> add:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">{
    "eventsListener": {
        "my-event-listener": {
            "max": 100
        }
    }
}</pre><p>
            </p>
        </div>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e482"/>4.3. Available SPIs</h2></div></div></div>
        
        <p>
            Here's a list of the available SPIs and a brief description. For more details on each SPI refer to
            individual
            sections.
            </p><div class="variablelist"><dl><dt><span class="term">Account</span></dt><dd>
                        Provides the account manage console pages. The default implementation uses FreeMarker templates.
                    </dd><dt><span class="term">Connections Infinispan</span></dt><dd>
                        Loads and configures Infinispan connections. The default implementation can load connections
                        from
                        the Infinispan subsystem, or alternatively can be manually configured in keycloak-server.json.
                    </dd><dt><span class="term">Connections Jpa</span></dt><dd>
                        Loads and configures Jpa connections. The default implementation can load datasources
                        from
                        WildFly/EAP, or alternatively can be manually configured in keycloak-server.json.
                    </dd><dt><span class="term">Connections Jpa Updater</span></dt><dd>
                        Updates database schema. The default implementation uses Liquibase.
                    </dd><dt><span class="term">Connections Mongo</span></dt><dd>
                        Loads and configures MongoDB connections. The default implementation is configured in
                        keycloak-server.json.
                    </dd><dt><span class="term">Email</span></dt><dd>
                        Formats and sends email. The default implementation uses FreeMarker templates and JavaMail.
                    </dd><dt><span class="term">Events Listener</span></dt><dd>
                        Listen to user related events for example user login success and failures. Keycloak provides two
                        implementations out of box. One that logs events to the server log and another that can send
                        email
                        notifications to users on certain events.
                    </dd><dt><span class="term">Events Store</span></dt><dd>
                        Store user related events so they can be viewed through the admin console and account management
                        console.
                        Keycloak provides implementations for Relational Databases and MongoDB.
                    </dd><dt><span class="term">Export</span></dt><dd>
                        Exports the Keycloak database. Keycloak provides implementations that export to JSON files
                        either
                        as a single file, multiple files in a directory or a encrypted ZIP archive.
                    </dd><dt><span class="term">Import</span></dt><dd>
                        Imports an exported Keycloak database. Keycloak provides implementations that import from JSON
                        files either
                        as a single file, multiple files in a directory or a encrypted ZIP archive.
                    </dd><dt><span class="term">Login</span></dt><dd>
                        Provides the login pages. The default implementation uses FreeMarker templates.
                    </dd><dt><span class="term">Login Protocol</span></dt><dd>
                        Provides protocols. Keycloak provides implementations of OpenID Connect and SAML 2.0.
                    </dd><dt><span class="term">Realm</span></dt><dd>
                        Provides realm and application meta-data. Keycloak provides implementations for Relational
                        Databases
                        and MongoDB.
                    </dd><dt><span class="term">Realm Cache</span></dt><dd>
                        Caches realm and application meta-data to improve performance. Keycloak provides a basic
                        in-memory
                        cache and a Infinispan cache.
                    </dd><dt><span class="term">Theme</span></dt><dd>
                        Allows creating themes to customize look and feel. Keycloak provides implementations that can
                        load
                        themes from the file-system or classpath.
                    </dd><dt><span class="term">Timer</span></dt><dd>
                        Executes scheduled tasks. Keycloak provides a basic implementation based on java.util.Timer.
                    </dd><dt><span class="term">User</span></dt><dd>
                        Provides users and role-mappings. Keycloak provides implementations for Relational Databases
                        and MongoDB.
                    </dd><dt><span class="term">User Cache</span></dt><dd>
                        Caches users and role-mappings to improve performance. Keycloak provides a basic in-memory
                        cache and a Infinispan cache.
                    </dd><dt><span class="term">User Federation</span></dt><dd>
                        Support syncing users from an external source. Keycloak provides implementations for LDAP and
                        Active Directory.
                    </dd><dt><span class="term">User Sessions</span></dt><dd>
                        Provides users session information. Keycloak provides implementations for basic in-memory,
                        Infinispan,
                        Relational Databases and MongoDB
                    </dd></dl></div><p>
        </p>
    </div>
</div>

    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="openshift"/>Chapter 5. Running Keycloak Server on OpenShift</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e553">5.1. Create Keycloak instance with the web tool</a></span></dt><dt><span class="section"><a href="#d4e566">5.2. Create Keycloak instance with the command-line tool</a></span></dt><dt><span class="section"><a href="#d4e573">5.3. Next steps</a></span></dt></dl></div>
    

    <p>
        Keycloak provides a OpenShift cartridge to make it easy to get it running on OpenShift. If you don't already
        have
        an account or don't know how to create applications go to
        <a class="ulink" href="https://www.openshift.com/">https://www.openshift.com/</a>
        first. You can
        create the Keycloak instance either with the web tool or the command line tool, both approaches are described
        below.
    </p>

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2>
        <p>
            It's important that immediately after creating a Keycloak instance you open the <code class="literal">Administration Console</code>
            and login to reset the password. If this is not done anyone can easily gain admin rights to your Keycloak instance.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e553"/>5.1. Create Keycloak instance with the web tool</h2></div></div></div>
        
        <p>
            Open
            <a class="ulink" href="https://openshift.redhat.com/app/console/applications">https://openshift.redhat.com/app/console/applications</a>
            and click on <code class="literal">Add Application</code>.
            Scroll down to the bottom of the page to find the
            <code class="literal">Code Anything</code>
            section. Insert
            <code class="literal">http://cartreflect-claytondev.rhcloud.com/github/keycloak/openshift-keycloak-cartridge</code>
            into the
            <code class="literal">URL to a cartridge definition</code>
            field and click on <code class="literal">Next</code>. Fill in the
            following form and click on <code class="literal">Create Application</code>.
        </p>
        <p>
            Click on <code class="literal">Continue to the application overview page</code>. Under the list of applications you should
            find your Keycloak instance and the status should be <code class="literal">Started</code>. Click on it to open the Keycloak
            servers homepage.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e566"/>5.2. Create Keycloak instance with the command-line tool</h2></div></div></div>
        
        <p>
            Run the following command from a terminal:
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">rhc app create &lt;APPLICATION NAME&gt; http://cartreflect-claytondev.rhcloud.com/github/keycloak/openshift-keycloak-cartridge</pre><p>
            Replace <code class="literal">&lt;APPLICATION NAME&gt;</code> with the name you want (for example keycloak).
        </p>
        <p>
            Once the instance is created the rhc tool outputs details about it. Open the returned <code class="literal">URL</code> in a
            browser to open the Keycloak servers homepage.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e573"/>5.3. Next steps</h2></div></div></div>
        
        <p>
            The Keycloak servers homepage shows the Keycloak logo and <code class="literal">Welcome to Keycloak</code>.
            There is also a link to the <code class="literal">Administration Console</code>. Open that and log in using username
            <code class="literal">admin</code> and password <code class="literal">admin</code>. On the first login you are required to change the password.
        </p>
        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2>
            <p>
                On OpenShift Keycloak has been configured to only accept requests over https. If you try to use http
                you will be redirected to https.
            </p>
        </div>
    </div>
</div>

    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="admin-permissions"/>Chapter 6. Master Admin Access Control</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e590">6.1. Global Roles</a></span></dt><dt><span class="section"><a href="#d4e604">6.2. Realm Specific Roles</a></span></dt></dl></div>
    
    <p>
        You can create and manage multiple realms by logging into the <code class="literal">master</code> Keycloak admin console
        at <code class="literal">/{keycloak-root}/admin/index.html</code>
    </p>
    <p>
        Users in the Keycloak <code class="literal">master</code> realm can be granted permission to manage zero or more realms that are
        deployed on the Keycloak server.  When a realm is created, Keycloak automatically creates various roles that grant fine-grain
        permissions to access that new realm.
        Access to The Admin Console and REST endpoints can be controlled by mapping these roles to users in the <code class="literal">master</code> realm.
        It's possible to create multiple super users as well as users that have only access to certain operations in specific realms.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e590"/>6.1. Global Roles</h2></div></div></div>
        
        <p>
            There are two realm roles in the <code class="literal">master</code> realm. These are:
            </p><div class="itemizedlist"><ul><li>
                    <code class="literal">admin</code> - This is the super-user role and grants permissions to all operations on all realms
                </li><li>
                    <code class="literal">create-realm</code> - This grants the user permission to create new realms. A user that creates a realm is granted all permissions to the newly created realm.
                </li></ul></div><p>
        </p>
        <p>
            To add these roles to a user select the <code class="literal">master</code> realm, then click on <code class="literal">Users</code>.
            Find the user you want to grant permissions to, open the user and click on <code class="literal">Role Mappings</code>. Under
            <code class="literal">Realm Roles</code> assign any of the above roles to the user by selecting it and clicking on the right-arrow.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e604"/>6.2. Realm Specific Roles</h2></div></div></div>
        
        <p>
            Each realm in Keycloak is represented by an application in the <code class="literal">master</code> realm. The name of the application
            is <code class="literal">&lt;realm name&gt;-realm</code>. This allows assigning access to users for individual realms. The
            roles available are:
            </p><div class="itemizedlist"><ul><li>
                    <code class="literal">view-realm</code> - View the realm configuration
                </li><li>
                    <code class="literal">view-users</code> - View users (including details for specific user) in the realm
                </li><li>
                    <code class="literal">view-applications</code> - View applications in the realm
                </li><li>
                    <code class="literal">view-clients</code> - View clients in the realm
                </li><li>
                    <code class="literal">view-events</code> - View events in the realm
                </li><li>
                    <code class="literal">manage-realm</code> - Modify the realm configuration (and delete the realm)
                </li><li>
                    <code class="literal">manage-users</code> - Create, modify and delete users in the realm
                </li><li>
                    <code class="literal">manage-applications</code> - Create, modify and delete applications in the realm
                </li><li>
                    <code class="literal">manage-clients</code> - Create, modify and delete clients in the realm
                </li><li>
                    <code class="literal">manage-events</code> - Enable/disable events, clear logged events and manage event listeners
                </li></ul></div><p>
            Manage roles includes permissions to view (for example a user with manage-realm role can also view the realm configuration).
        </p>
        <p>
            To add these roles to a user select the <code class="literal">master</code> realm, then click on <code class="literal">Users</code>.
            Find the user you want to grant permissions to, open the user and click on <code class="literal">Role Mappings</code>. Under
            <code class="literal">Application Roles</code> select the application that represents the realm you're adding permissions to
            (<code class="literal">&lt;realm name&gt;-realm</code>), then assign any of the above roles to the user by selecting it and clicking on the right-arrow.
        </p>
    </div>
</div>

    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="per-realm-admin-permissions"/>Chapter 7. Per Realm Admin Access Control</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e642">7.1. Realm Roles</a></span></dt></dl></div>
    
    <p>
        Administering your realm through the <code class="literal">master</code> realm as discussed in <a class="xref" href="#admin-permissions" title="Chapter 6. Master Admin Access Control">Chapter 6, <i>Master Admin Access Control</i></a> may not always be
        ideal or feasible.  For example, maybe you have more than one admin application that manages various admin aspects of your organization
        and you want to unify all these different "admin consoles" under one realm so you can do SSO between them.  Keycloak allows you to
        grant realm admin privileges to users within that realm.  These realm admins can participate in SSO for that realm and
        visit a keycloak admin console instance that is dedicated solely for that realm by going to the url:
        <code class="literal">/{keycloak-root}/admin/{realm}/console</code>
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e642"/>7.1. Realm Roles</h2></div></div></div>
        
        <p>
            Each realm has a built-in application called <code class="literal">realm-management</code>.  This application defines
            roles that define permissions that can be granted to manage the realm.
            </p><div class="itemizedlist"><ul><li>
                    <code class="literal">realm-admin</code> - This is a composite role that grants all admin privileges for managing
                    security for that realm.
                </li></ul></div><p>
            These are more fine-grain roles you can assign to the user.

            </p><div class="itemizedlist"><ul><li>
                    <code class="literal">view-realm</code> - View the realm configuration
                </li><li>
                    <code class="literal">view-users</code> - View users (including details for specific user) in the realm
                </li><li>
                    <code class="literal">view-applications</code> - View applications in the realm
                </li><li>
                    <code class="literal">view-clients</code> - View clients in the realm
                </li><li>
                    <code class="literal">view-events</code> - View events in the realm
                </li><li>
                    <code class="literal">manage-realm</code> - Modify the realm configuration (and delete the realm)
                </li><li>
                    <code class="literal">manage-users</code> - Create, modify and delete users in the realm
                </li><li>
                    <code class="literal">manage-applications</code> - Create, modify and delete applications in the realm
                </li><li>
                    <code class="literal">manage-clients</code> - Create, modify and delete clients in the realm
                </li><li>
                    <code class="literal">manage-events</code> - Enable/disable events, clear logged events and manage event listeners
                </li></ul></div><p>
            Manage roles includes permissions to view (for example a user with manage-realm role can also view the realm configuration).
        </p>
        <p>
            To add these roles to a user select the realm you want. Then click on <code class="literal">Users</code>.
            Find the user you want to grant permissions to, open the user and click on <code class="literal">Role Mappings</code>. Under
            <code class="literal">Application Roles</code> select <code class="literal">realm-management</code>, then assign any of the above roles to the user by selecting it and clicking on the right-arrow.
        </p>
    </div>
</div>

    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e675"/>Chapter 8. Adapters</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#adapter-config">8.1. General Adapter Config</a></span></dt><dt><span class="section"><a href="#jboss-adapter">8.2. JBoss/Wildfly Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#jboss-adapter-installation">8.2.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="#d4e910">8.2.2. Required Per WAR Configuration</a></span></dt><dt><span class="section"><a href="#d4e923">8.2.3. Securing WARs via Keycloak Subsystem</a></span></dt></dl></dd><dt><span class="section"><a href="#tomcat-adapter">8.3. Tomcat 6, 7 and 8 Adapters</a></span></dt><dd><dl><dt><span class="section"><a href="#tomcat-adapter-installation">8.3.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="#d4e958">8.3.2. Required Per WAR Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#jetty9-adapter">8.4. Jetty 9.x Adapters</a></span></dt><dd><dl><dt><span class="section"><a href="#jetty9-adapter-installation">8.4.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="#jetty9_per_war">8.4.2. Required Per WAR Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#jetty8-adapter">8.5. Jetty 8.1.x Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#jetty8-adapter-installation">8.5.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="#d4e1020">8.5.2. Required Per WAR Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1024">8.6. Java Servlet Filter Adapter</a></span></dt><dt><span class="section"><a href="#fuse-adapter">8.7. JBoss Fuse and Apache Karaf Adapter</a></span></dt><dt><span class="section"><a href="#javascript-adapter">8.8. Javascript Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e1100">8.8.1. Session status iframe</a></span></dt><dt><span class="section"><a href="#d4e1105">8.8.2. Older browsers</a></span></dt><dt><span class="section"><a href="#d4e1113">8.8.3. JavaScript Adapter reference</a></span></dt></dl></dd><dt><span class="section"><a href="#spring-boot-adapter">8.9. Spring Boot Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#spring-boot-adapter-installation">8.9.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="#spring-boot-adapter-configuration">8.9.2. Required Spring Boot Adapter Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#spring-security-adapter">8.10. Spring Security Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e1243">8.10.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="#d4e1248">8.10.2. Spring Security Configuration</a></span></dt><dt><span class="section"><a href="#d4e1267">8.10.3. Naming Security Roles</a></span></dt><dt><span class="section"><a href="#d4e1273">8.10.4. Client to Client Support</a></span></dt><dt><span class="section"><a href="#d4e1285">8.10.5. Spring Boot Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#installed-applications">8.11. Installed Applications</a></span></dt><dd><dl><dt><span class="section"><a href="#installed-applications-url">8.11.1. http://localhost</a></span></dt><dt><span class="section"><a href="#installed-applications-urn">8.11.2. urn:ietf:wg:oauth:2.0:oob</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1302">8.12. Logout</a></span></dt><dt><span class="section"><a href="#multi_tenancy">8.13. Multi Tenancy</a></span></dt><dt><span class="section"><a href="#jaas-adapter">8.14. JAAS plugin</a></span></dt></dl></div>
        
        <p>
            Keycloak can secure a wide variety of application types. This section defines which application
            types are supported and how to configure and install them so that you can use Keycloak to secure
            your applications.
        </p>
        <p>
            These client adapters use an extension of the OpenID Connect protocol (a derivate of OAuth 2.0).
            This extension provides support for clustering, backchannel logout, and other non-standard adminstrative functions.
            The Keycloak project also provides a separate, standalone, generic, SAML client adapter.  But that is describe in a separate
            document and has a different download.
        </p>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="adapter-config"/>8.1. General Adapter Config</h2></div></div></div>
    
    <p>
        Each adapter supported by Keycloak can be configured by a simple JSON text file.  This is what one might
        look like:
    </p>
    <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">{
  "realm" : "demo",
  "resource" : "customer-portal",
  "realm-public-key" : "MIGfMA0GCSqGSIb3D...31LwIDAQAB",
  "auth-server-url" : "https://localhost:8443/auth",
  "ssl-required" : "external",
  "use-resource-role-mappings" : false,
  "enable-cors" : true,
  "cors-max-age" : 1000,
  "cors-allowed-methods" : "POST, PUT, DELETE, GET",
  "bearer-only" : false,
  "enable-basic-auth" : false,
  "expose-token" : true,
   "credentials" : {
      "secret" : "234234-234234-234234"
   },

   "connection-pool-size" : 20,
   "disable-trust-manager": false,
   "allow-any-hostname" : false,
   "truststore" : "path/to/truststore.jks",
   "truststore-password" : "geheim",
   "client-keystore" : "path/to/client-keystore.jks",
   "client-keystore-password" : "geheim",
   "client-key-password" : "geheim"
}

</pre><p>
    </p>
    <p>
        Some of these configuration switches may be adapter specific and some are common across all adapters.
        For Java adapters you can use <code class="literal">${...}</code> enclosure as System property replacement.
        For example <code class="literal">${jboss.server.config.dir}</code>.  Also, you can obtain a template
        for this config file from the admin console.  Go to the realm and select the application you want a template for.
        Go to the <code class="literal">Installation</code> tab and this will provide you with a template that includes
        the public key of the realm.
    </p>
    <p>
        Here is a description of each item:
    </p>
    <p>
        </p><div class="variablelist"><dl><dt><span class="term">realm</span></dt><dd>
                    <p>
                        Name of the realm representing the users of your distributed applications and services.
                        This is
                        <span class="emphasis"><em>REQUIRED.</em></span>
                    </p>
                </dd><dt><span class="term">resource</span></dt><dd>
                    <p>
                        Username of the application. Each application has a username that is used when the
                        application connects with the Keycloak server to turn an access code into an access token
                        (part of the OAuth 2.0 protocol). This is
                        <span class="emphasis"><em>REQUIRED.</em></span>
                    </p>
                </dd><dt><span class="term">realm-public-key</span></dt><dd>
                    <p>
                        PEM format of public key. You can obtain this from the administration console.
                        This is
                        <span class="emphasis"><em>REQUIRED.</em></span>
                    </p>
                </dd><dt><span class="term">auth-server-url</span></dt><dd>
                    <p>
                        The base URL of the Keycloak Server.  All other Keycloak pages and REST services are derived
                        from this.  It is usually of the form <code class="literal">https://host:port/auth</code>
                        This is
                        <span class="emphasis"><em>REQUIRED.</em></span>
                    </p>
                </dd><dt><span class="term">ssl-required</span></dt><dd>
                    <p>
                        Ensures that all communication to and from the Keycloak server from the adapter is over HTTPS.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. The default value is
                        <span class="emphasis"><em>external</em></span>
                        meaning that HTTPS is required by default for external requests. Valid values are 'all', 'external'
                        and 'none'.
                    </p>
                </dd><dt><span class="term">use-resource-role-mappings</span></dt><dd>
                    <p>
                        If set to true, the adapter will look inside the token for application level role mappings for
                        the
                        user. If false, it will look at the realm level for user role mappings.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. The default value is <span class="emphasis"><em>false</em></span>.
                    </p>
                </dd><dt><span class="term">public-client</span></dt><dd>
                    <p>
                        If set to true, the adapter will not send credentials for the client to Keycloak.
                        The default value is <span class="emphasis"><em>false</em></span>.
                    </p>
                </dd><dt><span class="term">enable-cors</span></dt><dd>
                    <p>
                        This enables CORS support. It will handle CORS preflight requests. It will also look into
                        the access token to determine valid origins.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. The default value is <span class="emphasis"><em>false</em></span>.
                    </p>
                </dd><dt><span class="term">cors-max-age</span></dt><dd>
                    <p>
                        If CORS is enabled, this sets the value of the
                        <code class="literal">Access-Control-Max-Age</code>
                        header.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. If not set, this header is not returned in CORS
                        responses.
                    </p>
                </dd><dt><span class="term">cors-allowed-methods</span></dt><dd>
                    <p>
                        If CORS is enabled, this sets the value of the
                        <code class="literal">Access-Control-Allow-Methods</code>
                        header. This should be a comma-separated string.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. If not set, this header is not returned in CORS
                        responses.
                    </p>
                </dd><dt><span class="term">cors-allowed-headers</span></dt><dd>
                    <p>
                        If CORS is enabled, this sets the value of the
                        <code class="literal">Access-Control-Allow-Headers</code>
                        header. This should be a comma-separated string.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. If not set, this header is not returned in CORS
                        responses.
                    </p>
                </dd><dt><span class="term">bearer-only</span></dt><dd>
                    <p>
                        This tells the adapter to only do bearer token authentication. That is, it will not do
                        OAuth 2.0 redirects, but only accept bearer tokens through the
                        <code class="literal">Authorization</code>
                        header.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. The default value is <span class="emphasis"><em>false</em></span>.
                    </p>
                </dd><dt><span class="term">enable-basic-auth</span></dt><dd>
                    <p>
                        This tells the adapter to also support basic authentication. If this option is enabled,
                        then <span class="emphasis"><em>secret</em></span> must also be provided.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. The default value is <span class="emphasis"><em>false</em></span>.
                    </p>
                </dd><dt><span class="term">expose-token</span></dt><dd>
                    <p>
                        If <code class="literal">true</code>, an authenticated browser client (via a Javascript HTTP invocation)
                        can obtain the signed access token via the URL <code class="literal">root/k_query_bearer_token</code>.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. The default value is <span class="emphasis"><em>false</em></span>.
                    </p>
                </dd><dt><span class="term">credentials</span></dt><dd>
                    <p>
                        Specify the credentials of the application. This is an object notation where the key
                        is the credential type and the value is the value of the credential type. Currently only
                        <code class="literal">password</code>
                        is supported.
                        This is <span class="emphasis"><em>REQUIRED</em></span>.
                    </p>
                </dd><dt><span class="term">connection-pool-size</span></dt><dd>
                    <p>
                        Adapters will make separate HTTP invocations to the Keycloak Server to turn an access code
                        into an access token.  This config option defines how many connections to the Keycloak Server
                        should be pooled.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>.  The default value is <code class="literal">20</code>.
                    </p>
                </dd><dt><span class="term">disable-trust-manager</span></dt><dd>
                    <p>
                        If the Keycloak Server requires HTTPS and this config option is set to <code class="literal">true</code>
                        you do not have to specify a truststore.  While convenient,  this setting is not recommended
                        as you will not be verifying the host name of the Keycloak Server.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>.  The default value is <code class="literal">false</code>.
                    </p>
                </dd><dt><span class="term">allow-any-hostname</span></dt><dd>
                    <p>
                        If the Keycloak Server requires HTTPS and this config option is set to <code class="literal">true</code>
                        the Keycloak Server's certificate is validated via the truststore, but host name validation is
                        not done.  This is not a recommended.  This seting may be useful in test environments
                        This is <span class="emphasis"><em>OPTIONAL</em></span>.  The default value is <code class="literal">false</code>.
                    </p>
                </dd><dt><span class="term">truststore</span></dt><dd>
                    <p>
                        This setting is for Java adapters. The value is the file path to a Java keystore file.  If
                        you prefix the path with <code class="literal">classpath:</code>, then the truststore will be obtained
                        from the deployment's classpath instead.
                        Used for outgoing HTTPS communications to the Keycloak server. Client making HTTPS
                        requests need a way to verify the host of the server they are talking to. This is
                        what the trustore does. The keystore contains one or more trusted
                        host certificates or certificate authorities. You can
                        create this truststore by extracting the public certificate of the Keycloak server's SSL
                        keystore.
                        This is
                        <span class="emphasis"><em>OPTIONAL</em></span>
                        if
                        <code class="literal">ssl-required</code>
                        is
                        <code class="literal">none</code>
                        or
                        <code class="literal">disable-trust-manager</code>
                        is <code class="literal">true</code>.
                    </p>
                </dd><dt><span class="term">truststore-password</span></dt><dd>
                    <p>
                        Password for the truststore keystore.
                        This is
                        <span class="emphasis"><em>REQUIRED</em></span>
                        if
                        <code class="literal">truststore</code>
                        is set.
                    </p>
                </dd><dt><span class="term">client-keystore</span></dt><dd>
                    <p>
                        <span class="emphasis"><em>Not supported yet, but we will support in future versions.</em></span>

                        This setting is for Java adapters. This is the file path to a Java keystore file.
                        This keystore contains client certificate for two-way SSL when the adapter makes
                        HTTPS requests to the Keycloak server.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>.
                    </p>
                </dd><dt><span class="term">client-keystore-password</span></dt><dd>
                    <p>
                        <span class="emphasis"><em>Not supported yet, but we will support in future versions.</em></span>
                        Password for the client keystore.
                        This is
                        <span class="emphasis"><em>REQUIRED</em></span>
                        if
                        <code class="literal">client-keystore</code>
                        is set.
                    </p>
                </dd><dt><span class="term">client-key-password</span></dt><dd>
                    <p>
                        <span class="emphasis"><em>Not supported yet, but we will support in future versions.</em></span>
                        Password for the client's key.
                        This is
                        <span class="emphasis"><em>REQUIRED</em></span>
                        if
                        <code class="literal">client-keystore</code>
                        is set.
                    </p>
                </dd><dt><span class="term">auth-server-url-for-backend-requests</span></dt><dd>
                    <p>
                        Alternative location of auth-server-url used just for backend requests. It must be absolute URI. Useful
                        especially in cluster (see <a class="link" href="#relative-uri-optimization" title="29.2. Relative URI optimization">Relative URI Optimization</a>) or if you would like to use <span class="emphasis"><em>https</em></span> for browser requests
                        but stick with <span class="emphasis"><em>http</em></span> for backend requests etc.
                    </p>
                </dd><dt><span class="term">always-refresh-token</span></dt><dd>
                    <p>
                        If <span class="emphasis"><em>true</em></span>, Keycloak will refresh token in every request. More info in <a class="link" href="#refresh-token-each-req" title="29.5. Refresh token in each request">Refresh token in each request</a> .
                    </p>
                </dd><dt><span class="term">register-node-at-startup</span></dt><dd>
                    <p>
                        If <span class="emphasis"><em>true</em></span>, then adapter will send registration request to Keycloak. It's <span class="emphasis"><em>false</em></span>
                        by default and useful just in cluster (See <a class="link" href="#registration-app-nodes" title="29.4. Registration of application nodes to Keycloak">Registration of application nodes to Keycloak</a>)
                    </p>
                </dd><dt><span class="term">register-node-period</span></dt><dd>
                    <p>
                        Period for re-registration adapter to Keycloak. Useful in cluster. See <a class="link" href="#registration-app-nodes" title="29.4. Registration of application nodes to Keycloak">Registration of application nodes to Keycloak</a> for details.
                    </p>
                </dd><dt><span class="term">token-store</span></dt><dd>
                    <p>
                        Possible values are <span class="emphasis"><em>session</em></span> and <span class="emphasis"><em>cookie</em></span>. Default is <span class="emphasis"><em>session</em></span>,
                        which means that adapter stores account info in HTTP Session. Alternative <span class="emphasis"><em>cookie</em></span> means storage of info in cookie.
                        See <a class="link" href="#stateless-token-store" title="29.1. Stateless token store">Stateless token store</a> for details.
                    </p>
                </dd><dt><span class="term">principal-attribute</span></dt><dd>
                    <p>
                        OpenID Connection ID Token attribute to populate the UserPrincipal name with.  If token attribute is null, defaults to <code class="literal">sub</code>.
                        Possible values are <code class="literal">sub</code>, <code class="literal">preferred_username</code>, <code class="literal">email</code>, <code class="literal">name</code>, <code class="literal">nickname</code>, <code class="literal">given_name</code>, <code class="literal">family_name</code>.
                    </p>
                </dd></dl></div><p>
    </p>
</div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="jboss-adapter"/>8.2. JBoss/Wildfly Adapter</h2></div></div></div>
    
    <p>
        To be able to secure WAR apps deployed on JBoss AS 7.1.1, JBoss EAP 6.x, or Wildfly, you must install and
        configure the Keycloak Subsystem.  You then have two options to secure your WARs.  You can provide a keycloak
        config file in your WAR and change the auth-method to KEYCLOAK within web.xml.  Alternatively, you don't have
        to crack open your WARs at all and can apply Keycloak via the Keycloak Subsystem configuration in standalone.xml.
        Both methods are described in this section.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="jboss-adapter-installation"/>8.2.1. Adapter Installation</h3></div></div></div>
        
    <p>
        Adapters are no longer included with the appliance or war distribution.Each adapter is a separate download on
        the Keycloak download site.  They are also available as a maven artifact.
    </p>
    <p>
        Install on Wildfly 9:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd $WILDFLY_HOME
$ unzip keycloak-wf9-adapter-dist.zip
</pre><p>
    </p>
    <p>
        Install on Wildfly 8:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd $WILDFLY_HOME
$ unzip keycloak-wf8-adapter-dist.zip
</pre><p>
    </p>
    <p>
        Install on JBoss EAP 6.x:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd $JBOSS_HOME
$ unzip keycloak-eap6-adapter-dist.zip
</pre><p>
    </p>
    <p>
        Install on JBoss AS 7.1.1:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd $JBOSS_HOME
$ unzip keycloak-as7-adapter-dist.zip
</pre><p>
    </p>
    <p>
        This zip file creates new JBoss Modules specific to the Wildfly Keycloak Adapter within your Wildfly distro.
    </p>
    <p>
        After adding the Keycloak modules, you must then enable the Keycloak Subsystem within your app server's server configuration:
        <code class="literal">domain.xml</code> or <code class="literal">standalone.xml</code>.
    </p>
    <p>
        There is a CLI script that will help you modify your server configuration.  Start the server and run the script 
        from the server's bin directory:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd $JBOSS_HOME/bin
$ jboss-cli.sh -c --file=adapter-install.cli
</pre><p>
        The script will add the extension, subsystem, and optional security-domain as described below.
    </p>
    <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;server xmlns="urn:jboss:domain:1.4"&gt;

    &lt;extensions&gt;
        &lt;extension module="org.keycloak.keycloak-adapter-subsystem"/&gt;
          ...
    &lt;/extensions&gt;

    &lt;profile&gt;
        &lt;subsystem xmlns="urn:jboss:domain:keycloak:1.1"/&gt;
         ...
    &lt;/profile&gt;

</pre><p>
    </p>
        <p>
            The keycloak security domain should be used with EJBs and other components when you need the security context created
            in the secured web tier to be propagated to the EJBs (other EE component) you are invoking.  Otherwise
            this configuration is optional.
        </p>
<pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;server xmlns="urn:jboss:domain:1.4"&gt;
 &lt;subsystem xmlns="urn:jboss:domain:security:1.2"&gt;
    &lt;security-domains&gt;
...
      &lt;security-domain name="keycloak"&gt;
         &lt;authentication&gt;
           &lt;login-module code="org.keycloak.adapters.jboss.KeycloakLoginModule"
                         flag="required"/&gt;
          &lt;/authentication&gt;
      &lt;/security-domain&gt;
    &lt;/security-domains&gt;

</pre>
        <p>
            For example, if you have a JAX-RS service that is an EJB within your WEB-INF/classes directory, you'll want
            to annotate it with the @SecurityDomain annotation as follows:
        </p>
<pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
import org.jboss.ejb3.annotation.SecurityDomain;
import org.jboss.resteasy.annotations.cache.NoCache;

import javax.annotation.security.RolesAllowed;
import javax.ejb.EJB;
import javax.ejb.Stateless;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import java.util.ArrayList;
import java.util.List;

@Path("customers")
@Stateless
@SecurityDomain("keycloak")
public class CustomerService {

    @EJB
    CustomerDB db;

    @GET
    @Produces("application/json")
    @NoCache
    @RolesAllowed("db_user")
    public List&lt;String&gt; getCustomers() {
        return db.getCustomers();
    }
}

</pre>
        <p>
            We hope to improve our integration in the future so that you don't have to specify the @SecurityDomain
            annotation when you want to propagate a keycloak security context to the EJB tier.
        </p>

    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e910"/>8.2.2. Required Per WAR Configuration</h3></div></div></div>
        
        <p>
            This section describes how to secure a WAR directly by adding config and editing files within your WAR package.
        </p>
        <p>
            The first thing you must do is create
            a <code class="literal">keycloak.json</code> adapter config file within the <code class="literal">WEB-INF</code> directory
            of your WAR.  The format of this config file is describe in the <a class="link" href="#adapter-config" title="8.1. General Adapter Config">general adapter configuration</a>
            section.
        </p>
        <p>
            Next you must set the <code class="literal">auth-method</code> to <code class="literal">KEYCLOAK</code> in <code class="literal">web.xml</code>.  You also
            have to use standard servlet security to specify role-base constraints on your URLs.  Here's an example
            pulled from one of the examples that comes distributed with Keycloak.
        </p>
        <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
      version="3.0"&gt;

	&lt;module-name&gt;customer-portal&lt;/module-name&gt;

    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Admins&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/admin/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;admin&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
        &lt;user-data-constraint&gt;
            &lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;
        &lt;/user-data-constraint&gt;
    &lt;/security-constraint&gt;
    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Customers&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/customers/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;user&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
        &lt;user-data-constraint&gt;
            &lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;
        &lt;/user-data-constraint&gt;
    &lt;/security-constraint&gt;

    &lt;login-config&gt;
        &lt;auth-method&gt;KEYCLOAK&lt;/auth-method&gt;
        &lt;realm-name&gt;this is ignored currently&lt;/realm-name&gt;
    &lt;/login-config&gt;

    &lt;security-role&gt;
        &lt;role-name&gt;admin&lt;/role-name&gt;
    &lt;/security-role&gt;
    &lt;security-role&gt;
        &lt;role-name&gt;user&lt;/role-name&gt;
    &lt;/security-role&gt;
&lt;/web-app&gt;

</pre><p>
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e923"/>8.2.3. Securing WARs via Keycloak Subsystem</h3></div></div></div>
        
        <p>
            You do not have to crack open a WAR to secure it with Keycloak.  Alternatively, you can externally secure
            it via the Keycloak Adapter Subsystem.  While you don't have to specify KEYCLOAK as an <code class="literal">auth-method</code>,
            you still have to define the <code class="literal">security-constraints</code> in <code class="literal">web.xml</code>.  You do
            not, however, have to create a <code class="literal">WEB-INF/keycloak.json</code> file.  This metadata is instead defined
            within XML in your server's <code class="literal">domain.xml</code> or <code class="literal">standalone.xml</code> subsystem
            configuration section.
        </p>
<p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;extensions&gt;
  &lt;extension module="org.keycloak.keycloak-adapter-subsystem"/&gt;
&lt;/extensions&gt;

&lt;profile&gt;
  &lt;subsystem xmlns="urn:jboss:domain:keycloak:1.1"&gt;
     &lt;secure-deployment name="WAR MODULE NAME.war"&gt;
        &lt;realm&gt;demo&lt;/realm&gt;
        &lt;realm-public-key&gt;MIGfMA0GCSqGSIb3DQEBAQUAA&lt;/realm-public-key&gt;
        &lt;auth-server-url&gt;http://localhost:8081/auth&lt;/auth-server-url&gt;
        &lt;ssl-required&gt;external&lt;/ssl-required&gt;
        &lt;resource&gt;customer-portal&lt;/resource&gt;
        &lt;credential name="secret"&gt;password&lt;/credential&gt;
     &lt;/secure-deployment&gt;
  &lt;/subsystem&gt;
&lt;/profile&gt;

</pre><p>
</p>
        <p>
            The <code class="literal">secure-deployment</code> <code class="literal">name</code> attribute identifies the WAR you want
            to secure.  Its value is the <code class="literal">module-name</code> defined in <code class="literal">web.xml</code> with
            <code class="literal">.war</code> appended.  The rest of the configuration corresponds pretty much one to one
            with the <code class="literal">keycloak.json</code> configuration options defined in <a class="link" href="#adapter-config" title="8.1. General Adapter Config">general adapter configuration</a>.
            The exception is the <code class="literal">credential</code> element.
        </p>
        <p>
            To make it easier for you, you can go to the Keycloak Adminstration Console and go to the Application/Installation
            tab of the application this WAR is aligned with.  It provides an example XML file you can cut and paste.
        </p>
        <p>
            There is an additional convenience format for this XML if you have multiple WARs you are deployment that
            are secured by the same domain.  This format allows you to define common configuration items in one place
            under the <code class="literal">realm</code> element.
        </p>
        <p>
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;subsystem xmlns="urn:jboss:domain:keycloak:1.1"&gt;
    &lt;realm name="demo"&gt;
        &lt;realm-public-key&gt;MIGfMA0GCSqGSIb3DQEBA&lt;/realm-public-key&gt;
        &lt;auth-server-url&gt;http://localhost:8080/auth&lt;/auth-server-url&gt;
        &lt;ssl-required&gt;external&lt;/ssl-required&gt;
    &lt;/realm&gt;
    &lt;secure-deployment name="customer-portal.war"&gt;
        &lt;realm&gt;demo&lt;/realm&gt;
        &lt;resource&gt;customer-portal&lt;/resource&gt;
        &lt;credential name="secret"&gt;password&lt;/credential&gt;
    &lt;/secure-deployment&gt;
    &lt;secure-deployment name="product-portal.war"&gt;
        &lt;realm&gt;demo&lt;/realm&gt;
        &lt;resource&gt;product-portal&lt;/resource&gt;
        &lt;credential name="secret"&gt;password&lt;/credential&gt;
    &lt;/secure-deployment&gt;
    &lt;secure-deployment name="database.war"&gt;
        &lt;realm&gt;demo&lt;/realm&gt;
        &lt;resource&gt;database-service&lt;/resource&gt;
        &lt;bearer-only&gt;true&lt;/bearer-only&gt;
    &lt;/secure-deployment&gt;
&lt;/subsystem&gt;

            </pre><p>
        </p>
    </div>

</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="tomcat-adapter"/>8.3. Tomcat 6, 7 and 8 Adapters</h2></div></div></div>
    
    <p>
        To be able to secure WAR apps deployed on Tomcat 6, 7 and 8 you must install the Keycloak Tomcat 6, 7 or 8 adapter
        into your Tomcat installation.  You then have to provide some extra configuration in each WAR you deploy to
        Tomcat.  Let's go over these steps.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="tomcat-adapter-installation"/>8.3.1. Adapter Installation</h3></div></div></div>
        
        <p>
            Adapters are no longer included with the appliance or war distribution.  Each adapter is a separate download on
            the Keycloak download site.  They are also available as a maven artifact.
        </p>
    <p>
        You must unzip the adapter distro into Tomcat's <code class="literal">lib/</code> directory.  Including
        adapter's jars within your WEB-INF/lib directory will not work!  The Keycloak adapter is implemented as a Valve
        and valve code must reside in Tomcat's main lib/ directory.
    </p>
    <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd $TOMCAT_HOME/lib
$ unzip keycloak-tomcat6-adapter-dist.zip
    or
$ unzip keycloak-tomcat7-adapter-dist.zip
    or
$ unzip keycloak-tomcat8-adapter-dist.zip
</pre><p>
    </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e958"/>8.3.2. Required Per WAR Configuration</h3></div></div></div>
        
        <p>
            This section describes how to secure a WAR directly by adding config and editing files within your WAR package.
        </p>
        <p>
            The first thing you must do is create a <code class="literal">META-INF/context.xml</code> file in your WAR package.  This is
            a Tomcat specific config file and you must define a Keycloak specific Valve.
        </p>
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;Context path="/your-context-path"&gt;
    &lt;Valve className="org.keycloak.adapters.tomcat.KeycloakAuthenticatorValve"/&gt;
&lt;/Context&gt;
        </pre>
        <p>
            Next you must create
            a <code class="literal">keycloak.json</code> adapter config file within the <code class="literal">WEB-INF</code> directory
            of your WAR.  The format of this config file is describe in the <a class="link" href="#adapter-config" title="8.1. General Adapter Config">general adapter configuration</a>
            section.
        </p>
        <p>
            Finally you must specify both a <code class="literal">login-config</code> and use standard servlet security to specify
            role-base constraints on your URLs.  Here's an example:
        </p>
        <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
      version="3.0"&gt;

	&lt;module-name&gt;customer-portal&lt;/module-name&gt;

    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Customers&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;user&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
    &lt;/security-constraint&gt;

    &lt;login-config&gt;
        &lt;auth-method&gt;BASIC&lt;/auth-method&gt;
        &lt;realm-name&gt;this is ignored currently&lt;/realm-name&gt;
    &lt;/login-config&gt;

    &lt;security-role&gt;
        &lt;role-name&gt;admin&lt;/role-name&gt;
    &lt;/security-role&gt;
    &lt;security-role&gt;
        &lt;role-name&gt;user&lt;/role-name&gt;
    &lt;/security-role&gt;
&lt;/web-app&gt;

</pre><p>
        </p>
    </div>
</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="jetty9-adapter"/>8.4. Jetty 9.x Adapters</h2></div></div></div>
    
    <p>
        Keycloak has a separate adapter for Jetty 9.1.x and Jetty 9.2.x that you will have to install into your Jetty
        installation.  You then have to provide some extra configuration in each WAR you deploy to
        Jetty.  Let's go over these steps.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="jetty9-adapter-installation"/>8.4.1. Adapter Installation</h3></div></div></div>
        
        <p>
            Adapters are no longer included with the appliance or war distribution.Each adapter is a separate download on
            the Keycloak download site.  They are also available as a maven artifact.
        </p>
        <p>
            You must unzip the Jetty 9.x  distro into Jetty 9.x's root directory.  Including
            adapter's jars within your WEB-INF/lib directory will not work!
        </p>
    <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd $JETTY_HOME
$ unzip keycloak-jetty92-adapter-dist.zip
</pre><p>
    </p>
    <p>
        Next, you will have to enable the keycloak module for your jetty.base.
    </p>
        <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd your-base
$ java -jar $JETTY_HOME/start.jar --add-to-startd=keycloak
</pre><p>

        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="jetty9_per_war"/>8.4.2. Required Per WAR Configuration</h3></div></div></div>
        
        <p>
            This section describes how to secure a WAR directly by adding config and editing files within your WAR package.
        </p>
        <p>
            The first thing you must do is create a <code class="literal">WEB-INF/jetty-web.xml</code> file in your WAR package.  This is
            a Jetty specific config file and you must define a Keycloak specific authenticator within it.
        </p>
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE Configure PUBLIC "-//Mort Bay Consulting//DTD Configure//EN" "http://www.eclipse.org/jetty/configure_9_0.dtd"&gt;
&lt;Configure class="org.eclipse.jetty.webapp.WebAppContext"&gt;
    &lt;Get name="securityHandler"&gt;
        &lt;Set name="authenticator"&gt;
            &lt;New class="org.keycloak.adapters.jetty.KeycloakJettyAuthenticator"&gt;
            &lt;/New&gt;
        &lt;/Set&gt;
    &lt;/Get&gt;
&lt;/Configure&gt;
        </pre>
        <p>
            Next you must create
            a <code class="literal">keycloak.json</code> adapter config file within the <code class="literal">WEB-INF</code> directory
            of your WAR.  The format of this config file is describe in the <a class="link" href="#adapter-config" title="8.1. General Adapter Config">general adapter configuration</a>
            section.
        </p>
        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2>
            <p>
                The Jetty 9.1.x adapter will not be able to find the <code class="literal">keycloak.json</code> file.  You will have to define
                all adapter settings within the <code class="literal">jetty-web.xml</code> file as described below.
            </p>
        </div>
        <p>
            Instead of using keycloak.json, you can define everything within the <code class="literal">jetty-web.xml</code>.  You'll
            just have to figure out how the json settings match to the <code class="literal">org.keycloak.representations.adapters.config.AdapterConfig</code>
            class.
        </p>
        <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE Configure PUBLIC "-//Mort Bay Consulting//DTD Configure//EN" "http://www.eclipse.org/jetty/configure_9_0.dtd"&gt;
&lt;Configure class="org.eclipse.jetty.webapp.WebAppContext"&gt;
  &lt;Get name="securityHandler"&gt;
    &lt;Set name="authenticator"&gt;
        &lt;New class="org.keycloak.adapters.jetty.KeycloakJettyAuthenticator"&gt;
            &lt;Set name="adapterConfig"&gt;
                &lt;New class="org.keycloak.representations.adapters.config.AdapterConfig"&gt;
                    &lt;Set name="realm"&gt;tomcat&lt;/Set&gt;
                    &lt;Set name="resource"&gt;customer-portal&lt;/Set&gt;
                    &lt;Set name="authServerUrl"&gt;http://localhost:8081/auth&lt;/Set&gt;
                    &lt;Set name="sslRequired"&gt;external&lt;/Set&gt;
                    &lt;Set name="credentials"&gt;
                        &lt;Map&gt;
                            &lt;Entry&gt;
                                &lt;Item&gt;secret&lt;/Item&gt;
                                &lt;Item&gt;password&lt;/Item&gt;
                            &lt;/Entry&gt;
                        &lt;/Map&gt;
                    &lt;/Set&gt;
                    &lt;Set name="realmKey"&gt;MIGfMA0GCSqGSIb3DQEBAQUAA4&lt;/Set&gt;
                &lt;/New&gt;
            &lt;/Set&gt;
        &lt;/New&gt;
    &lt;/Set&gt;
  &lt;/Get&gt;
&lt;/Configure&gt;

</pre><p>
        </p>
        <p>
            You do not have to crack open your WAR to secure it with keycloak.  Instead create the jetty-web.xml file
            in your webapps directory with the name of yourwar.xml.  Jetty should pick it up.  In this mode, you'll have
            to declare keycloak.json configuration directly within the xml file.
        </p>
        <p>
            Finally you must specify both a <code class="literal">login-config</code> and use standard servlet security to specify
            role-base constraints on your URLs.  Here's an example:
        </p>
        <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
      version="3.0"&gt;

	&lt;module-name&gt;customer-portal&lt;/module-name&gt;

    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Customers&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;user&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
        &lt;user-data-constraint&gt;
            &lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;
        &lt;/user-data-constraint&gt;
    &lt;/security-constraint&gt;

    &lt;login-config&gt;
        &lt;auth-method&gt;BASIC&lt;/auth-method&gt;
        &lt;realm-name&gt;this is ignored currently&lt;/realm-name&gt;
    &lt;/login-config&gt;

    &lt;security-role&gt;
        &lt;role-name&gt;admin&lt;/role-name&gt;
    &lt;/security-role&gt;
    &lt;security-role&gt;
        &lt;role-name&gt;user&lt;/role-name&gt;
    &lt;/security-role&gt;
&lt;/web-app&gt;

</pre><p>
        </p>
    </div>
</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="jetty8-adapter"/>8.5. Jetty 8.1.x Adapter</h2></div></div></div>
    
    <p>
        Keycloak has a separate adapter for Jetty 8.1.x that you will have to install into your Jetty
        installation.  You then have to provide some extra configuration in each WAR you deploy to
        Jetty.  Let's go over these steps.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="jetty8-adapter-installation"/>8.5.1. Adapter Installation</h3></div></div></div>
        
        <p>
            Adapters are no longer included with the appliance or war distribution.Each adapter is a separate download on
            the Keycloak download site.  They are also available as a maven artifact.
        </p>
    <p>
        You must unzip the Jetty 8.1.x  distro into Jetty 8.1.x's root directory.  Including
        adapter's jars within your WEB-INF/lib directory will not work!
    </p>
    <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd $JETTY_HOME
$ unzip keycloak-jetty81-adapter-dist.zip
</pre><p>
    </p>
    <p>
        Next, you will have to enable the keycloak option.  Edit start.ini and add keycloak to the options
    </p>
        <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

#===========================================================
# Start classpath OPTIONS.
# These control what classes are on the classpath
# for a full listing do
#   java -jar start.jar --list-options
#-----------------------------------------------------------
OPTIONS=Server,jsp,jmx,resources,websocket,ext,plus,annotations,keycloak

</pre><p>

        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1020"/>8.5.2. Required Per WAR Configuration</h3></div></div></div>
        
        <p>
            Enabling Keycloak for your WARs is the same as the Jetty 9.x adapter.  Our 8.1.x adapter supports both keycloak.json
            and the jboss-web.xml advanced configuration.  See <a class="link" href="#jetty9_per_war" title="8.4.2. Required Per WAR Configuration">Required Per WAR Configuration</a>
        </p>
     </div>
</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e1024"/>8.6. Java Servlet Filter Adapter</h2></div></div></div>
    
    <p>
        If you want to use Keycloak with a Java servlet application that doesn't have an adapter for that servlet
        platform, you can opt to use the servlet filter adapter that Keycloak has.  This adapter works a little
        differently than the other adapters.  You do not define security constraints in web.xml.  Instead you define
        a filter mapping using the Keycloak servlet filter adapter to secure the url patterns you want to secure.
    </p>
    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2>
        <p>
            Backchannel logout works a bit differently than the standard adapters.  Instead of invalidating the http session
            it instead marks the session id as logged out.  There's just no way of arbitrarily invalidating an http session
            based on a session id.
        </p>
    </div>

    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
        
&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
      version="3.0"&gt;

	&lt;module-name&gt;customer-portal&lt;/module-name&gt;

    &lt;filter&gt;
        &lt;filter-name&gt;Keycloak Filter&lt;/filter-name&gt;
        &lt;filter-class&gt;org.keycloak.adapters.servlet.KeycloakOIDCFilter&lt;/filter-class&gt;
    &lt;/filter&gt;
    &lt;filter-mapping&gt;
        &lt;filter-name&gt;Keycloak Filter&lt;/filter-name&gt;
        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;
&lt;/web-app&gt;

    </pre>
    <p>
        The Keycloak filter has the same configuration parameters available as the other adapters except you must define
        them as filter init params instead of context params.
    </p>
    <p>
        To use this filter, include this maven artifact in your WAR poms
    </p>
    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
           &lt;dependency&gt;
                &lt;groupId&gt;org.keycloak&lt;/groupId&gt;
                &lt;artifactId&gt;keycloak-servlet-filter-adapter&lt;/artifactId&gt;
                &lt;version&gt;&amp;project.version;&lt;/version&gt;
            &lt;/dependency&gt;
</pre>
</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="fuse-adapter"/>8.7. JBoss Fuse and Apache Karaf Adapter</h2></div></div></div>
    
    <p>
        Currently Keycloak supports securing your web applications running inside <a class="ulink" href="http://www.jboss.org/products/fuse/overview/">JBoss Fuse</a>
        or <a class="ulink" href="http://karaf.apache.org/">Apache Karaf</a> . It leverages <a class="link" href="#jetty8-adapter" title="8.5. Jetty 8.1.x Adapter">Jetty 8 adapter</a> as both JBoss Fuse 6.1
        and Apache Karaf 3 are bundled with <a class="ulink" href="http://eclipse.org/jetty/">Jetty 8.1 server</a> under the covers and Jetty is used for running various kinds of web applications.
    </p>
    <p>
        What is supported for Fuse/Karaf is:
        </p><div class="itemizedlist"><ul><li>
                <p>
                    Security for classic WAR applications deployed on Fuse/Karaf with <a class="ulink" href="https://ops4j1.jira.com/wiki/display/ops4j/Pax+Web+Extender+-+War">Pax Web War Extender</a>.
                </p>
            </li><li>
                <p>
                    Security for servlets deployed on Fuse/Karaf as OSGI services with <a class="ulink" href="https://ops4j1.jira.com/wiki/display/ops4j/Pax+Web+Extender+-+Whiteboard">Pax Web Whiteboard Extender</a>.
                </p>
            </li><li>
                <p>
                    Security for <a class="ulink" href="http://camel.apache.org/">Apache Camel</a> Jetty endpoints running with
                    <a class="ulink" href="http://camel.apache.org/jetty.html">Camel Jetty</a> component.
                </p>
            </li><li>
                <p>
                    Security for <a class="ulink" href="http://cxf.apache.org/">Apache CXF</a> endpoints running on their own separate
                    <a class="ulink" href="http://cxf.apache.org/docs/jetty-configuration.html">Jetty engine</a>.
                </p>
            </li><li>
                <p>
                    Security for <a class="ulink" href="http://cxf.apache.org/">Apache CXF</a> endpoints running on default engine provided by CXF servlet.
                </p>
            </li><li>
                <p>
                    Security for SSH and JMX admin access.
                </p>
            </li><li>
                <p>
                    Security for <a class="ulink" href="http://hawt.io/">Hawt.io admin console</a> .
                </p>
            </li></ul></div><p>
    </p>
    <p>The best place to start is look at Fuse demo bundled as part of Keycloak examples in directory <code class="literal">examples/fuse</code> .</p>
</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="javascript-adapter"/>8.8. Javascript Adapter</h2></div></div></div>
    
    <p>
        The Keycloak Server comes with a Javascript library you can use to secure HTML/Javascript applications.  This
        library is referencable directly from the keycloak server.  You can also download the adapter from Keycloak's download
        site if you want a static copy of this library.  It
        works in the same way as other application adapters except that your browser is driving the OAuth redirect protocol
        rather than the server.
    </p>
    <p>
        The disadvantage of using this approach is that you have a non-confidential, public client. This makes it more
        important that you register valid redirect URLs and make sure your domain name is secured.
    </p>
    <p>
        To use this adapter, you must first configure an application (or client) through the <code class="literal">Keycloak Admin Console</code>.
        You should select <code class="literal">public</code> for the <code class="literal">Client Type</code> field. As public clients can't
        be verified with a client secret you are required to configure one or more valid redirect uris as well.
        Once you've configured the application click on the <code class="literal">Installation</code> tab and download the <code class="literal">keycloak.json</code>
        file. This file should be hosted in your web-server at the same root as your HTML pages. Alternatively you can either
        specify the URL for this file, or manually configure the adapter.
    </p>
    <p>
        Next you have to initialize the adapter in your application. An example on how to do this is shown below.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;head&gt;
    &lt;script src="http://&lt;keycloak server&gt;/auth/js/keycloak.js"&gt;&lt;/script&gt;
    &lt;script&gt;
        var keycloak = Keycloak();
        keycloak.init().success(function(authenticated) {
            alert(authenticated ? 'authenticated' : 'not authenticated');
        }).error(function() {
            alert('failed to initialize');
        });
    &lt;/script&gt;
&lt;/head&gt;
</pre><p>
        To specify the location of the keycloak.json file:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
var keycloak = Keycloak('http://localhost:8080/myapp/keycloak.json'));
</pre><p>
        Or finally to manually configure the adapter:
        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
var keycloak = Keycloak({
    url: 'http://keycloak-server/auth',
    realm: 'myrealm',
    clientId: 'myapp'
});
</pre><p>
        You can also pass <code class="literal">login-required</code> or <code class="literal">check-sso</code> to the init function. Login
        required will redirect to the login form on the server, while check-sso will redirect to the auth server to check
        if the user is already logged in to the realm. For example:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
keycloak.init({ onLoad: 'login-required' })
</pre><p>
    </p>

    <p>
        After you login, your application will be able to make REST calls using bearer token authentication.  Here's
        an example pulled from the <code class="literal">customer-portal-js</code> example that comes with the distribution.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;script&gt;
    var loadData = function () {
        document.getElementById('username').innerText = keycloak.username;

        var url = 'http://localhost:8080/database/customers';

        var req = new XMLHttpRequest();
        req.open('GET', url, true);
        req.setRequestHeader('Accept', 'application/json');
        req.setRequestHeader('Authorization', 'Bearer ' + keycloak.token);

        req.onreadystatechange = function () {
            if (req.readyState == 4) {
                if (req.status == 200) {
                    var users = JSON.parse(req.responseText);
                    var html = '';
                    for (var i = 0; i &lt; users.length; i++) {
                        html += '&lt;p&gt;' + users[i] + '&lt;/p&gt;';
                    }
                    document.getElementById('customers').innerHTML = html;
                    console.log('finished loading data');
                }
            }
        }

        req.send();
    };

    var loadFailure = function () {
        document.getElementById('customers').innerHTML = '&lt;b&gt;Failed to load data.  Check console log&lt;/b&gt;';

    };

    var reloadData = function () {
        keycloak.updateToken().success(loadData).error(loadFailure);
    }
&lt;/script&gt;

&lt;button onclick="loadData()"&gt;Submit&lt;/button&gt;
</pre><p>
     </p>
    <p>
        The <code class="literal">loadData()</code> method builds an HTTP request setting the <code class="literal">Authorization</code>
        header to a bearer token.  The <code class="literal">keycloak.token</code> points to the access token the browser obtained
        when it logged you in.  The <code class="literal">loadFailure()</code> method is invoked on a failure.  The <code class="literal">reloadData()</code>
        function calls <code class="literal">keycloak.onValidAccessToken()</code> passing in the <code class="literal">loadData()</code> and
        <code class="literal">loadFailure()</code> callbacks.  The <code class="literal">keycloak.onValidAcessToken()</code> method checks to
        see if the access token hasn't expired.  If it hasn't, and your oauth login returned a refresh token, this method
        will refresh the access token.  Finally, if successful, it will invoke the success callback, which in this case
        is the <code class="literal">loadData()</code> method.
    </p>

    <p>
        To refresh the token if it's expired call the <code class="literal">updateToken</code> method. This method returns a promise
        object which can be used to invoke a function on success or failure. This method can be used to wrap functions
        that should only be called with a valid token. For example the following method will refresh the token if it
        expires within 30 seconds, and then invoke the specified function. If the token is valid for more than 30 seconds it
        will just call the specified function.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
keycloak.updateToken(30).success(function() {
    // send request with valid token
}).error(function() {
    alert('failed to refresh token');
);
</pre><p>
    </p>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1100"/>8.8.1. Session status iframe</h3></div></div></div>
        

        <p>
            By default the JavaScript adapter creates a non-visible iframe that is used to detect if a single-sign out has occured.
            This does not require any network traffic, instead the status is retrieved from a special status cookie. This feature can be disabled
            by setting <code class="literal">checkLoginIframe: false</code> in the options passed to the <code class="literal">init</code>
            method.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1105"/>8.8.2. Older browsers</h3></div></div></div>
        

        <p>
            The JavaScript adapter depends on Base64 (window.btoa and window.atob) and HTML5 History API. If you need to
            support browsers that don't provide those (for example IE9) you'll need to add polyfillers. Example polyfill
            libraries:

            </p><div class="itemizedlist"><ul><li>Base64 - <a class="ulink" href="https://github.com/davidchambers/Base64.js">https://github.com/davidchambers/Base64.js</a></li><li>HTML5 History - <a class="ulink" href="https://github.com/devote/HTML5-History-API">https://github.com/devote/HTML5-History-API</a></li></ul></div><p>
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1113"/>8.8.3. JavaScript Adapter reference</h3></div></div></div>
        

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e1115"/>8.8.3.1. Constructor</h4></div></div></div>
            
<pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
new Keycloak();
new Keycloak('http://localhost/keycloak.json');
new Keycloak({ url: 'http://localhost/auth', realm: 'myrealm', clientId: 'myApp' });
</pre>
        </div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e1118"/>8.8.3.2. Properties</h4></div></div></div>
            

            <div class="itemizedlist"><ul><li>authenticated - true if the user is authenticated</li><li>token - the base64 encoded token that can be sent in the <code class="literal">Authorization</code> header in requests to services</li><li>tokenParsed - the parsed token</li><li>subject - the user id</li><li>idToken - the id token if claims is enabled for the application, null otherwise</li><li>idTokenParsed - the parsed id token</li><li>realmAccess - the realm roles associated with the token</li><li>resourceAccess - the resource roles assocaited with the token</li><li>refreshToken - the base64 encoded token that can be used to retrieve a new token</li><li>refreshTokenParsed - the parsed refresh token</li><li>timeSkew - estimated skew between local time and Keycloak server in seconds</li></ul></div>
        </div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e1133"/>8.8.3.3. Methods</h4></div></div></div>
            

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1135"/>init(options)</h5></div></div></div>
                

                <p>Called to initialize the adapter.</p>
                <p>Options is an Object, where:
                    </p><div class="itemizedlist"><ul><li>onLoad - specifies an action to do on load, can be either 'login-required' or 'check-sso'</li><li>token - set an initial value for the token</li><li>refreshToken - set an initial value for the refresh token</li><li>checkLoginIframe - set to enable/disable monitoring login state (default is true)</li><li>checkLoginIframeInterval - set the interval to check login state (default is 5 seconds)</li></ul></div><p>
                </p>
                <p>Returns promise to set functions to be invoked on success or error.</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1146"/>login(options)</h5></div></div></div>
                

                <p>Redirects to login form on (options is an optional object with redirectUri and/or prompt fields)</p>
                <p>Options is an Object, where:
                    </p><div class="itemizedlist"><ul><li>redirectUri - specifies the uri to redirect to after login</li><li>prompt - can be set to 'none' to check if the user is logged in already (if not logged in, a login form is not displayed)</li><li>loginHint - used to pre-fill the username/email field on the login form</li><li>action - if value is 'register' then user is redirected to registration page, otherwise to login page</li></ul></div><p>
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1155"/>createLoginUrl(options)</h5></div></div></div>
                

                <p>Returns the url to login form on (options is an optional object with redirectUri and/or prompt fields)</p>
                <p>Options is an Object, where:
                    </p><div class="itemizedlist"><ul><li>redirectUri - specifies the uri to redirect to after login</li><li>prompt - can be set to 'none' to check if the user is logged in already (if not logged in, a login form is not displayed)</li></ul></div><p>
                </p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1162"/>logout(options)</h5></div></div></div>
                

                <p>Redirects to logout</p>
                <p>Options is an Object, where:
                    </p><div class="itemizedlist"><ul><li>redirectUri - specifies the uri to redirect to after logout</li></ul></div><p>
                </p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1168"/>createLogoutUrl(options)</h5></div></div></div>
                

                <p>Returns logout out</p>
                <p>Options is an Object, where:
                    </p><div class="itemizedlist"><ul><li>redirectUri - specifies the uri to redirect to after logout</li></ul></div><p>
                </p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1174"/>register(options)</h5></div></div></div>
                

                <p>Redirects to registration form. It's a shortcut for doing login with option action = 'register'</p>
                <p>Options are same as login method but 'action' is overwritten to 'register'</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1178"/>createRegisterUrl(options)</h5></div></div></div>
                

                <p>Returns the url to registration page. It's a shortcut for doing createRegisterUrl with option action = 'register'</p>
                <p>Options are same as createLoginUrl method but 'action' is overwritten to 'register'</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1182"/>accountManagement()</h5></div></div></div>
                

                <p>Redirects to account management</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1185"/>createAccountUrl()</h5></div></div></div>
                

                <p>Returns the url to account management</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1188"/>hasRealmRole(role)</h5></div></div></div>
                

                <p>Returns true if the token has the given realm role</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1191"/>hasResourceRole(role, resource)</h5></div></div></div>
                

                <p>Returns true if the token has the given role for the resource (resource is optional, if not specified clientId is used)</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1194"/>loadUserProfile()</h5></div></div></div>
                

                <p>Loads the users profile</p>

                <p>Returns promise to set functions to be invoked on success or error.</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1198"/>isTokenExpired(minValidity)</h5></div></div></div>
                

                <p>Returns true if the token has less than minValidity seconds left before it expires (minValidity is optional, if not specified 0 is used)</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1201"/>updateToken(minValidity)</h5></div></div></div>
                

                <p>If the token expires within minValidity seconds (minValidity is optional, if not specified 0 is used) the token is refreshed.
                    If the session status iframe is enabled, the session status is also checked.
                </p>

                <p>Returns promise to set functions that can be invoked if the token is still valid, or if the token is no longer valid. For example:</p>

                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
keycloak.updateToken(5).success(function(refreshed) {
        if (refreshed) {
            alert('token was successfully refreshed');
        } else {
            alert('token is still valid');
        }
    }).error(function() {
        alert('failed to refresh the token, or the session has expired');
    });
</pre>

            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1206"/>clearToken()</h5></div></div></div>
                

                <p>
                    Clear authentication state, including tokens. This can be useful if application has detected the session
                    has expired, for example if updating token fails. Invoking this results in onAuthLogout callback listener
                    being invoked.
                </p>

                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
keycloak.updateToken(5).error(function() {
    keycloak.clearToken();
});
</pre>

            </div>
        </div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e1210"/>8.8.3.4. Callback Events</h4></div></div></div>
            

            <p>The adapter supports setting callback listeners for certain events. For example:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
keycloak.onAuthSuccess = function() { alert('authenticated'); }
</pre><p>
            </p>

            <div class="itemizedlist"><ul><li>onReady(authenticated) - called when the adapter is initialized</li><li>onAuthSuccess - called when a user is successfully authenticated</li><li>onAuthError - called if there was an error during authentication</li><li>onAuthRefreshSuccess - called when the token is refreshed</li><li>onAuthRefreshError - called if there was an error while trying to refresh the token</li><li>onAuthLogout - called if the user is logged out (will only be called if the session status iframe is enabled, or in Cordova mode)</li></ul></div>
        </div>
    </div>
</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="spring-boot-adapter"/>8.9. Spring Boot Adapter</h2></div></div></div>
    
    <p>
        To be able to secure Spring Boot apps you must add the Keycloak Spring Boot adapter
        JAR to your app. You then have to provide some extra configuration via normal Spring
        Boot configuration (<code class="literal">application.properties</code>).  Let's go over these steps.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="spring-boot-adapter-installation"/>8.9.1. Adapter Installation</h3></div></div></div>
        
        <p>
            The Keycloak Spring Boot adapter takes advantage of Spring Boot's autoconfiguration so all
            you need to do is add the Keycloak Spring Boot adapter JAR to your project. Depending on
            what container you are using with Spring Boot, you also need to add the appropriate
            Keycloak container adapter. If you are using Maven, add the following to your pom.xml (using
            Tomcat as an example):
        </p>
        <p>
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;dependency&gt;
    &lt;groupId&gt;org.keycloak&lt;/groupId&gt;
    &lt;artifactId&gt;keycloak-spring-boot-adapter&lt;/artifactId&gt;
    &lt;version&gt;&amp;project.version;&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.keycloak&lt;/groupId&gt;
    &lt;artifactId&gt;keycloak-tomcat8-adapter&lt;/artifactId&gt;
    &lt;version&gt;&amp;project.version;&lt;/version&gt;
&lt;/dependency&gt;

            </pre><p>
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="spring-boot-adapter-configuration"/>8.9.2. Required Spring Boot Adapter Configuration</h3></div></div></div>
        
        <p>
            This section describes how to configure your Spring Boot app to use Keycloak.
        </p>
        <p>
            Instead of a <code class="literal">keycloak.json</code> file, you configure the realm for the Spring
            Boot Keycloak adapter via the normal Spring Boot configuration. For example:
        </p>
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

keycloak.realm = demorealm
keycloak.realmKey = MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCLCWYuxXmsmfV+Xc9Ik8QET8lD4wuHrJAXbbutS2O/eMjQQLNK7QDX/k/XhOkhxP0YBEypqeXeGaeQJjCxDhFjJXQuewUEMlmSja3IpoJ9/hFn4Cns4m7NGO+rtvnfnwgVfsEOS5EmZhRddp+40KBPPJfTH6Vgu6KjQwuFPj6DTwIDAQAB
keycloak.auth-server-url = http://127.0.0.1:8080/auth
keycloak.ssl-required = external
keycloak.resource = demoapp
keycloak.credentials.secret = 11111111-1111-1111-1111-111111111111
keycloak.use-resource-role-mappings = true

        </pre>
        <p>
            You also need to specify the J2EE security config that would normally go in the <code class="literal">web.xml</code>.
            Here's an example configuration:
        </p>
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

keycloak.securityConstraints[0].securityCollections[0].name = insecure stuff
keycloak.securityConstraints[0].securityCollections[0].authRoles[0] = admin
keycloak.securityConstraints[0].securityCollections[0].authRoles[0] = user
keycloak.securityConstraints[0].securityCollections[0].patterns[0] = /insecure

keycloak.securityConstraints[0].securityCollections[1].name = admin stuff
keycloak.securityConstraints[0].securityCollections[1].authRoles[0] = admin
keycloak.securityConstraints[0].securityCollections[1].patterns[0] = /admin

        </pre>
    </div>
</div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="spring-security-adapter"/>8.10. Spring Security Adapter</h2></div></div></div>
    
    <p>
        To to secure an application with Spring Security and Keyloak, add this adapter as a dependency to your project.
        You then have to provide some extra beans in your Spring Security configuration file and add the Keycloak security
        filter to your pipeline.
    </p>
    <p>
        Unlike the other Keycloak Adapters, you should not configure your security in web.xml. However, keycloak.json is still required.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1243"/>8.10.1. Adapter Installation</h3></div></div></div>
        
        <p>
            Add Keycloak Spring Security adapter as a dependency to your Maven POM or Gradle build.
        </p>
        <p>
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                
&lt;dependency&gt;
    &lt;groupId&gt;org.keycloak&lt;/groupId&gt;
    &lt;artifactId&gt;keycloak-spring-security-adapter&lt;/artifactId&gt;
    &lt;version&gt;&amp;project.version;&lt;/version&gt;
&lt;/dependency&gt;

            </pre><p>
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1248"/>8.10.2. Spring Security Configuration</h3></div></div></div>
        
        <p>
            The Keycloak Spring Security adapter takes advantage of Spring Security's flexible security configuration syntax.
        </p>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e1251"/>8.10.2.1. Java Configuration</h4></div></div></div>
            
            <p>
                Keycloak provides a KeycloakWebSecurityConfigurerAdapter as a convenient base class for creating a
                <a class="ulink" href="http://docs.spring.io/spring-security/site/docs/4.0.x/apidocs/org/springframework/security/config/annotation/web/WebSecurityConfigurer.html">WebSecurityConfigurer</a>
                instance. The implementation allows customization by overriding methods. While its use is not required, it greatly simplifies your security context configuration.
            </p>
            <p>
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                    
@Configuration
@EnableWebSecurity
@ComponentScan(basePackageClasses = KeycloakSecurityComponents.class)
public class SecurityConfig extends KeycloakWebSecurityConfigurerAdapter
{
    /**
     * Registers the KeycloakAuthenticationProvider with the authentication manager.
     */
    @Autowired
    public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
        auth.authenticationProvider(keycloakAuthenticationProvider());
    }

    /**
     * Defines the session authentication strategy.
     */
    @Bean
    @Override
    protected SessionAuthenticationStrategy sessionAuthenticationStrategy() {
        return new RegisterSessionAuthenticationStrategy(new SessionRegistryImpl());
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception
    {
        super.configure(http);
        http
                .authorizeRequests()
                .antMatchers("/customers*").hasRole("USER")
                .antMatchers("/admin*").hasRole("ADMIN")
                .anyRequest().permitAll();
    }
}

                </pre><p>
            </p>
            <p>
                You must provide a session authentication strategy bean which should be of type
                <code class="code">RegisterSessionAuthenticationStrategy</code> for public or confidential applications and
                <code class="code">NullAuthenticatedSessionStrategy</code> for bearer-only applications.
            </p>
            <p>
                Spring Security's <code class="code">SessionFixationProtectionStrategy</code> is currently not supported because it changes
                the session identifier after login via Keycloak. If the session identifier changes, universal log out will not
                work because Keycloak is unaware of the new session identifier.
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e1262"/>8.10.2.2. XML Configuration</h4></div></div></div>
            
            <p>
                While Spring Security's XML namespace simplifies configuration, customizing the configuration can be a bit
                verbose.
            </p>
            <p>
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                    
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:security="http://www.springframework.org/schema/security"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/security
       http://www.springframework.org/schema/security/spring-security.xsd"&gt;

    &lt;context:component-scan base-package="org.keycloak.adapters.springsecurity" /&gt;

    &lt;security:authentication-manager alias="authenticationManager"&gt;
        &lt;security:authentication-provider ref="keycloakAuthenticationProvider" /&gt;
    &lt;/security:authentication-manager&gt;

    &lt;bean id="adapterDeploymentContextBean" class="org.keycloak.adapters.springsecurity.AdapterDeploymentContextBean" /&gt;
    &lt;bean id="keycloakAuthenticationEntryPoint" class="org.keycloak.adapters.springsecurity.authentication.KeycloakAuthenticationEntryPoint" /&gt;
    &lt;bean id="keycloakAuthenticationProvider" class="org.keycloak.adapters.springsecurity.authentication.KeycloakAuthenticationProvider" /&gt;
    &lt;bean id="keycloakPreAuthActionsFilter" class="org.keycloak.adapters.springsecurity.filter.KeycloakPreAuthActionsFilter" /&gt;
    &lt;bean id="keycloakAuthenticationProcessingFilter" class="org.keycloak.adapters.springsecurity.filter.KeycloakAuthenticationProcessingFilter"&gt;
        &lt;constructor-arg name="authenticationManager" ref="authenticationManager" /&gt;
    &lt;/bean&gt;

    &lt;bean id="keycloakLogoutHandler" class="org.keycloak.adapters.springsecurity.authentication.KeycloakLogoutHandler"&gt;
            &lt;constructor-arg ref="adapterDeploymentContextBean" /&gt;
    &lt;/bean&gt;

    &lt;bean id="logoutFilter" class="org.springframework.security.web.authentication.logout.LogoutFilter"&gt;
        &lt;constructor-arg name="logoutSuccessUrl" value="/" /&gt;
        &lt;constructor-arg name="handlers"&gt;
            &lt;list&gt;
                &lt;ref bean="keycloakLogoutHandler" /&gt;
                &lt;bean class="org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler" /&gt;
            &lt;/list&gt;
        &lt;/constructor-arg&gt;
        &lt;property name="logoutRequestMatcher"&gt;
            &lt;bean class="org.springframework.security.web.util.matcher.AntPathRequestMatcher"&gt;
                &lt;constructor-arg name="pattern" value="/sso/logout**" /&gt;
                &lt;constructor-arg name="httpMethod" value="GET" /&gt;
            &lt;/bean&gt;
        &lt;/property&gt;
    &lt;/bean&gt;

    &lt;security:http auto-config="false" entry-point-ref="keycloakAuthenticationEntryPoint"&gt;
        &lt;security:custom-filter ref="keycloakPreAuthActionsFilter" before="LOGOUT_FILTER" /&gt;
        &lt;security:custom-filter ref="keycloakAuthenticationProcessingFilter" before="FORM_LOGIN_FILTER" /&gt;
        &lt;security:intercept-url pattern="/customers**" access="ROLE_USER" /&gt;
        &lt;security:intercept-url pattern="/admin**" access="ROLE_ADMIN" /&gt;
        &lt;security:custom-filter ref="logoutFilter" position="LOGOUT_FILTER" /&gt;
    &lt;/security:http&gt;

&lt;/beans&gt;

                </pre><p>
            </p>
        </div>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1267"/>8.10.3. Naming Security Roles</h3></div></div></div>
        
        <p>
            Spring Security, when using role-based authentication, requires that role names start with <code class="code">ROLE_</code>.
            For example, an administrator role must be declared in Keycloak as <code class="code">ROLE_ADMIN</code> or similar, not simply
            <code class="code">ADMIN</code>.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1273"/>8.10.4. Client to Client Support</h3></div></div></div>
        
        <p>
            To simplify communication between clients, Keycloak provides an extension of Spring's <code class="code">RestTemplate</code> that
            handles bearer token authentication for you. To enable this feature your security configuration must add the
            <code class="code">KeycloakRestTemplate</code> bean. Note that it must be scoped as a prototype to function correctly.
        </p>
        <p>
            For Java configuration:
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                
@Configuration
@EnableWebSecurity
@ComponentScan(basePackageClasses = KeycloakSecurityComponents.class)
public class SecurityConfig extends KeycloakWebSecurityConfigurerAdapter {

    ...

    @Autowired
    public KeycloakClientRequestFactory keycloakClientRequestFactory;

    @Bean
    @Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)
    public KeycloakRestTemplate keycloakRestTemplate() {
        return new KeycloakRestTemplate(keycloakClientRequestFactory);
    }

    ...
}

            </pre><p>
        </p>
        <p>
            For XML configuration:
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                
&lt;bean id="keycloakRestTemplate" class="org.keycloak.adapters.springsecurity.client.KeycloakRestTemplate" scope="prototype"&gt;
    &lt;constructor-arg name="factory" ref="keycloakClientRequestFactory" /&gt;
&lt;/bean&gt;

            </pre><p>
        </p>
        <p>
            Your application code can then use <code class="code">KeycloakRestTemplate</code> any time it needs to make a call to another
            client. For example:
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                

@Service
public class RemoteProductService implements ProductService {

    @Autowired
    private KeycloakRestTemplate template;

    private String endpoint;

    @Override
    public List&lt;String&gt; getProducts() {
        ResponseEntity&lt;String[]&gt; response = template.getForEntity(endpoint, String[].class);
        return Arrays.asList(response.getBody());
    }
}


            </pre><p>
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1285"/>8.10.5. Spring Boot Configuration</h3></div></div></div>
        
        <p>
            Spring Boot attempts to eagerly register filter beans with the web application context. Therefore,
            when running the Keycloak Spring Security adapter in a Spring Boot environment, it may be necessary to add two
            <code class="code">FilterRegistrationBean</code>s to your security configuration to prevent the Keycloak filters from being
            registered
            twice.
        </p>
        <p>
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                
@Configuration
@EnableWebSecurity
public class SecurityConfig extends KeycloakWebSecurityConfigurerAdapter
{
    ...

    @Bean
    public FilterRegistrationBean keycloakAuthenticationProcessingFilterRegistrationBean(
            KeycloakAuthenticationProcessingFilter filter) {
        FilterRegistrationBean registrationBean = new FilterRegistrationBean(filter);
        registrationBean.setEnabled(false);
        return registrationBean;
    }

    @Bean
    public FilterRegistrationBean keycloakPreAuthActionsFilterRegistrationBean(
            KeycloakPreAuthActionsFilter filter) {
        FilterRegistrationBean registrationBean = new FilterRegistrationBean(filter);
        registrationBean.setEnabled(false);
        return registrationBean;
    }

    ...
}

            </pre><p>
        </p>
    </div>
</div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="installed-applications"/>8.11. Installed Applications</h2></div></div></div>
    
    <p>
        Keycloak provides two special redirect uris for installed applications.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="installed-applications-url"/>8.11.1. http://localhost</h3></div></div></div>
        
        <p>
            This returns the code to a web server on the client as a query parameter. Any port number is allowed.
            This makes it possible to start a web server for the installed application on any free port number without
            requiring changes in the <code class="literal">Admin Console</code>.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="installed-applications-urn"/>8.11.2. urn:ietf:wg:oauth:2.0:oob</h3></div></div></div>
        
        <p>
            If its not possible to start a web server in the client (or a browser is not available) it is possible to
            use the special <code class="literal">urn:ietf:wg:oauth:2.0:oob</code> redirect uri. When this redirect uri is used
            Keycloak displays a page with the code in the title and in a box on the page. The application can either
            detect that the browser title has changed, or the user can copy/paste the code manually to the application.
            With this redirect uri it is also possible for a user to use a different device to obtain a code to paste
            back to the application.
        </p>
    </div>
</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e1302"/>8.12. Logout</h2></div></div></div>
    
    <p>
        There are multiple ways you can logout from a web application.  For Java EE servlet containers, you can call
        HttpServletRequest.logout().
        For any other browser application, you can point the browser at the url <code class="literal">http://auth-server/auth/realms/{realm-name}/tokens/logout?redirect_uri=encodedRedirectUri</code>.
        This will log you out if you have an SSO session with your browser.
    </p>
</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="multi_tenancy"/>8.13. Multi Tenancy</h2></div></div></div>
    
    <p>
        Multi Tenancy, in our context, means that one single target application (WAR) can be secured by a single (or clustered) Keycloak server, authenticating
        its users against different realms. In practice, this means that one application needs to use different <code class="literal">keycloak.json</code> files.
        For this case, there are two possible solutions:
        </p><div class="itemizedlist"><ul><li>
                The same WAR file deployed under two different names, each with its own Keycloak configuration (probably via the Keycloak Subsystem).
                This scenario is suitable when the number of realms is known in advance or when there's a dynamic provision of application instances.
                One example would be a service provider that dynamically creates servers/deployments for their clients, like a PaaS.
            </li><li>
                A WAR file deployed once (possibly in a cluster), that decides which realm to authenticate against based on the request parameters.
                This scenario is suitable when there are an undefined number of realms. One example would be a SaaS provider that have only one deployment
                (perhaps in a cluster) serving several companies, differentiating between clients based on the hostname
                (<code class="literal">client1.acme.com</code>, <code class="literal">client2.acme.com</code>) or path (<code class="literal">/app/client1/</code>,
                <code class="literal">/app/client2/</code>) or even via a special HTTP Header.
            </li></ul></div><p>

        This chapter of the reference guide focus on this second scenario.
    </p>

    <p>
        Keycloak provides an extension point for applications that need to evaluate the realm on a request basis. During the authentication
        and authorization phase of the incoming request, Keycloak queries the application via this extension point and expects the application
        to return a complete representation of the realm. With this, Keycloak then proceeds the authentication and authorization process,
        accepting or refusing the request based on the incoming credentials and on the returned realm.

        For this scenario, an application needs to:

        </p><div class="itemizedlist"><ul><li>
                Add a context parameter to the <code class="literal">web.xml</code>, named <code class="literal">keycloak.config.resolver</code>.
                The value of this property should be the fully qualified name of the class extending
                <code class="literal">org.keycloak.adapters.KeycloakConfigResolver</code>.
            </li><li>
                A concrete implementation of <code class="literal">org.keycloak.adapters.KeycloakConfigResolver</code>. Keycloak will call the
                <code class="literal">resolve(org.keycloak.adapters.spi.HttpFacade.Request)</code> method and expects a complete
                <code class="literal">org.keycloak.adapters.KeycloakDeployment</code> in response. Note that Keycloak will call this for every request,
                so, take the usual performance precautions.
            </li></ul></div><p>
    </p>
    <p>
        An implementation of this feature can be found in the examples.
    </p>
</div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="jaas-adapter"/>8.14. JAAS plugin</h2></div></div></div>
    
    <p>
        It's generally not needed to use JAAS for most of the applications, especially if they are HTTP based, but directly choose one of our adapters.
        However some applications and systems may still rely on pure legacy JAAS solution. Keycloak provides couple of login modules
        to help with such use cases. Some login modules provided by Keycloak are:
    </p>
    <p>
        </p><div class="variablelist"><dl><dt><span class="term">org.keycloak.adapters.jaas.DirectAccessGrantsLoginModule</span></dt><dd>
                    <p>
                        This login module allows to authenticate with username/password from Keycloak database. It's using
                        <a class="link" href="#direct-access-grants" title="Chapter 15. Direct Access Grants">Direct Access Grants</a> Keycloak endpoint to validate on Keycloak side if provided username/password is valid.
                        It's useful especially for non-web based systems, which need to rely on JAAS and want to use Keycloak credentials, but can't use classic browser based
                        authentication flow due to their non-web nature. Example of such application could be messaging application or SSH system.
                    </p>
                </dd><dt><span class="term">org.keycloak.adapters.jaas.BearerTokenLoginModule</span></dt><dd>
                    <p>
                        This login module allows to authenticate with Keycloak access token passed to it through CallbackHandler as password.
                        It may be useful for example in case, when you have Keycloak access token from classic web based authentication flow
                        and your web application then needs to talk to external non-web based system, which rely on JAAS. For example to JMS/messaging system.
                    </p>
                </dd></dl></div><p>
    </p>
    <p>
        Both login modules have configuration property <code class="literal">keycloak-config-file</code> where you need to provide location of keycloak.json configuration file.
        It could be either provided from filesystem or from classpath (in that case you may need value like <code class="literal">classpath:/folder-on-classpath/keycloak.json</code> ).
    </p>
    <p>
        Second property <code class="literal">role-principal-class</code> allows to specify alternative class for Role principals attached to JAAS Subject. Default
        value for Role principal is <code class="literal">org.keycloak.adapters.jaas.RolePrincipal</code> . Note that class should have constructor
        with single String argument.
    </p>
</div>
    </div>

    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="identity-broker"/>Chapter 9. Identity Broker</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e1377">9.1. Overview</a></span></dt><dt><span class="section"><a href="#d4e1409">9.2. Configuration</a></span></dt><dt><span class="section"><a href="#d4e1480">9.3. Social Identity Providers</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e1483">9.3.1. Google</a></span></dt><dt><span class="section"><a href="#d4e1552">9.3.2. Facebook</a></span></dt><dt><span class="section"><a href="#d4e1622">9.3.3. Twitter</a></span></dt><dt><span class="section"><a href="#d4e1675">9.3.4. Github</a></span></dt><dt><span class="section"><a href="#d4e1727">9.3.5. LinkedIn</a></span></dt><dt><span class="section"><a href="#d4e1783">9.3.6. StackOverflow</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e1825">9.4. SAML v2.0 Identity Providers</a></span></dt><dt><span class="section"><a href="#d4e1889">9.5. OpenID Connect v1.0 Identity Providers</a></span></dt><dt><span class="section"><a href="#d4e1948">9.6. Retrieving Tokens from Identity Providers</a></span></dt><dt><span class="section"><a href="#d4e1961">9.7. Automatically Select and Identity Provider</a></span></dt><dt><span class="section"><a href="#d4e1973">9.8. Mapping/Importing SAML and OIDC Metadata</a></span></dt><dt><span class="section"><a href="#d4e1978">9.9. Mapping/Importing User profile data from Social Identity Provider</a></span></dt><dt><span class="section"><a href="#d4e1986">9.10. User Session Data</a></span></dt><dt><span class="section"><a href="#d4e1994">9.11. Examples</a></span></dt></dl></div>
    

    <p>
        An Identity Broker is an intermediary service that connects multiple service providers with different identity providers.
        As an intermediary service, the identity broker is responsible to create a trust relationship with an external
        identity provider in order to use its identities to access internal services exposed by service providers.
    </p>

    <p>
        From an user perspective, an identity broker provides an user-centric and centralized way to manage identities across
        different security domains or realms, where an existing account can be linked with one or more identities from different
        identity providers or even created based on the identity information obtained from them.
    </p>

    <p>
        An identity provider is usually based on a specific protocol in order to authenticate and communicate authentication and
        authorization information to their users. It can be a social provider such as Facebook, Google or Twitter, a business partner
        which you want to allow its users to access your services or a cloud-based identity service that you want to integrate with.
        Usually, identity providers are based on the following protocols:
    </p>

    <div class="itemizedlist"><ul><li>
            <p>
                <code class="literal">SAML v2.0</code>
            </p>
        </li><li>
            <p>
                <code class="literal">OpenID Connect v1.0</code>
            </p>
        </li><li>
            <p>
                <code class="literal">oAuth v2.0</code>
            </p>
        </li></ul></div>

    <p>
        In the next sections we'll see how to configure and use Keycloak as an identity broker, covering some important aspects such as:
    </p>

    <div class="itemizedlist"><ul><li>
            <p>
                <code class="literal">Social Authentication</code>
            </p>
        </li><li>
            <p>
                <code class="literal">OpenID Connect v1.0 Brokering</code>
            </p>
        </li><li>
            <p>
                <code class="literal">SAML v2.0 Brokering</code>
            </p>
        </li><li>
            <p>
                <code class="literal">Identity Federation</code>
            </p>
        </li></ul></div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e1377"/>9.1. Overview</h2></div></div></div>
        

        <p>
            When using Keycloak as an identity broker, users are not forced to provide their credentials in order to
            authenticate in a specific realm. Instead of that, they are presented with a list of identity providers from
            where they can pick one and authenticate. You can also configure a hard-coded default broker.  In this case
            the user will not be given a choice, but instead be redirected directly the the parent broker.
            The following diagram demonstrates the steps involved when using
            Keycloak to broker an external identity provider:
        </p>

        <p>
        	<img src="images/identity_broker_flow.png"/>
        </p>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                <p>
                    User is not authenticated and requests a protected resource in a service provider.
                </p>
            </li><li>
                <p>
                    The service provider redirects the user to Keycloak to authenticate.
                </p>
            </li><li>
                <p>
                    At this point the user is presented to the login page where there is a list of identity providers supported by a realm.
                </p>
            </li><li>
                <p>
                    User selects one of the identity providers by clicking on its respective button or link.
                </p>
            </li><li>
                <p>
                    Keycloak issues an authentication request to the target identity provider asking for authentication and the
                    user is redirect to the login page or just to a consent page in the identity provider.
                    The connection properties and other configuration options for the identity provider were previously
                    set by the administrator in the admin console.
                </p>
            </li><li>
                <p>
                    User provides his credentials or consent in order to authenticate in the identity provider.
                </p>
            </li><li>
                <p>
                    Upon a successful authentication by the identity provider, the user is redirected back to Keycloak
                    with an authentication response. Usually this response contains a security token that will be used
                    by Keycloak to trust the authentication performed by the identity provider and retrieve information
                    about the user.
                </p>
            </li><li>
                <p>
                    Now Keycloak is going to check if the response from the identity provider is valid. If valid, it will create an user
                    or just skip that if the user already exists. If it is a new user, Keycloak will ask informations about the user to the identity provider
                    (or just read that from a security token) and create the user locally. This is what we call <span class="emphasis"><em>identity federation</em></span>.
                    If the user already exists Keycloak will ask him to link the identity returned from the identity provider
                    with his existing account. A process that we call <span class="emphasis"><em>account linking</em></span>.
                    At the end of this step, Keycloak authenticates the user and issues its own token in order to access
                    the requested resource in the service provider.
                </p>
            </li><li>
                <p>
                    Once the user is locally authenticated, Keycloak redirects the user to the service provider by sending
                    the token previously issued during the local authentication.
                </p>
            </li><li>
                <p>
                    The service provider receives the token from Keycloak and allows access to the protected resource.
                </p>
            </li></ol></div>

        <p>
            There are some variations of this flow that we will talk about later. For instance, instead of present a
            list of identity providers, the service provider can automatically select a specific one to authenticate an user.
            Or you can tell Keycloak to force the user to provide additional information before federate his identity.
        </p>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2>
            <p>
                Different protocols may require different authentication flows. At this moment, all the identity providers
                supported by KeyCloak use a flow just like described above. However, despite the protocol in use, user experience should
                be pretty much the same.
            </p>
        </div>

        <p>
            As you may notice, at the end of the authentication process Keycloak will always issue its own token
            to service providers, what means that service providers are completely decoupled from external identity providers.
            They don't need to know which protocol (eg.: SAML, OpenID Connect, oAuth, etc) was used or how the user's
            identity was validated. They only need to know about Keycloak !
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e1409"/>9.2. Configuration</h2></div></div></div>
        
        <p>
            The identity broker configuration is all based on identity providers. Identity providers are created for each
            realm and by default they are enabled for every single application. That means that users from a realm can use any
            of the registered identity providers when signing in to an application.
        </p>
        <p>
            In order to create an identity provider, follow these steps:
        </p>
        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                <p>In the admin console, select a realm.</p>
            </li><li>
                <p>On the left side menu, click on <code class="literal">Settings</code>.</p>
            </li><li>
                <p>
                    Select the <code class="literal">Identity Provider</code> tab on the settings page.
                </p>
            </li><li>
                <p>
                    You should now be able to see a table that lists all registered identity providers.
                    To add a new identity provider, click the select box on the top right of this table and select
                    which type of identity provider you want to create.
                </p>
            </li></ol></div>
        <p>
            Identity providers are organized in two main categories:
        </p>
        <div class="variablelist"><dl><dt><span class="term">Social</span></dt><dd>
                    <p>
                        Social providers allows you to enable social authentication to your realm.
                        Keycloak makes it easy to let users log in to your application using an existing account with a social network.
                        Currently Facebook, Google and Twitter are supported with more planned for the future.
                    </p>
                </dd><dt><span class="term">Protocol-based</span></dt><dd>
                    <p>
                        Protocol-based providers are those that rely on a specific protocol in order to authenticate and authorize
                        users. They allow you to connect to any identity provider compliant with a specific protocol.
                        Keycloak provides support for SAML v2.0 and OpenID Connect v1.0 protocols.
                        It makes it easy to configure and broker any identity provider based on these open standards.
                    </p>
                </dd></dl></div>
        <p>
            Although each type of identity provider has its own configuration options, all of them share some very common configuration.
            Regardless the identity provider you are creating, you'll see the following configuration options avaiable:
        </p>
        <div class="table"><a id="d4e1435"/><p class="title"><b>Table 9.1. Common Configuration</b></p><div class="table-contents">
            
            <table summary="Common Configuration" border="1"><colgroup><col/><col/></colgroup><thead><tr><th align="left">
                            Configuration
                        </th><th align="left">
                            Description
                        </th></tr></thead><tbody valign="top"><tr><td align="left" valign="top">
                            <code class="literal">Alias</code>
                        </td><td align="left" valign="top">
                            The alias is an unique identifier for an identity provider. It is used to reference internally an identity provider.
                            Some protocols require a <span class="emphasis"><em>redirect uri or callback url</em></span> in order to communicate with an identity provider. For instance, OpenID Connect.
                            In this case, the alias is used to build the redirect uri.
                            Every single identity provider must have an alias. For example, facebook, google, idp.acme.com, etc.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Name</code>
                        </td><td align="left" valign="top">
                            You can give a friendly name to an identity provider.
                            The name will be used, for example, to display a link or a button in the login page.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Enabled</code>
                        </td><td align="left" valign="top">
                            Allows you to enable or disable an identity provider.
                            When disabled, the identity provider will not be available from the login page and can not
                            be used by any other means.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Store Tokens</code>
                        </td><td align="left" valign="top">
                            Any external tokens provided by the parent IDP will be stored.
                            This options is useful if you are using social authentication and need to access the token in order to invoke the
                            API of a social provider on behalf of the user.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Stored Tokens Readable</code>
                        </td><td align="left" valign="top">
                            Automatically assigns a <code class="literal">broker.read-token</code> role that allows the user
                            to access any stored external tokens via the broker service.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Update Profile on First Login</code>
                        </td><td align="left" valign="top">
                            Allows you to force users to update their profile right after the authentication finishes and
                            before the account is actually created in Keycloak. When "On", users will be always presented with the
                            <span class="emphasis"><em>update profile page</em></span> asking for additional information in order to federate their identities.
                            When "On missing info", users will be presented with the <span class="emphasis"><em>update profile page</em></span> only if some 
                            mandatory information (email, first name, last name) is not provided by identity provider.
                            If "Off", the account will be created with the minimal information obtained from the identity provider
                            during the authentication process.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Trust email</code>
                        </td><td align="left" valign="top">
                            Allows you to trust email address returned from the social provider. If enabled then email address returned by the provider 
                            is marked as 'verified' in the Keycloak user profile. This means that email verification step is skipped even 
                            if "Verify email" feature is enabled in realm settings.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">GUI order</code>
                        </td><td align="left" valign="top">
                            Allows you to define order of the provider when shown on login page. 
                            You can put number into this field, providers with lower numbers are shown first.
                        </td></tr></tbody></table>
        </div></div><br class="table-break"/>
        <p>
            On the next sections, we'll see how to configure each type of identity provider individually.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e1480"/>9.3. Social Identity Providers</h2></div></div></div>
        
        <p>
            Forcing users to register to your realm when they want to access applications is hard.
            So is trying to remember yet another username and password combination.
            Social identity providers makes it easy for users to register on your realm and quickly sign in using a social network.
            Keycloak provides built-in support for the most common social networks out there, such as Google, Facebook, Twitter and
            even Github.
        </p>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1483"/>9.3.1. Google</h3></div></div></div>
            
            <p>
                To enable login with Google you first have to create a project and a client in the
                <a class="ulink" href="https://cloud.google.com/console/project">Google Developer Console</a>. Then you need to copy
                the client id and secret into the Keycloak Admin Console.
            </p>
            <p>
                Let's see first how to create a project with Google.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Log in to the <a class="ulink" href="https://cloud.google.com/console/project">Google Developer Console</a>. Click the
                        <code class="literal">Create Project</code> button. Use any value for <code class="literal">Project name</code> and
                        <code class="literal">Project ID</code> you want, then click the <code class="literal">Create</code> button. Wait for the project to
                        be created (this may take a while).
                    </p>
                </li><li>
                    <p>
                        Once the project has been created click on <code class="literal">APIs &amp; auth</code> in sidebar on the left. To retrieve
                        user profiles the <code class="literal">Google+ API</code> has to be enabled. Scroll down to find it in the list. If its
                        status is <code class="literal">OFF</code>, click on <code class="literal">OFF</code> to enable it (it should move to the top of
                        the list and the status should be <code class="literal">ON</code>).
                    </p>
                </li><li>
                    <p>
                        Now click on the <code class="literal">Consent screen</code> link on the sidebar menu on the left.  You must specify
                        a project name and choose an email for the consent screen.  Otherwise users will get a login error.  There's
                        other things you can configure here like what the consent screen looks like.  Feel free to play around with this.
                    </p>
                </li><li>
                    <p>
                        Now click <code class="literal">Credentials</code> in the sidebar on the left. Then click
                        <code class="literal">Create New Client ID</code>. Select <code class="literal">Web application</code> as
                        <code class="literal">Application type</code>. Empty the <code class="literal">Authorized Javascript origins</code> textarea.
                        Click the <code class="literal">Create Client ID</code> button.
                    </p>
                </li><li>
                    <p>
                        Copy <code class="literal">Client ID</code> and <code class="literal">Client secret</code>.
                    </p>
                </li></ol></div>
            <p>
                Now that you have the client id and secret, you can proceed with the creation of a Google Identity Provider in Keycloak. As follows:
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Select the <code class="literal">Google</code> identity provider from the drop-down box on the top right corner of the identity providers table in Keycloak's Admin Console. You should be presented with a specific page to configure the selected provided.
                    </p>
                </li><li>
                    <p>
                        Copy the client id and secret to their corresponding fields in the Keycloak Admin Console. Click <code class="literal">Save</code>.
                    </p>
                </li></ol></div>
            <p>
                Once you create the identity provider in Keycloak, you must update your Google project with the redirect url that was
                generated to your identity provider.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Open the Google Developer Console and select your project. Click <code class="literal">Credentials</code> in the
                        sidebar on the left. In <code class="literal">Authorized redirect URI</code> insert the redirect uri created by Keycloak. The redirect uri
                        usually have the following format: <code class="literal">http://{host}:{port}/auth/realms/{realm}/broker/{provider_alias}</code>.
                    </p>
                </li></ol></div>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2>
                <p>
                    You can always get the redirect url for a specific identity provider from the table presented when you
                    click on the 'Identity Provider' tab in <span class="emphasis"><em>Realm &gt; Settings</em></span>.
                </p>
            </div>
            <p>
                That is it! This is pretty much what you need to do in order to setup this identity provider.
            </p>
            <p>
                The table below lists some additional configuration options you may use when configuring this provider.
            </p>
            <div class="table"><a id="d4e1538"/><p class="title"><b>Table 9.2. Configuration Options</b></p><div class="table-contents">
                
                <table summary="Configuration Options" border="1"><colgroup><col/><col/></colgroup><thead><tr><th align="left">
                                Configuration
                            </th><th align="left">
                                Description
                            </th></tr></thead><tbody valign="top"><tr><td align="left" valign="top">
                                <code class="literal">Default Scopes</code>
                            </td><td align="left" valign="top">
                                Allows you to manually specify the scopes that users must authorize when authenticating with this provider. For a complete list of scopes, please take a look at <a class="ulink" href="https://developers.google.com/oauthplayground/">https://developers.google.com/oauthplayground/</a>. By default, Keycloak uses the following scopes: <code class="literal">openid profile email</code>
                            </td></tr></tbody></table>
            </div></div><br class="table-break"/>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1552"/>9.3.2. Facebook</h3></div></div></div>
            
            <p>
                To enable login with Facebook you first have to create an application in the
                <a class="ulink" href="https://developers.facebook.com/">Facebook Developer Console</a>. Then you need to copy
                the client id and secret into the Keycloak Admin Console.
            </p>
            <p>
                Let's see first how to create an application with Facebook.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Log in to the <a class="ulink" href="https://developers.facebook.com/">Facebook Developer Console</a>. Click
                        <code class="literal">Apps</code> in the menu and select <code class="literal">Create a New App</code>. Use any value for
                        <code class="literal">Display Name</code> and <code class="literal">Category</code> you want, then click the
                        <code class="literal">Create App</code> button. Wait for the project to be created (this may take a while). If after
                        creating the app you are not redirected to the app settings, click on <code class="literal">Apps</code> in the
                        menu and select the app you created.
                    </p>
                </li><li>
                    <p>
                        Once the app has been created click on <code class="literal">Settings</code> in sidebar on the left. You must specify
                        a contact email.  Save your changes.  Then click
                        on <code class="literal">Advanced</code>. Under <code class="literal">Security</code> make sure
                        <code class="literal">Client OAuth Login</code> is enabled. Scroll down and click on the <code class="literal">Save Changes</code> button.
                    </p>
                </li><li>
                    <p>
                        Click <code class="literal">Status &amp; Review</code> and select <code class="literal">YES</code> for <code class="literal">Do you want
                        to make this app and all its live features available to the general public?</code>.  You will
                        not be able to set this until you have provided a contact email in the general settings of this application.
                    </p>
                </li><li>
                    <p>
                        Click <code class="literal">Basic</code>. Copy <code class="literal">App ID</code> and <code class="literal">App Secret</code>
                        (click <code class="literal">show</code>) from the <a class="ulink" href="https://developers.facebook.com/">Facebook Developer Console</a>.
                    </p>
                </li></ol></div>
            <p>
                Now that you have the client id and secret, you can proceed with the creation of a Facebook Identity Provider in Keycloak. As follows:
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Select the <code class="literal">Facebook</code> identity provider from the drop-down box on the top right corner of the identity providers table in Keycloak's Admin Console. You should be presented with a specific page to configure the selected provided.
                    </p>
                </li><li>
                    <p>
                        Copy the client id and secret to their corresponding fields in the Keycloak Admin Console. Click <code class="literal">Save</code>.
                    </p>
                </li></ol></div>
            <p>
                Once you create the identity provider in Keycloak, you must update your Facebook application with the redirect url that was
                generated to your identity provider.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Open the Facebook Developer Console and select your application. Click
                        on <code class="literal">Advanced</code>. Under <code class="literal">Security</code> make sure
                        <code class="literal">Client OAuth Login</code> is enabled. In <code class="literal">Valid OAuth redirect URIs</code> insert
                        the redirect uri created by Keycloak. The redirect uri
                        usually have the following format: <code class="literal">http://{host}:{port}/auth/realms/{realm}/broker/{provider_alias}</code>.
                    </p>
                </li></ol></div>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2>
                <p>
                    You can always get the redirect url for a specific identity provider from the table presented when you
                    click on the 'Identity Provider' tab in <span class="emphasis"><em>Realm &gt; Settings</em></span>.
                </p>
            </div>
            <p>
                That is it! This pretty much what you need to do in order to setup this identity 		provider.
            </p>
            <p>
                The table below lists some additional configuration options you may use when configuring this provider.
            </p>
            <div class="table"><a id="d4e1608"/><p class="title"><b>Table 9.3. Configuration Options</b></p><div class="table-contents">
                
                <table summary="Configuration Options" border="1"><colgroup><col/><col/></colgroup><thead><tr><th align="left">
                                Configuration
                            </th><th align="left">
                                Description
                            </th></tr></thead><tbody valign="top"><tr><td align="left" valign="top">
                                <code class="literal">Default Scopes</code>
                            </td><td align="left" valign="top">
                                Allows you to manually specify the scopes that users must authorize when authenticating with this provider. For a complete list of scopes, please take a look at <a class="ulink" href="https://developers.facebook.com/docs/graph-api">https://developers.facebook.com/docs/graph-api</a>. By default, Keycloak uses the following scopes: <code class="literal">email</code>
                            </td></tr></tbody></table>
            </div></div><br class="table-break"/>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1622"/>9.3.3. Twitter</h3></div></div></div>
            
            <p>
                To enable login with Twtter you first have to create an application in the
                <a class="ulink" href="https://dev.twitter.com/apps">Twitter Developer Console</a>. Then you need to copy
                the consumer key and secret into the Keycloak Admin Console.
            </p>
            <p>
                Let's see first how to create an application with Twitter.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Log in to the <a class="ulink" href="https://dev.twitter.com/apps">Twitter Developer Console</a>. Click the
                        <code class="literal">Create a new application</code> button. Use any value for <code class="literal">Name</code>,
                        <code class="literal">Description</code> and <code class="literal">Website</code> you want. Insert the social callback url
                        in <code class="literal">Callback URL</code>. Then click <code class="literal">Create your Twitter application</code>.
                    </p>
                </li><li>
                    <p>
                        Now click on <code class="literal">Settings</code> and tick the box <code class="literal">Allow this application to be used to Sign in with Twitter</code>,
                        then click on <code class="literal">Update this Twitter application's settings</code>.
                    </p>
                </li><li>
                    <p>
                        Now click <code class="literal">API Keys</code> tab. Copy <code class="literal">API key</code> and <code class="literal">API secret</code> from the
                        <a class="ulink" href="https://dev.twitter.com/apps">Twitter Developer Console</a>.
                    </p>
                </li></ol></div>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2>
                <p>
                    Twitter doesn't allow <code class="literal">localhost</code> in the redirect URI. To test on a local server
                    replace <code class="literal">localhost</code> with <code class="literal">127.0.0.1</code>.
                </p>
            </div>

            <p>
                Now that you have the client id and secret, you can proceed with the creation of a Twitter Identity Provider in Keycloak. As follows:
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Select the <code class="literal">Twitter</code> identity provider from the drop-down box on the top right corner of the identity providers table in Keycloak's Admin Console. You should be presented with a specific page to configure the selected provided.
                    </p>
                </li><li>
                    <p>
                        Copy the client id and secret to their corresponding fields in the Keycloak Admin Console. Click <code class="literal">Save</code>.
                    </p>
                </li></ol></div>
            <p>
                That is it! This pretty much what you need to do in order to setup this identity 		provider.
            </p>
            <p>
                The table below lists some additional configuration options you may use when configuring this provider.
            </p>
            <div class="table"><a id="d4e1663"/><p class="title"><b>Table 9.4. Configuration Options</b></p><div class="table-contents">
                
                <table summary="Configuration Options" border="1"><colgroup><col/><col/></colgroup><thead><tr><th align="left">
                                Configuration
                            </th><th align="left">
                                Description
                            </th></tr></thead><tbody valign="top"><tr><td align="left" valign="top">
                                <code class="literal">Default Scopes</code>
                            </td><td align="left" valign="top">
                                Not supported by Twitter.
                            </td></tr></tbody></table>
            </div></div><br class="table-break"/>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1675"/>9.3.4. Github</h3></div></div></div>
            
            <p>
                To enable login with GitHub you first have to create an application in
                <a class="ulink" href="https://github.com/settings/applications">GitHub Settings</a>. Then you need to copy
                the client id and secret into the Keycloak Admin Console.
            </p>
            <p>
                Let's see first how to create an application with GitHub.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Log in to <a class="ulink" href="https://github.com/settings/applications">GitHub Settings</a>. Click the
                        <code class="literal">Register new application</code> button. Use any value for <code class="literal">Application name</code>,
                        <code class="literal">Homepage URL</code> and <code class="literal">Application Description</code> you want. Click the
                        <code class="literal">Register application</code> button.
                    </p>
                </li><li>
                    <p>
                        Copy <code class="literal">Client ID</code> and <code class="literal">Client Secret</code> from the <a class="ulink" href="https://github.com/settings/applications">GitHub Settings</a>.
                    </p>
                </li></ol></div>
            <p>
                Now that you have the client id and secret, you can proceed with the creation of a Github Identity Provider in Keycloak. As follows:
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Select the <code class="literal">Github</code> identity provider from the drop-down box on the top right corner of the identity providers table in Keycloak's Admin Console. You should be presented with a specific page to configure the selected provided.
                    </p>
                </li><li>
                    <p>
                        Copy the client id and secret to their corresponding fields in the Keycloak Admin Console. Click <code class="literal">Save</code>.
                    </p>
                </li></ol></div>
            <p>
                Once you create the identity provider in Keycloak, you must update your GitHub application with the redirect url that was
                generated to your identity provider.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Open the GitHub Settings and select your application. In <code class="literal">Authorization callback URL</code>
                        insert the redirect uri created by Keycloak. The redirect uri
                        usually have the following format: <code class="literal">http://{host}:{port}/auth/realms/{realm}/broker/{provider_alias}</code>.
                    </p>
                </li></ol></div>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2>
                <p>
                    You can always get the redirect url for a specific identity provider from the table presented when you
                    click on the 'Identity Provider' tab in <span class="emphasis"><em>Realm &gt; Settings</em></span>.
                </p>
            </div>
            <p>
                That is it! This pretty much what you need to do in order to setup this identity 		provider.
            </p>
            <p>
                The table below lists some additional configuration options you may use when configuring this provider.
            </p>
            <div class="table"><a id="d4e1713"/><p class="title"><b>Table 9.5. Configuration Options</b></p><div class="table-contents">
                
                <table summary="Configuration Options" border="1"><colgroup><col/><col/></colgroup><thead><tr><th align="left">
                                Configuration
                            </th><th align="left">
                                Description
                            </th></tr></thead><tbody valign="top"><tr><td align="left" valign="top">
                                <code class="literal">Default Scopes</code>
                            </td><td align="left" valign="top">
                                Allows you to manually specify the scopes that users must authorize when authenticating with this provider. For a complete list of scopes, please take a look at <a class="ulink" href="https://developer.github.com/v3/oauth/#scopes">https://developer.github.com/v3/oauth/#scopes</a>. By default, Keycloak uses the following scopes: <code class="literal">user:email</code>
                            </td></tr></tbody></table>
            </div></div><br class="table-break"/>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1727"/>9.3.5. LinkedIn</h3></div></div></div>
            
            <p>
                To enable login with LinkedIn you first have to create an application in
                <a class="ulink" href="https://www.linkedin.com/secure/developer">LinkedIn Developer Network</a>. Then you need to copy
                the client id and secret into the Keycloak Admin Console.
            </p>
            <p>
                Let's see first how to create an application with LinkedIn.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Log in to <a class="ulink" href="https://www.linkedin.com/secure/developer">LinkedIn Developer Network</a>. Click the
                        <code class="literal">Add New Application</code> link. Use any value for <code class="literal">Application Name</code>,
                        <code class="literal">Website URL</code>, <code class="literal">Description</code>, <code class="literal">Developer Contact Email</code> and <code class="literal">Phone</code> you want.
                        Select <code class="literal">r_basicprofile</code> and <code class="literal">r_emailaddress</code> in the <code class="literal">Default Scope</code> section. 
                        Click the <code class="literal">Add Application</code> button.
                    </p>
                </li><li>
                    <p>
                        Copy <code class="literal">Consumer Key / API Key</code> and <code class="literal">Consumer Secret / Secret Key</code> from the shown page.
                    </p>
                </li></ol></div>
            <p>
                Now that you have the client id and secret, you can proceed with the creation of a LinkedIn Identity Provider in Keycloak. As follows:
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Select the <code class="literal">LinkedIn</code> identity provider from the drop-down box on the top right corner of the identity providers table in Keycloak's Admin Console. You should be presented with a specific page to configure the selected provided.
                    </p>
                </li><li>
                    <p>
                        Copy the client id and secret to their corresponding fields in the Keycloak Admin Console. Click <code class="literal">Save</code>.
                    </p>
                </li></ol></div>
            <p>
                Once you create the identity provider in Keycloak, you must update your LinkedIn application with the redirect url that was
                generated to your identity provider.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Open the LinkedIn Developer Network and select your application. In <code class="literal">OAuth 2.0 Redirect URLs</code>
                        insert the redirect uri created by Keycloak. The redirect uri
                        usually have the following format: <code class="literal">http://{host}:{port}/auth/realms/{realm}/broker/{provider_alias}/endpoint</code>.
                    </p>
                </li></ol></div>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2>
                <p>
                    You can always get the redirect url for a specific identity provider from the table presented when you
                    click on the 'Identity Provider' tab in <span class="emphasis"><em>Realm &gt; Settings</em></span>.
                </p>
            </div>
            <p>
                That is it! This pretty much what you need to do in order to setup this identity provider.
            </p>
            <p>
                The table below lists some additional configuration options you may use when configuring this provider.
            </p>
            <div class="table"><a id="d4e1769"/><p class="title"><b>Table 9.6. Configuration Options</b></p><div class="table-contents">
                
                <table summary="Configuration Options" border="1"><colgroup><col/><col/></colgroup><thead><tr><th align="left">
                                Configuration
                            </th><th align="left">
                                Description
                            </th></tr></thead><tbody valign="top"><tr><td align="left" valign="top">
                                <code class="literal">Default Scopes</code>
                            </td><td align="left" valign="top">
                                Allows you to manually specify the scopes that users must authorize when authenticating with this provider. 
                                For a complete list of scopes, please take a look at application configuration in <a class="ulink" href="https://www.linkedin.com/secure/developer">LinkedIn Developer Network</a>. By default, Keycloak uses the following scopes: <code class="literal">r_basicprofile r_emailaddress</code>
                            </td></tr></tbody></table>
            </div></div><br class="table-break"/>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1783"/>9.3.6. StackOverflow</h3></div></div></div>
            
            <p>
                To enable login with StackOverflow you first have to register an OAuth application on
                <a class="ulink" href="https://stackapps.com/">StackApps</a>. Then you need to copy the client id, secret and key into the Keycloak Admin Console.
            </p>
            <p>
                Let's see first how to create an application with StackOverflow.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Go to <a class="ulink" href="http://stackapps.com/apps/oauth/register">registering your application on Stack Apps</a> url and login here. 
                        Use any value for <code class="literal">Application Name</code>, <code class="literal">Application Website</code> and <code class="literal">Description</code> you want.
                        Set <code class="literal">OAuth Domain</code> to the domain where your Keycloak instance runs.
                        Click the <code class="literal">Register Your Application</code> button.
                    </p>
                </li><li>
                    <p>
                        Copy <code class="literal">Client Id</code>, <code class="literal">Client Secret</code> and <code class="literal">Key</code> from the shown page.
                    </p>
                </li></ol></div>
            <p>
                Now that you have the client id, secret and key, you can proceed with the creation of a StackOverflow Identity Provider in Keycloak. As follows:
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Select the <code class="literal">StackOverflow</code> identity provider from the drop-down box on the top right corner of the identity providers table in Keycloak's Admin Console. You should be presented with a specific page to configure the selected provided.
                    </p>
                </li><li>
                    <p>
                        Copy the client id, client secret and key to their corresponding fields in the Keycloak Admin Console. Click <code class="literal">Save</code>.
                    </p>
                </li></ol></div>
            <p>
                That is it! This pretty much what you need to do in order to setup this identity provider.
            </p>
            <p>
                The table below lists some additional configuration options you may use when configuring this provider.
            </p>
            <div class="table"><a id="d4e1812"/><p class="title"><b>Table 9.7. Configuration Options</b></p><div class="table-contents">
                
                <table summary="Configuration Options" border="1"><colgroup><col/><col/></colgroup><thead><tr><th align="left">
                                Configuration
                            </th><th align="left">
                                Description
                            </th></tr></thead><tbody valign="top"><tr><td align="left" valign="top">
                                <code class="literal">Default Scopes</code>
                            </td><td align="left" valign="top">
                                Allows you to manually specify the scopes that users must authorize when authenticating with this provider. 
                                For a complete list of scopes, please take a look at application configuration in <a class="ulink" href="https://api.stackexchange.com/docs/authentication#scope">StackExchange API Authentication</a> documentation. Keycloak uses the empty scope by default.
                            </td></tr></tbody></table>
            </div></div><br class="table-break"/>
        </div>        
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e1825"/>9.4. SAML v2.0 Identity Providers</h2></div></div></div>
        
        <p>
            Keycloak can broker identity providers based on the SAML v2.0 protocol.
        </p>
        <p>
            In order to configure a SAML identity provider, follow these steps:
        </p>
        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                <p>
                    Select the <code class="literal">SAML v2.0</code> identity provider from the drop-down box on the top right
                    corner of the identity providers table in Keycloak's Admin Console.
                    You should be presented with a specific page to configure the selected provider.
                </p>
            </li></ol></div>
        <p>
            When configuring a SAML identity provider you are presented with different configuration options in order to
            properly communicate and integrate with the external identity provider.
            In this case, you must keep in mind that Keycloak will act as an Service Provider that issues authentication requests(AuthnRequest)
            to the external identity provider.
        </p>
        <div class="table"><a id="d4e1834"/><p class="title"><b>Table 9.8. Configuration Options</b></p><div class="table-contents">
            
            <table summary="Configuration Options" border="1"><colgroup><col/><col/></colgroup><thead><tr><th align="left">
                            Configuration
                        </th><th align="left">
                            Description
                        </th></tr></thead><tbody valign="top"><tr><td align="left" valign="top">
                            <code class="literal">Import IdP SAML Metadata</code>
                        </td><td align="left" valign="top">
                            When creating a new identity provider, you may just upload the SAML Metadata for the brokered IdP (IDPSSODescriptor). In this case, Keycloak will read all the necessary configuration from the metadata and automatically configure the identity provider for you.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Single Sign-On Service Url</code>
                        </td><td align="left" valign="top">
                            Allows you to specify the URL that will be used to send SAML authentication requests.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Single Logout Service Url</code>
                        </td><td align="left" valign="top">
                            Allows you to specify the URL that will be used to send SAML logout requests.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Backchannel Logout</code>
                        </td><td align="left" valign="top">
                            If set to true, logout to the external IDP will be done in a background HTTP request.  If
                            set to false, then the browser will be redirected to the external IDP to perform the logout.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">NameID Policy Format</code>
                        </td><td align="left" valign="top">
                            Allows you to specify a NameID Policy that will be sent in the SAML authentication request.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Validating X509 Certificate</code>
                        </td><td align="left" valign="top">
                            Allows you to specify the certificate in PEM format that will be used to validate signatures for all messages received from the brokered identity provider.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Want AuthnRequests Signed</code>
                        </td><td align="left" valign="top">
                            Allows you to specify whether the brokered identity provider is expecting signed SAML authentication requests or not.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Force Authentication</code>
                        </td><td align="left" valign="top">
                            Allows you to tell the brokered identity provider that user must be authenticated even if he was previously authenticated (re-authentication) in the same session.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Validate Signature</code>
                        </td><td align="left" valign="top">
                            Enable or disable signature validation of any message returned by the brokered identity provider.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">HTTP-POST Binding Response</code>
                        </td><td align="left" valign="top">
                            Allows you to specify if responses from the brokered identity providers are returned using the HTTP-POST or HTTP-Redirect protocol bindings. If enabled, only responses using HTTP-POST binding are accepted.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">HTTP-POST Binding for AuthnReques</code>
                        </td><td align="left" valign="top">
                            Allows you to specify wheter SAML authentication requests must be sent using the HTTP-POST or HTTP-Redirect protocol bindings. If enabled, it will send requests using HTTP-POST binding.
                        </td></tr></tbody></table>
        </div></div><br class="table-break"/>
        <p>
            You can also import all this configuration data by providing a URL or XML file that points to the entity descriptor of the external
            SAML IDP you want to connect to.
        </p>
        <p>
            Once you create a SAML provider, there is an <code class="literal">EXPORT</code> button that appears when viewing that provider.
            Clicking this button will export a SAML entity descriptor which you can use to
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e1889"/>9.5. OpenID Connect v1.0 Identity Providers</h2></div></div></div>
        
        <p>
            Keycloak can broker identity providers based on the OpenID Connect v1.0 protocol.
        </p>
        <p>
            In order to configure a OIDC identity provider, follow these steps:
        </p>
        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                <p>
                    Select the <code class="literal">OpenID Connect v1.0</code> identity provider from the drop-down box on the top right corner of the identity providers table in Keycloak's Admin Console. You should be presented with a specific page to configure the selected provider.
                </p>
            </li></ol></div>
        <p>
            When configuring an OIDC identity provider you are presented with different configuration options in order to send authentication requests to the external identity provider. In this case, the brokered identity provider must support the Authorization Code Flow (as defined by the specification) in order to authenticate the user and authorize access for the scopes specified in the configuration.
        </p>
        <div class="table"><a id="d4e1898"/><p class="title"><b>Table 9.9. Configuration Options</b></p><div class="table-contents">
            
            <table summary="Configuration Options" border="1"><colgroup><col/><col/></colgroup><thead><tr><th align="left">
                            Configuration
                        </th><th align="left">
                            Description
                        </th></tr></thead><tbody valign="top"><tr><td align="left" valign="top">
                            <code class="literal">Authorization Url</code>
                        </td><td align="left" valign="top">
                            The authorization url.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Token Url</code>
                        </td><td align="left" valign="top">
                            The token url.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Logout Url</code>
                        </td><td align="left" valign="top">
                            The IDP logout url.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Backchannel Logout</code>
                        </td><td align="left" valign="top">
                            If set to true, logout to the external IDP will be done in a background HTTP request.  If
                            set to false, then the browser will be redirected to the external IDP to perform the logout.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">User Info Url</code>
                        </td><td align="left" valign="top">
                            The user info url. This is usually an url from where Keycloak will obtain user information in order to create a local account.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Client ID</code>
                        </td><td align="left" valign="top">
                            The client id is usually generated when configuring an application or a project on the brokered identity provider.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Client Secret</code>
                        </td><td align="left" valign="top">
                            The client secret is usually generated when configuring an application or a project on the brokered identity provider.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Issuer</code>
                        </td><td align="left" valign="top">
                            Allows you to specify the expected value for the "issuer" claim when validating the ID token.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Default Scopes</code>
                        </td><td align="left" valign="top">
                            Allows you to specify additional scopes when asking for user authentication and consent. By default, scope <code class="literal">openid</code> is always appended to the list of the scopes.
                        </td></tr><tr><td align="left" valign="top">
                            <code class="literal">Prompt</code>
                        </td><td align="left" valign="top">
                            Allows you to specify how the brokered identity provider must prompt user for authentication. You must check which values are supported by the brokered identity provider before choosing a value.
                        </td></tr></tbody></table>
        </div></div><br class="table-break"/>
        <p>
            You can also import all this configuration data by providing a URL or file that points to OpenID Provider Metadata (see OIDC Discovery specification)
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e1948"/>9.6. Retrieving Tokens from Identity Providers</h2></div></div></div>
        
        <p>
            Keycloak allows you to store tokens and responses from identity providers during the authentication process.
            For that, you can use the <code class="literal">Store Token</code> configuration option, as mentioned before.
        </p>
        <p>
            It also allows you to retrieve these tokens and responses once the user is authenticated in order to use their
            information or use them to invoke external resources protected by these tokens.
            The latter case is usually related with social providers,
            where you usually need to use their tokens to invoke methods on their APIs.
        </p>
        <p>
            To retrieve a token for a particular identity provider you need to send a request as follows:
        </p>
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">GET&nbsp;</span><!-- <br/> --><span class="java_operator">/</span><!-- <br/> --><span class="java_plain">auth</span><!-- <br/> --><span class="java_operator">/</span><!-- <br/> --><span class="java_plain">realms</span><!-- <br/> --><span class="java_operator">/</span><!-- <br/> --><span class="java_separator">{</span><!-- <br/> --><span class="java_plain">realm</span><!-- <br/> --><span class="java_separator">}</span><!-- <br/> --><span class="java_operator">/</span><!-- <br/> --><span class="java_plain">broker</span><!-- <br/> --><span class="java_operator">/</span><!-- <br/> --><span class="java_separator">{</span><!-- <br/> --><span class="java_plain">provider_alias</span><!-- <br/> --><span class="java_separator">}</span><!-- <br/> --><span class="java_operator">/</span><!-- <br/> --><span class="java_plain">token&nbsp;HTTP</span><!-- <br/> --><span class="java_operator">/</span><!-- <br/> --><span class="java_literal">1.1</span>
<!--  --><br/><span class="java_type">Host</span><span class="java_operator">:</span><span class="java_plain">&nbsp;localhost</span><span class="java_operator">:</span><span class="java_literal">8080</span>
<!--  --><br/><span class="java_type">Authorization</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_type">Bearer</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">keycloak_access_token</span><span class="java_separator">}</span></pre>
        <p>
            In this case, given that you are accessing an protected service in Keycloak, you need to send the access token
            issued by Keycloak during the user authentication.
        </p>
        <p>
            By default, the Keycloak access token issued for the application can't be automatically used for retrieve thirdparty token.
            A user will have to have the <code class="literal">broker.read-token</code> role.  The client will also have to have that role
            in its scope.  In the broker configuration page you can automatically assign this role to newly imported users by
            turning on the <code class="literal">Stored Tokens Readable</code> switch.
        </p>
        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2>
            <p>
                If your application is not at the same origin as the authentication server, make sure you have properly configured CORS.
            </p>
        </div>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e1961"/>9.7. Automatically Select and Identity Provider</h2></div></div></div>
        
        <p>
            Applications can automatically select an identity provider in order to authenticate an user. In this case, the user will not be presented to the login page but automatically redirected to the identity provider.
        </p>
        <p>
            Keycloak supports a specific HTTP query parameter that you can use as a hint to tell the server which identity provider should be used to authenticate the user.
        </p>
        <p>
            For that, you can append the <code class="literal">kc_idp_hint</code> as a query parameter to your application url, as follows:
        </p>
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">GET&nbsp;</span><!-- <br/> --><span class="java_operator">/</span><!-- <br/> --><span class="java_plain">myapplication</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">com</span><!-- <br/> --><span class="java_operator">?</span><!-- <br/> --><span class="java_plain">kc_idp_hint</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">facebook&nbsp;HTTP</span><!-- <br/> --><span class="java_operator">/</span><!-- <br/> --><span class="java_literal">1.1</span>
<!--  --><br/><span class="java_type">Host</span><span class="java_operator">:</span><span class="java_plain">&nbsp;localhost</span><span class="java_operator">:</span><span class="java_literal">8080</span></pre>
        <p>
            In this case, is expected that your realm has an identity provider with an alias <code class="literal">facebook</code>.
        </p>
        <p>
            If you are using <code class="literal">keycloak.js</code> adapter, you can also achieve the same behavior:
        </p>
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">var&nbsp;keycloak&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Keycloak</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">'keycloak.json'</span><!-- <br/> --><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_plain">keycloak</span><span class="java_separator">.</span><span class="java_plain">createLoginUrl</span><span class="java_separator">({</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;idpHint</span><span class="java_operator">:</span><span class="java_plain">&nbsp;</span><span class="java_literal">'facebook'</span>
<!--  --><br/><span class="java_separator">});</span></pre>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e1973"/>9.8. Mapping/Importing SAML and OIDC Metadata</h2></div></div></div>
        
        <p>
            You can import SAML assertion data, OpenID Connect ID Token claims, and Keycloak access token claims
            into new users that are imported from a brokered IDP.  After you configure a broker, you'll see a <code class="literal">Mappers</code>
            button appear.  Click on that and you'll get to the list of mappers that are assigned to this broker.  There is a
            <code class="literal">Create</code> button on this page.  Clicking on this create button allows you to create a broker mapper.
            Broker mappers can import SAML attributes or OIDC ID/Access token claims into user attributes.  You can assign
            a role mapping to a user if a claim or external role exists.  There's a bunch of options here so just mouse over
            the tool tips to see what each mapper can do for you.
        </p>
    </div>
    
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e1978"/>9.9. Mapping/Importing User profile data from Social Identity Provider</h2></div></div></div>
        
        <p>
            You can import user profile data provided by social identity providers like Google, GitHub, LinkedIn, Stackoverflow and Facebook 
            into new Keycloak user created from given social accounts. After you configure a broker, you'll see a <code class="literal">Mappers</code>
            button appear. Click on that and you'll get to the list of mappers that are assigned to this broker. There is a
            <code class="literal">Create</code> button on this page. Clicking on this create button allows you to create a broker mapper.
            "Attribute Importer" mapper allows you to define path in JSON user profile data provided by the provider to get value from. 
            You can use dot notation for nesting and square brackets to access fields in array by index. For example 'contact.address[0].country'. 
            Then you can define name of Keycloak's user profile attribute this value is stored into.
				</p>
				<p>             
            To investigate structure of user profile JSON data provided by social providers you can enable <code class="literal">DEBUG</code> level for 
            logger <code class="literal">org.keycloak.social.user_profile_dump</code> and login using given provider. Then you can find user profile 
            JSON structure in Keycloak log file. 
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e1986"/>9.10. User Session Data</h2></div></div></div>
        
        <p>
           After a user logs in from the external IDP, there's some additional user session note data that Keycloak stores that you
            can access.  This data can be propagated to the client requesting a login
            via the token or SAML assertion being passed back to it by using an appropriate client mapper.
            </p><div class="variablelist"><dl><dt><span class="term">BROKER_PROVIDER_ID</span></dt><dd>
                        <p>
                            This is the IDP alias of the broker used to perform the login.
                        </p>
                    </dd></dl></div><p>
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e1994"/>9.11. Examples</h2></div></div></div>
        
        <p>
            Keycloak provides some useful examples about how to use it as an identity broker.
            Take a look at <code class="literal">{KEYCLOAK_HOME}/examples/broker</code> for more details.
        </p>
        <p>
            Each example application has its own README file where you can find additional information about how to configure Keycloak and
            run it.
        </p>
    </div>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="themes"/>Chapter 10. Themes</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e2002">10.1. Theme types</a></span></dt><dt><span class="section"><a href="#d4e2011">10.2. Configure theme</a></span></dt><dt><span class="section"><a href="#d4e2025">10.3. Default themes</a></span></dt><dt><span class="section"><a href="#d4e2029">10.4. Creating a theme</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2070">10.4.1. Stylesheets</a></span></dt><dt><span class="section"><a href="#d4e2084">10.4.2. Scripts</a></span></dt><dt><span class="section"><a href="#d4e2094">10.4.3. Images</a></span></dt><dt><span class="section"><a href="#d4e2101">10.4.4. Messages</a></span></dt><dt><span class="section"><a href="#d4e2110">10.4.5. Modifying HTML</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e2119">10.5. Deploying themes</a></span></dt><dt><span class="section"><a href="#d4e2148">10.6. SPIs</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2151">10.6.1. Account SPI</a></span></dt><dt><span class="section"><a href="#d4e2159">10.6.2. Login SPI</a></span></dt></dl></dd></dl></div>
    

    <p>
        Keycloak provides theme support for web pages and emails. This allows customizing the look
        and feel of end-user facing pages so they can be integrated with your applications.
    </p>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2002"/>10.1. Theme types</h2></div></div></div>
        
        <p>
            A theme can support several types to customize different aspects of Keycloak. The types currently available
            are:
            </p><div class="itemizedlist"><ul><li>Account - Account management</li><li>Admin - Admin console</li><li>Email - Emails</li><li>Login - Login forms</li><li>Welcome - Welcome pages</li></ul></div><p>
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2011"/>10.2. Configure theme</h2></div></div></div>
        
        <p>
            All theme types, except welcome, is configured through <code class="literal">Keycloak Admin Console</code>. To change
            the theme used for a realm open the <code class="literal">Keycloak Admin Console</code>, select your realm
            from the drop-down box in the top left corner. Under <code class="literal">Settings</code> click on <code class="literal">Theme</code>.
        </p>
        <p>
            To set the theme for the <code class="literal">master</code> Keycloak admin console set the admin console theme for
            the <code class="literal">master</code> realm. To set the theme for per realm admin access control set the admin console
            theme for the corresponding realm.
        </p>
        <p>
            To change the welcome theme you need to edit <code class="literal">standalone/configuration/keycloak-server.json</code>
            and add <code class="literal">welcomeTheme</code> to the theme element, for example:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"theme": {
    ...
    "welcomeTheme": "custom-theme"
}
</pre><p>
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2025"/>10.3. Default themes</h2></div></div></div>
        
        <p>
            Keycloak comes bundled with default themes in <code class="literal">standalone/configuration/themes</code>. You should
            not edit the bundled themes directly. Instead create a new theme that extends a bundled theme.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2029"/>10.4. Creating a theme</h2></div></div></div>
        
        <p>
            A theme consists of:
            </p><div class="itemizedlist"><ul><li><a class="ulink" href="http://freemarker.org">FreeMarker</a> templates</li><li>Stylesheets</li><li>Scripts</li><li>Images</li><li>Message bundles</li><li>Theme properties</li></ul></div><p>
        </p>
        <p>
            A theme can extend another theme. When extending a theme you can override individual files (templates, stylesheets, etc.).
            The recommended way to create a theme is to extend the base theme. The base theme provides templates
            and a default message bundle. If you decide to override templates bear in mind that you may need to update
            your templates when upgrading to a new release to include any changes made to the original template.
        </p>
        <p>
            Before creating a theme it's a good idea to disable caching as this makes it possible to edit theme resources
            without restarting the server. To do this open <code class="literal">../standalone/configuration/keycloak-server.json</code>
            for <code class="literal">theme</code> set <code class="literal">staticMaxAge</code> to <code class="literal">-1</code> and
            <code class="literal">cacheTemplates</code> and <code class="literal">cacheThemes</code> to <code class="literal">false</code>. For example:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">[
"theme": {
    "default": "keycloak",
    "staticMaxAge": -1,
    "cacheTemplates": false,
    "cacheThemes": false,
    "folder": {
      "dir": "${jboss.server.config.dir}/themes"
    }
},
</pre><p>
            Remember to re-enable caching in production as it will significantly impact performance.
        </p>
        <p>
            To create a new theme create a directory for the theme in <code class="literal">.../standalone/configuration/themes</code>.
            The name of the directory should be the name of the theme. For example to create a theme called <code class="literal">example-theme</code>
            create the directory <code class="literal">.../standalone/configuration/themes/example-theme</code>. Inside the theme
            directory you then need to create a directory for each of the types your theme is going to provide. For example
            to add the login type to the <code class="literal">example-theme</code> theme create the directory
            <code class="literal">.../standalone/configuration/themes/example-theme/login</code>.
        </p>
        <p>
            For each type create a file <code class="literal">theme.properties</code> which allows setting some configuration for
            the theme, for example what theme it overrides and if it should import any themes. For the above example we
            want to override the base theme and import common resources from the Keycloak theme. To do this create the
            file <code class="literal">.../standalone/configuration/themes/example-theme/login/theme.properties</code> with the
            following contents:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">[
parent=base
import=common/keycloak
</pre><p>
        </p>
        <p>
            You have now created a theme with support for the login type. To check that it works open the admin console.
            Select your realm and click on <code class="literal">Themes</code>. For <code class="literal">Login Theme</code> select
            <code class="literal">example-theme</code> and click <code class="literal">Save</code>. Then open the login page for the realm.
            You can do this either by login through your application or by opening <code class="literal">http://localhost:8080/realms/&lt;realm name&gt;/account</code>.
        </p>
        <p>
            To see the effect of changing the parent theme, set <code class="literal">parent=keycloak</code> in <code class="literal">theme.properties</code>
            and refresh the login page. To follow the rest of the documentation set it back to <code class="literal">parent=base</code>
            before continuing.
        </p>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e2070"/>10.4.1. Stylesheets</h3></div></div></div>
            
            <p>
                A theme can have one or more stylesheets, to add a stylesheet create a file inside <code class="literal">resources/css</code>
                (for example <code class="literal">resources/css/styles.css</code>) inside your theme folder. Then registering it
                in <code class="literal">theme.properties</code> by adding:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">styles=css/styles.css</pre>
            <p>
                The <code class="literal">styles</code> property supports a space separated list so you can add as many
                as you want. For example:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">styles=css/styles.css css/more-styles.css</pre>
            For the example-theme above add <code class="literal">example-theme/login/resources/css/styles.css</code> with the
            following content:
<pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">[
#kc-form {
    background-color: #000;
    color: #fff;
    padding: 20px;
}</pre>
            Then edit <code class="literal">example-theme/login/theme.properties</code> and add <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">styles=css/styles.css</pre>.
            Refresh the login page to see your changes. It's not pretty, but you can see how easily you can modify the
            styles for your theme.
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e2084"/>10.4.2. Scripts</h3></div></div></div>
            
            <p>
                A theme can have one or more scripts, to add a script create a file inside <code class="literal">resources/js</code> (for example <code class="literal">resources/js/script.js</code>)
                inside your theme folder. Then registering it in <code class="literal">theme.properties</code> by adding:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">scripts=js/script.js</pre>
            <p>
                The <code class="literal">scripts</code> property supports a space separated list so you can add as many
                as you want. For example:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">scripts=js/script.js js/more-script.js</pre>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e2094"/>10.4.3. Images</h3></div></div></div>
            
            <p>
                To make images available to the theme add them to <code class="literal">resources/img</code>. They can then be used
                through stylesheets. For example:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">body {
    background-image: url('../img/image.jpg');
}</pre>
            <p>
                Or in templates, for example:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;img src="${url.resourcesPath}/img/image.jpg"&gt;</pre>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e2101"/>10.4.4. Messages</h3></div></div></div>
            
            <p>
                Text in the templates are loaded from message bundles. A theme that extends another theme will inherit
                all messages from the parents message bundle, but can override individual messages. For example to replace
                <code class="literal">Username</code> on the login form with <code class="literal">Your Username</code> create the file
                <code class="literal">messages/messages.properties</code> inside your theme folder and add the following content:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">username=Your Username</pre>
            <p>
                For the admin console, there is a second resource bundle named <code class="literal">admin-messages.properties</code>.
                This resource bundle is converted to JSON and shipped to the console to be processed by
                angular-translate.  It is found in the same directory as messages.properties and can be overridden
                in the same way as described above.
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e2110"/>10.4.5. Modifying HTML</h3></div></div></div>
            
            <p>
                Keycloak uses <a class="ulink" href="http://freemarker.org">Freemarker Templates</a> in order to generate HTML.
                These templates are defined in <code class="literal">.ftl</code> files and can be overriden from the base theme.
                Check out the Freemarker website on how to form a template file. To override the login template for the
                <code class="literal">example-theme</code> copy <code class="literal">../standalone/configuration/themes/base/login/login.ftl</code>
                to <code class="literal">../standalone/configuration/themes/example-theme/login</code> and open it in an editor. After
                the first line (&lt;#import ...&gt;) add <code class="literal">&lt;h1&gt;HELLO WORLD!&lt;/h1&gt;</code> then refresh
                the page.
            </p>
        </div>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2119"/>10.5. Deploying themes</h2></div></div></div>
        
        <p>
            Themes can be deployed to Keycloak by copying the theme directory to <code class="literal">../standalone/configuration/themes</code>
            or it can be deployed as a module. For a single server or during development just copying the theme is fine, but
            in a cluster or domain it's recommended to deploy as a module.
        </p>
        <p>
            To deploy a theme as a module you need to create an jar (it's basically just a zip with jar extension) with
            the theme resources and a file <code class="literal">META/keycloak-themes.json</code> that describes the themes contained
            in the archive. For example <code class="literal">example-theme.jar</code> with the contents:
            </p><div class="itemizedlist"><ul><li>META-INF/keycloak-themes.json</li><li>theme/example-theme/login/theme.properties</li><li>theme/example-theme/login/login.ftl</li><li>theme/example-theme/login/resources/css/styles.css</li></ul></div><p>
            The contents of META-INF/keycloak-themes.json in this case would be:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">[
{
    "themes": [{
        "name" : "example-theme",
        "types": [ "login" ]
    }]
}
</pre><p>
            As you can see a single jar can contain multiple themes and each theme can support one or more types.
        </p>
        <p>
            The deploy the jar as a module to Keycloak you can either manually create the module or use <code class="literal">jboss-cli</code>.
            It's simplest to use <code class="literal">jboss-cli</code> as it creates the required directories and module descriptor
            for you. To deploy the above jar <code class="literal">jboss-cli</code> run:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">[
    KEYCLOAK_HOME/bin/jboss-cli.sh --command="module add --name=org.example.exampletheme --resources=example-theme.jar"
</pre><p>
            If you're on windows run </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">KEYCLOAK_HOME/bin/jboss-cli.bat</pre><p>.
        </p>
        <p>
            This command creates <code class="literal">modules/org/example/exampletheme/main</code> containing <code class="literal">example-theme.jar</code>
            and <code class="literal">module.xml</code>.
        </p>
        <p>
            Once you've created the module you need to register it with Keycloak do this by editing
            <code class="literal">../standalone/configuration/keycloak-server.json</code> and adding the module to <code class="literal">theme/module/modules</code>. For example:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">[
"theme": {
    ...
    "module": {
        "modules": [ "org.example.exampletheme" ]
    }
}
</pre><p>
        </p>
        <p>
            If a theme is deployed to <code class="literal">../standalone/configuration/themes</code> and as a module the first
            is used.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2148"/>10.6. SPIs</h2></div></div></div>
        
        <p>
            For full control of login forms and account management Keycloak provides a number of SPIs.
        </p>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e2151"/>10.6.1. Account SPI</h3></div></div></div>
            
            <p>
                The Account SPI allows implementing the account management pages using whatever web framework or templating
                engine you want. To create an Account provider implement <code class="literal">org.keycloak.account.AccountProviderFactory</code>
                and <code class="literal">org.keycloak.account.AccountProvider</code>.
            </p>
            <p>
                Once you have deployed your account provider to Keycloak you need to configure <code class="literal">keycloak-server.json</code> to specify which provider should be used:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"account": {
    "provider": "custom-provider"
}
</pre><p>
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e2159"/>10.6.2. Login SPI</h3></div></div></div>
            
            <p>
                The Login SPI allows implementing the login forms using whatever web framework or templating
                engine you want. To create a Login forms provider implement <code class="literal">org.keycloak.login.LoginFormsProviderFactory</code>
                and <code class="literal">org.keycloak.login.LoginFormsProvider</code> in <code class="literal">forms/login-api</code>.
            </p>
            <p>
                Once you have deployed your account provider to Keycloak you need to configure <code class="literal">keycloak-server.json</code> to specify which provider should be used:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"login": {
    "provider": "custom-provider"
}
</pre><p>
            </p>
        </div>
    </div>

</div>

    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="recaptcha"/>Chapter 11. Recaptcha Support on Registration</h2></div></div></div>
    

    <p>
        To safeguard registration against bots, Keycloak has integration with Google Recaptcha.  To enable this you
        need to first go to <a class="ulink" href="https://developers.google.com/recaptcha/">Google Recaptcha</a>
        and create an API key so that you can get your recaptcha site key and secret.  (FYI, localhost works by default
        so you don't have to specify a domain).
     </p>
    <p>Next, go to the Keycloak Admin Console.  Go to
        Authentication-&gt;Flows page.  Select the 'registration' flow.  Set the 'Recaptcha' requirement to 'Required'.  Click
        on the 'Configure' button and enter in the Recaptcha site key and secret.
    </p>
    <p>
        Finally, you have to change Keycloak's default security headers.  In the Admin Console, go to Settings-&gt;Security Defenses
        of your realm.  Add a space and <code class="literal">https://www.google.com</code> to the values of both the <code class="literal">X-Frame-Options</code>
        and <code class="literal">Content-Security-Policy</code> headers.  i.e.
        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
            frame-src 'self' https://www.google.com
        </pre><p>
    </p>
    <p>
        That's it!  You may want to edit register.ftl in your login theme to muck around with the placement and styling
        of the recaptcha button.  Up to you.
    </p>
</div>


    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2179"/>Chapter 12. Email</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#email-config">12.1. Email Server Config</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2194">12.1.1. Enable SSL or TLS</a></span></dt><dt><span class="section"><a href="#d4e2200">12.1.2. Authentication</a></span></dt></dl></dd></dl></div>
        
        <p>
            Keycloak sends emails to users to verify their email address. Emails are also used to allow users to
            safely restore their username and passwords.
        </p>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="email-config"/>12.1. Email Server Config</h2></div></div></div>
    
    <p>
        To enable Keycloak to send emails you need to provide Keycloak with your SMTP server settings. If you don't have
        a SMTP server you can use one of many hosted solutions (such as Sendgrid or smtp2go).
    </p>

    <p>
        To configure your SMTP server, open the <code class="literal">Keycloak Admin Console</code>, select your realm from the drop-down box in the top left corner.
        Then click on <code class="literal">Email</code> in the menu at the top.
    </p>

    <p>
        You are required to fill in the <code class="literal">Host</code> and <code class="literal">Port</code> for your SMTP server (the default port for SMTP is 25). You also have
        to specify the sender email address (<code class="literal">From</code>). The other options are optional.
    </p>

    <p>
        The screenshot below shows a simple example where the SMTP server doesn't use SSL or TLS and doesn't require authentication.
    </p>

    <img src="images/email-simple-example.png"/>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e2194"/>12.1.1. Enable SSL or TLS</h3></div></div></div>
        
        <p>
            As emails are used for recovering usernames and passwords it's recommended to use SSL or TLS, especially if the SMTP server
            is on an external network. To enable SSL click on <code class="literal">Enable SSL</code> or to enable TLS click on <code class="literal">Enable TLS</code>.
            You will most likely also need to change the <code class="literal">Port</code> (the default port for SSL/TLS is 465).
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e2200"/>12.1.2. Authentication</h3></div></div></div>
        
        <p>
            If your SMTP server requires authentication click on <code class="literal">Enable Authentication</code> and insert
            the <code class="literal">Username</code> and <code class="literal">Password</code>.
        </p>
    </div>
</div>
    </div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="access-types"/>Chapter 13. Client Access Types</h2></div></div></div>
    
    <p>
        When you create a Client in admin console you may be wondering what the "Access Types" are.
    </p>
    <p>
        </p><div class="variablelist"><dl><dt><span class="term">confidential</span></dt><dd>
                    <p>
                        Confidential access type is for clients that need to perform a browser login and that you want
                        to require a client secret when they turn an access code into an access token, (see
                        <a class="ulink" href="http://tools.ietf.org/html/rfc6749#section-4.1.3">Access Token Request</a> in
                        the OAuth 2.0 spec for more details).  The advantages of this is that it is a little extra security.
                        Since Keycloak requires you to register valid redirect-uris, I'm not exactly sure what this little
                        extra security is though. :)
                        The disadvantages of this access type is that confidential access type is pointless for pure
                        Javascript clients as anybody could easily figure out your client's secret!
                    </p>
                </dd><dt><span class="term">public</span></dt><dd>
                    <p>
                        Public access type is for clients that need to perform a browser login and that you feel
                        that the added extra security of confidential access type is not needed.  FYI, Pure javascript
                        clients are by nature public.
                    </p>
                </dd><dt><span class="term">bearer-only</span></dt><dd>
                    <p>
                        Bearer-only access type means that the application only allows bearer token requests.  If this
                        is turned on, this application cannot participate in browser logins.
                    </p>
                </dd><dt><span class="term">direct access only</span></dt><dd>
                    <p>
                        You would also see a "Direct Access Only" switch when creating the Client.
                        This switch is for clients that only use the  <a class="link" href="#direct-access-grants" title="Chapter 15. Direct Access Grants">Direct Access Grant</a>
                        protocol to obtain access tokens.
                    </p>
                </dd></dl></div><p>
    </p>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="roles"/>Chapter 14. Roles</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e2233">14.1. Composite Roles</a></span></dt></dl></div>
    
    <p>
        In Keycloak, roles (or permissions) can be defined globally at the realm level, or individually per application.
        Each role has a name which must be unique at the level it is defined in, i.e. you can have only one "admin" role at
        the realm level.  You may have that a role named "admin" within an Application too, but "admin" must be unique
        for that application.
    </p>
    <p>
        The description of a role is displayed in the OAuth Grant page when Keycloak is processing a browser OAuth
        Grant request.  Look for more features being added here in the future like internationalization and other fine
        grain options.
    </p>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2233"/>14.1. Composite Roles</h2></div></div></div>
        
        <p>
            Any realm or application level role can be turned into a Composite Role.  A Composite Role is a role that has
            one or more additional roles associated with it.  I guess another term for it could be Role Group.
            When a composite role is mapped to the user, the user gains the permission of that role, plus any other role the
            composite is associated with.  This association is dynamic.  So, if you add  or remove an associated role from
            the composite, then all users that are mapped to the composite role will automatically have those permissions
            added or removed.  Composites can also be used to define Client scopes.
        </p>
        <p>
            Composite roles can be associated with any type of role Realm or Application.  In the admin console simple
            flip the composite switch in the Role detail, and you will get a screen that will allow you to associate roles
            with the composite.
        </p>
    </div>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="direct-access-grants"/>Chapter 15. Direct Access Grants</h2></div></div></div>
    
    <p>
        Keycloak allows you to make direct REST invocations to obtain an access token.
        (See <a class="ulink" href="http://tools.ietf.org/html/rfc6749#section-4.3">Resource Owner Password Credentials Grant</a>
        from OAuth 2.0 spec).  To use it you must also have
        registered a valid Client to use as the "client_id" for this grant request.
    </p>
    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2>
        <p>
            It is highly recommended that you do not use Direct Access Grants to write your own login pages for your application.
            You will lose a lot of features that Keycloak has if you do this.  Specifically all the account management, remember me,
            lost password, account reset features of Keycloak.  Instead, if you want to tailor the look and feel of Keycloak login
            pages, you should create your own <a class="link" href="#themes" title="Chapter 10. Themes">theme</a>. There are also security implications
            to using Direct Access Grants compared to the redirect based flows as you are exposing plain text passwords
            to applications directly.
        </p>
        <p>
            It is even highly recommended that you use the browser to log in for native mobile applications!  Android
            and iPhone applications allow you to redirect to and from the browser.  You can use this to redirect the user
            from your native mobile app to the web browser to perform login, then the browser will redirect back to your
            native application.
        </p>
    </div>


    <p>
        The REST URL to invoke on is <code class="literal">/{keycloak-root}/realms/{realm-name}/protocol/openid-connect/token</code>.
        Invoking on this URL is a POST request and requires you to post the username and credentials of the user you want
        an access token for.  You must also pass along the "client_id" of the client you are creating
        an access token for.  This "client_id" is the Client Id specified in admin console (not it's id from DB!).  Depending on
        whether your client is <a class="link" href="#access-types" title="Chapter 13. Client Access Types">"public" or "confidential"</a>, you may also have to pass along
        it's client secret as well. We support pluggable client authentication, so alternatively you can use other form of client credentials like signed JWT assertion.
        See <a class="link" href="#client_authentication" title="33.7. Authentication of clients">Client Authentication</a> section for more details. Finally you need to pass "grant_type"
        parameter with value "password" .
    </p>
    <p>
        For public client's, the POST invocation requires form parameters that contain the username,
        credentials, and client_id of your application.  For example:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    POST /auth/realms/demo/protocol/openid-connect/token
    Content-Type: application/x-www-form-urlencoded

    username=bburke&amp;password=geheim&amp;client_id=customer-portal&amp;grant_type=password
</pre><p>
        The response would be this <a class="ulink" href="http://tools.ietf.org/html/rfc6749#section-4.3.3">standard JSON document</a> from the OAuth 2.0 specification.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
HTTP/1.1 200 OK
Content-Type: application/json;charset=UTF-8
Cache-Control: no-store
Pragma: no-cache

{
    "access_token":"2YotnFZFEjr1zCsicMWpAA",
    "token_type":"bearer",
    "expires_in":3600,
    "refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA",
    "id_token":"tGzv3JOkF0XG5Qx2TlKWIA",
    "session-state":"234234-234234-234234"
}
</pre><p>
    </p>
    <p>
        For confidential client's, you must create a Basic Auth <code class="literal">Authorization</code>
        header that contains the client_id and client secret.  And pass in the form parameters for username and for
        each user credential.  For example:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    POST /auth/realms/demo/protocol/openid-connect/token
    Authorization: Basic atasdf023l2312023
    Content-Type: application/x-www-form-urlencoded

    username=bburke&amp;password=geheim&amp;grant_type=password
</pre><p>

    </p>
    <p>As mentioned above, we support also other means of authenticating clients. In adition to default client_id and client secret,
        we also have signed JWT assertion by default. There is possibility to use any other form of client authentication implemented by you. See <a class="link" href="#client_authentication" title="33.7. Authentication of clients">Client Authentication</a>
        section for more details.
    </p>
    <p>
        Here's a Java example using Apache HTTP Client and some Keycloak utility classes.:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
HttpClient client = new HttpClientBuilder()
                .disableTrustManager().build();


try {
   HttpPost post = new HttpPost(
           KeycloakUriBuilder.fromUri("http://localhost:8080/auth")
           .path(ServiceUrlConstants.TOKEN_PATH).build("demo"));
   List &lt;NameValuePair&gt; formparams = new ArrayList &lt;NameValuePair&gt;();
   formparams.add(new BasicNameValuePair(OAuth2Constants.GRANT_TYPE, "password"));
   formparams.add(new BasicNameValuePair("username", "bburke"));
   formparams.add(new BasicNameValuePair("password", "password"));

   if (isPublic()) { // if client is public access type
       formparams.add(new BasicNameValuePair(OAuth2Constants.CLIENT_ID, "customer-portal"));
   } else {
       String authorization = BasicAuthHelper.createHeader("customer-portal", "secret-secret-secret");
       post.setHeader("Authorization", authorization);
   }
   UrlEncodedFormEntity form = new UrlEncodedFormEntity(formparams, "UTF-8");
   post.setEntity(form);

   HttpResponse response = client.execute(post);
   int status = response.getStatusLine().getStatusCode();
   HttpEntity entity = response.getEntity();
   if (status != 200) {
      throw new IOException("Bad status: " + status);
   }
   if (entity == null) {
      throw new IOException("No Entity");
   }
   InputStream is = entity.getContent();
   try {
      AccessTokenResponse tokenResponse = JsonSerialization.readValue(is, AccessTokenResponse.class);
   } finally {
      try {
          is.close();
      } catch (IOException ignored) { }
      }
} finally {
   client.getConnectionManager().shutdown();
}


</pre><p>
    </p>
    <p>
        Once you have the access token string, you can use it in REST HTTP bearer token authorized requests, i.e
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
GET /my/rest/api
Authorization: Bearer 2YotnFZFEjr1zCsicMWpAA
</pre><p>
    </p>
    <p>
        To logout you must use the refresh token contained in the AccessTokenResponse object.
    </p>
<pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    
List&lt;NameValuePair&gt; formparams = new ArrayList&lt;NameValuePair&gt;();
if (isPublic()) { // if client is public access type
    formparams.add(new BasicNameValuePair(OAuth2Constants.CLIENT_ID, "customer-portal"));
} else {
    String authorization = BasicAuthHelper.createHeader("customer-portal", "secret-secret-secret");
    post.setHeader("Authorization", authorization);
}
formparams.add(new BasicNameValuePair(OAuth2Constants.REFRESH_TOKEN, tokenResponse.getRefreshToken()));
HttpResponse response = null;
URI logoutUri = KeycloakUriBuilder.fromUri(getBaseUrl(request) + "/auth")
                    .path(ServiceUrlConstants.TOKEN_SERVICE_LOGOUT_PATH)
                    .build("demo");
HttpPost post = new HttpPost(logoutUri);
UrlEncodedFormEntity form = new UrlEncodedFormEntity(formparams, "UTF-8");
post.setEntity(form);
response = client.execute(post);
int status = response.getStatusLine().getStatusCode();
HttpEntity entity = response.getEntity();
if (status != 204) {
   error(status, entity);
}
if (entity == null) {
   return;
}
InputStream is = entity.getContent();
if (is != null) is.close();
</pre>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="service-accounts"/>Chapter 16. Service Accounts</h2></div></div></div>
    
    <p>
        Keycloak allows you to obtain an access token dedicated to some Client Application (not to any user).
        See <a class="ulink" href="http://tools.ietf.org/html/rfc6749#section-4.4">Client Credentials Grant</a>
        from OAuth 2.0 spec.
    </p>
    <p>
        To use it you must have
        registered a valid confidential Client and you need to check the switch <code class="literal">Service Accounts Enabled</code> in Keycloak
        admin console for this client. In tab <code class="literal">Service Account Roles</code> you can configure the roles available to the service account retrieved on behalf of this client.
        Don't forget that you need those roles to be available in Scopes of this client as well (unless you have <code class="literal">Full Scope Allowed</code> on).
        As in normal login, roles from access token are intersection of scopes and the service account roles.
    </p>

    <p>
        The REST URL to invoke on is <code class="literal">/{keycloak-root}/realms/{realm-name}/protocol/openid-connect/token</code>.
        Invoking on this URL is a POST request and requires you to post the client credentials. By default, client credentials are
        represented by clientId and clientSecret of the client in <code class="literal">Authorization: Basic</code> header, but you can also
        authenticate client with signed JWT assertion or any other custom mechanism for client authentication. See
        <a class="link" href="#client_authentication" title="33.7. Authentication of clients">Client Authentication</a> section for more details. You also need to use parameter <code class="literal">grant_type=client_credentials</code> as per OAuth2 specification.
    </p>
    <p>
        For example the POST invocation to retrieve service account can look like this:
        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    POST /auth/realms/demo/protocol/openid-connect/token
    Authorization: Basic cHJvZHVjdC1zYS1jbGllbnQ6cGFzc3dvcmQ=
    Content-Type: application/x-www-form-urlencoded

    grant_type=client_credentials
        </pre><p>
        The response would be this <a class="ulink" href="http://tools.ietf.org/html/rfc6749#section-4.4.3">standard JSON document</a> from the OAuth 2.0 specification.
        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
HTTP/1.1 200 OK
Content-Type: application/json;charset=UTF-8
Cache-Control: no-store
Pragma: no-cache

{
    "access_token":"2YotnFZFEjr1zCsicMWpAA",
    "token_type":"bearer",
    "expires_in":60,
    "refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA",
    "refresh_expires_in":600,
    "id_token":"tGzv3JOkF0XG5Qx2TlKWIA",
    "not-before-policy":0,
    "session-state":"234234-234234-234234"
}
        </pre><p>
    </p>
    <p>
        The retrieved access token can be refreshed or logged out by out-of-bound request.
    </p>
    <p>
        See the example application <code class="literal">service-account</code>
        from the main Keycloak <code class="literal">demo</code> example.
    </p>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="cors"/>Chapter 17. CORS</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e2298">17.1. Handling CORS Yourself</a></span></dt></dl></div>
    
    <p>
        CORS stands for Cross-Origin Resource Sharing.  If executing browser Javascript tries to make an AJAX HTTP request
        to a server's whose domain is different than the one the Javascript code came from, then the request uses the
        <a class="ulink" href="http://www.w3.org/TR/cors/">CORS protocol</a>.  The server must handle CORS requests in a special
        way, otherwise the browser will not display or allow the request to be processed.  This protocol exists to protect
        against XSS and other Javascript-based attacks.  Keycloak has support for validated CORS requests.
    </p>
    <p>
        Keycloak's CORS support is configured per client.  You specify the allowed origins
        in the client's configuration page in the admin console.  You can add as many you want.  The value
        must be what the browser would send as a value in the <code class="literal">Origin</code> header.  For example <code class="literal">http://example.com</code>
        is what you must specify to allow CORS requests from <code class="literal">example.com</code>.  When an access token is
        created for the client, these allowed origins are embedded within the token.  On authenticated
        CORS requests, your application's Keycloak adapter will handle the CORS protocol and validate the <code class="literal">Origin</code>
        header against the allowed origins embedded in the token.  If there is no match, then the request is denied.
    </p>
    <p>
        To enable CORS processing in your application's server, you must set the <code class="literal">enable-cors</code> setting
        to <code class="literal">true</code> in your <a class="link" href="#adapter-config" title="8.1. General Adapter Config">adapter's configuration file</a>.  When this
        setting is enabled, the Keycloak adapter will handle all CORS preflight requests.  It will validate authenticated
        requests (protected resource requests), but will let unauthenticated requests (unprotected resource requests) pass through.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2298"/>17.1. Handling CORS Yourself</h2></div></div></div>
        
        <p>
            This section is for Java developers securing servlet-based applications using our servlet adapter.
        </p>
        <p>
            If you don't like our CORS support you can handle it yourself in a filter or something.  One problem you will encounter is that our adapter will
            may trigger for any CORS preflight OPTIONS requests to blindly secured URLs.  This will result in 302 redirection or 401 responses
            for the preflight OPTIONS request.  To workaround this problem, you must modify your web.xml security constraints to let OPTIONS requests
            through
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;security-constraint&gt;
     &lt;web-resource-collection&gt;
         &lt;web-resource-name&gt;wholesale&lt;/web-resource-name&gt;
         &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
         &lt;http-method&gt;GET&lt;/http-method&gt;
         &lt;http-method&gt;POST&lt;/http-method&gt;
         &lt;http-method&gt;PUT&lt;/http-method&gt;
         &lt;http-method&gt;DELETE&lt;/http-method&gt;
     &lt;/web-resource-collection&gt;
...
&lt;/security-constraint&gt;

</pre><p>
        </p>
        <p>
            The above security constraint will secure all URLs, but only on GET, POST, PUT, and DELETE calls.  OPTIONS requests
            will be let through.
        </p>
    </div>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="timeouts"/>Chapter 18. Cookie settings, Session Timeouts, and Token Lifespans</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e2307">18.1. Remember Me</a></span></dt><dt><span class="section"><a href="#session-timeouts">18.2. Session Timeouts</a></span></dt><dt><span class="section"><a href="#token-timeouts">18.3. Token Timeouts</a></span></dt><dt><span class="section"><a href="#offline-access">18.4. Offline Access</a></span></dt></dl></div>
    
    <p>
        Keycloak has a bunch of fine-grain settings to manage browser cookies, user login sessions, and token lifespans.
        Sessions can be viewed and managed within the admin console for all users, and individually in the user's account
        management pages.  This chapter goes over configuration options for cookies, sessions, and tokens.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2307"/>18.1. Remember Me</h2></div></div></div>
        
        <p>
            If you go to the admin console page of Settings-&gt;General, you should see a <code class="literal">Remember Me</code> on/off switch.
            Your realm sets a SSO cookie so that you only have to enter in your login credentials once.
            This <code class="literal">Remember Me</code> admin config option, when turned on, will show a "Remember Me" checkbox on the user's login page.
            If the user clicks this, the realm's SSO cookie will be persistent.   This means that if the user closes their browser
            they will still be logged in the next time they start up their browser.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="session-timeouts"/>18.2. Session Timeouts</h2></div></div></div>
        
        <p>
            If you go to the Sesions and Tokens-&gt;Timeout Settings page of the Keycloak adminstration console there is a bunch of fine tuning
            you can do as far as login session timeouts go.
        </p>
        <p>
            The <code class="literal">SSO Session Idle Timeout</code> is the idle time of a user session.  If there is no activity
            in the user's session for this amount of time, the user session will be destroyed, and the user will become logged
            out.  The idle time is refreshed with every action against the keycloak server for that session, i.e.: a user login,
            SSO, a refresh token grant, etc.
        </p>
        <p>
            The <code class="literal">SSO Session Max Lifespan</code> setting is the maximum time a user session is allowed to be alive.  This
            max lifespan countdown starts from when the user first logs in and is never refreshed.  This works great with <code class="literal">Remember Me</code>
            in that it allow you to force a relogin after a set timeframe.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="token-timeouts"/>18.3. Token Timeouts</h2></div></div></div>
        
        <p>
            The <code class="literal">Access Token Lifespan</code> is how long an access token is valid for.  An access token contains everything
            an application needs to authorize a client.  It contains roles allowed as well as other user information.  When
            an access token expires, your application will attempt to refresh it using a refresh token that it obtained in the
            initial login.  The value of this configuration option should be however long you feel comfortable with the
            application not knowing if the user's permissions have changed.  This value is usually in minutes.
        </p>
        <p>
            The <code class="literal">Client login timeout</code> is how long an access code is valid for.  An access code is obtained
            on the 1st leg of the OAuth 2.0 redirection protocol.  This should be a short time limit.  Usually seconds.
        </p>
        <p>
            The <code class="literal">Login user action lifespan</code> is how long a user is allowed to attempt a login.  When a user tries
            to login, they may have to change their password, set up TOTP, or perform some other action before they are redirected
            back to your application as an authentnicated user.  This value is relatively short and is usually measured in minutes.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="offline-access"/>18.4. Offline Access</h2></div></div></div>
        
        <p>
            The Offline access is the feature described in <a class="ulink" href="http://openid.net/specs/openid-connect-core-1_0.html#OfflineAccess">OpenID Connect specification</a> .
            The idea is that during login, your client application will request Offline token instead of classic Refresh token.
            Then the application can save this offline token in the database and can use it anytime later even if user is logged out.
            This is useful for example if your application needs to do some "offline" actions on behalf of user even if user is not online. For example
            periodic backup of some data every night etc.
        </p>
        <p>
            Your application is responsible for persist the offline token in some storage (usually database) and then use it to
            manually retrieve new access token from Keycloak server.
        </p>
        <p>
            The difference between classic Refresh token and Offline token is, that offline token will never expire and is not subject of <code class="literal">SSO Session Idle timeout</code> .
            The offline token is valid even after user logout or server restart. However you need to use offline token for refresh at least once per each 30 days (
            The value can be changed in admin console. It is <code class="literal">Offline Session Idle timeout</code> ). Also if you enable option <code class="literal">Revoke refresh tokens</code>
            , then each offline token can be used just once. So after refresh, you always need to store new offline token from refresh response into your DB instead of the previous one.
        </p>
        <p>
            User can revoke the offline tokens in Account management UI. The admin
            user can revoke offline tokens for individual users in admin console (The <code class="literal">Consent</code> tab of particular user) and he can
            see all the offline tokens of all users for particular client application in the settings of the client. Revoking of all offline tokens for particular
            client is possible by set <code class="literal">notBefore</code> policy for the client.
        </p>
        <p>
            For requesting the offline token, user needs to be in realm role <code class="literal">offline_access</code> and client needs to have
            scope for this role. If client has <code class="literal">Full scope allowed</code>, the scope is granted by default. Also users are automatically
            members of the role as it's the default role.
        </p>
        <p>
            The client can request offline token by adding parameter <code class="literal">scope=offline_access</code>
            when sending authorization request to Keycloak. The adapter automatically adds this parameter when you use it to access secured
            URL of your application (ie. http://localhost:8080/customer-portal/secured?scope=offline_access ).
            The <a class="link" href="#direct-access-grants" title="Chapter 15. Direct Access Grants">Direct Access Grant</a> or <a class="link" href="#service-accounts" title="Chapter 16. Service Accounts">Service account</a> flows also support
            offline tokens if you include <code class="literal">scope=offline_access</code> in the body of the authentication request. For more details,
            see the <code class="literal">offline-access-app</code> example from Keycloak demo.
        </p>
    </div>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="admin-rest-api"/>Chapter 19. Admin REST API</h2></div></div></div>
    
    <p>
        The Keycloak Admin Console is implemented entirely with a fully functional REST admin API.  You can invoke this
        REST API from your Java applications by obtaining an access token.  You must have the appropriate
        permissions set up as described in <a class="xref" href="#admin-permissions" title="Chapter 6. Master Admin Access Control">Chapter 6, <i>Master Admin Access Control</i></a> and <a class="xref" href="#per-realm-admin-permissions" title="Chapter 7. Per Realm Admin Access Control">Chapter 7, <i>Per Realm Admin Access Control</i></a>
    </p>
    <p>
        The documentation for this REST API is auto-generated and is contained in the distribution of keycloak under
        the docs/rest-api/overview-index.html directory, or directly from the docs page at the keycloak website.
    </p>
    <p>
        There are a number of examples that come with the keycloak distribution that show you how to invoke on this REST API.
        <code class="literal">examples/preconfigured-demo/admin-access-app</code> shows you how to access this api from java.
        <code class="literal">examples/cors/angular-product-app</code> shows you how to invoke on it from Javascript. Finally there is example in
        <code class="literal">example/admin-client</code>, which contains example for Admin client, that can be used to invoke REST endpoints easily as Java methods.
    </p>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="events"/>Chapter 20. Events</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e2362">20.1. Event types</a></span></dt><dt><span class="section"><a href="#d4e2384">20.2. Event Listener</a></span></dt><dt><span class="section"><a href="#d4e2395">20.3. Event Store</a></span></dt><dt><span class="section"><a href="#d4e2401">20.4. Configure Events Settings for Realm</a></span></dt></dl></div>
    
    <p>
        Keycloak provides an Events SPI that makes it possible to register listeners for user related events, for example
        user logins. There are two interfaces that can be implemented, the first is a pure listener, the second is a events
        store which listens for events, but is also required to store events. An events store provides a way for the admin
        and account management consoles to view events.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2362"/>20.1. Event types</h2></div></div></div>
        
        <p>
            Login events:
            </p><div class="itemizedlist"><ul><li>Login - A user has logged in</li><li>Register - A user has registered</li><li>Logout - A user has logged out</li><li>Code to Token - An application/client has exchanged a code for a token</li><li>Refresh Token - An application/client has refreshed a token</li></ul></div><p>
        </p>
        <p>
            Account events:
            </p><div class="itemizedlist"><ul><li>Social Link - An account has been linked to a social provider</li><li>Remove Social Link - A social provider has been removed from an account</li><li>Update Email - The email address for an account has changed</li><li>Update Profile - The profile for an account has changed</li><li>Send Password Reset - A password reset email has been sent</li><li>Update Password - The password for an account has changed</li><li>Update TOTP - The TOTP settings for an account has changed</li><li>Remove TOTP - TOTP has been removed from an account</li><li>Send Verify Email - A email verification email has been sent</li><li>Verify Email - The email address for an account has been verified</li></ul></div><p>
        </p>
        <p>
            For all events there is a corresponding error event.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2384"/>20.2. Event Listener</h2></div></div></div>
        
        <p>
            Keycloak comes with an Email Event Listener and a JBoss Logging Event Listener. The Email Event Listener
            sends an email to the users account when an event occurs. The JBoss Logging Event Listener writes to a log
            file when an events occurs.
        </p>
        <p>
            The Email Event Listener only supports the following events at the moment:
            </p><div class="itemizedlist"><ul><li>Login Error</li><li>Update Password</li><li>Update TOTP</li><li>Remove TOTP</li></ul></div><p>
            You can exclude one or more events by editing <code class="literal">standalone/configuration/keycloak-server.json</code>
            and adding for example:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"eventListener": {
    "email": {
        "exclude-events": [ "UPDATE_TOTP", "REMOVE_TOTP" ]
    }
}
</pre><p>
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2395"/>20.3. Event Store</h2></div></div></div>
        
        <p>
            Event Store listen for events and is expected to persist the events to make it possible to query for them
            later. This is used by the admin console and account management to view events. Keycloak includes providers
            to persist events to JPA and Mongo.
        </p>
        <p>
            You can specify events to include or exclude by editing <code class="literal">standalone/configuration/keycloak-server.json</code>,
        and adding for example:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"eventsStore": {
    "jpa": {
        "exclude-events": [ "LOGIN", "REFRESH_TOKEN", "CODE_TO_TOKEN" ]
    }
}
</pre><p>
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2401"/>20.4. Configure Events Settings for Realm</h2></div></div></div>
        
        <p>
            To enable persisting of events for a realm you first need to make sure you have a event store provider registered for Keycloak.
            By default the JPA event store provider is registered. Once you've done that open the admin console, select the
            realm you're configuring, select <code class="literal">Events</code>. Then click on <code class="literal">Config</code>.
            You can enable storing events for your realm by toggling <code class="literal">Save Events</code> to ON. You can also set
            an expiration on events. This will periodically delete events from the database that are older than the specified
            time.
        </p>
        <p>
            To configure listeners for a realm on the same page as above add one or more event listeners to the
            <code class="literal">Listeners</code> select box. This will allow you to enable any registered event listeners with the
            realm.
        </p>
    </div>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="user_federation"/>Chapter 21. User Federation SPI and LDAP/AD Integration</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e2414">21.1. LDAP and Active Directory Plugin</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2420">21.1.1. Edit Mode</a></span></dt><dt><span class="section"><a href="#d4e2436">21.1.2. Other config options</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e2461">21.2. Sync of LDAP users to Keycloak</a></span></dt><dt><span class="section"><a href="#ldap_mappers">21.3. LDAP/Federation mappers</a></span></dt><dt><span class="section"><a href="#d4e2513">21.4. Writing your own User Federation Provider</a></span></dt></dl></div>
    
    <p>
        Keycloak can federate external user databases.  Out of the box we have support for LDAP and Active Directory.
        Before you dive into this, you should understand how Keycloak does federation.
    </p>
    <p>
        Keycloak performs federation a bit differently than other products/projects.  The vision of Keycloak is that it
        is an out of the box solution that should provide a core set of feature irregardless of the backend user storage you
        want to use.  Because of this requirement/vision, Keycloak has a set data model that all of its services use.
        Most of the time when you want to federate an external user store, much of the metadata that would be needed to
        provide this complete feature set does not exist in that external store.  For example your LDAP server may only
        provide password validation, but not support TOTP or user role mappings.  The Keycloak User Federation SPI was
        written to support these completely variable configurations.
    </p>
    <p>
        The way user federation works is that Keycloak will import your federated users on demand to its local storage.  How
        much metadata that is imported depends on the underlying federation plugin and how that plugin is configured.  Some
        federation plugins may only import the username into Keycloak storage, others might import everything from name,
        address, and phone number, to user role mappings.  Some plugins might want to import credentials directly into
        Keycloak storage and let Keycloak handle credential validation.  Others might want to handle credential validation
        themselves.  The goal of the Federation SPI is to support all of these scenarios.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2414"/>21.1. LDAP and Active Directory Plugin</h2></div></div></div>
        
        <p>
            Keycloak comes with a built-in LDAP/AD plugin.  By default, it is set up only to import username, email, first and last name, but you are free
            to configure <a class="link" href="#ldap_mappers" title="21.3. LDAP/Federation mappers">mappers</a> and add more attributes or delete default ones.
            It supports password validation via LDAP/AD protocols and different user metadata synchronization modes.  To configure
            a federated LDAP store go to the admin console.  Click on the <code class="literal">Users</code> menu option to get you
            to the user management page.  Then click on the <code class="literal">Federation</code> submenu option.  When
            you get to this page there is an "Add Provider" select box.  You should see "ldap" within this list.  Selecting
            "ldap" will bring you to the ldap configuration page.
        </p>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e2420"/>21.1.1. Edit Mode</h3></div></div></div>
            
            <p>
                Edit mode defines various synchronization options with your LDAP store depending on what privileges
                you have.
                </p><div class="variablelist"><dl><dt><span class="term">READONLY</span></dt><dd>
                            <p>
                                Username, email, first and last name and other mapped attributes will be unchangeable.  Keycloak will show an error
                                anytime anybody tries to update these fields.  Also, password updates will not be supported.
                            </p>
                        </dd><dt><span class="term">WRITABLE</span></dt><dd>
                            <p>
                                Username, email, first and last name, other mapped attributes and passwords can all be updated and will
                                be synchronized automatically with your LDAP store.
                            </p>
                        </dd><dt><span class="term">UNSYNCED</span></dt><dd>
                            <p>
                                Any changes to username, email, first and last name, and passwords will be stored
                                in Keycloak local storage. It is up to you to figure out how to synchronize back to
                                LDAP.
                            </p>
                        </dd></dl></div><p>
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e2436"/>21.1.2. Other config options</h3></div></div></div>
            
            <p>
                </p><div class="variablelist"><dl><dt><span class="term">Display Name</span></dt><dd>
                            <p>
                                Name used when this provider is referenced in the admin console
                            </p>
                        </dd><dt><span class="term">Priority</span></dt><dd>
                            <p>
                                The priority of this provider when looking up users or for adding registrations.
                            </p>
                        </dd><dt><span class="term">Sync Registrations</span></dt><dd>
                            <p>
                                If a new user is added through a registration page or admin console, should the user
                                be eligible to be synchronized to this provider.
                            </p>
                        </dd><dt><span class="term">Allow Kerberos authentication</span></dt><dd>
                            <p>
                                Enable Kerberos/SPNEGO authentication in realm with users data provisioned from LDAP. More info in <a class="link" href="#kerberos" title="Chapter 22. Kerberos brokering">Kerberos section</a>.
                            </p>
                        </dd><dt><span class="term">Other options</span></dt><dd>
                            <p>
                                The rest of the configuration options should be self explanatory. You can use tooltips in admin console
                                to see some more details about them.
                            </p>
                        </dd></dl></div><p>
            </p>
        </div>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2461"/>21.2. Sync of LDAP users to Keycloak</h2></div></div></div>
        
        <p>
            LDAP Federation Provider will automatically take care of synchronization (import) of needed LDAP users into Keycloak database.
            For example once you first authenticate LDAP user <code class="literal">john</code> from Keycloak UI, LDAP Federation provider will
            first import this LDAP user into Keycloak database and then authenticate against LDAP password.
        </p>
        <p>
            Federation Provider imports just requested users by default, so if you click to <code class="literal">View all users</code>
            in Keycloak admin console, you will see just those LDAP users, which were already authenticated/requested by Keycloak.
        </p>
        <p>If you want to sync all LDAP users into Keycloak database, you may configure and enable Sync, which is in
            admin console on same page like the configuration of Federation provider itself. There are 2 types of sync:
            </p><div class="variablelist"><dl><dt><span class="term">Full sync</span></dt><dd>
                        <p>
                            This will synchronize all LDAP users into Keycloak DB. Those LDAP users, which already exist in Keycloak and were
                            changed in LDAP directly will be updated in Keycloak DB (For example if user <code class="literal">Mary Kelly</code> was changed in LDAP to <code class="literal">Mary Doe</code>).
                        </p>
                    </dd><dt><span class="term">Changed users sync</span></dt><dd>
                        <p>
                            This will check LDAP and it will sync into Keycloak just those users, which were created or updated in LDAP from the time of last sync.
                        </p>
                    </dd></dl></div><p>
        </p>
        <p>
            In usual cases you may want to trigger full sync at the beginning, so you will import all LDAP users to Keycloak just once. Then you may setup
            periodic sync of changed users, so Keycloak will periodically ask LDAP server for newly created or updated users and backport them to Keycloak DB.
            Also you may want to trigger full sync again after some longer time or setup periodic full sync as well.
        </p>
        <p>In admin console, you can trigger sync directly or you can enable periodic changed or full sync.</p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="ldap_mappers"/>21.3. LDAP/Federation mappers</h2></div></div></div>
        
        <p>
            LDAP mappers are <code class="literal">listeners</code>, which are triggered by LDAP Federation provider at various points and provide
            another extension point to LDAP integration. They are triggered during import LDAP user into Keycloak, registration Keycloak user back to LDAP or when querying LDAP user from Keycloak.
            When you create LDAP Federation provider, Keycloak will automatically provide set of builtin <code class="literal">mappers</code> for this provider.
            You are free to change this set and create new mapper or update/delete existing ones.
        </p>
        <p>
            By default, we have those implementation of LDAP federation mapper:
            </p><div class="variablelist"><dl><dt><span class="term">User Attribute Mapper</span></dt><dd>
                        <p>
                            This allows to specify which LDAP attribute is mapped to which attribute of Keycloak User. So for example you can configure
                            that LDAP attribute <code class="literal">mail</code> is supposed to be mapped to the UserModel attribute <code class="literal">email</code> in Keycloak database.
                            For this mapper implementation, there is always one-to-one mapping (one LDAP attribute mapped to one Keycloak UserModel attribute)
                        </p>
                    </dd><dt><span class="term">FullName Mapper</span></dt><dd>
                        <p>
                            This allows to specify that fullname of user, which is saved in some LDAP attribute (usualy <code class="literal">cn</code> ) will be mapped to
                            <code class="literal">firstName</code> and <code class="literal">lastname</code> attributes of UserModel. Having <code class="literal">cn</code> to contain full name of user
                            is common case for some LDAP deployments.
                        </p>
                    </dd><dt><span class="term">Role Mapper</span></dt><dd>
                        <p>
                            This allows to configure role mappings from LDAP into Keycloak role mappings. One Role mapper can be used to map LDAP roles
                            (usually groups from particular branch of LDAP tree) into roles corresponding to either realm roles or client roles of specified client.
                            It's not a problem to configure more Role mappers for same LDAP provider. So for example you can specify that role mappings from groups under
                            <code class="literal">ou=main,dc=example,dc=org</code> will be mapped to realm role mappings and role mappings from
                            groups under <code class="literal">ou=finance,dc=example,dc=org</code> will be mapped to client role mappings of client <code class="literal">finance</code> .
                        </p>
                    </dd></dl></div><p>
        </p>
        <p>By default, there is set of User Attribute mappers to map basic UserModel attributes username, first name, lastname and email to corresponding LDAP attributes. You are free to extend this and provide
            more attribute mappings (For example to street, postalCode etc), delete firstName/lastname mapper and put fullName mapper instead, add role mappers etc.
            Admin console provides tooltips, which should help on how to configure corresponding mappers.
        </p>
        <p>
            We have an example, which is showing LDAP integration and set of base mappers and sample mappers (mappers for street and postalCode) . It's in <code class="literal">examples/ldap</code>
            in the Keycloak example distribution or demo distribution download. You can also check the example sources directly <a class="ulink" href="https://github.com/keycloak/keycloak/blob/master/examples/ldap">here</a> .
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2513"/>21.4. Writing your own User Federation Provider</h2></div></div></div>
        
        <p>
            The keycloak examples directory contains an example of a simple User Federation Provider backed by
            a simple properties file.  See <code class="literal">examples/providers/federation-provider</code>.  Most of how
            to create a federation provider is explained directly within the example code, but some information is here too.
        </p>
        <p>
            Writing a User Federation Provider starts by implementing the <code class="literal">UserFederationProvider</code>
            and <code class="literal">UserFederationProviderFactory</code> interfaces.  Please see the Javadoc and example
            for complete details on how to do this.  Some important methods of note:
            getUserByUsername() and getUserByEmail() require that you query your federated storage and if the user exists
            create and import the user into Keycloak storage.  How much metadata you import is fully up to you.  This
            import is done by invoking methods on the object returned <code class="literal">KeycloakSession.userStorage()</code>
            to add and import user information.  The proxy() method will be called whenever Keycloak has found an imported
            UserModel.  This allows the federation provider to proxy the UserModel which is useful if you want to support
            external storage updates on demand.
        </p>
        <p>
            After your code is written you must package up all your classes within a JAR file.  This jar file must
            contain a file called <code class="literal">org.keycloak.models.UserFederationProviderFactory</code>
            within the <code class="literal">META-INF/services</code> directory of the JAR.  This file is a list
            of fully qualified classnames of all implementations of <code class="literal">UserFederationProviderFactory</code>.
            For more details on writing provider implementations and how to deploy to Keycloak refer to the
            <a class="link" href="#providers" title="Chapter 4. Providers and SPIs">providers</a> section.
        </p>
    </div>

</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="kerberos"/>Chapter 22. Kerberos brokering</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e2555">22.1. Setup of Kerberos server</a></span></dt><dt><span class="section"><a href="#d4e2570">22.2. Setup and configuration of Keycloak server</a></span></dt><dt><span class="section"><a href="#d4e2599">22.3. Setup and configuration of client machines</a></span></dt><dt><span class="section"><a href="#d4e2606">22.4. Example setups</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e2609">22.4.1. Keycloak and FreeIPA docker image</a></span></dt><dt><span class="section"><a href="#d4e2615">22.4.2. ApacheDS testing Kerberos server</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e2620">22.5. Credential delegation</a></span></dt><dt><span class="section"><a href="#d4e2636">22.6. Troubleshooting</a></span></dt></dl></div>
    
    <p>
        Keycloak supports login with Kerberos ticket through SPNEGO. SPNEGO (Simple and Protected GSSAPI Negotiation Mechanism) is used
        to authenticate transparently through the web browser after the user has been authenticated when logging-in his session.
        For non-web cases or when ticket is not available during login, Keycloak also supports login with Kerberos username/password.
    </p>
    <p>
        A typical use case for web authentication is the following:
        </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                <p>
                    User logs into his desktop (Such as a Windows machine in Active Directory domain or Linux machine with Kerberos integration enabled).
                </p>
            </li><li>
                <p>
                    User then uses his browser (IE/Firefox/Chrome) to access a web application secured by Keycloak.
                </p>
            </li><li>
                <p>
                    Application redirects to Keycloak login.
                </p>
            </li><li>
                <p>
                    Keycloak sends HTML login screen together with status 401 and HTTP header <code class="literal">WWW-Authenticate: Negotiate</code>
                </p>
            </li><li>
                <p>
                    In case that browser has Kerberos ticket from desktop login, it transfers the desktop sign on information to the
                    Keycloak in header <code class="literal">Authorization: Negotiate 'spnego-token'</code> . Otherwise it just displays login screen.
                </p>
            </li><li>
                <p>
                    Keycloak validates token from browser and authenticate user. It provisions user data from LDAP (in case of
                    LDAPFederationProvider with Kerberos authentication support) or let user to update his profile and prefill data
                    (in case of KerberosFederationProvider).
                </p>
            </li><li>
                <p>
                    Keycloak returns back to the application. Communication between Keycloak and application happens through OpenID
                    Connect or SAML messages. The fact that Keycloak was authenticated through Kerberos is hidden from the application.
                    So Keycloak acts as broker to Kerberos/SPNEGO login.
                </p>
            </li></ol></div><p>
    </p>
    <p>
        For setup there are 3 main parts:
        </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                <p>
                    Setup and configuration of Kerberos server (KDC)
                </p>
            </li><li>
                <p>
                    Setup and configuration of Keycloak server
                </p>
            </li><li>
                <p>
                    Setup and configuration of client machines
                </p>
            </li></ol></div><p>
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2555"/>22.1. Setup of Kerberos server</h2></div></div></div>
        
        <p>
            This is platform dependent. Exact steps depend on your OS and the Kerberos vendor you're going to use.
            Consult Windows Active Directory, MIT Kerberos and your OS documentation for how exactly to setup and configure Kerberos server.
        </p>
        <p>
            At least you will need to:
            </p><div class="itemizedlist"><ul><li>
                    <p>
                        Add some user principals to your Kerberos database. You can also integrate your Kerberos with LDAP,
                        which means that user accounts will be provisioned from LDAP server.
                    </p>
                </li><li>
                    <p>
                        Add service principal for "HTTP" service. For example if your Keycloak server will be running on
                        <code class="literal">www.mydomain.org</code> you may need to add principal <code class="literal">HTTP/www.mydomain.org@MYDOMAIN.ORG</code>
                        assuming that MYDOMAIN.ORG will be your Kerberos realm.
                    </p>
                    <p>
                        For example on MIT Kerberos you can run "kadmin" session. If you are on same machine where is MIT Kerberos, you can simply use command:
                        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
sudo kadmin.local
</pre><p>
                        Then add HTTP principal and export his key to keytab file with the commands like:
                        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
addprinc -randkey HTTP/www.mydomain.org@MYDOMAIN.ORG
ktadd -k /tmp/http.keytab HTTP/www.mydomain.org@MYDOMAIN.ORG
</pre><p>
                        Keytab file <code class="literal">/tmp/http.keytab</code> will need to be accessible on the host where keycloak server will be running.
                    </p>
                </li></ul></div><p>
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2570"/>22.2. Setup and configuration of Keycloak server</h2></div></div></div>
        
        <div class="itemizedlist"><ul><li>
                <p>
                    Install kerberos client. This is again platform dependent. If you are on Fedora, Ubuntu or RHEL, you can install package <code class="literal">freeipa-client</code>,
                    which contains Kerberos client and bunch of other stuff.
                </p>
            </li><li>
                <p>
                    Configure kerberos client (on linux it's in file <code class="literal">/etc/krb5.conf</code> ). You need to put your Kerberos realm and at least
                    configure the Http domains your server will be running on. For the example realm MYDOMAIN.ORG you may configure <code class="literal">domain_realm</code> section like this:
                    </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
[domain_realm]
  .mydomain.org = MYDOMAIN.ORG
  mydomain.org = MYDOMAIN.ORG
</pre><p>
                </p>
            </li><li>
                <p>
                    Export keytab file with HTTP principal and make sure the file is accessible to the process under which Keycloak
                    server is running. For production, it's ideal if it's readable just by this process and not by someone else.
                    For MIT Kerberos example above, we already exported keytab to <code class="literal">/tmp/http.keytab</code> . If your KDC and Keycloak
                    are running on same host, you have file already available.
                </p>
            </li><li>
                <p>
                    Finally run Keycloak server and configure SPNEGO/Kerberos authentication in Keycloak admin console. Keycloak supports Kerberos authentication
                    through <a class="link" href="#user_federation" title="Chapter 21. User Federation SPI and LDAP/AD Integration">Federation provider SPI</a> . We have 2 federation providers with Kerberos authentication support:
                    </p><div class="variablelist"><dl><dt><span class="term">Kerberos</span></dt><dd>
                                <p>
                                    This provider is useful if you want to authenticate with Kerberos <code class="literal">NOT</code> backed by LDAP server.
                                    In this case, users are usually created to Keycloak database after first successful SPNEGO/Kerberos login
                                    and they may need to update profile after first login, as Kerberos protocol itself doesn't provision
                                    any data like first name, last name or email.
                                </p>
                                <p>
                                    You can also choose if users can authenticate with classic username/password. In this case, if user doesn't have SPNEGO ticket available,
                                    Keycloak will display login screen and user can fill his Kerberos username and password on login screen. Username/password works also for non-web flows like
                                    <a class="link" href="#direct-access-grants" title="Chapter 15. Direct Access Grants">Direct Access grants</a>.
                                </p>
                            </dd><dt><span class="term">LDAP</span></dt><dd>
                                <p>
                                    This provider is useful if you want to authenticate with Kerberos backed by LDAP server.
                                    In this case, data about users are provisioned from LDAP server after successful Kerberos authentication.
                                </p>
                            </dd></dl></div><p>
                </p>
            </li></ul></div>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2599"/>22.3. Setup and configuration of client machines</h2></div></div></div>
        
        <p>
            Clients need to install kerberos client and setup krb5.conf as described above. Additionally they need to enable SPNEGO login support in their browser.
            See for example <a class="ulink" href="http://www.microhowto.info/howto/configure_firefox_to_authenticate_using_spnego_and_kerberos.html">this</a>
            for more info about Firefox. URI <code class="literal">.mydomain.org</code> must be allowed in <code class="literal">network.negotiate-auth.trusted-uris</code> config option.
        </p>
        <p>
            In windows domain, clients usually don't need to configure anything special as IE is already able to participate in SPNEGO authentication for the windows domain.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2606"/>22.4. Example setups</h2></div></div></div>
        
        <p>
            For easier testing with Kerberos, we provided some example setups to test.
        </p>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e2609"/>22.4.1. Keycloak and FreeIPA docker image</h3></div></div></div>
            
            <p>
                Once you install <a class="ulink" href="https://www.docker.com/">docker</a>, you can run docker image with <a class="ulink" href="http://www.freeipa.org/">FreeIPA</a>
                server installed. FreeIPA provides integrated security solution with MIT Kerberos and 389 LDAP server among other things . The image provides
                also Keycloak server configured with LDAP Federation provider and enabled SPNEGO/Kerberos authentication against the FreeIPA server.
                See details <a class="ulink" href="https://github.com/mposolda/keycloak-freeipa-docker/blob/master/README.md">here</a> .
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e2615"/>22.4.2. ApacheDS testing Kerberos server</h3></div></div></div>
            
            <p>
                For quick testing and unit tests, we use very simple <a class="ulink" href="http://directory.apache.org/apacheds/">ApacheDS</a> Kerberos server.
                You need to build Keycloak from sources and then run Kerberos server with maven-exec-plugin from our testsuite. See details
                <a class="ulink" href="https://github.com/keycloak/keycloak/blob/master/misc/Testsuite.md#kerberos-server">here</a> .
            </p>
        </div>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2620"/>22.5. Credential delegation</h2></div></div></div>
        
        <p>
            One scenario supported by Kerberos 5 is credential delegation. In this case when user receives forwardable TGT and authenticates to the web server,
            then web server might be able to reuse the ticket and forward it to another service secured by Kerberos (for example LDAP server or IMAP server).
        </p>
        <p>
            The scenario is supported by Keycloak, but there is tricky thing that SPNEGO authentication is done by Keycloak server but
            GSS credential will need to be used by your application. So you need to enable built-in <code class="literal">gss delegation credential</code> protocol mapper
            in admin console for your application. This will cause that Keycloak will deserialize GSS credential and transmit it to the application
            in access token. Application will need to deserialize it and use it for further GSS calls against other services. We have an example, which is showing it in details. It's in <code class="literal">examples/kerberos</code>
            in the Keycloak example distribution or demo distribution download. You can also check the example sources directly <a class="ulink" href="https://github.com/keycloak/keycloak/blob/master/examples/kerberos">here</a> .
        </p>
        <p>
            Once you deserialize the credential from the access token to the GSSCredential object, then GSSContext will need to
            be created with this credential passed to the method <code class="literal">GSSManager.createContext</code> for example like this:
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
GSSContext context = gssManager.createContext(serviceName, krb5Oid,
    deserializedGssCredFromKeycloakAccessToken, GSSContext.DEFAULT_LIFETIME);
</pre><p>
        </p>
        <p>
            Note that you also need to configure <code class="literal">forwardable</code> kerberos tickets in <code class="literal">krb5.conf</code> file
            and add support for delegated credentials to your browser. For details, see the kerberos example from Keycloak examples set as mentioned above.
        </p>
        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2>
            <p>
                Credential delegation has some security implications. So enable the protocol claim and support in browser just if you really need it.
                It's highly recommended to use it together with HTTPS. See for example
                <a class="ulink" href="http://www.microhowto.info/howto/configure_firefox_to_authenticate_using_spnego_and_kerberos.html#idp27072">this article</a>
                for details.
            </p>
        </div>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2636"/>22.6. Troubleshooting</h2></div></div></div>
        
        <p>
            If you have issues, we recommend to enable more logging by:
            </p><div class="itemizedlist"><ul><li>
                    <p>
                        Enable <code class="literal">Debug</code> flag in admin console for Kerberos or LDAP federation providers
                    </p>
                </li><li>
                    <p>
                        Enable TRACE logging for category <code class="literal">org.keycloak</code> in logging section of <code class="literal">$WILDFLY_HOME/standalone/configuration/standalone.xml</code>
                        to receive more info <code class="literal">$WILDFLY_HOME/standalone/log/server.log</code>
                    </p>
                </li><li>
                    <p>
                        Add system properties <code class="literal">-Dsun.security.krb5.debug=true</code> and <code class="literal">-Dsun.security.spnego.debug=true</code>
                    </p>
                </li></ul></div><p>
        </p>
    </div>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="export-import"/>Chapter 23. Export and Import</h2></div></div></div>
    
    <p>
        Export/import is useful especially if you want to migrate your whole Keycloak database from one environment to another or migrate to different database (For example from MySQL to Oracle).
        You can trigger export/import at startup of Keycloak server and it's configurable with System properties right now. The fact it's done at server startup means that no-one can access Keycloak UI or REST endpoints
        and edit Keycloak database on the fly when export or import is in progress. Otherwise it could lead to inconsistent results.
    </p>
    <p>
        You can export/import your database either to:
        </p><div class="itemizedlist"><ul><li>Directory on local filesystem</li><li>Single JSON file on your filesystem</li></ul></div><p>

        When importing using the "dir" strategy, note that the files need to follow the naming convention specified below.
        If you are importing files which were previously exported, the files already follow this convention.
        </p><div class="itemizedlist"><ul><li>{REALM_NAME}-realm.json, such as "acme-roadrunner-affairs-realm.json" for the realm named "acme-roadrunner-affairs"</li><li>{REALM_NAME}-users-{INDEX}.json, such as "acme-roadrunner-affairs-users-0.json" for the first users file of the realm named "acme-roadrunner-affairs"</li></ul></div><p>
    </p>
    <p>
        If you import to Directory, you can specify also the number of users to be stored in each JSON file. So if you have
        very large amount of users in your database, you likely don't want to import them into single file as the file might be very big.
        Processing of each file is done in separate transaction as exporting/importing all users at once could also lead to memory issues.
    </p>
    <p>
        To export into unencrypted directory you can use:
        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
bin/standalone.sh -Dkeycloak.migration.action=export
-Dkeycloak.migration.provider=dir -Dkeycloak.migration.dir=&lt;DIR TO EXPORT TO&gt;
</pre><p>
        And similarly for import just use <code class="literal">-Dkeycloak.migration.action=import</code> instead of <code class="literal">export</code> .
    </p>
    <p>
        To export into single JSON file you can use:
        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
bin/standalone.sh -Dkeycloak.migration.action=export
-Dkeycloak.migration.provider=singleFile -Dkeycloak.migration.file=&lt;FILE TO EXPORT TO&gt;
</pre><p>
    </p>
    <p>
        Here's an example of importing:
        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
bin/standalone.sh -Dkeycloak.migration.action=import
-Dkeycloak.migration.provider=singleFile -Dkeycloak.migration.file=&lt;FILE TO IMPORT&gt;
-Dkeycloak.migration.strategy=OVERWRITE_EXISTING
</pre><p>
    </p>
    <p>
        Other available options are:
        </p><div class="variablelist"><dl><dt><span class="term">-Dkeycloak.migration.realmName</span></dt><dd>
                    <p>
                        can be used if you want to export just one specified realm instead of all.
                        If not specified, then all realms will be exported.
                    </p>
                </dd><dt><span class="term">-Dkeycloak.migration.usersExportStrategy</span></dt><dd>
                    <p>
                        can be used to specify for Directory providers to specify where to import users.
                        Possible values are:
                        </p><div class="itemizedlist"><ul><li>DIFFERENT_FILES - Users will be exported into more different files according to maximum number of users per file. This is default value</li><li>SKIP - exporting of users will be skipped completely</li><li>REALM_FILE - All users will be exported to same file with realm (So file like "foo-realm.json" with both realm data and users)</li><li>SAME_FILE - All users will be exported to same file but different than realm (So file like "foo-realm.json" with realm data and "foo-users.json" with users)</li></ul></div><p>
                    </p>
                </dd><dt><span class="term">-Dkeycloak.migration.usersPerFile</span></dt><dd>
                    <p>
                        can be used to specify number of users per file (and also per DB transaction).
                        It's 5000 by default. It's used only if usersExportStrategy is DIFFERENT_FILES
                    </p>
                </dd><dt><span class="term">-Dkeycloak.migration.strategy</span></dt><dd>
                    <p>
                        is used during import. It can be used to specify how to proceed if realm with same name
                        already exists in the database where you are going to import data. Possible values are:
                        </p><div class="itemizedlist"><ul><li>IGNORE_EXISTING - Ignore importing if realm of this name already exists</li><li>OVERWRITE_EXISTING - Remove existing realm and import it again with new data from JSON file.
                                If you want to fully migrate one environment to another and ensure that the new environment will contain same data
                                like the old one, you can specify this.
                            </li></ul></div><p>
                    </p>
                </dd></dl></div><p>
    </p>
    <p>
        When importing realm files that weren't exported before, the option <code class="literal">keycloak.import</code> can be used. If more than one realm
        file needs to be imported, a comma separated list of file names can be specified. This is more appropriate than the cases before, as this
        will happen only after the master realm has been initialized. Examples:
        </p><div class="itemizedlist"><ul><li>-Dkeycloak.import=/tmp/realm1.json</li><li>-Dkeycloak.import=/tmp/realm1.json,/tmp/realm2.json</li></ul></div><p>
    </p>

</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="admin-recovery"/>Chapter 24. Recovering the Master Admin User</h2></div></div></div>
    
    <p>
        It is possible for the "admin" user in the master realm to become inoperable.  This may be because it was
        accidentally deleted, its role mappings were removed, or the password was simply forgotten.
    </p>
    <p>
        To recover the master admin user, just start the server with the following system properties:
        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
bin/standalone.sh -Dkeycloak.recover-admin=true -Dkeycloak.temp-admin-password=temppassword
</pre><p>
        Then you can log in to the master admin account with your temporary password.  You will then be
        prompted to immediately change this password.
    </p>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="server_cache"/>Chapter 25. Server Cache</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e2710">25.1. Disabling Caches</a></span></dt><dt><span class="section"><a href="#d4e2720">25.2. Clear Caches</a></span></dt><dt><span class="section"><a href="#d4e2723">25.3. Cache Config</a></span></dt></dl></div>
    
    <p>
        By default, Keycloak caches realm metadata and users.  There are two separate caches, one for realm metadata
        (realm, application, client, roles, etc...) and one for users.  These caches greatly improves the performance of the server.
    </p>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2710"/>25.1. Disabling Caches</h2></div></div></div>
        
        <p>
            The realm and user caches can be disabled through configuration or through the management console.  To
            manally disable the realm or user cache, you must edit the <code class="literal">keycloak-server.json</code> file
            in your distribution.  Here's what the config looks like initially.
        </p>
        <p>
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    "realmCache": {
        "provider": "${keycloak.realm.cache.provider:mem}"
    },

    "userCache": {
        "provider": "${keycloak.user.cache.provider:mem}",
        "mem": {
            "maxSize": 20000
        }
    },
</pre><p>
        </p>
        <p>You must then change it to:
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    "realmCache": {
        "provider": "${keycloak.realm.cache.provider:none}"
    },

    "userCache": {
        "provider": "${keycloak.user.cache.provider:none}"
    },
</pre><p>
        </p>
        <p>
           You can also disable either of the caches at runtime through the Keycloak admin console Realm Settings page.
           This will not permanently disable the cache.  If you reboot the server, the cache will be re-enabled unless
            you manualy disable the cache in the <code class="literal">keycloak-server.json</code> file.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2720"/>25.2. Clear Caches</h2></div></div></div>
        
        <p>
            To clear the realm or user cache, go to the Keycloak admin console Realm Settings-&gt;Cache Config page.  Disable the cache
            you want.  Save the settings.  Then re-enable the cache.  This will cause the cache to be cleared.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2723"/>25.3. Cache Config</h2></div></div></div>
        
        <p>
            Cache configuration is done within <code class="literal">keycloak-server.json</code>.  Changes to this file will not
            be seen by the server until you reboot.  Currently you can only configure the max size of the user cache.
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    "userCache": {
        "provider": "${keycloak.user.cache.provider:mem}",
        "mem": {
            "maxSize": 20000
        }
    },
</pre><p>
        </p>
    </div>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="saml"/>Chapter 26. SAML SSO</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e2804">26.1. SAML Entity Descriptor</a></span></dt><dt><span class="section"><a href="#d4e2811">26.2. IDP Initiated Login</a></span></dt></dl></div>
    
    <p>
        Keycloak supports SAML 2.0 for registered applications.  Both POST and Redirect bindings are supported.  You can choose
        to require client signature validation and can have the server sign and/or encrypt responses as well.  We do not
        yet support logout via redirects.  All logouts happen via a background POST binding request to the application
        that will be logged out.  We do not support SAML 1.1 either.  If you want support for either of those, please
        log a JIRA request and we'll schedule it.
    </p>
    <p>
        When you create an application in the admin console, you can choose which protocol the application will log in with.
        In the application create screen, choose <code class="literal">saml</code> from the protocol list.  After that there
        are a bunch of configuration options.  Here is a description of each item:
    </p>
    <p>
        </p><div class="variablelist"><dl><dt><span class="term">Include AuthnStatement</span></dt><dd>
                    <p>
                        SAML login responses may specify the authentication method used (password, etc.) as well as
                        a timestamp of the login.  Setting this to on will include that statement in the response document.
                    </p>
                </dd><dt><span class="term">Multi-valued Roles</span></dt><dd>
                    <p>
                        If this switch is off, any user role mappings will have a corresponding attribute created for it.
                        If this switch is turn on, only one role attribute will be created, but it will have
                        multiple values within in.
                    </p>
                </dd><dt><span class="term">Sign Documents</span></dt><dd>
                    <p>
                        When turned on, Keycloak will sign the document using the realm's private key.
                    </p>
                </dd><dt><span class="term">Sign Assertions</span></dt><dd>
                    <p>
                        With the <code class="literal">Sign Documents</code> switch signs the whole document.  With this setting
                        you just assign the assertions of the document.
                    </p>
                </dd><dt><span class="term">Signature Algorithm</span></dt><dd>
                    <p>
                        Choose between a variety of algorithms for signing SAML documents.
                    </p>
                </dd><dt><span class="term">Encrypt Assertions</span></dt><dd>
                    <p>
                        Encrypt assertions in SAML documents with the realm's private key.  The AES algorithm is used
                        with a key size of 128 bits.
                    </p>
                </dd><dt><span class="term">Client Signature Required</span></dt><dd>
                    <p>
                        Expect that documents coming from a client are signed.  Keycloak will validate this signature
                        using the client keys set up in the <code class="literal">Application Keys</code> submenu item.
                    </p>
                </dd><dt><span class="term">Force POST Binding</span></dt><dd>
                    <p>
                        By default, Keycloak will respond using the initial SAML binding of the original request.  By turning
                        on this switch, you will force Keycloak to always respond using the SAML POST Binding even if the
                        original request was the Redirect binding.
                    </p>
                </dd><dt><span class="term">Front Channel Logout</span></dt><dd>
                    <p>
                        If true, this application requires a browser redirect to be able to perform a logout.  For example,
                        the application may require a cookie to be reset which could only be done by a done via a redirect.
                        If this switch is false, then Keycloak will invoke a background SAML request to logout the application.
                    </p>
                </dd><dt><span class="term">Force Name ID Format</span></dt><dd>
                    <p>
                        If the request has a name ID policy, ignore it and used the value configured in the admin console
                        under Name ID Format
                    </p>
                </dd><dt><span class="term">Name ID Format</span></dt><dd>
                    <p>
                        Name ID Format for the subject.  If no name ID policy is specified in the request or if the
                        Force Name ID Format attribute is true, this value is used.
                    </p>
                </dd><dt><span class="term">Master SAML Processing URL</span></dt><dd>
                    <p>
                        This URL will be used for all SAML requests and responsed directed to the SP.  It will be used
                        as the Assertion Consumer Service URL and the Single Logout Service URL.  If a login request
                        contains the Assertion Consumer Service URL, that will take precedence, but this URL must be valided
                        by a registered Valid Redirect URI pattern
                    </p>
                </dd><dt><span class="term">Assertion Consumer Service POST Binding URL</span></dt><dd>
                    <p>
                        POST Binding URL for the Assertion Consumer Service.
                    </p>
                </dd><dt><span class="term">Assertion Consumer Service Redirect Binding URL</span></dt><dd>
                    <p>
                        Redirect Binding URL for the Assertion Consumer Service.
                    </p>
                </dd><dt><span class="term">Logout Service POST Binding URL</span></dt><dd>
                    <p>
                        POST Binding URL for the Logout Service.
                    </p>
                </dd><dt><span class="term">Logout Service Redirect Binding URL</span></dt><dd>
                    <p>
                        Redirect Binding URL for the Logout Service.
                    </p>
                </dd></dl></div><p>
    </p>
    <p>
        For login to work, Keycloak needs to be able to resolve the URL for the Assertion Consumer Service of the SP.  If
        you are relying on the SP to provide this URL in the login request, then you must register valid redirect uri patterns
        so that this URL can be validated.  You can set the Master SAML Processing URL as well, or alternatively, you can
        specify the Assertion Consumer Service URL per binding.
    </p>
    <p>
        For logout to work, you must specify a Master SAML Processing URL, or the Loging Service URL for the binding
        you want Keycloak to use.
    </p>
    <p>
        One thing to note is that roles are not treated as a hierarchy.  So, any role mappings will just be added
        to the role attributes in the SAML document using their basic name.  So, if you have multiple application roles
        you might have name collisions.  You can use the Scope Mapping menu item to control which role mappings are set
        in the response.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2804"/>26.1. SAML Entity Descriptor</h2></div></div></div>
        
        <p>
            If you go into the admin console in the application list menu page you will see an <code class="literal">Import</code>
            button.  If you click on that you can import SAML Service Provider definitions using the <a class="ulink" href="http://docs.oasis-open.org/security/saml/v2.0/saml-metadata-2.0-os.pdf">Entity Descriptor</a>
            format described in SAML 2.0.  You should review all the information there to make sure everything is set up correctly.
        </p>
        <p>
            Each realm has a URL where you can view the XML entity descriptor for the IDP.  <code class="literal">root/auth/realms/{realm}/protocol/saml/descriptor</code>
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2811"/>26.2. IDP Initiated Login</h2></div></div></div>
        
        <p>
            IDP Initiated Login is a feature that where you can set up a URL on the Keycloak server that will log you into a specific application/client.  To set this up
            go to the client page in the admin console of the client you want to set this up for.  Specify the <code class="literal">IDP Initiated SSO URL Name</code>.  This is a simple string
            with no whitespace in it.  After this you can reference your client at the following URL:  <code class="literal">root/auth/realms/{realm}/protocol/saml/clients/{url-name}</code>
        </p>
        <p>
            If your client requires a special relay state, you can also configure this in the admin console.  Alternatively, you can specify the relay state in a
            <code class="literal">RelayState</code> query parameter, i.e. :  <code class="literal">root/auth/realms/{realm}/protocol/saml/clients/{url-name}?RelayState=thestate</code>
        </p>
    </div>
</div>

    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="security_vulnerabilities"/>Chapter 27. Security Vulnerabilities</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e2823">27.1. SSL/HTTPS Requirement</a></span></dt><dt><span class="section"><a href="#d4e2829">27.2. CSRF Attacks</a></span></dt><dt><span class="section"><a href="#d4e2835">27.3. Clickjacking</a></span></dt><dt><span class="section"><a href="#d4e2841">27.4. Compromised Access Codes</a></span></dt><dt><span class="section"><a href="#d4e2844">27.5. Compromised access and refresh tokens</a></span></dt><dt><span class="section"><a href="#d4e2848">27.6. Open redirectors</a></span></dt><dt><span class="section"><a href="#d4e2852">27.7. Password guess: brute force attacks</a></span></dt><dt><span class="section"><a href="#d4e2859">27.8. Password database compromised</a></span></dt><dt><span class="section"><a href="#d4e2862">27.9. SQL Injection attacks</a></span></dt><dt><span class="section"><a href="#d4e2865">27.10. Limiting Scope</a></span></dt></dl></div>
    
    <p>
        This chapter discusses possible security vulnerabilities Keycloak could have, how Keycloak mitigates those
        vulnerabilities, and what steps you need to do to configure Keycloak to mitigate some vulnerabilities.  A good list
        of potential vulnerabilities and what security implementations should do to mitigate them can be found in the
        <a class="ulink" href="http://tools.ietf.org/html/rfc6819">OAuth 2.0 Threat Model</a> document put out by the IETF.  Many of those vulnerabilities are discussed here.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2823"/>27.1. SSL/HTTPS Requirement</h2></div></div></div>
        
        <p>
            If you do not use SSL/HTTPS for all communication between the Keycloak auth server and the clients it secures
            you will be very vulnerable to man in the middle attacks.  OAuth 2.0/OpenID Connect uses access tokens for
            security.  Without SSL/HTTPS, attackers can sniff your network and obtain an access token.  Once they have an
            access token they can do any operation that the token has been given permission for.
        </p>
        <p>
            Keycloak has <a class="link" href="#ssl_modes" title="3.2.5. SSL/HTTPS Requirement/Modes">three modes for SSL/HTTPS</a>.  SSL can be hard to set up, so out of the box, Keycloak allows
            non-HTTPS communication over private IP addresses like localhost, 192.168.x.x, and other private IP addresses.
            In production, you should make sure SSL is enabled and required across the board.
        </p>
        <p>
            On the adapter/client side, Keycloak allows you to turn off the SSL trust manager.  The trust manager ensures
            identity the client is talking to.  It checks the DNS domain name against the server's certificate.  In production
            you should make sure that each of your client adapters is configured to use a truststore.  Otherwise you are vulnerable
            to DNS man in the middle attacks.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2829"/>27.2. CSRF Attacks</h2></div></div></div>
        
        <p>
            Cross-site request forgery (CSRF) is a web-based attack whereby HTTP
            requests are transmitted from a user that the web site trusts or has
            authenticated (e.g., via HTTP redirects or HTML forms).  Any site that uses
            cookie based authentication is vulnerable for these types of attacks.  These attacks are mitigated
            by matching a state cookie against a posted form or query parameter.
        </p>
        <p>
            OAuth 2.0 login specification requires that a state cookie be used and matched against a transmitted state
            parameter.  Keycloak fully implements this part of the specification so all logins are protected.
        </p>
        <p>
            The Keycloak adminstration console is a pure Javascript/HTML5 application that makes REST calls to the
            backend Keycloak admin API.  These calls all require bearer token authentication and are made via Javascript
            Ajax calls.  CSRF does not apply here.  The admin REST API can also be configured to validate CORS origins
            as well.
        </p>
        <p>
            The only part of Keycloak that really falls into CSRF is the user account management pages.  To mitigate this
            Keycloak sets a state cookie and also embeds the value of this state cookie within hidden form fields or
            query parameters in action links.  This query or form parameter is checked against the state cookie to verify
            that the call was made by the user.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2835"/>27.3. Clickjacking</h2></div></div></div>
        
        <p>
            With clickjacking, a malicious site loads the target site in a
            transparent iFrame overlaid on top of a set of dummy
            buttons that are carefully constructed to be placed directly under
            important buttons on the target site.  When a user clicks a visible
            button, they are actually clicking a button (such as an "Authorize"
            button) on the hidden page.  An attacker can steal a user's authentication credentials and
            access their resources.
        </p>
        <p>
            By default, every response by Keycloak sets some specific browser headers that can prevent this from happening
            specifically <a class="ulink" href="http://tools.ietf.org/html/rfc7034">X-FRAME_OPTIONS</a> and <a class="ulink" href="http://www.w3.org/TR/CSP/">Content-Security-Policy</a>.  You
            should take a look at both of these headers.  In the admin console you can specify the values these headers will
            have.  By default, Keycloak only sets up a same-origin policy for iframes.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2841"/>27.4. Compromised Access Codes</h2></div></div></div>
        
        <p>
            It would be very hard for an attacker to compromise Keycloak access codes.  Keycloak generates a cryptographically
            strong random value for its access codes so it would be very hard to guess an access token.
            An access code can only be turned into an access token once so it can't be replayed.  In the admin console
            you can specify how long an access token is valid for.  This value should be really short.  Like a seconds.
            Just long enough for the client to make the request to turn the code into an token.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2844"/>27.5. Compromised access and refresh tokens</h2></div></div></div>
        
        <p>
            There's a few things you can do to mitigate access tokens and refresh tokens from being stolen.
            Most importantly is to enforce SSL/HTTPS communication between Keycloak and its clients and applications.
            Short lifespans (minutes) for access tokens allows Keycloak to check the validity of a refresh token.  Making
            sure refresh tokens always stay private to the client and are never transmitted ever is very important as well.
        </p>
        <p>
            If an access token or refresh token is compromised, the first thing you should do is go to the admin console
            and push a not-before revocation policy to all applications.  This will enforce that any tokens issued
            prior to that date are now invalid.  You can also disable specific applications, clients, and users if you
            feel that any one of those entities is completely compromised.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2848"/>27.6. Open redirectors</h2></div></div></div>
        
        <p>
            An attacker could use the end-user authorization endpoint and the
            redirect URI parameter to abuse the authorization server as an open
            redirector.  An open redirector is an endpoint using a parameter to
            automatically redirect a user agent to the location specified by the
            parameter value without any validation.  An attacker could utilize a user's trust in an authorization
            server to launch a phishing attack.
        </p>
        <p>
            Keycloak requires that all registered applications and clients register at least one redirection uri pattern.
            Any time a client asks Keycloak to perform a redirect (on login or logout for example), Keycloak will
            check the redirect uri vs. the list of valid registered uri patterns.  It is important that clients and
            applications register as specific a URI pattern as possible to mitigate open redirector attacks.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2852"/>27.7. Password guess: brute force attacks</h2></div></div></div>
        
        <p>
            A brute force attack happens when an attacker is trying to guess a user's password.  Keycloak has some
            limited brute force detection capabilities.  If turned on, a user account will be temporarily disabled
            if a threshold of login failures is reached.  The downside of this is that this makes Keycloak vulnerable
            to denial of service attacks.  Eventually we will expand this functionality to take client IP address into
            account when deciding whether to block a user.
        </p>
        <p>
            Another thing you can do to prevent password guessing is to point a tool like <a class="ulink" href="http://fail2ban.org">Fail2Ban</a> to the Keycloak
            server's log file.  Keycloak logs every login failure and client IP address that had the failure.
        </p>
        <p>
            In the admin console, per realm, you can set up a password policy to enforce that users pick hard to guess passwords.
            A password has to match all policies. The password policies that can be configured are hash iterations, length, digits,
            lowercase, uppercase, special characters, not username, regex patterns, password history and force expired password update. 
            Force expired password update policy forces or requires password updates after specified span of time. Password history policy 
            restricts a user from resetting his password to N old expired passwords. Multiple regex patterns can be specified.
            If there's more than one regex added, password has to match all fully.
            Increasing number of Hash Iterations (n) does not worsen anything (and certainly not the cipher) and it greatly increases the 
            resistance to dictionary attacks. However the drawback to increasing n is that it has some cost (CPU usage, energy, delay) for 
            the legitimate parties. Increasing n also slightly increases the odds that a random password gives the same result as the right 
            password due to hash collisions, and is thus a false but accepted password; however that remains very unlikely, in the order of 
            n*[1/(2^256)] for practical values of n, and can be entirely ignored in practice. Keycloak also uses PBKDF2 internally to 
            cryptographically derive passwords to refine and improve the ratio of cost between attacker and legitimate parties.
            Good practice is to pay attention to the time complexity of hash_password and hash; then increase n as much as tolerable in 
            the situation(s) at hand and and revise parameters such as n every few years to account for time complexity trade off.
        </p>
        <p>
            Finally, the best way to mitigate against brute force attacks is to require user to set up a one-time-password (OTP).
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2859"/>27.8. Password database compromised</h2></div></div></div>
        
        <p>
            Keycloak does not store passwords in raw text.  It stores a hash of them.  Because of performance reasons,
            Keycloak only hashes passwords once.  While a human could probably never crack a hashed password, it is very
            possible that a computer could.  The security community suggests around 20,000 (yes thousand!) hashing iterations
            to be done to each password.  This number grows every year due to increasing computing power (It was 1000 12 years ago).
            The problem with this is that password hashing is a huge performance hit as each login would require the entered
            password to be hashed that many times and compared to the stored hash.  So, its up to the admin to configure the
            password hash iterations.  This can be done in the admin console password policy configuration.  Again, the default
            value is 1 as we thought it might be more important for Keycloak to scale out of the box.  There's a lot of
            other measures admins can do to protect their password databases.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2862"/>27.9. SQL Injection attacks</h2></div></div></div>
        
        <p>
            At this point in time, there is no knowledge of any SQL injection vulnerabilities in Keycloak
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2865"/>27.10. Limiting Scope</h2></div></div></div>
        
        <p>
            Using the <code class="literal">Scope</code> menu in the admin console for clients, you can control
            exactly which role mappings will be included within the token sent back to the client application.  This
            allows you to limit the scope of permissions given to the client which is great if the client isn't
            very trusted and is known to not being very careful with its tokens.
        </p>
    </div>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="clustering"/>Chapter 28. Clustering</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e2884">28.1. Configure a shared database</a></span></dt><dt><span class="section"><a href="#d4e2887">28.2. Configure Infinispan</a></span></dt><dt><span class="section"><a href="#d4e2907">28.3. Start in HA mode</a></span></dt><dt><span class="section"><a href="#d4e2915">28.4. Enabling cluster security</a></span></dt><dt><span class="section"><a href="#d4e2926">28.5. Troubleshooting</a></span></dt></dl></div>
    

    <p>To improve availability and scalability Keycloak can be deployed in a cluster.</p>

    <p>It's fairly straightforward to configure a Keycloak cluster, the steps required are:
        </p><div class="itemizedlist"><ul><li>
                <p>
                    Configure a shared database
                </p>
            </li><li>
                <p>
                    Configure Infinispan
                </p>
            </li><li>
                <p>
                    Enable realm and user cache invalidation
                </p>
            </li><li>
                <p>
                    Enable distributed user sessions
                </p>
            </li><li>
                <p>
                    Start in HA mode
                </p>
            </li></ul></div><p>
    </p>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2884"/>28.1. Configure a shared database</h2></div></div></div>
        
        <p>
            Keycloak doesn't replicate realms and users, but instead relies on all nodes using the same
            database. This can be a relational database or Mongo. To make sure your database doesn't become a single
            point of failure you may also want to deploy your database to a cluster.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2887"/>28.2. Configure Infinispan</h2></div></div></div>
        
        <p>
            Keycloak uses <a class="ulink" href="http://www.infinispan.org/">Infinispan</a> caches to share information between nodes.
        </p>
        <p>
            For realm and users Keycloak uses a invalidation cache. An invalidation cache doesn't share any data, but simply
            removes stale data from remote caches and makes sure all nodes re-load data from the database when it is changed. This reduces network traffic, as well as preventing sensitive data (such as
            realm keys and password hashes) from being sent between the nodes.
        </p>
        <p>
            User sessions and login failures supports either distributed caches or fully replicated caches. We recommend using a distributed
            cache. A distributed
            cache splits user sessions into segments where each node holds one or more segment. It is possible
            to replicate each segment to multiple nodes, but this is not strictly necessary since the failure of a node
            will only result in users having to log in again. If you need to prevent node failures from requiring users to
            log in again, set the <code class="literal">owners</code> attribute to 2 or more for the <code class="literal">sessions</code> cache
            of <code class="literal">infinispan/Keycloak</code> container as described below.
        </p>
        <p>
            The infinispan container is set by default in <code class="literal">standalone/configuration/keycloak-server.json</code>:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"connectionsInfinispan": {
    "default" : {
        "cacheContainer" : "java:jboss/infinispan/Keycloak"
    }
}
</pre><p>
        </p>
        <p>As you can see in this file, the realmCache, userCache and userSession providers are configured to use infinispan by default, which applies for both cluster and non-cluster environment.</p>
        <p>
            For non-cluster configuration (server executed with <code class="literal">standalone.xml</code> ) is the infinispan container <code class="literal">infinispan/Keycloak</code> just uses local infinispan caches for realms, users and userSessions.
        </p>
        <p>
            For cluster configuration, you can edit the configuration of <code class="literal">infinispan/Keycloak</code> container in <code class="literal">standalone/configuration/standalone-ha.xml</code> (or <code class="literal">standalone-keycloak-ha.xml</code>
            if you are using overlay or demo distribution) .
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2907"/>28.3. Start in HA mode</h2></div></div></div>
        
        <p>
            To start the server in HA mode, start it with:
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""># bin/standalone --server-config=standalone-ha.xml</pre><p>
            or if you are using overlay or demo distribution with:
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""># bin/standalone --server-config=standalone-keycloak-ha.xml</pre><p>
        </p>
        <p>
            Alternatively you can copy <code class="literal">standalone/config/standalone-ha.xml</code> to <code class="literal">standalone/config/standalone.xml</code>
            to make it the default server config.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2915"/>28.4. Enabling cluster security</h2></div></div></div>
        
        <p>
            By default there's nothing to prevent unauthorized nodes from joining the cluster and sending potentially malicious
            messages to the cluster. However, as there's no sensitive data sent there's not much that can be achieved.
            For realms and users all that can be done is to send invalidation messages to make nodes load data from the
            database more frequently. For user sessions it would be possible to modify existing user sessions, but creating
            new sessions would have no affect as they would not be linked to any access tokens. There's not too much that
            can be achieved by modifying user sessions. For example it would be possible to prevent sessions from expiring,
            by changing the creation time. However, it would for example have no effect adding additional permissions to the
            sessions as these are rechecked against the user and application when the token is created or refreshed.
        </p>
        <p>
            In either case your cluster nodes should be in a private network, with a firewall protecting them from outside
            attacks. Ideally isolated from workstations and laptops. You can also enable encryption of cluster messages,
            this could for example be useful if you can't isolate cluster nodes from workstations and laptops on your private
            network. However, encryption will obviously come at a cost of reduced performance.
        </p>
        <p>
            To enable encryption of cluster messages you first have to create a shared keystore (change the key and store passwords!):
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

# keytool -genseckey -alias keycloak -keypass &lt;PASSWORD&gt; -storepass &lt;PASSWORD&gt; \
 -keyalg Blowfish -keysize 56 -keystore defaultStore.keystore -storetype JCEKS

</pre><p>
        </p>
        <p>
            Copy this keystore to all nodes (for example to standalone/configuration). Then configure JGroups to encrypt all
            messages by adding the <code class="literal">ENCRYPT</code> protocol to the JGroups sub-system (this should be added after
            the <code class="literal">pbcast.GMS</code> protocol):
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;subsystem xmlns="urn:jboss:domain:jgroups:2.0" default-stack="udp"&gt;
    &lt;stack name="udp"&gt;
        ...
        &lt;protocol type="pbcast.GMS"/&gt;
        &lt;protocol type="ENCRYPT"&gt;
            &lt;property name="key_store_name"&gt;
                ${jboss.server.config.dir}/defaultStore.keystore
            &lt;/property&gt;
            &lt;property name="key_password"&gt;PASSWORD&lt;/property&gt;
            &lt;property name="store_password"&gt;PASSWORD&lt;/property&gt;
            &lt;property name="alias"&gt;keycloak&lt;/property&gt;
        &lt;/protocol&gt;
        ...
    &lt;/stack&gt;
    &lt;stack name="tcp"&gt;
        ...
        &lt;protocol type="pbcast.GMS"/&gt;
        &lt;protocol type="ENCRYPT"&gt;
            &lt;property name="key_store_name"&gt;
                ${jboss.server.config.dir}/defaultStore.keystore
            &lt;/property&gt;
            &lt;property name="key_password"&gt;PASSWORD&lt;/property&gt;
            &lt;property name="store_password"&gt;PASSWORD&lt;/property&gt;
            &lt;property name="alias"&gt;keycloak&lt;/property&gt;
        &lt;/protocol&gt;
        ...
    &lt;/stack&gt;
    ...
&lt;/subsystem&gt;

</pre><p>
            See the <a class="ulink" href="http://www.jgroups.org/manual/index.html#ENCRYPT">JGroups manual</a> for more details.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e2926"/>28.5. Troubleshooting</h2></div></div></div>
        
        <p>
            Note that when you run cluster, you should see message similar to this in the log of both cluster nodes:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (Incoming-10,shared=udp)
ISPN000094: Received new cluster view: [node1/keycloak|1] (2) [node1/keycloak, node2/keycloak]

</pre><p>
            If you see just one node mentioned, it's possible that your cluster hosts are not joined together.
        </p>
        <p>
            Usually it's best practice to have your cluster nodes on private network without firewall for communication among them.
            Firewall could be enabled just on public access point to your network instead. If for some reason you still need to have firewall
            enabled on cluster nodes, you will need to open some ports. Default values are UDP port 55200 and multicast port 45688
            with multicast address 230.0.0.4. Note that you may need more ports opened if you want to enable additional features like diagnostics for your JGroups stack.
            Keycloak delegates most of the clustering work to Infinispan/JGroups, so consult EAP or JGroups documentation for more info.
        </p>
    </div>

</div>

    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="applicationClustering"/>Chapter 29. Application Clustering</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#stateless-token-store">29.1. Stateless token store</a></span></dt><dt><span class="section"><a href="#relative-uri-optimization">29.2. Relative URI optimization</a></span></dt><dt><span class="section"><a href="#admin-url-configuration">29.3. Admin URL configuration</a></span></dt><dt><span class="section"><a href="#registration-app-nodes">29.4. Registration of application nodes to Keycloak</a></span></dt><dt><span class="section"><a href="#refresh-token-each-req">29.5. Refresh token in each request</a></span></dt></dl></div>
    

    <p>This chapter is focused on clustering support for your own AS7, EAP6 or Wildfly applications, which are secured by Keycloak.
        We support various deployment scenarios according if your application is:
        </p><div class="itemizedlist"><ul><li>
                <p>
                    stateless or stateful
                </p>
            </li><li>
                <p>
                    distributable (replicated http session) or non-distributable and just relying on sticky sessions provided by loadbalancer
                </p>
            </li><li>
                <p>
                    deployed on same or different cluster hosts where keycloak servers are deployed
                </p>
            </li></ul></div><p>
    </p>

    <p>
        The situation is a bit tricky as application communicates with Keycloak directly within user's browser (for example redirecting to login screen),
        but there is also backend (out-of-bound) communication between keycloak and application, which is hidden from end-user
        and his browser and hence can't rely on sticky sessions.
    </p>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="stateless-token-store"/>29.1. Stateless token store</h2></div></div></div>
        
        <p>
            By default, the servlet web application secured by Keycloak uses HTTP session to store information about authenticated
            user account. This means that this info could be replicated across cluster and your application will safely survive
            failover of some cluster node.
        </p>
        <p>
            However if you don't need or don't want to use HTTP Session, you may alternatively save all info about authenticated
            account into cookie. This is useful especially if your application is:
            </p><div class="itemizedlist"><ul><li>
                    <p>
                        stateless application without need of HTTP Session, but with requirement to be safe to failover of some cluster node
                    </p>
                </li><li>
                    <p>
                        stateful application, but you don't want sensitive token data to be saved in HTTP session
                    </p>
                </li><li>
                    <p>
                        stateless application relying on loadbalancer, which is not aware of sticky sessions (in this case cookie is your only way)
                    </p>
                </li></ul></div><p>
        </p>
        <p>
            To configure this, you can add this line to configuration of your adapter in <code class="literal">WEB-INF/keycloak.json</code> of your application:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

"token-store": "cookie"

</pre><p>
        </p>
        <p>
            Default value of <code class="literal">token-store</code> is <code class="literal">session</code>, hence saving data in HTTP session.
        </p>
        <p>
            One limitation of cookie store is, that whole info about account is passed in cookie KEYCLOAK_ADAPTER_STATE in each HTTP request.
            Hence it's not the best for network performance.
            Another small limitation is limited support for Single-Sign out. It works without issues if you init servlet logout (HttpServletRequest.logout)
            from this application itself as the adapter will delete the KEYCLOAK_ADAPTER_STATE cookie. But back-channel logout initialized from different application can't be
            propagated by Keycloak to this application with cookie store. Hence it's recommended to use very short value of access token
            timeout (1 minute for example).
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="relative-uri-optimization"/>29.2. Relative URI optimization</h2></div></div></div>
        
        <p>
            In many deployment scenarios will be Keycloak and secured applications deployed on same cluster hosts. For this case Keycloak
            already provides option to use relative URI as value of option <span class="emphasis"><em>auth-server-url</em></span> in <code class="literal">WEB-INF/keycloak.json</code> .
            In this case, the URI of Keycloak server is resolved from the URI of current request.
        </p>
        <p>
            For example if your loadbalancer is on <span class="emphasis"><em>https://loadbalancer.com/myapp</em></span> and auth-server-url is <span class="emphasis"><em>/auth</em></span>,
            then relative URI of Keycloak is resolved to be  <span class="emphasis"><em>https://loadbalancer.com/auth</em></span> .
        </p>
        <p>
            For cluster setup, it may be even better to use option <span class="emphasis"><em>auth-server-url-for-backend-request</em></span> . This allows to configure
            that backend requests between Keycloak and your application will be sent directly to same cluster host without additional
            round-trip through loadbalancer. So for this, it's good to configure values in <code class="literal">WEB-INF/keycloak.json</code> like this:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

"auth-server-url": "/auth",
"auth-server-url-for-backend-requests": "http://${jboss.host.name}:8080/auth"

</pre><p>
        </p>
        <p>
            This would mean that browser requests (like redirecting to Keycloak login screen) will be still resolved relatively
            to current request URI like <span class="emphasis"><em>https://loadbalancer.com/myapp</em></span>, but backend (out-of-bound) requests between keycloak
            and your app are sent always to same cluster host with application .
        </p>
        <p>
            Note that additionally to network optimization,
            you may not need "https" in this case as application and keycloak are communicating directly within same cluster host.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="admin-url-configuration"/>29.3. Admin URL configuration</h2></div></div></div>
        
            <p>
                Admin URL for particular application can be configured in Keycloak admin console. It's used by Keycloak server to
                send backend requests to application for various tasks, like logout users or push revocation policies.
            </p>
            <p>
                For example logout of user from Keycloak works like this:
                </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                        <p>
                            User sends logout request from one of applications where he is logged.
                        </p>
                    </li><li>
                        <p>
                            Then application will send logout request to Keycloak
                        </p>
                    </li><li>
                        <p>
                            Keycloak server logout user in itself, and then it re-sends logout request by backend channel to all
                            applications where user is logged. Keycloak is using admin URL for this. So logout is propagated to all apps.
                        </p>
                    </li></ol></div><p>
            </p>
            <p>
                You may again use relative values for admin URL, but in cluster it may not be the best similarly like in <a class="link" href="#relative-uri-optimization" title="29.2. Relative URI optimization">previous section</a> .
            </p>
            <p>
                Some examples of possible values of admin URL are:
                </p><div class="variablelist"><dl><dt><span class="term">http://${jboss.host.name}:8080/myapp</span></dt><dd>
                            <p>
                                This is best choice if "myapp" is deployed on same cluster hosts like Keycloak and is distributable.
                                In this case Keycloak server sends logout request to itself, hence no communication with loadbalancer
                                or other cluster nodes and no additional network traffic.
                            </p>
                            <p>
                                Note that since the application is distributable,
                                the backend request sent by Keycloak could be served on any application cluster node as invalidation
                                of HTTP Session on <span class="emphasis"><em>node1</em></span> will propagate the invalidation to other cluster nodes due to replicated HTTP sessions.
                            </p>
                        </dd><dt><span class="term">http://${application.session.host}:8080/myapp</span></dt><dd>
                            <p>
                                Keycloak will track hosts where is particular HTTP Session served and it will send session
                                invalidation message to proper cluster node.
                            </p>
                            <p>
                                For example application is deployed on <span class="emphasis"><em>http://node1:8080/myapp</em></span> and <span class="emphasis"><em>http://node2:8080/myapp</em></span> .
                                Now HTTP Session <span class="emphasis"><em>session1</em></span> is sticky-session served on cluster node <span class="emphasis"><em>node2</em></span> .
                                When keycloak invalidates this session, it will send request directly to <span class="emphasis"><em>http://node2:8080/myapp</em></span> .
                            </p>
                            <p>
                                This is ideal configuration for distributable applications deployed on different host than keycloak
                                or for non-distributable applications deployed either on same or different nodes than keycloak.
                                Good thing is that it doesn't send requests through load-balancer and hence helps to reduce network traffic.
                            </p>
                        </dd></dl></div><p>
            </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="registration-app-nodes"/>29.4. Registration of application nodes to Keycloak</h2></div></div></div>
        
        <p>
            Previous section describes how can Keycloak send logout request to proper application node. However in some cases admin
            may want to propagate admin tasks to all registered cluster nodes, not just one of them. For example push new notBefore
            for realm or application, or logout all users from all applications on all cluster nodes.
        </p>
        <p>
            In this case Keycloak should
            be aware of all application cluster nodes, so it could send event to all of them. To achieve this, we support auto-discovery mechanism:
            </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                        Once new application node joins cluster, it sends registration request to Keycloak server
                    </p>
                </li><li>
                    <p>
                        The request may be re-sent to Keycloak in configured periodic intervals
                    </p>
                </li><li>
                    <p>
                        If Keycloak won't receive re-registration request within specified timeout (should be greater than period from point 2)
                        then it automatically unregister particular node
                    </p>
                </li><li>
                    <p>
                        Node is also unregistered in Keycloak when it sends unregistration request, which is usually during node
                        shutdown or application undeployment. This may not work properly for forced shutdown when
                        undeployment listeners are not invoked, so here you need to rely on automatic unregistration from point 3 .
                    </p>
                </li></ol></div><p>
        </p>
        <p>
                Sending startup registrations and periodic re-registration is disabled by default, as it's main usecase is just
                cluster deployment. In <code class="literal">WEB-INF/keycloak.json</code> of your application, you can specify:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

"register-node-at-startup": true,
"register-node-period": 600,

</pre><p>
                which means that registration is sent at startup (accurately when 1st request is served by the application node)
                and then it's resent each 10 minutes.
        </p>
        <p>
            In Keycloak admin console you can specify the maximum node re-registration timeout (makes sense to have it
            bigger than <span class="emphasis"><em>register-node-period</em></span> from adapter configuration for particular application). Also you
            can manually add and remove cluster nodes in admin console, which is useful if you don't want to rely on adapter's
            automatic registration or if you want to remove stale application nodes, which weren't unregistered
            (for example due to forced shutdown).
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="refresh-token-each-req"/>29.5. Refresh token in each request</h2></div></div></div>
        
        <p>
            By default, application adapter tries to refresh access token when it's expired (period can be specified as <a class="link" href="#token-timeouts" title="18.3. Token Timeouts">Access Token Lifespan</a>) .
            However if you don't want to rely on the fact, that Keycloak is able to successfully propagate admin events like logout
            to your application nodes, then you have possibility to configure adapter to refresh access token in each HTTP request.
        </p>
        <p>
            In <code class="literal">WEB-INF/keycloak.json</code> you can configure:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

"always-refresh-token": true

</pre><p>
        </p>
        <p>
            Note that this has big performance impact. It's useful just if performance is not priority, but security is critical
            and you can't rely on logout and push notBefore propagation from Keycloak to applications.
        </p>
    </div>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="proxy"/>Chapter 30. Keycloak Security Proxy</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e3037">30.1. Proxy Install and Run</a></span></dt><dt><span class="section"><a href="#d4e3045">30.2. Proxy Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e3049">30.2.1. Basic Config</a></span></dt><dt><span class="section"><a href="#d4e3105">30.2.2. Application Config</a></span></dt><dt><span class="section"><a href="#d4e3175">30.2.3. Header Names Config</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e3199">30.3. Keycloak Identity Headers</a></span></dt></dl></div>
    
    <p>
        Keycloak has an HTTP(S) proxy that you can put in front of web applications and services where it is not possible
        to install the keycloak adapter.  You can set up URL filters so that certain URLs are secured either by browser login
        and/or bearer token authentication.  You can also define role constraints for URL patterns within your applications.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3037"/>30.1. Proxy Install and Run</h2></div></div></div>
        
        <p>Download the keycloak proxy distribution from the Keycloak download pages and unzip it.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ unzip keycloak-proxy-dist.zip
</pre><p>
        </p>
        <p>
            To run it you must have a proxy config file (which we'll discuss in a moment).
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ java -jar bin/launcher.jar [your-config.json]
</pre><p>
        </p>
        <p>
            If you do not specify a path to the proxy config file, the launcher will look in the current working directory
            for the file named <code class="literal">proxy.json</code>
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3045"/>30.2. Proxy Configuration</h2></div></div></div>
        
        <p>
            Here's an example configuration file.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
{
    "target-url": "http://localhost:8082",
    "send-access-token": true,
    "bind-address": "localhost",
    "http-port": "8080",
    "https-port": "8443",
    "keystore": "classpath:ssl.jks",
    "keystore-password": "password",
    "key-password": "password",
    "applications": [
        {
            "base-path": "/customer-portal",
            "error-page": "/error.html",
            "adapter-config": {
                "realm": "demo",
                "resource": "customer-portal",
                "realm-public-key": "MIGfMA0GCSqGSIb",
                "auth-server-url": "http://localhost:8081/auth",
                "ssl-required" : "external",
                "principal-attribute": "name",
                "credentials": {
                    "secret": "password"
                }
            }
            ,
            "constraints": [
                {
                    "pattern": "/users/*",
                    "roles-allowed": [
                        "user"
                    ]
                },
                {
                    "pattern": "/admins/*",
                    "roles-allowed": [
                        "admin"
                    ]
                },
                {
                    "pattern": "/users/permit",
                    "permit": true
                },
                {
                    "pattern": "/users/deny",
                    "deny": true
                }
            ]
        }
    ]
}
</pre><p>
        </p>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3049"/>30.2.1. Basic Config</h3></div></div></div>
            
        <p>
            The basic configuration options for the server are as follows:
            </p><div class="variablelist"><dl><dt><span class="term">target-url</span></dt><dd>
                        <p>
                            The URL this server is proxying <span class="emphasis"><em>REQUIRED.</em></span>.
                        </p>
                    </dd><dt><span class="term">send-access-token</span></dt><dd>
                        <p>
                            Boolean flag.  If true, this will send the access token via the KEYCLOAK_ACCESS_TOKEN header to the
                            proxied server. <span class="emphasis"><em>OPTIONAL.</em></span>.  Default is false.
                        </p>
                    </dd><dt><span class="term">bind-address</span></dt><dd>
                        <p>
                            DNS name or IP address to bind the proxy server's sockets to.
                            <span class="emphasis"><em>OPTIONAL.</em></span>.  The default value is <span class="emphasis"><em>localhost</em></span>
                        </p>
                    </dd><dt><span class="term">http-port</span></dt><dd>
                        <p>
                            Port to listen for HTTP requests.  If you do not specify this value, then the proxy will
                            not listen for regular HTTP requests.
                            <span class="emphasis"><em>OPTIONAL.</em></span>.
                        </p>
                    </dd><dt><span class="term">https-port</span></dt><dd>
                        <p>
                            Port to listen for HTTPS requests.  If you do not specify this value, then the proxy will
                            not listen for HTTPS requests.
                            <span class="emphasis"><em>OPTIONAL.</em></span>.
                        </p>
                    </dd><dt><span class="term">keystore</span></dt><dd>
                        <p>
                            Path to a Java keystore file that contains private key and certificate for the server to be
                            able to handle HTTPS requests.  Can be a file path, or, if you prefix it with <code class="literal">classpath:</code>
                            it will look for this file in the classpath.
                            <span class="emphasis"><em>OPTIONAL.</em></span>.  If you have enabled HTTPS, but have not defined a keystore, the proxy
                            will auto-generate a self-signed certificate and use that.
                        </p>
                    </dd><dt><span class="term">buffer-size</span></dt><dd>
                        <p>
                            HTTP server socket buffer size.  Usually the default is good enough. <span class="emphasis"><em>OPTIONAL.</em></span>.
                        </p>
                    </dd><dt><span class="term">buffers-per-region</span></dt><dd>
                        <p>
                            HTTP server socket buffers per region.  Usually the default is good enough. <span class="emphasis"><em>OPTIONAL.</em></span>.
                        </p>
                    </dd><dt><span class="term">io-threads</span></dt><dd>
                        <p>
                            Number of threads to handle IO.  Usually default is good enough.  <span class="emphasis"><em>OPTIONAL.</em></span>.
                            The default is the number of available processors * 2.
                        </p>
                    </dd><dt><span class="term">worker-threads</span></dt><dd>
                        <p>
                            Number of threads to handle requests.  Usually the default is good enough. <span class="emphasis"><em>OPTIONAL.</em></span>.
                            The default is the number of available processors * 16.
                        </p>
                    </dd></dl></div><p>
        </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3105"/>30.2.2. Application Config</h3></div></div></div>
            
            <p>
                Next under the <code class="literal">applications</code> array attribute, you can define one or more applications per host you are proxying.
                </p><div class="variablelist"><dl><dt><span class="term">base-path</span></dt><dd>
                            <p>
                                The base context root for the application.  Must start with '/' <span class="emphasis"><em>REQUIRED.</em></span>.
                            </p>
                        </dd><dt><span class="term">error-page</span></dt><dd>
                            <p>
                                If the proxy has an error, it will display the target application's error page relative URL <span class="emphasis"><em>OPTIONAL.</em></span>.
                                This is a relative path to the base-path.  In the example above it would be <code class="literal">/customer-portal/error.html</code>.
                            </p>
                        </dd><dt><span class="term">adapter-config</span></dt><dd>
                            <p>
                                <span class="emphasis"><em>REQUIRED.</em></span>.  Same configuration as any other keycloak adapter.  See <a class="link" href="#adapter-config" title="8.1. General Adapter Config">Adapter Config</a>
                            </p>
                        </dd></dl></div><p>
            </p>
            <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3127"/>30.2.2.1. Constraint Config</h4></div></div></div>
                
                <p>
                    Next under each application you can define one or more constraints in the <code class="literal">constraints</code> array attribute.
                    A constraint defines a URL pattern relative to the base-path.  You can deny, permit, or require authentication for
                    a specific URL pattern.  You can specify roles allowed for that path as well.  More specific constraints will take
                    precedence over more general ones.
                    </p><div class="variablelist"><dl><dt><span class="term">pattern</span></dt><dd>
                                <p>
                                    URL pattern to match relative to the base-path of the application.  Must start with '/' <span class="emphasis"><em>REQUIRED.</em></span>.
                                    You may only have one wildcard and it must come at the end of the pattern.  Valid <code class="literal">/foo/bar/*</code> and  <code class="literal">/foo/*.txt</code>
                                    Not valid: <code class="literal">/*/foo/*</code>.
                                </p>
                            </dd><dt><span class="term">roles-allowed</span></dt><dd>
                                <p>
                                    Array of strings of roles allowed to access this url pattern. <span class="emphasis"><em>OPTIONAL.</em></span>.
                                </p>
                            </dd><dt><span class="term">methods</span></dt><dd>
                                <p>
                                    Array of strings of HTTP methods that will exclusively match this pattern and HTTP request. <span class="emphasis"><em>OPTIONAL.</em></span>.
                                </p>
                            </dd><dt><span class="term">excluded-methods</span></dt><dd>
                                <p>
                                    Array of strings of HTTP methods that will be ignored when match this pattern. <span class="emphasis"><em>OPTIONAL.</em></span>.
                                </p>
                            </dd><dt><span class="term">deny</span></dt><dd>
                                <p>
                                    Deny all access to this URL pattern. <span class="emphasis"><em>OPTIONAL.</em></span>.
                                </p>
                            </dd><dt><span class="term">permit</span></dt><dd>
                                <p>
                                    Permit all access without requiring authentication or a role mapping. <span class="emphasis"><em>OPTIONAL.</em></span>.
                                </p>
                            </dd><dt><span class="term">permit-and-inject</span></dt><dd>
                                <p>
                                    Permit all access, but inject the headers, if user is already authenticated.<span class="emphasis"><em>OPTIONAL.</em></span>.
                                </p>
                            </dd><dt><span class="term">authenticate</span></dt><dd>
                                <p>
                                    Require authentication for this pattern, but no role mapping. <span class="emphasis"><em>OPTIONAL.</em></span>.
                                </p>
                            </dd></dl></div><p>
                </p>
            </div>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3175"/>30.2.3. Header Names Config</h3></div></div></div>
            
            <p>
            Next under the list of applications you can override the defaults for the names of the header fields injected by the proxy (see Keycloak Identity Headers).
            This mapping is optional.
            </p><div class="variablelist"><dl><dt><span class="term">keycloak-subject</span></dt><dd>
                        <p>
                            e.g. MYAPP_USER_ID
                        </p>
                    </dd><dt><span class="term">keycloak-username</span></dt><dd>
                        <p>
                            e.g. MYAPP_USER_NAME
                        </p>
                    </dd><dt><span class="term">keycloak-email</span></dt><dd>
                        <p>
                            e.g. MYAPP_USER_EMAIL
                        </p>
                    </dd><dt><span class="term">keycloak-name</span></dt><dd>
                        <p>
                            e.g. MYAPP_USER_ID
                        </p>
                    </dd><dt><span class="term">keycloak-access-token</span></dt><dd>
                        <p>
                            e.g. MYAPP_ACCESS_TOKEN
                        </p>
                    </dd></dl></div><p>
            </p>
        </div>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3199"/>30.3. Keycloak Identity Headers</h2></div></div></div>
        
        <p>
            When forwarding requests to the proxied server, Keycloak Proxy will set some additional headers with values from the
            OIDC identity token it received for authentication.
            </p><div class="variablelist"><dl><dt><span class="term">KEYCLOAK_SUBJECT</span></dt><dd>
                        <p>
                            User id. Corresponds to JWT <code class="literal">sub</code> and will be the user id Keycloak uses to store
                            this user.
                        </p>
                    </dd><dt><span class="term">KEYCLOAK_USERNAME</span></dt><dd>
                        <p>
                            Username. Corresponds to JWT <code class="literal">preferred_username</code>
                        </p>
                    </dd><dt><span class="term">KEYCLOAK_EMAIL</span></dt><dd>
                        <p>
                            Email address of user if set.
                        </p>
                    </dd><dt><span class="term">KEYCLOAK_NAME</span></dt><dd>
                        <p>
                            Full name of user if set.
                        </p>
                    </dd><dt><span class="term">KEYCLOAK_ACCESS_TOKEN</span></dt><dd>
                        <p>
                            Send the access token in this header if the proxy was configured to send it.  This token can
                            be used to make bearer token requests.
                        </p>
                    </dd></dl></div><p>
            Header field names can be configured using a map of <code class="literal">header-names</code> in configuration file:
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
{
    "header-names" {
        "keycloak-subject": "MY_SUBJECT"
    }
}
            </pre><p>
        </p>
    </div>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="custom-user-attributes"/>Chapter 31. Custom User Attributes</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e3231">31.1. In admin console</a></span></dt><dt><span class="section"><a href="#d4e3251">31.2. In registration page</a></span></dt><dt><span class="section"><a href="#d4e3270">31.3. In user account profile page</a></span></dt></dl></div>
    
    <p>If you have custom user data you want to store and manage in the admin console, registration page, and user account service, you can easily add
    support for it by extending and modifying various Keycloak <a class="link" href="#themes" title="Chapter 10. Themes">themes</a>.</p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3231"/>31.1. In admin console</h2></div></div></div>
        
    <p>To be able to enter custom attributes in the admin console, take the following steps</p>
    <p>
        </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                Create a new theme within the <code class="literal">themes/admin/mytheme</code> directory in your distribution.
                Where <code class="literal">mytheme</code> is whatever you want to name your theme.
            </li><li>
                Create a <code class="literal">theme.properties</code> file in this directory that extends the main admin console
                theme.
                <pre xmlns="" class="">parent=keycloak
import=common/keycloak
</pre>
            </li><li>
                Copy the file <code class="literal">themes/admin/base/resources/partials/user-attribute-entry.html</code> into the
                a mirror directory in your theme: <code class="literal">themes/admin/mytheme/resources/partials/user-attribute-entry.html</code>.
                What you are doing here is overriding the user attribute entry page in the admin console and putting in
                what attributes you want.  This file already contains an example of entering address data.  You can remove
                this if you want and replace it with something else.  Also, if you want to edit this file directly instead
                of creating a new theme, you can.
            </li><li>
                In the <code class="literal">user-attribute-entry.html</code> file add your custom user attribute entry form item.  For example
<pre xmlns="" class="">    &lt;div class="form-group clearfix block"&gt;
        &lt;label class="col-sm-2 control-label" for="mobile"&gt;Mobile&lt;/label&gt;
        &lt;div class="col-sm-6"&gt;
            &lt;input ng-model="user.attributes.mobile" class="form-control" type="text" name="mobile" id="mobile" /&gt;
        &lt;/div&gt;
        &lt;span tooltip-placement="right" tooltip="Mobile number." class="fa fa-info-circle"&gt;&lt;/span&gt;
    &lt;/div&gt;
</pre>
                The <code class="literal">ng-model</code> names the user attribute you will store in the database and must have the
                form of <code class="literal">user.attributes.ATTR_NAME</code>.
            </li><li>
                Change the theme for the admin console.  Save it, then refresh your browser, and you should
                now see these fields in the User detail page for any user.
            </li></ol></div><p>
    </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3251"/>31.2. In registration page</h2></div></div></div>
        
    <p>To be able to enter custom attributes in the registration page, take the following steps</p>
    <p>
        </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                Create a new theme within the <code class="literal">themes/login/mytheme</code> directory in your distribution.
                Where <code class="literal">mytheme</code> is whatever you want to name your theme.
            </li><li>
                Create a <code class="literal">theme.properties</code> file in this directory that extends the main admin console
                theme.
                <pre xmlns="" class="">parent=keycloak
import=common/keycloak
styles= ../patternfly/lib/patternfly/css/patternfly.css ../patternfly/css/login.css ../patternfly/lib/zocial/zocial.css css/login.css</pre>
            </li><li>
                Copy the file <code class="literal">themes/login/base/register.ftl</code> into the
                a mirror directory in your theme: <code class="literal">themes/login/mytheme/register.ftl</code>.
                What you are doing here is overriding the registration page and adding
                what attributes you want.  This file already contains an example of entering address data.  You can remove
                this if you want and replace it with something else.  Also, if you want to edit this file directly instead
                of creating a new theme, you can.
            </li><li>
                In the <code class="literal">register.ftl</code> file add your custom user attribute entry form item.  For example
<pre xmlns="" class="">
&lt;div class="form-group"&gt;
   &lt;div class="${properties.kcLabelWrapperClass!}"&gt;
       &lt;label for="user.attributes.mobile" class="${properties.kcLabelClass!}"&gt;Mobile number&lt;/label&gt;
   &lt;/div&gt;

   &lt;div class="col-sm-10 col-md-10"&gt;
       &lt;input type="text" class="${properties.kcInputClass!}"  id="user.attributes.mobile" name="user.attributes.mobile"/&gt;
   &lt;/div&gt;
&lt;/div&gt;
</pre>
                Make sure the input field id ane name match the user attribute you want to store in the database.
                This must have the
                form of <code class="literal">user.attributes.ATTR_NAME</code>.  You might also want to replace the label text
                with a message property.  This will help later if you want to internationalize your pages.
            </li><li>
                Change the theme for the login to your new theme.  Save it, then refresh your browser, and you should
                now see these fields in the registration.
            </li></ol></div><p>
    </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3270"/>31.3. In user account profile page</h2></div></div></div>
        
    <p>To be able to manage custom attributes in the user account profile page, take the following steps</p>
    <p>
        </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                Create a new theme within the <code class="literal">themes/account/mytheme</code> directory in your distribution.
                Where <code class="literal">mytheme</code> is whatever you want to name your theme.
            </li><li>
                Create a <code class="literal">theme.properties</code> file in this directory that extends the main admin console
                theme.
                <pre xmlns="" class="">parent=patternfly
import=common/keycloak

styles= ../patternfly/lib/patternfly/css/patternfly.css ../patternfly/css/account.css css/account.css</pre>
            </li><li>
                Copy the file <code class="literal">themes/account/base/account.ftl</code> into the
                a mirror directory in your theme: <code class="literal">themes/account/mytheme/account.ftl</code>.
                What you are doing here is overriding the profile page and adding
                what attributes you want to manage.  This file already contains an example of entering address data.  You can remove
                this if you want and replace it with something else.  Also, if you want to edit this file directly instead
                of creating a new theme, you can.
            </li><li>
                In the <code class="literal">account.ftl</code> file add your custom user attribute entry form item.  For example
<pre xmlns="" class="">
&lt;div class="form-group"&gt;
   &lt;div class="col-sm-2 col-md-2"&gt;
       &lt;label for="user.attributes.mobile" class="control-label"&gt;Mobile number&lt;/label&gt;
   &lt;/div&gt;

   &lt;div class="col-sm-10 col-md-10"&gt;
       &lt;input type="text" class="form-control" id="user.attributes.mobile" name="user.attributes.mobile" value="${(account.attributes.mobile!'')?html}"/&gt;
   &lt;/div&gt;
&lt;/div&gt;</pre>
                Make sure the input field id ane name match the user attribute you want to store in the database.
                This must have the
                form of <code class="literal">user.attributes.ATTR_NAME</code>.  You might also want to replace the label text
                with a message property.  This will help later if you want to internationalize your pages.
            </li><li>
                Change the theme for the account to your new theme.  Save it, then refresh your browser, and you should
                now see these fields in the account profile page.
            </li></ol></div><p>
    </p>
    </div>



</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="mappers"/>Chapter 32. OIDC Token and SAML Assertion Mappings</h2></div></div></div>
    
    <p>
        Applications that receive ID Tokens, Access Tokens, or SAML assertions may need or want different user metadata
        and roles.  Keycloak allows you to define what exactly is transferred.  You can hardcode roles, claims and custom
        attributes.  You can pull user metadata into a token or assertion.  You can rename roles.  Basicall you have
        a lot of control of what exactly goes back to the client.
    </p>
    <p>
        Within the admin console, if you go to an application you've registered, you'll see a "Mappers" sub-menu item.
        This is the place where you can control how a OIDC ID Token, Access Token, and SAML login response assertions look
        like.  When you click on this you'll see some default mappers that have been set up for you.  Clicking the
        "Add Builtin" button gives you the option to add other preconfigured mappers.  Clicking on "Create" allows
        you to define your own protocol mappers.  The tooltips are very helpful to learn exactly what you can do
        to tailor your tokens and assertions.  They should be enough to guide you through the process.
    </p>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="auth_spi"/>Chapter 33. Custom Authentication, Registration, and Required Actions</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e3298">33.1. Terms</a></span></dt><dt><span class="section"><a href="#d4e3326">33.2. Algorithm Overview</a></span></dt><dt><span class="section"><a href="#auth_spi_walkthrough">33.3. Authenticator SPI Walk Through</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e3358">33.3.1. Packaging Classes and Deployment</a></span></dt><dt><span class="section"><a href="#d4e3366">33.3.2. Implementing an Authenticator</a></span></dt><dt><span class="section"><a href="#d4e3387">33.3.3. Implementing an AuthenticatorFactory</a></span></dt><dt><span class="section"><a href="#d4e3400">33.3.4. Adding Authenticator Form</a></span></dt><dt><span class="section"><a href="#adding_authenticator">33.3.5. Adding Authenticator to a Flow</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e3420">33.4. Required Action Walkthrough</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e3423">33.4.1. Packaging Classes and Deployment</a></span></dt><dt><span class="section"><a href="#d4e3431">33.4.2. Implement the RequiredActionProvider</a></span></dt><dt><span class="section"><a href="#d4e3440">33.4.3. Implement the RequiredActionFactory</a></span></dt><dt><span class="section"><a href="#d4e3445">33.4.4. Enable Required Action</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e3448">33.5. Modifying/Extending the Registration Form</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e3451">33.5.1. Implementation FormAction Interface</a></span></dt><dt><span class="section"><a href="#d4e3469">33.5.2. Packaging the Action</a></span></dt><dt><span class="section"><a href="#d4e3477">33.5.3. Adding FormAction to the Registration Flow</a></span></dt></dl></dd><dt><span class="section"><a href="#d4e3482">33.6. Modifying Forgot Password/Credential Flow</a></span></dt><dt><span class="section"><a href="#client_authentication">33.7. Authentication of clients</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e3494">33.7.1. Default implementations</a></span></dt><dt><span class="section"><a href="#d4e3528">33.7.2. Implement your own client authenticator</a></span></dt></dl></dd></dl></div>
    
    <p>
        Keycloak comes out of the box with a bunch of different authentication mechanisms: kerberos, password, and otp.
        These mechanisms may not meet all of your requirements and you may want to plug in your own custom ones.  Keycloak
        provides an authentication SPI that you can use to write new plugins.  The admin console supports applying, ordering,
        and configuring these new mechanisms.
    </p>
    <p>
        Keycloak also supports a simple registration form.  Different aspects of this form can be enabled and disabled i.e.
        Recaptcha support can be turned off and on.  The same authentication SPI can be used to add another page to the
        registration flow or reimplement it entirely.  There's also an additional fine-grain SPI you can use to add
        specific validations and user extensions to the built in registration form.
    </p>
    <p>
        A required action in Keycloak is an action that a user has to perform after he authenticates.  After the action
        is performed successfully, the user doesn't have to perform the action again.  Keycloak comes with some built in
        required actions like "reset password".  This action forces the user to change their password after they have logged in.
        You can write and plug in your own required actions.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3298"/>33.1. Terms</h2></div></div></div>
        
        <p>
            To first learn about the Authentication SPI, let's go over some of the terms used to describe it.
            </p><div class="variablelist"><dl><dt><span class="term">Authentication Flow</span></dt><dd>
                        <p>
                            A flow is a container for all authentications that must happen during login or registration.  If you
                            go to the admin console authentication page, you can view all the defined flows in the system and
                            what authenticators they are made up of.  Flows can contain other flows.  You can also bind a new
                            different flow for browser login, direct grant access, and registration.
                        </p>
                    </dd><dt><span class="term">Authenticator</span></dt><dd>
                        <p>
                            An authenticator is a pluggable component that hold the logic for performing the authentication
                            or action within a flow.  It is usually a singleton.
                        </p>
                    </dd><dt><span class="term">Execution</span></dt><dd>
                        <p>
                            An execution is an object that binds the authenticator to the flow and the authenticator
                            to the configuration of the authenticator.  Flows contain execution entries.
                        </p>
                    </dd><dt><span class="term">Execution Requirement</span></dt><dd>
                        <p>
                            Each execution defines how an authenticator behaves in a flow.  The requirement defines
                            whether the authenticator is enabled, disabled, optional, required, or an alternative.  An
                            alternative requirement means that the authentiactor is optional unless no other alternative
                            authenticator is successful in the flow.  For example, cookie authentication, kerberos,
                            and the set of all login forms are all alternative.  If one of those is successful, none of
                            the others are executed.
                        </p>
                    </dd><dt><span class="term">Authenticator Config</span></dt><dd>
                        <p>
                            This object defines the configuration for the Authenticator for a specific execution within
                            an authentication flow.  Each execution can have a different config.
                        </p>
                    </dd><dt><span class="term">Required Action</span></dt><dd>
                        <p>
                            After authentication completes, the user might have one or more one-time actions he must
                            complete before he is allowed to login.  The user might be required to set up an OTP token
                            generator or reset an expired password or even accept a Terms and Conditions document.
                        </p>
                    </dd></dl></div><p>
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3326"/>33.2. Algorithm Overview</h2></div></div></div>
        
        <p>
            Let's talk about how this all works for browser login. Let's assume the following flows, executions and sub flows.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
Cookie - ALTERNATIVE
Kerberos - ALTERNATIVE
Forms Subflow - ALTERNATIVE
           Username/Password Form - REQUIRED
           OTP Password Form - OPTIONAL

</pre><p>
        </p>
        <p>
            In the top level of the form we have 3 executions of which all are alternatively required.  This means that
            if any of these are successful, then the others do not have to execute.  The Username/Password form is not executed
            if there is an SSO Cookie set or a successful Kerberos login.  Let's walk through the steps from when a client
            first redirects to keycloak to authenticate the user.
            </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>
                    <p>
                    The OpenID Connect or SAML protocol provider unpacks relevent data, verifies the client and any signatures.
                    It creates a ClientSessionModel.  It looks up what the browser flow should be, then starts executing the flow.
                    </p>
                </li><li>
                    <p>
                        The flow looks at the cookie execution and sees that it is an alternative.  It loads the cookie provider.
                        It checks to see if the cookie provider requires that a user already be associated with the client session.
                        Cookie provider does not require a user.   If it did, the flow would abort and the user would see an error screen.
                        Cookie provider then executes.  Its purpose is to see if there is an SSO cookie set.  If there is one set, it is validated
                        and the UserSessionModel is verified and associated with the ClientSessionModel.  The Cookie provider returns a
                        success() status if the SSO cookie exists and is validated.  Since the cookie provider returned success and each execution
                        at this level of the flow is ALTERNATIVE, no other execution is executed and this results in a successful login.
                        If there is no SSO cookie, the cookie provider returns with a status of attempted().  This means there was no error condition,
                        but no success either.  The provider tried, but the request just wasn't set up to handle this authenticator.
                    </p>
                </li><li>
                    <p>
                    Next the flow looks at the Kerberos execution.  This is also an alternative.  The kerberos provider also does not
                    require a user to be already set up and associated with the ClientSessionModel so this provider is executed.
                    Kerberos uses the SPNEGO browser protocol.  This requires a series of challenge/responses between the server and client
                    exchanging negotiation headers.  The kerberos provider does not see any negotiate header, so it assumes that this is the
                    first interaction between the server and client.  It therefore creates an HTTP challenge response to the client and sets a
                    forceChallenge() status.  A forceChallenge() means that this HTTP response cannot be ignored by the flow and must be returned to the
                    client.  If instead the provider returned a challenge() status, the flow would hold the challenge response until all other alternatives
                    are attempted.  So, in this initial phase, the flow would stop and the challenge response would be sent back to the browser.  If the browser
                        then responds with a successful negotiate header, the provider associates the user with the ClientSession and the flow ends because
                        the rest of the executions on this level of the flow are all alternatives.  Otherwise, again, the kerberos provider
                        sets an attempted() status and the flow continues.
                    </p>
                </li><li>
                    <p>
                        The next execution is a subflow called Forms. The executions for this subflow are loaded and
                        the same processing logic occurs
                    </p>
                </li><li>
                    <p>
                        The first execution in the Forms subflow is the UsernamePassword provider.  This provider also does not require for a user
                        to already be associated with the flow.  This provider creates challenge HTTP response and sets its status to challenge().
                        This execution is required, so the flow honors this challenge and sends the HTTP response back to the browser.  This
                        response is a rendering of the Username/Password HTML page.  The user enters in their username and password and clicks submit.
                        This HTTP request is directed to the UsernamePassword provider.  If the user entered an invalid username or password, a new
                        challenge response is created and a status of failureChallenge() is set for this execution.  A failureChallenge() means that
                        there is a challenge, but that the flow should log this as an error in the error log.  This error log can be used to lock accounts
                        or IP Addresses that have had too many login failures.  If the username and password is valid, the provider associated the
                        UserModel with the ClientSessionModel and returns a status of success()
                    </p>
                </li><li>
                    <p>
                        The next execution is the OTP Form.  This provider requires that a user has been associated with the flow.  This requirement is satisfied
                        because the UsernamePassword provider already associated the user with the flow.  Since a user is required for this provider, the provider
                        is also asked if the user is configured to use this provider.  If user is not configured, and this execution is required, then the flow will
                        then set up a required action that the user must perform after authentication is complete.  For OTP, this means the OTP setup page.
                        If the execution was optional, then this execution is skipped.
                    </p>
                </li><li>
                    <p>
                        After the flow is complete, the authentication processor creates a UserSessionModel and associates it with the ClientSessionModel.
                        It then checks to see if the user is required to complete any required actions before logging in.
                    </p>
                </li><li>
                    <p>
                        First, each required action's evaluateTriggers() method is called.  This allows the required action provider to figure out if
                        there is some state that might trigger the action to be fired.  For example, if your realm has a password expiration policy,
                        it might be triggered by this method.
                    </p>
                </li><li>
                    <p>
                        Each required action associated with the user that has its requiredActionChallenge() method called.  Here the provider
                        sets up an HTTP response which renders the page for the required action.   This is done by setting a challenge status.
                    </p>
                </li><li>
                    <p>
                        If the required action is ultimately successful, then the required action is removed from the user's require actions list.
                    </p>
                </li><li>
                    <p>
                        After all required actions have been resolved, the user is finally logged in.
                    </p>
                </li></ol></div><p>
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="auth_spi_walkthrough"/>33.3. Authenticator SPI Walk Through</h2></div></div></div>
        
        <p>
            In this section, we'll take a look at the Authenticator interface.  For this, we are going to implement an authenticator
            that requires that a user enter in the answer to a secret question like "What is your mother's maiden name?".  This example
            is fully implemented and contained in the examples/providers/authenticator directory of the demo distribution of Keycloak.
        </p>
        <p>
            The classes you must implement are the org.keycloak.authentication.AuthenticatorFactory and Authenticator interfaces.  The Authenticator
            interface defines the logic.  The AuthenticatorFactory is responsible for creating instances of an Authenticator.  They both extend
            a more generic Provider and ProviderFactory set of interfaces that other Keycloak components like User Federation do.
        </p>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3358"/>33.3.1. Packaging Classes and Deployment</h3></div></div></div>
            
            <p>
                You will package your classes within a single jar.  This jar must contain a file named  <code class="literal">org.keycloak.authentication.AuthenticatorFactory</code>
                and must be contained in the <code class="literal">META-INF/services/</code> directory of your jar.  This file must list the fully qualified classname
                of each AuthenticatorFactory implementation you have in the jar.  For example:
        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
            org.keycloak.examples.authenticator.SecretQuestionAuthenticatorFactory
            org.keycloak.examples.authenticator.AnotherProviderFactory
        </pre><p>
            </p>
            <p>
                This services/ file is used by Keycloak to scan the providers it has to load into the system.
            </p>
            <p>
                To deploy this jar, just copy it to the standalone/configuration/providers directory.
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3366"/>33.3.2. Implementing an Authenticator</h3></div></div></div>
            
            <p>
                When implementing the Authenticator interface, the first method that needs to be implemented is the
                requiresUser() method.  For our example, this method must return true as we need to validate the secret question
                associated with the user.  A provider like kerberos would return false from this method as it can
                resolve a user from the negotiate header.  This example, however, is validating a specific credential of a specific
                user.
            </p>
            <p>
                The next method to implement is the configuredFor() method.  This method is responsible for determining if the
                user is configured for this particular authenticator.  For this example, we need to check if the answer to the
                secret question has been set up by the user or not.  In our case we are storing this information, hashed, within
                a UserCredentialValueModel within the UserModel (just like passwords are stored).  Here's how we do this
                very simple check:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    @Override
    public boolean configuredFor(KeycloakSession session, RealmModel realm, UserModel user) {
        return session.users().configuredForCredentialType("secret_question", realm, user);
    }
</pre><p>
            </p>
            <p>
                The configuredForCredentialType() call queries the user to see if it supports that credential type.
            </p>
            <p>
                The next method to implement on the Authenticator is setRequiredActions().  If configuredFor() returns false
                and our example authenticator is required within the flow, this method will be called.  It is responsible for
                registering any required actions that must be performed by the user.  In our example, we need to register
                a required action that will force the user to set up the answer to the secret question.  We will implement
                this required action provider later in this chapter.  Here is the implementation of the setRequiredActions()
                method.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    @Override
    public void setRequiredActions(KeycloakSession session, RealmModel realm, UserModel user) {
        user.addRequiredAction("SECRET_QUESTION_CONFIG");
    }
</pre><p>
            </p>
            <p>
                Now we are getting into the meat of the Authenticator implementation.  The next method to implement is
                authenticate().  This is the initial method the flow invokes when the execution is first visited.  What we
                want is that if a user has answered the secret question already on their browser's machine, then the
                user doesn't have to answer the question again, making that machine "trusted".  The authenticate()
                method isn't responsible for processing the secret question form.  Its sole purpose is to render the page
                or to continue the flow.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    @Override
    public void authenticate(AuthenticationFlowContext context) {
        if (hasCookie(context)) {
           context.success();
           return;
        }
        Response challenge = loginForm(context).createForm("secret_question.ftl");
        context.challenge(challenge);
    }
</pre><p>
            </p>
            <p>
                The hasCookie() method checks to see if there is already a cookie set on the browser which indicates
                that the secret question has already been answered.  If that returns true, we just mark this execution's
                status as SUCCESS using the AuthenticationFlowContext.success() method and returning from the authentication()
                method.
            </p>
            <p>
                If the hasCookie() method returns false, we must return a response that renders the secret question HTML
                form.  AuthenticationFlowContext has a form() method that initializes a Freemarker page builder with appropriate base information needed
                to build the form.  This page builder is called <code class="literal">org.keycloak.login.LoginFormsProvider</code>.
                the LoginFormsProvider.createForm() method loads a Freemarker template file from your login theme.  Additionally
                you can call the LoginFormsProvider.setAttribute() method if you want to pass additional information to the
                Freemarker template.  We'll go over this later.
            </p>
            <p>
                Calling LoginFormsProvider.createForm() returns a JAX-RS Response object.  We then call AuthenticationFlowContext.challenge()
                passing in this response.  This sets the status of the execution as CHALLENGE and if the execution is Required, this
                JAX-RS Response object will be sent to the browser.
            </p>
            <p>
                So, the HTML page asking for the answer to a secret question is displayed to the user and the user
                enteres in the answer and clicks submit.  The action URL of the HTML form will send an HTTP request to the
                flow.  The flow will end up invoking the action() method of our Authenticator implementation.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    @Override
    public void action(AuthenticationFlowContext context) {
        boolean validated = validateAnswer(context);
        if (!validated) {
           Response challenge = context.form()
                                 .setError("badSecret")
                                 .createForm("secret-question.ftl");
           context.failureChallenge(AuthenticationFlowError.INVALID_CREDENTIALS, challenge);
           return;
        }
        setCookie(context);
        context.success();
    }


</pre><p>
            </p>
            <p>
                If the answer is not valid, we rebuild the HTML Form with an additional error message.  We then call
                AuthenticationFlowContext.failureChallenge() passing in the reason for the value and the JAX-RS response.
                failureChallenge() works the same as challenge(), but it also records the failure so it can be analyzed
                by any attack detection service.
            </p>
            <p>
                If validation is successful, then we set a cookie to remember that the secret question has been answered
                and we call AuthenticationFlowContext.success().
            </p>
            <p>
                The last thing I want to go over is the setCookie() method.  This is an example of providing configuration
                for the Authenticator.  In this case we want the max age of the cookie to be configurable.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    protected void setCookie(AuthenticationFlowContext context) {
        AuthenticatorConfigModel config = context.getAuthenticatorConfig();
        int maxCookieAge = 60 * 60 * 24 * 30; // 30 days
        if (config != null) {
            maxCookieAge = Integer.valueOf(config.getConfig().get("cookie.max.age"));

        }
        ... set the cookie ...
    }

</pre><p>
            </p>
            <p>
                We obtain an AuthenticatorConfigModel from the AuthenticationFlowContext.getAuthenticatorConfig() method.
                If configuration exists we pull the max age config out of it.  We will see how we can define what should
                be configured when we talk about the AuthenticatorFactory implementation.  The config values can be
                defined within the admin console if you set up config definitions in your AuthenticatorFactory implementation.
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3387"/>33.3.3. Implementing an AuthenticatorFactory</h3></div></div></div>
            
            <p>
                The next step in this process is to implement an AuthenticatorFactory.  This factory is responsible
                for instantiating an Authenticator.  It also provides deployment and configuration metadata about
                the Authenticator.
            </p>
            <p>
                The getId() method is just the unique name of the component.  The create() method is called by the
                runtime to allocate and process the Authenticator.

</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
public class SecretQuestionAuthenticatorFactory implements AuthenticatorFactory, ConfigurableAuthenticatorFactory {

    public static final String PROVIDER_ID = "secret-question-authenticator";
    private static final SecretQuestionAuthenticator SINGLETON = new SecretQuestionAuthenticator();

    @Override
    public String getId() {
        return PROVIDER_ID;
    }

    @Override
    public Authenticator create(KeycloakSession session) {
        return SINGLETON;
    }

</pre><p>
            </p>
            <p>
                The next thing the factory is responsible for is specify the allowed requirement switches.  While there
                are four different requirement types:  ALTERNATIVE, REQUIRED, OPTIONAL, DISABLED, AuthenticatorFactory
                implementations can limit which  requirement options are shown in the admin console when defining
                a flow.  In our example, we're going to limit our requirement options to REQUIRED and DISABLED.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    private static AuthenticationExecutionModel.Requirement[] REQUIREMENT_CHOICES = {
            AuthenticationExecutionModel.Requirement.REQUIRED,
            AuthenticationExecutionModel.Requirement.DISABLED
    };
    @Override
    public AuthenticationExecutionModel.Requirement[] getRequirementChoices() {
        return REQUIREMENT_CHOICES;
    }
</pre><p>
            </p>
            <p>
                The AuthenticatorFactory.isUserSetupAllowed() is a flag that tells the flow manager whether or not
                Authenticator.setRequiredActions() method will be called.  If an Authenticator is not configured for a user,
                the flow manager checks isUserSetupAllowed().  If it is false, then the flow aborts with an error.  If it
                returns true, then the flow manager will invoke Authenticator.setRequiredActions().
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    @Override
    public boolean isUserSetupAllowed() {
        return true;
    }
</pre><p>
            </p>
            <p>
                The next few methods define how the Authenticator can be configured.  The isConfigurable() method
                is a flag which specifies to the admin console on whether the Authenticator can be configured within
                a flow.  The getConfigProperties() method returns a list of ProviderConfigProperty objects.  These
                objects define a specific configuration attribute.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    @Override
    public List&lt;ProviderConfigProperty&gt; getConfigProperties() {
        return configProperties;
    }

    private static final List&lt;ProviderConfigProperty&gt; configProperties = new ArrayList&lt;ProviderConfigProperty&gt;();

    static {
        ProviderConfigProperty property;
        property = new ProviderConfigProperty();
        property.setName("cookie.max.age");
        property.setLabel("Cookie Max Age");
        property.setType(ProviderConfigProperty.STRING_TYPE);
        property.setHelpText("Max age in seconds of the SECRET_QUESTION_COOKIE.");
        configProperties.add(property);
    }
</pre><p>
            </p>
            <p>
                Each ProviderConfigProperty defines the name of the config property.  This is the key used in the config
                map stored in AuthenticatorConfigModel.  The label defines how the config option will be displayed in the
                admin console.  The type defines if it is a String, Boolean, or other type.  The admin console
                will display different UI inputs depending on the type. The help text is what will be shown in the
                tooltip for the config attribute in the admin console.  Read the javadoc of ProviderConfigProperty
                for more detail.
            </p>
            <p>
                The rest of the methods are for the admin console.  getHelpText() is the tooltip text that will be
                shown when you are picking the Authenticator you want to bind to an execution.  getDisplayType()
                is what text that will be shown in the admin console when listing the Authenticator.  getReferenceCategory()
                is just a category the Authenticator belongs to.
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3400"/>33.3.4. Adding Authenticator Form</h3></div></div></div>
            
            <p>
                Keycloak comes with a Freemarker <a class="link" href="#themes" title="Chapter 10. Themes">theme and template engine</a>.  The createForm()
                method you called within authenticate() of your Authenticator class, builds an HTML page from a file within
                your login theme: secret-question.ftl.  This file should be placed in the login theme with all the other
                .ftl files you see for login.
            </p>
            <p>
                Let's take a bigger look at secret-question.ftl  Here's a small code snippet:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
        &lt;form id="kc-totp-login-form" class="${properties.kcFormClass!}" action="${url.loginAction}" method="post"&gt;
            &lt;div class="${properties.kcFormGroupClass!}"&gt;
                &lt;div class="${properties.kcLabelWrapperClass!}"&gt;
                    &lt;label for="totp" class="${properties.kcLabelClass!}"&gt;${msg("loginSecretQuestion")}&lt;/label&gt;
                &lt;/div&gt;

                &lt;div class="${properties.kcInputWrapperClass!}"&gt;
                    &lt;input id="totp" name="secret_answer" type="text" class="${properties.kcInputClass!}" /&gt;
                &lt;/div&gt;
            &lt;/div&gt;

</pre><p>
            </p>
            <p>
                Any piece of text enclosed in <code class="literal">${}</code> corresponds to an attribute or template funtion.
                If you see the form's action, you see it points to <code class="literal">${url.loginAction}</code>.  This value
                is automatically generated when you invoke the AuthenticationFlowContext.form() method.  You can also obtain
                this value by calling the AuthenticationFlowContext.getActionURL() method in Java code.
            </p>
            <p>
                You'll also see <code class="literal">${properties.someValue}</code>.  These correspond to properties defined
                in your theme.properties file of our theme.  <code class="literal">${msg("someValue")}</code> corresponds to the
                internationalized message bundles (.properties files) included with the login theme messages/ directory.
                If you're just using english, you can just add the value of the <code class="literal">loginSecretQuestion</code>
                value.  This should be the question you want to ask the user.
            </p>
            <p>
                When you call AuthenticationFlowContext.form() this gives you a LoginFormsProvider  instance.  If you called,
                <code class="literal">LoginFormsProvider.setAttribute("foo", "bar")</code>, the value of "foo" would be available
                for reference in your form as <code class="literal">${foo}</code>.  The value of an attribute can be any Java
                bean as well.
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="adding_authenticator"/>33.3.5. Adding Authenticator to a Flow</h3></div></div></div>
            
            <p>
                Adding an Authenticator to a flow must be done in the admin console.
                If you go to the Authentication menu item and go to the Flow tab, you will be able to view the currently
                defined flows.  You cannot modify an built in flows, so, to add the Authenticator we've created you
                have to copy an existing flow or create your own.  I'm hoping the UI is intuitive enough so that you
                can figure out for yourself how to create a flow and add the Authenticator.
            </p>
            <p>
                After you've created your flow, you have to bind it to the login action you want to bind it to.  If you go
                to the Authentication menu and go  to the Bindings tab you will see options to bind a flow to
                the browser, registration, or direct grant flow.
            </p>
        </div>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3420"/>33.4. Required Action Walkthrough</h2></div></div></div>
        
        <p>
            In this section we will discuss how to define a required action.  In the Authenticator section you may have wondered,
            "How will we get the user's answer to the secret question entered into the system?".  As we showed in the example,
            if the answer is not set up, a required action will be triggered.  This section discusses how to implement
            the required action for the Secret Question Authenticator.
        </p>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3423"/>33.4.1. Packaging Classes and Deployment</h3></div></div></div>
            
            <p>
                You will package your classes within a single jar.  This jar does not have to be separate from other provider classes
                but it must contain a file named  <code class="literal">org.keycloak.authentication.RequiredActionFactory</code>
                and must be contained in the <code class="literal">META-INF/services/</code> directory of your jar.  This file must list the fully qualified classname
                of each RequiredActionFactory implementation you have in the jar.  For example:
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                    org.keycloak.examples.authenticator.SecretQuestionRequiredActionFactory
                </pre><p>
            </p>
            <p>
                This services/ file is used by Keycloak to scan the providers it has to load into the system.
            </p>
            <p>
                To deploy this jar, just copy it to the standalone/configuration/providers directory.
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3431"/>33.4.2. Implement the RequiredActionProvider</h3></div></div></div>
            
            <p>Required actions must first implement the RequiredActionProvider interface.  The RequiredActionProvider.requiredActionChallenge()
            is the initial call by the flow manager into the required action.  This method is responsible for rendering the
            HTML form that will drive the required action.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    @Override
    public void requiredActionChallenge(RequiredActionContext context) {
        Response challenge = context.form().createForm("secret_question_config.ftl");
        context.challenge(challenge);

    }
</pre><p>
            </p>
            <p>
                You see that RequiredActionContext has similar methods to AuthenticationFlowContext.  The form() method allows
                you to render the page from a Freemarker template.  The action URL is preset by the call to this form() method.
                You just need to reference it within your HTML form.  I'll show you this later.
            </p>
            <p>
                The challenge() method notifies the flow manager that
                a required action must be executed.
            </p>
            <p>
                The next method is responsible for processing input from the HTML form of the required action.  The action
                URL of the form will be routed to the RequiredActionProvider.processAction() method
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    @Override
    public void processAction(RequiredActionContext context) {
        String answer = (context.getHttpRequest().getDecodedFormParameters().getFirst("answer"));
        UserCredentialValueModel model = new UserCredentialValueModel();
        model.setValue(answer);
        model.setType(SecretQuestionAuthenticator.CREDENTIAL_TYPE);
        context.getUser().updateCredentialDirectly(model);
        context.success();
    }
</pre><p>
            </p>
            <p>
                The answer is pulled out of the form post.  A UserCredentialValueModel is created and the type and value
                of the credential are set.  Then UserModel.updateCredentialDirectly() is invoked.  Finally, RequiredActionContext.success()
                notifies the container that the required action was successful.
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3440"/>33.4.3. Implement the RequiredActionFactory</h3></div></div></div>
            
            <p>
                This class is really simple.  It is just responsible for creating the required actin provider instance.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
public class SecretQuestionRequiredActionFactory implements RequiredActionFactory {

    private static final SecretQuestionRequiredAction SINGLETON = new SecretQuestionRequiredAction();

    @Override
    public RequiredActionProvider create(KeycloakSession session) {
        return SINGLETON;
    }


    @Override
    public String getId() {
        return SecretQuestionRequiredAction.PROVIDER_ID;
    }

    @Override
    public String getDisplayText() {
        return "Secret Question";
    }

</pre><p>
            </p>
            <p>
                The getDisplayText() method is just for the admin console when it wants to display a friendly name
                for the required action.
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3445"/>33.4.4. Enable Required Action</h3></div></div></div>
            
            <p>
                The final thing you have to do is go into the admin console.  Click on the Authentication left menu.
                Click on the Required Actions tab.  Click on the Register button and choose your new Required Action.
                Your new required action should now be displayed and enabled in the required actions list.
            </p>
        </div>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3448"/>33.5. Modifying/Extending the Registration Form</h2></div></div></div>
        
        <p>
            It is entirely possible for you to implement your own flow with a set of Authenticators to totally change
            how regisration is done in Keycloak.  But what you'll usually want to do is just add a little bit of validation
            to the out of the box registration page.
            An additional SPI was created to be able to do this.  It basically allows
            you to add validation of form elements on the page as well as to initialize UserModel attributes and data
            after the user has been registered.  We'll look at both the implementation of the user profile registration
            processing as well as the registration Google Recaptcha plugin.
        </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3451"/>33.5.1. Implementation FormAction Interface</h3></div></div></div>
        
        <p>
            The core interface you have to implement is the FormAction interface.  A FormAction is responsible for
            rendering and processing a portion of the page.  Rendering is done in the buildPage() method, validation
            is done in the validate() method, post validation operations are done in success().  Let's first take a look
            at buildPage() method of the Recaptcha plugin.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    @Override
    public void buildPage(FormContext context, LoginFormsProvider form) {
        AuthenticatorConfigModel captchaConfig = context.getAuthenticatorConfig();
        if (captchaConfig == null || captchaConfig.getConfig() == null
                || captchaConfig.getConfig().get(SITE_KEY) == null
                || captchaConfig.getConfig().get(SITE_SECRET) == null
                ) {
            form.addError(new FormMessage(null, Messages.RECAPTCHA_NOT_CONFIGURED));
            return;
        }
        String siteKey = captchaConfig.getConfig().get(SITE_KEY);
        form.setAttribute("recaptchaRequired", true);
        form.setAttribute("recaptchaSiteKey", siteKey);
        form.addScript("https://www.google.com/recaptcha/api.js");
    }

</pre><p>
        </p>
        <p>
            The Recaptcha buildPage() method is a callback by the form flow to help render the page.  It receives a form parameter
            which is a LoginFormsProvider.  You can add additional attributes to the form provider so that they can
            be displayed in the HTML page generated by the registration Freemarker template.
        </p>
        <p>
            The code above is from the registration recaptcha plugin.  Recaptcha requires some specific settings that
            must be obtained from configuration.  FormActions are configured in the exact same was as Authenticators are.
            In this example, we pull the Google Recaptcha site key from configuration and add it as an attribute
            to the form provider.  Our regstration template file can read this attribute now.
        </p>
        <p>
            Recaptcha also has the requirement of loading a javascript script.  You can do this by calling LoginFormsProvider.addScript()
            passing in the URL.
        </p>
        <p>
            For user profile processing, there is no additional information that it needs to add to the form, so its buildPage() method
            is empty.
        </p>
        <p>
            The next meaty part of this interface is the validate() method.  This is called immediately upon receiving a form
            post.  Let's look at the Recaptcha's plugin first.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    @Override
    public void validate(ValidationContext context) {
        MultivaluedMap&lt;String, String&gt; formData = context.getHttpRequest().getDecodedFormParameters();
        List&lt;FormMessage&gt; errors = new ArrayList&lt;&gt;();
        boolean success = false;

        String captcha = formData.getFirst(G_RECAPTCHA_RESPONSE);
        if (!Validation.isBlank(captcha)) {
            AuthenticatorConfigModel captchaConfig = context.getAuthenticatorConfig();
            String secret = captchaConfig.getConfig().get(SITE_SECRET);

            success = validateRecaptcha(context, success, captcha, secret);
        }
        if (success) {
            context.success();
        } else {
            errors.add(new FormMessage(null, Messages.RECAPTCHA_FAILED));
            formData.remove(G_RECAPTCHA_RESPONSE);
            context.validationError(formData, errors);
            return;


        }
    }

</pre><p>
        </p>
        <p>
            Here we obtain the form data that the Recaptcha widget adds to the form.  We obtain the Recaptcha secret key
            from configuration.  We then validate the recaptcha.  If successful, ValidationContext.success() is called.
            If not, we invoke ValidationContext.validationError() passing in the formData (so the user doesn't have to re-enter data),
            we also specify an error message we want displayed.  The error message must point to a message bundle property
            in the internationalized message bundles.  For other registration extensions validate() might be validating the
            format of a form element, i.e. an alternative email attribute.
        </p>
        <p>
            Let's also look at the user profile plugin that is used to validate email address and other user information
            when registering.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    @Override
    public void validate(ValidationContext context) {
        MultivaluedMap&lt;String, String&gt; formData = context.getHttpRequest().getDecodedFormParameters();
        List&lt;FormMessage&gt; errors = new ArrayList&lt;&gt;();

        String eventError = Errors.INVALID_REGISTRATION;

        if (Validation.isBlank(formData.getFirst((RegistrationPage.FIELD_FIRST_NAME)))) {
            errors.add(new FormMessage(RegistrationPage.FIELD_FIRST_NAME, Messages.MISSING_FIRST_NAME));
        }

        if (Validation.isBlank(formData.getFirst((RegistrationPage.FIELD_LAST_NAME)))) {
            errors.add(new FormMessage(RegistrationPage.FIELD_LAST_NAME, Messages.MISSING_LAST_NAME));
        }

        String email = formData.getFirst(Validation.FIELD_EMAIL);
        if (Validation.isBlank(email)) {
            errors.add(new FormMessage(RegistrationPage.FIELD_EMAIL, Messages.MISSING_EMAIL));
        } else if (!Validation.isEmailValid(email)) {
            formData.remove(Validation.FIELD_EMAIL);
            errors.add(new FormMessage(RegistrationPage.FIELD_EMAIL, Messages.INVALID_EMAIL));
        }

        if (context.getSession().users().getUserByEmail(email, context.getRealm()) != null) {
            formData.remove(Validation.FIELD_EMAIL);
            errors.add(new FormMessage(RegistrationPage.FIELD_EMAIL, Messages.EMAIL_EXISTS));
        }

        if (errors.size() &gt; 0) {
            context.validationError(formData, errors);
            return;

        } else {
            context.success();
        }
    }
</pre><p>
        </p>
        <p>
            As you can see, this validate() method of user profile processing makes sure that the email, first, and last name
            are filled in in the form.  It also makes sure that email is in the right format.  If any of these validations
            fail, an error message is queued up for rendering.  Any fields in error are removed from the form data.  Error messages
            are represented by the FormMessage class.  The first parameter of the constructor of this class takes the HTML
            element id.  The input in error will be highlighted when the form is re-rendered. The second parameter is
            a message reference id.  This id must correspond to a property in one of the localized message bundle files.
            in the theme.
        </p>
        <p>
            After all validations have been processed then, the form flow then invokes the FormAction.success() method.  For recaptcha
            this is a no-op, so we won't go over it.  For user profile processing, this method fills in values in the registered
            user.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    @Override
    public void success(FormContext context) {
        UserModel user = context.getUser();
        MultivaluedMap&lt;String, String&gt; formData = context.getHttpRequest().getDecodedFormParameters();
        user.setFirstName(formData.getFirst(RegistrationPage.FIELD_FIRST_NAME));
        user.setLastName(formData.getFirst(RegistrationPage.FIELD_LAST_NAME));
        user.setEmail(formData.getFirst(RegistrationPage.FIELD_EMAIL));
    }

</pre><p>
        </p>
        <p>
            Pretty simple implementation.  The UserModel of the newly registered user is obtained from the FormContext.
            The appropriate methods are called to initialize UserModel data.
        </p>
        <p>
            Finally, you are also required to define a FormActionFactory class.  This class is implemented similarly to AuthenticatorFactory, so we won't go over it.
        </p>
    </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3469"/>33.5.2. Packaging the Action</h3></div></div></div>
            
            <p>
                You will package your classes within a single jar.  This jar must contain a file named  <code class="literal">org.keycloak.authentication.ForActionFactory</code>
                and must be contained in the <code class="literal">META-INF/services/</code> directory of your jar.  This file must list the fully qualified classname
                of each FormActionFactory implementation you have in the jar.  For example:
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                    org.keycloak.authentication.forms.RegistrationProfile
                    org.keycloak.authentication.forms.RegistrationRecaptcha
                </pre><p>
            </p>
            <p>
                This services/ file is used by Keycloak to scan the providers it has to load into the system.
            </p>
            <p>
                To deploy this jar, just copy it to the standalone/configuration/providers directory.
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3477"/>33.5.3. Adding FormAction to the Registration Flow</h3></div></div></div>
            
            <p>
                Adding an FormAction to a registration page flow must be done in the admin console.
                If you go to the Authentication menu item and go to the Flow tab, you will be able to view the currently
                defined flows.  You cannot modify an built in flows, so, to add the Authenticator we've created you
                have to copy an existing flow or create your own.  I'm hoping the UI is intuitive enough so that you
                can figure out for yourself how to create a flow and add the FormAction.
            </p>
            <p>
                Basically you'll have to copy the registration flow.  Then click Actions menu to the right of
                the Registration Form, and pick "Add Execution" to add a new execution.  You'll pick the FormAction from the selection list.
                Make sure your FormAction comes after "Registration User Creation" by using the down errors to move it if your FormAction
                isn't already listed after "Registration User Creation".  You want your FormAction to come after user creation
                because the success() method of Regsitration User Creation is responsible for creating the new UserModel.
            </p>
            <p>
                After you've created your flow, you have to bind it to registration.  If you go
                to the Authentication menu and go  to the Bindings tab you will see options to bind a flow to
                the browser, registration, or direct grant flow.
            </p>
        </div>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3482"/>33.6. Modifying Forgot Password/Credential Flow</h2></div></div></div>
        
        <p>
            Keycloak also has a specific authentication flow for forgot password, or rather credential reset initiated
            by a user.  If you go to the admin console flows page, there is a "reset credentials" flow.  By default,
            Keycloak asks for the email or username of the user and sends an email to them.  If the user clicks on the
            link, then they are able to reset both their password and OTP (if an OTP has been set up).  You can disable
            automatic OTP reset by disabling the "Reset OTP" authenticator in the flow.
        </p>
        <p>
            You can add additional functionality to this flow as well.  For example, many deployments would like for the
            user to answer one or more secret questions in additional to sending an email with a link.  You could expand
            on the secret question example that comes with the distro and incorporate it into the reset credential flow.
        </p>
        <p>
            One thing to note if you are extending the reset credentials flow.  The first "authenticator" is just
            a page to obtain the username or email.  If the username or email exists, then the AuthenticationFlowContext.getUser()
            will return the located user.  Otherwise this will be null.  This form *WILL NOT* re-ask the user to enter in
            an email or username if the previous email or username did not exist.  You need to prevent attackers from being able
            to guess valid users.  So, if AuthenticationFlowContext.getUser() returns null, you should proceed with the flow to make
            it look like a valid user was selected.  I suggest that if you want to add secret questions to this flow, you should
            ask these questions after the email is sent.  In other words, add your custom authenticator after the "Send Reset Email"
            authenticator.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="client_authentication"/>33.7. Authentication of clients</h2></div></div></div>
        
        <p>Keycloak actually supports pluggable authentication for <a class="ulink" href="http://openid.net/specs/openid-connect-core-1_0.html">OpenID Connect</a>
            client applications. Authentication of client (application) is used under the hood by the <a class="link" href="#adapter-config" title="8.1. General Adapter Config">Keycloak adapter</a>
            during sending any backchannel requests to the Keycloak server (like the request for exchange code to access token after
            successful authentication or request to refresh token). But the client authentication can be also used directly by you during
            <a class="link" href="#direct-access-grants" title="Chapter 15. Direct Access Grants">Direct Access grants</a> or during <a class="link" href="#service-accounts" title="Chapter 16. Service Accounts">Service account</a> authentication.
        </p>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3494"/>33.7.1. Default implementations</h3></div></div></div>
            
            <p>
                Actually Keycloak has 2 builtin implementations of client authentication:
                </p><div class="variablelist"><dl><dt><span class="term">Traditional authentication with client_id and client_secret</span></dt><dd>
                            <p>
                                This is default mechanism mentioned in the <a class="ulink" href="http://openid.net/specs/openid-connect-core-1_0.html">OpenID Connect</a>
                                or <a class="ulink" href="http://tools.ietf.org/html/rfc6749">OAuth2</a> specification and Keycloak supports it since it's early days.
                                The public client needs to include <code class="literal">client_id</code> parameter with it's ID in the POST request (so it's defacto not authenticated)
                                and the confidential client needs to include <code class="literal">Authorization: Basic</code> header with
                                the clientId and clientSecret used as username and password.
                            </p>
                            <p>
                                For the public/javascript clients, you
                                don't need to add anything into your keycloak.json configuration file. For the confidential (server) clients, you need to add something like this:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"credentials": {
    "secret": "mysecret"
}
</pre><p>

                                where the <code class="literal">mysecret</code> needs to be replaced with the real value of client secret. You can obtain it from admin console from client configuration.
                            </p>
                        </dd><dt><span class="term">Authentication with signed JWT</span></dt><dd>
                            <p>
                                This is based on the <a class="ulink" href="https://tools.ietf.org/html/rfc7523">JWT Bearer Token Profiles for OAuth 2.0</a> specification.
                                The client/adapter generates the <a class="ulink" href="https://tools.ietf.org/html/rfc7519">JWT</a> and signs it with his private key.
                                The Keycloak then verifies the signed JWT with the client's public key and authenticates client based on it.
                            </p>
                            <p>
                                To achieve this, you need those steps:
                                </p><div class="itemizedlist"><ul><li>Your client needs to have private key and Keycloak needs to have client public key. This can be either:
                                        <div class="itemizedlist"><ul><li>
                                                Generated in Keycloak admin console - In this case, Keycloak will generate pair of keys and it will save
                                                public key and certificate in it's DB. The keystore file with the private key will be downloaded and you need to save it
                                                in the location accessible to your client application
                                            </li><li>
                                                Uploaded in Keycloak admin console - This option is useful if you already have existing private key of your client.
                                                In this case, you just need to upload the public key and certificate to the Keycloak server.
                                            </li></ul></div>
                                        In both cases, the private key is not saved in Keycloak DB, but it's owned exclusively by your client. The Keycloak DB has just public key.
                                    </li><li>
                                        As second step, you need to use the configuration like this in your <code class="literal">keycloak.json</code> adapter configuration:
<pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"credentials": {
    "jwt": {
        "client-keystore-file": "classpath:keystore-client.jks",
        "client-keystore-type": "JKS",
        "client-keystore-password": "storepass",
        "client-key-password": "keypass",
        "client-key-alias": "clientkey",
        "token-expiration": 10
    }
}
</pre>
                                        The <code class="literal">client-keystore-file</code> is the location of the keystore file, which is either on classpath
                                        (for example if bundled in the WAR itself) or somewhere on the filesystem. Other options specify type of keystore and password of keystore itself
                                        and of the private key. Last option <code class="literal">token-expiration</code> is the expiration of JWT in seconds. The token needs to be valid
                                        just for single request, so 10 seconds is usually sufficient.
                                    </li></ul></div><p>
                            </p>
                        </dd></dl></div><p>
            </p>
            <p>
                See the demo example and especially the <code class="literal">examples/preconfigured-demo/service-account</code>
                for the example application showing service accounts authentication with both clientId+clientSecret and with signed JWT.
            </p>
        </div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3528"/>33.7.2. Implement your own client authenticator</h3></div></div></div>
            
            <p>
                For plug your own client authenticator, you need to implement few interfaces on both client (adapter) and server side.
                </p><div class="variablelist"><dl><dt><span class="term">Client side</span></dt><dd>
                            <p>
                                Here you need to implement <code class="literal">org.keycloak.adapters.authentication.ClientCredentialsProvider</code> and put the implementation either to:
                                </p><div class="itemizedlist"><ul><li>your WAR file into WEB-INF/classes . But in this case, the implementation can be used just for this single WAR application</li><li>Some JAR file, which will be added into WEB-INF/lib of your WAR</li><li>Some JAR file, which will be used as jboss module and configured in jboss-deployment-structure.xml of your WAR.</li></ul></div><p>
                                In all cases, you also need to create the file <code class="literal">META-INF/services/org.keycloak.adapters.authentication.ClientCredentialsProvider</code>
                                either in the WAR or in your JAR.
                            </p>
                            <p>
                                You also need to configure your clientCredentialsProvider in <code class="literal">keycloak.json</code> . See the javadoc for more details.
                            </p>
                        </dd><dt><span class="term">Server side</span></dt><dd>
                            <p>
                                Here you need to implement <code class="literal">org.keycloak.authentication.ClientAuthenticatorFactory</code> and
                                <code class="literal">org.keycloak.authentication.ClientAuthenticator</code> . You also need to add the file
                                <code class="literal">META-INF/services/org.keycloak.authentication.ClientAuthenticatorFactory</code> with the name of the implementation classes.
                                See <a class="link" href="#auth_spi_walkthrough" title="33.3. Authenticator SPI Walk Through">authenticators</a> for more details.
                            </p>
                            <p>
                                Finally you need to configure admin console . You need to create new client authentication flow and define execution
                                with your authenticator (you can also add the builtin authenticators and configure requirements etc)
                                and finally configure Clients binding . See <a class="link" href="#adding_authenticator" title="33.3.5. Adding Authenticator to a Flow">Adding Authenticator</a> for more details. Then
                                you need to go to Client credentials tab and choose the method for authentication your client and configure client credentials (if possible).
                            </p>
                        </dd></dl></div><p>
            </p>
        </div>
    </div>
</div>
    <div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="Migration_from_older_versions"/>Chapter 34. Migration from older versions</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d4e3557">34.1. Migrate database</a></span></dt><dt><span class="section"><a href="#d4e3569">34.2. Migrate keycloak-server.json</a></span></dt><dt><span class="section"><a href="#d4e3573">34.3. Migrate providers</a></span></dt><dt><span class="section"><a href="#d4e3576">34.4. Migrate themes</a></span></dt><dt><span class="section"><a href="#d4e3579">34.5. Migrate application</a></span></dt><dt><span class="section"><a href="#d4e3582">34.6. Version specific migration</a></span></dt><dd><dl><dt><span class="section"><a href="#d4e3584">34.6.1. Migrating to 1.6.0.Final</a></span></dt><dt><span class="section"><a href="#d4e3600">34.6.2. Migrating to 1.5.0.Final</a></span></dt><dt><span class="section"><a href="#d4e3612">34.6.3. Migrating to 1.3.0.Final</a></span></dt><dt><span class="section"><a href="#d4e3640">34.6.4. Migrating from 1.2.0.Beta1 to 1.2.0.RC1</a></span></dt><dt><span class="section"><a href="#d4e3653">34.6.5. Migrating from 1.1.0.Final to 1.2.0.Beta1</a></span></dt><dt><span class="section"><a href="#d4e3702">34.6.6. Migrating from 1.1.0.Beta2 to 1.1.0.Final</a></span></dt><dt><span class="section"><a href="#d4e3709">34.6.7. Migrating from 1.1.0.Beta1 to 1.1.0.Beta2</a></span></dt><dt><span class="section"><a href="#d4e3719">34.6.8. Migrating from 1.0.x.Final to 1.1.0.Beta1</a></span></dt><dt><span class="section"><a href="#d4e3725">34.6.9. Migrating from 1.0 RC-1 to RC-2</a></span></dt><dt><span class="section"><a href="#d4e3729">34.6.10. Migrating from 1.0 Beta 4 to RC-1</a></span></dt><dt><span class="section"><a href="#d4e3733">34.6.11. Migrating from 1.0 Beta 1 to Beta 4</a></span></dt><dt><span class="section"><a href="#d4e3747">34.6.12. Migrating from 1.0 Alpha 4 to Beta 1</a></span></dt><dt><span class="section"><a href="#d4e3761">34.6.13. Migrating from 1.0 Alpha 2 to Alpha 3</a></span></dt><dt><span class="section"><a href="#d4e3768">34.6.14. Migrating from 1.0 Alpha 1 to Alpha 2</a></span></dt></dl></dd></dl></div>
    

    <p>
        To upgrade to a new version of Keycloak first download and install the new version of Keycloak. You then have to
        migrate the database, keycloak-server.json, providers, themes and applications from the old version.
    </p>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3557"/>34.1. Migrate database</h2></div></div></div>
        
        <p>
            Keycloak provides automatic migration of the database. It's highly recommended that you backup your
            database prior to upgrading Keycloak.
        </p>
        <p>
            To enable automatic upgrading of the database if you're using a relational database make sure
            <code class="literal">databaseSchema</code> is set to <code class="literal">update</code> for <code class="literal">connectionsJpa</code>:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"connectionsJpa": {
    "default": {
        ...
        "databaseSchema": "update"
    }
}
</pre><p>
        </p>
        <p>
            For MongoDB do the same, but for <code class="literal">connectionsMongo</code>:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"connectionsMongo": {
    "default": {
        ...
        "databaseSchema": "update"
    }
}
</pre><p>
        </p>
        <p>
            When you start the server with this setting your database will automatically be migrated if the database
            schema has changed in the new version.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3569"/>34.2. Migrate keycloak-server.json</h2></div></div></div>
        
        <p>
            You should copy <code class="literal">standalone/configuration/keycloak-server.json</code> from the old version to
            make sure any configuration changes you've done are added to the new installation. The version specific
            section below will list any changes done to this file that you have to do when upgrading from one version
            to another.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3573"/>34.3. Migrate providers</h2></div></div></div>
        
        <p>
            If you have implemented any SPI providers you need to copy them to the new server. The version
            specific section below will mention if any of the SPI's have changed. If they have you may have to update
            your code accordingly.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3576"/>34.4. Migrate themes</h2></div></div></div>
        
        <p>
            If you have created a custom theme you need to copy them to the new server. The version specific section below
            will mention if changes have been made to themes. If there is you may have to update your themes accordingly.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3579"/>34.5. Migrate application</h2></div></div></div>
        
        <p>
            If you deploy applications directly to the Keycloak server you should copy them to the new server. For any
            applications including those not deployed directly to the Keycloak server you should upgrade the adapter.
            The version specific section below will mention if any changes are required to applications.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e3582"/>34.6. Version specific migration</h2></div></div></div>
        
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3584"/>34.6.1. Migrating to 1.6.0.Final</h3></div></div></div>
            
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3586"/>Refresh tokens are not reusable anymore</h4></div></div></div>
                
                <p>
                    Old versions of Keycloak allowed reusing refresh tokens multiple times. Keycloak no longer permits
                    this by default. When a refresh token is used to obtain a new access token a new refresh token is also
                    included. This new refresh token should be used next time the access token is refreshed. If this is
                    a problem for you it's possible to enable reuse of refresh tokens in the admin console under token
                    settings.
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3589"/>Some packages renamed</h4></div></div></div>
                
                <p>
                    We did a bit of restructure and renamed some packages. It is mainly about renaming internal packages of util classes.
                    The most important classes used in your application ( for example AccessToken or KeycloakSecurityContext ) as well
                    as the SPI are still unchanged. However there is slight chance that you will be affected and will need to update imports of your classes.
                    For example if you are using multitenancy and KeycloakConfigResolver, you will be affected as for example class
                    HttpFacade was moved to different package - it is <code class="literal">org.keycloak.adapters.spi.HttpFacade</code> now.
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3593"/>Persisting user sessions</h4></div></div></div>
                
                <p>
                    We added support for offline tokens in this release, which means that we are persisting "offline" user sessions into database now.
                    If you are not using offline tokens, nothing will be persisted for you, so you don't need to care about worse performance for more DB writes.
                    However in all cases, you will need to update <code class="literal">standalone/configuration/keycloak-server.json</code> and add <code class="literal">userSessionPersister</code>
                    like this:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
"userSessionPersister": {
    "provider": "jpa"
},
</pre><p>
                    If you want sessions to be persisted in Mongo instead of classic RDBMS, use provider <code class="literal">mongo</code> instead.
                </p>
            </div>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3600"/>34.6.2. Migrating to 1.5.0.Final</h3></div></div></div>
            
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3602"/>Realm and User cache providers</h4></div></div></div>
                
                <p>
                    Infinispan is now the default and only realm and user cache providers. In non-clustered mode a local Infinispan cache is used. We've also removed our
                    custom in-memory cache and the no cache providers. If you have realmCache or userCache set in keycloak-server.json to mem or none please
                    remove these. As Infinispan is the only provider there's no longer any need for the realmCache and userCache objects so these can
                    be removed.
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3605"/>Uses Session providers</h4></div></div></div>
                
                <p>
                    Infinispan is now the default and only user session provider. In non-clustered mode a local Infinispan cache is used. We've also removed the JPA
                    and Mongo user session providers. If you have userSession set in keycloak-server.json to mem, jpa or mongo please
                    remove it. As Infinispan is the only provider there's no longer any need for the userSession object so it can
                    be removed.
                </p>
                <p>
                    For anyone that wants to achieve increased durability of user sessions this can be achieved by configuring the user session cache with
                    more than one owner or use a replicated cache. It's also possible to configure Infinispan to persist caches, although that would have
                    impacts on performance.
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3609"/>Contact details removed from registration and account management</h4></div></div></div>
                
                <p>
                    In the default theme we have now removed the contact details from the registration page and account management. The admin console now lists
                    all the users attributes, not just contact specific attributes. The admin console also has the ability to add/remove attributes to a user.
                    If you want to add contact details, please refer to the address theme included in the examples.
                </p>
            </div>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3612"/>34.6.3. Migrating to 1.3.0.Final</h3></div></div></div>
            
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3614"/>Direct Grant API always enabled</h4></div></div></div>
                
                <p>
                    In the past Direct Grant API (or Resource Owner Password Credentials) was disabled by default and
                    there was an option on a realm to enable it. The Direct Grant API is now always enabled and the
                    option to enable/disable for a realm is removed.
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3617"/>Database changed</h4></div></div></div>
                
                <p>
                    There are again few database changes. Remember to backup your database prior to upgrading.
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3620"/>UserFederationProvider changed</h4></div></div></div>
                
                <p>
                    There are few minor changes in UserFederationProvider interface. You may need to sync your implementation when upgrade
                    to newer version and upgrade few methods, which has changed signature. Changes are really minor, but were needed to improve performance of federation.
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3623"/>WildFly 9.0.0.Final</h4></div></div></div>
                
                <p>
                    Following on from the distribution changes that was done in the last release the standalone download
                    of Keycloak is now based on WildFly 9.0.0.Final. This als affects the overlay which can only be deployed
                    to WildFly 9.0.0.Final or JBoss EAP 6.4.0.GA. WildFly 8.2.0.Final is no longer supported for the server.
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3626"/>WildFly, JBoss EAP and JBoss AS7 adapters</h4></div></div></div>
                
                <p>
                    There are now 3 separate adapter downloads for WildFly, JBoss EAP and JBoss AS7:
                    </p><div class="itemizedlist"><ul><li><code class="literal">eap6</code> - for JBoss EAP 6.x</li><li><code class="literal">wf9</code> - for WildFly 9.x</li><li><code class="literal">wf8</code> - for WildFly 8.x</li><li><code class="literal">as7</code> - for JBoss AS 7.x</li></ul></div><p>
                    Make sure you grab the correct one.
                </p>
                <p>
                    You also need to update standalone.xml as the extension module and subsystem definition has changed.
                    See <a class="link" href="#jboss-adapter-installation" title="8.2.1. Adapter Installation">Adapter Installation</a> for details.
                </p>
            </div>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3640"/>34.6.4. Migrating from 1.2.0.Beta1 to 1.2.0.RC1</h3></div></div></div>
            
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3642"/>Distribution changes</h4></div></div></div>
                
                <p>
                    Keycloak is now available in 3 downloads: standalone, overlay and demo bundle. The standalone is intended
                    for production and non-JEE developers. Overlay is aimed at adding Keycloak to an existing WildFly 8.2 or EAP 6.4
                    installation and is mainly for development. Finally we have a demo (or dev) bundle that is aimed at
                    developers getting started with Keycloak. This bundle contains a WildFly server, with Keycloak server and
                    adapter included. It also contains all documentation and examples.
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3645"/>Database changed</h4></div></div></div>
                
                <p>
                    This release contains again a number of changes to the database. The biggest one is Application and OAuth client merge.
                    Remember to backup your database prior to upgrading.
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3648"/>Application and OAuth client merge</h4></div></div></div>
                
                <p>
                    Application and OAuth clients are now merged into <code class="literal">Clients</code>. The UI of admin console is updated and database as well.
                    Your data from database should be automatically updated. The previously set Applications will be converted into Clients with <code class="literal">Consent required</code>
                    switch off and OAuth Clients will be converted into Clients with this switch on.
                </p>
            </div>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3653"/>34.6.5. Migrating from 1.1.0.Final to 1.2.0.Beta1</h3></div></div></div>
            
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3655"/>Database changed</h4></div></div></div>
                
                <p>
                    This release contains a number of changes to the database. Remember to backup your database prior to
                    upgrading.
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3658"/><code class="literal">iss</code> in access and id tokens</h4></div></div></div>
                
                <p>
                    The value of <code class="literal">iss</code> claim in access and id tokens have changed from <code class="literal">realm name</code>
                    to <code class="literal">realm url</code>. This is required by OpenID Connect specification. If you're using our adapters
                    there's no change required, other than if you've been using bearer-only without specifying <code class="literal">auth-server-url</code>
                    you have to add it now. If you're using another library (or RSATokenVerifier) you need to make the corresponding
                    changes when verifying <code class="literal">iss</code>.
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3667"/>OpenID Connect endpoints</h4></div></div></div>
                
                <p>
                    To comply with OpenID Connect specification the authentication and token endpoints have been changed
                    to having a single authentication endpoint and a single token endpoint. As per-spec <code class="literal">response_type</code>
                    and <code class="literal">grant_type</code> parameters are used to select the required flow. The old endpoints (<code class="literal">/realms/{realm}/protocols/openid-connect/login</code>,
                    <code class="literal">/realms/{realm}/protocols/openid-connect/grants/access</code>, <code class="literal">/realms/{realm}/protocols/openid-connect/refresh</code>,
                    <code class="literal">/realms/{realm}/protocols/openid-connect/access/codes)</code> are now deprecated and will be removed
                    in a future version.
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3676"/>Theme changes</h4></div></div></div>
                
                <p>
                    The layout of themes have changed. The directory hierarchy used to be <code class="literal">type/name</code>
                    this is now changed to <code class="literal">name/type</code>. For example a login theme named <code class="literal">sunrise</code>
                    used to be deployed to <code class="literal">standalone/configuration/themes/login/sunrise</code>, which is now
                    moved to <code class="literal">standalone/configuration/themes/sunrise/login</code>. This change was done to
                    make it easier to have group the different types for the same theme into one folder.
                </p>
                <p>
                    If you deployed themes as a JAR in the past you had to create a custom theme loader which required
                    Java code. This has been simplified to only requiring a plain text file (<code class="literal">META-INF/keycloak-themes.json</code>)
                    to describe the themes included in a JAR. See the <a class="link" href="#themes" title="Chapter 10. Themes">themes</a> section in the docs for more information.
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3687"/>Claims changes</h4></div></div></div>
                
                <p>
                    Previously there was <code class="literal">Claims</code> tab in admin console for application and OAuth clients. This
                    was used to configure which attributes should go into access token for particular application/client. This was removed
                    and replaced with <a class="link" href="#mappers" title="Chapter 32. OIDC Token and SAML Assertion Mappings">Protocol mappers</a>, which are more flexible.
                </p>
                <p>
                    You don't need to care about migration of database from previous version.
                    We did migration scripts for both RDBMS and Mongo, which should ensure that claims configured for particular application/client
                    will be converted into corresponding protocol mappers (Still it's safer to backup DB before migrating to newer version though).
                    Same applies for exported JSON representation from previous version.
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e3693"/>Social migration to identity brokering</h4></div></div></div>
                
                <p>
                    We refactored social providers SPI and replaced it with <a class="link" href="#identity-broker" title="Chapter 9. Identity Broker">identity brokering SPI</a>,
                    which is more flexible. The <code class="literal">Social</code> tab in admin console is renamed to <code class="literal">Identity Provider</code> tab.
                </p>
                <p>
                    Again you don't need to care about migration of database from previous version similarly like for Claims/protocol mappers.
                    Both configuration of social providers and "social links" to your users will be converted to corresponding Identity providers.
                </p>
                <p>
                    Only required action from you would be to change allowed <code class="literal">Redirect URI</code> in the admin console of
                    particular 3rd party social providers. You can first go to the Keycloak admin console and copy Redirect URI from the page where
                    you configure the identity provider. Then you can simply paste this as allowed Redirect URI to the admin console
                    of 3rd party provider (IE. Facebook admin console).
                </p>
            </div>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3702"/>34.6.6. Migrating from 1.1.0.Beta2 to 1.1.0.Final</h3></div></div></div>
            
            <div class="itemizedlist"><ul><li>
                    Providers are no longer loaded from <code class="literal">WEB-INF/lib</code>, they are now loaded
                    from <code class="literal">standalone/configuration/providers</code>. See the
                    <a class="link" href="#providers" title="Chapter 4. Providers and SPIs">providers</a> section for more details.
                </li></ul></div>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3709"/>34.6.7. Migrating from 1.1.0.Beta1 to 1.1.0.Beta2</h3></div></div></div>
            
            <div class="itemizedlist"><ul><li>Adapters are now a separate download.  They are not included in appliance and war distribution.  We have too many now and the distro
                is getting bloated.</li><li>The tomcat adapter valve has moved to a different package.  From <code class="literal">org.keycloak.adapters.tomcat7.KeycloakAuthenticatorValve</code> to <code class="literal">org.keycloak.adapters.tomcat.KeycloakAuthenticatorValve</code>
                From the 'tomcat7' package to just 'tomcat'.
                </li><li>JavaScript adapter now has idToken and idTokenParsed properties. If you use idToken to retrieve first name, email, etc. you need to change this to idTokenParsed.</li><li>The as7-eap-subsystem and keycloak-wildfly-subsystem have been merged into one keycloak-subsystem.  If you have an existing standalone.xml
                          or domain.xml, you will need edit near the top of the file and change the extension module name to org.keycloak.keycloak-subsystem.
                          For AS7 only, the extension module name is org.keycloak.keycloak-as7-subsystem.</li><li>Server installation is no longer supported on AS7.  You can still use AS7 as an application client.</li></ul></div>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3719"/>34.6.8. Migrating from 1.0.x.Final to 1.1.0.Beta1</h3></div></div></div>
            
            <div class="itemizedlist"><ul><li>RealmModel JPA and Mongo storage schema has changed</li><li>UserSessionModel JPA and Mongo storage schema has changed as these interfaces have been refactored</li><li>
                    Upgrade your adapters, old adapters are not compatible with Keycloak 1.1.  We interpreted JSON Web Token and OIDC ID Token specification incorrectly.  'aud'
                    claim must be the client id, we were storing the realm name in there and validating it.
                </li></ul></div>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3725"/>34.6.9. Migrating from 1.0 RC-1 to RC-2</h3></div></div></div>
            
            <div class="itemizedlist"><ul><li>A lot of info level logging has been changed to debug. Also, a realm no longer has the jboss-logging audit listener by default.
                    If you want log output when users login, logout, change passwords, etc. enable the jboss-logging audit listener through the admin console.</li></ul></div>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3729"/>34.6.10. Migrating from 1.0 Beta 4 to RC-1</h3></div></div></div>
            
            <div class="itemizedlist"><ul><li>
                    logout REST API has been refactored.  The GET request on the logout URI does not take a session_state
                    parameter anymore.  You must be logged in in order to log out the session.
                    You can also POST to the logout REST URI.  This action requires a valid refresh token to perform the logout.
                    The signature is the same as refresh token minus the grant type form parameter.  See documentation for details.
                </li></ul></div>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3733"/>34.6.11. Migrating from 1.0 Beta 1 to Beta 4</h3></div></div></div>
            
            <div class="itemizedlist"><ul><li>
                    LDAP/AD configuration is changed.  It is no longer under the "Settings" page.  It is now under
                    Users-&gt;Federation.  Add Provider will show you an "ldap" option.
                </li><li>
                    Authentication SPI has been removed and rewritten.  The new SPI is UserFederationProvider and is
                    more flexible.
                </li><li>
                    <code class="literal">ssl-not-required</code> property in adapter config has been removed. Replaced with
                    <code class="literal">ssl-required</code>, valid values are <code class="literal">all</code> (require SSL for all requests), <code class="literal">external</code>
                    (require SSL only for external request) and <code class="literal">none</code> (SSL not required).
                </li><li>
                    DB Schema has changed again.
                </li><li>
                    Created applications now have a full scope by default.  This means that you don't have to configure
                    the scope of an application if you don't want to.
                </li><li>
                    Format of JSON file for importing realm data was changed. Now role mappings is available under the JSON record of particular
                    user.
                </li></ul></div>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3747"/>34.6.12. Migrating from 1.0 Alpha 4 to Beta 1</h3></div></div></div>
            
            <div class="itemizedlist"><ul><li>
                    DB Schema has changed.  We have added export of the database to Beta 1, but not the ability to import
                    the database from older versions. This will be supported in future releases.
                </li><li>
                    For all clients except bearer-only applications, you must specify at least one redirect uri.  Keycloak
                    will not allow you to log in unless you have specified a valid redirect uri for that application.
                </li><li>
                    Resource Owner Password Credentials flow is now disabled by default. It can be enabled by setting the toggle
                    for <code class="literal">Direct Grant API</code> <code class="literal">ON</code> under realm config in the admin console.
                </li><li>
                    Configuration is now done through <code class="literal">standalone/configuration/keycloak-server.json</code>. This
                    should mainly affect those that use MongoDB.
                </li><li>
                    JavaScript adapter has been refactored. See the <a class="link" href="#javascript-adapter" title="8.8. Javascript Adapter">JavaScript adapter</a> section for more details.
                </li><li>
                    The "Central Login Lifespan" setting no longer exists.  Please see the <a class="link" href="#session-timeouts" title="18.2. Session Timeouts">Session Timeout</a> section
                    for me details.
                </li></ul></div>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3761"/>34.6.13. Migrating from 1.0 Alpha 2 to Alpha 3</h3></div></div></div>
            
            <div class="itemizedlist"><ul><li>
                    SkeletonKeyToken, SkeletonKeyScope, SkeletonKeyPrincipal, and SkeletonKeySession have been renamed to:
                    AccessToken, AccessScope, KeycloakPrincipal, and KeycloakAuthenticatedSession respectively.
                </li><li>
                    ServleOAuthClient.getBearerToken() method signature has changed.  It now returns an AccessTokenResponse
                    so that you can obtain a refresh token too.
                </li><li>
                    Adapters now check the access token expiration with every request.  If the token is expired, they will
                    attempt to invoke a refresh on the auth server using a saved refresh token.
                </li><li>
                    Subject in AccessToken has been changed to the User ID.
                </li></ul></div>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e3768"/>34.6.14. Migrating from 1.0 Alpha 1 to Alpha 2</h3></div></div></div>
            
            <div class="itemizedlist"><ul><li>
                    DB Schema has changed.  We don't have any data migration utilities yet as of Alpha 2.
                </li><li>
                    JBoss and Wildfly adapters are now installed via a JBoss/Wildfly subsystem.  Please review the adapter
                    installation documentation.  Edits to standalone.xml are now required.
                </li><li>
                    There is a new credential type "secret".  Unlike other credential types, it is stored in plain text in
                    the database and can be viewed in the admin console.

                </li><li>
                    There is no longer required Application or OAuth Client credentials.  These client types are now
                    hard coded to use the "secret" credential type.
                </li><li>
                    Because of the "secret" credential change to Application and OAuth Client, you'll have to update
                    your keycloak.json configuration files and regenarate a secret within the Application or OAuth Client
                    credentials tab in the administration console.
                </li></ul></div>
        </div>
    </div>
</div>

</div></body></html>
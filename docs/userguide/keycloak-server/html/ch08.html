<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">Chapter 8. Adapters</title><link rel="stylesheet" href="css/jbossorg.css" type="text/css"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL-NS Stylesheets V1.74.0"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" http-equiv="Content-Type" content="text/html; charset=UTF-8"/><link rel="home" href="index.html" title="Keycloak Reference Guide"/><link rel="up" href="index.html" title="Keycloak Reference Guide"/><link rel="prev" href="per-realm-admin-permissions.html" title="Chapter 7. Per Realm Admin Access Control"/><link rel="next" href="identity-broker.html" title="Chapter 9. Identity Broker"/></head><body><p xmlns:d="http://docbook.org/ns/docbook" id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><ul xmlns:d="http://docbook.org/ns/docbook" class="docnav"><li class="previous"><a accesskey="p" href="per-realm-admin-permissions.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="identity-broker.html"><strong>Next</strong></a></li></ul><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e675"/>Chapter 8. Adapters</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="ch08.html#adapter-config">8.1. General Adapter Config</a></span></dt><dt><span class="section"><a href="ch08.html#jboss-adapter">8.2. JBoss/Wildfly Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="ch08.html#jboss-adapter-installation">8.2.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="ch08.html#d4e910">8.2.2. Required Per WAR Configuration</a></span></dt><dt><span class="section"><a href="ch08.html#d4e923">8.2.3. Securing WARs via Keycloak Subsystem</a></span></dt></dl></dd><dt><span class="section"><a href="ch08.html#tomcat-adapter">8.3. Tomcat 6, 7 and 8 Adapters</a></span></dt><dd><dl><dt><span class="section"><a href="ch08.html#tomcat-adapter-installation">8.3.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="ch08.html#d4e958">8.3.2. Required Per WAR Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="ch08.html#jetty9-adapter">8.4. Jetty 9.x Adapters</a></span></dt><dd><dl><dt><span class="section"><a href="ch08.html#jetty9-adapter-installation">8.4.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="ch08.html#jetty9_per_war">8.4.2. Required Per WAR Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="ch08.html#jetty8-adapter">8.5. Jetty 8.1.x Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="ch08.html#jetty8-adapter-installation">8.5.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="ch08.html#d4e1020">8.5.2. Required Per WAR Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="ch08.html#d4e1024">8.6. Java Servlet Filter Adapter</a></span></dt><dt><span class="section"><a href="ch08.html#fuse-adapter">8.7. JBoss Fuse and Apache Karaf Adapter</a></span></dt><dt><span class="section"><a href="ch08.html#javascript-adapter">8.8. Javascript Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="ch08.html#d4e1100">8.8.1. Session status iframe</a></span></dt><dt><span class="section"><a href="ch08.html#d4e1105">8.8.2. Older browsers</a></span></dt><dt><span class="section"><a href="ch08.html#d4e1113">8.8.3. JavaScript Adapter reference</a></span></dt></dl></dd><dt><span class="section"><a href="ch08.html#spring-boot-adapter">8.9. Spring Boot Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="ch08.html#spring-boot-adapter-installation">8.9.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="ch08.html#spring-boot-adapter-configuration">8.9.2. Required Spring Boot Adapter Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="ch08.html#spring-security-adapter">8.10. Spring Security Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="ch08.html#d4e1243">8.10.1. Adapter Installation</a></span></dt><dt><span class="section"><a href="ch08.html#d4e1248">8.10.2. Spring Security Configuration</a></span></dt><dt><span class="section"><a href="ch08.html#d4e1267">8.10.3. Naming Security Roles</a></span></dt><dt><span class="section"><a href="ch08.html#d4e1273">8.10.4. Client to Client Support</a></span></dt><dt><span class="section"><a href="ch08.html#d4e1285">8.10.5. Spring Boot Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="ch08.html#installed-applications">8.11. Installed Applications</a></span></dt><dd><dl><dt><span class="section"><a href="ch08.html#installed-applications-url">8.11.1. http://localhost</a></span></dt><dt><span class="section"><a href="ch08.html#installed-applications-urn">8.11.2. urn:ietf:wg:oauth:2.0:oob</a></span></dt></dl></dd><dt><span class="section"><a href="ch08.html#d4e1302">8.12. Logout</a></span></dt><dt><span class="section"><a href="ch08.html#multi_tenancy">8.13. Multi Tenancy</a></span></dt><dt><span class="section"><a href="ch08.html#jaas-adapter">8.14. JAAS plugin</a></span></dt></dl></div>
        
        <p>
            Keycloak can secure a wide variety of application types. This section defines which application
            types are supported and how to configure and install them so that you can use Keycloak to secure
            your applications.
        </p>
        <p>
            These client adapters use an extension of the OpenID Connect protocol (a derivate of OAuth 2.0).
            This extension provides support for clustering, backchannel logout, and other non-standard adminstrative functions.
            The Keycloak project also provides a separate, standalone, generic, SAML client adapter.  But that is describe in a separate
            document and has a different download.
        </p>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="adapter-config"/>8.1. General Adapter Config</h2></div></div></div>
    
    <p>
        Each adapter supported by Keycloak can be configured by a simple JSON text file.  This is what one might
        look like:
    </p>
    <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">{
  "realm" : "demo",
  "resource" : "customer-portal",
  "realm-public-key" : "MIGfMA0GCSqGSIb3D...31LwIDAQAB",
  "auth-server-url" : "https://localhost:8443/auth",
  "ssl-required" : "external",
  "use-resource-role-mappings" : false,
  "enable-cors" : true,
  "cors-max-age" : 1000,
  "cors-allowed-methods" : "POST, PUT, DELETE, GET",
  "bearer-only" : false,
  "enable-basic-auth" : false,
  "expose-token" : true,
   "credentials" : {
      "secret" : "234234-234234-234234"
   },

   "connection-pool-size" : 20,
   "disable-trust-manager": false,
   "allow-any-hostname" : false,
   "truststore" : "path/to/truststore.jks",
   "truststore-password" : "geheim",
   "client-keystore" : "path/to/client-keystore.jks",
   "client-keystore-password" : "geheim",
   "client-key-password" : "geheim"
}

</pre><p>
    </p>
    <p>
        Some of these configuration switches may be adapter specific and some are common across all adapters.
        For Java adapters you can use <code class="literal">${...}</code> enclosure as System property replacement.
        For example <code class="literal">${jboss.server.config.dir}</code>.  Also, you can obtain a template
        for this config file from the admin console.  Go to the realm and select the application you want a template for.
        Go to the <code class="literal">Installation</code> tab and this will provide you with a template that includes
        the public key of the realm.
    </p>
    <p>
        Here is a description of each item:
    </p>
    <p>
        </p><div class="variablelist"><dl><dt><span class="term">realm</span></dt><dd>
                    <p>
                        Name of the realm representing the users of your distributed applications and services.
                        This is
                        <span class="emphasis"><em>REQUIRED.</em></span>
                    </p>
                </dd><dt><span class="term">resource</span></dt><dd>
                    <p>
                        Username of the application. Each application has a username that is used when the
                        application connects with the Keycloak server to turn an access code into an access token
                        (part of the OAuth 2.0 protocol). This is
                        <span class="emphasis"><em>REQUIRED.</em></span>
                    </p>
                </dd><dt><span class="term">realm-public-key</span></dt><dd>
                    <p>
                        PEM format of public key. You can obtain this from the administration console.
                        This is
                        <span class="emphasis"><em>REQUIRED.</em></span>
                    </p>
                </dd><dt><span class="term">auth-server-url</span></dt><dd>
                    <p>
                        The base URL of the Keycloak Server.  All other Keycloak pages and REST services are derived
                        from this.  It is usually of the form <code class="literal">https://host:port/auth</code>
                        This is
                        <span class="emphasis"><em>REQUIRED.</em></span>
                    </p>
                </dd><dt><span class="term">ssl-required</span></dt><dd>
                    <p>
                        Ensures that all communication to and from the Keycloak server from the adapter is over HTTPS.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. The default value is
                        <span class="emphasis"><em>external</em></span>
                        meaning that HTTPS is required by default for external requests. Valid values are 'all', 'external'
                        and 'none'.
                    </p>
                </dd><dt><span class="term">use-resource-role-mappings</span></dt><dd>
                    <p>
                        If set to true, the adapter will look inside the token for application level role mappings for
                        the
                        user. If false, it will look at the realm level for user role mappings.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. The default value is <span class="emphasis"><em>false</em></span>.
                    </p>
                </dd><dt><span class="term">public-client</span></dt><dd>
                    <p>
                        If set to true, the adapter will not send credentials for the client to Keycloak.
                        The default value is <span class="emphasis"><em>false</em></span>.
                    </p>
                </dd><dt><span class="term">enable-cors</span></dt><dd>
                    <p>
                        This enables CORS support. It will handle CORS preflight requests. It will also look into
                        the access token to determine valid origins.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. The default value is <span class="emphasis"><em>false</em></span>.
                    </p>
                </dd><dt><span class="term">cors-max-age</span></dt><dd>
                    <p>
                        If CORS is enabled, this sets the value of the
                        <code class="literal">Access-Control-Max-Age</code>
                        header.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. If not set, this header is not returned in CORS
                        responses.
                    </p>
                </dd><dt><span class="term">cors-allowed-methods</span></dt><dd>
                    <p>
                        If CORS is enabled, this sets the value of the
                        <code class="literal">Access-Control-Allow-Methods</code>
                        header. This should be a comma-separated string.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. If not set, this header is not returned in CORS
                        responses.
                    </p>
                </dd><dt><span class="term">cors-allowed-headers</span></dt><dd>
                    <p>
                        If CORS is enabled, this sets the value of the
                        <code class="literal">Access-Control-Allow-Headers</code>
                        header. This should be a comma-separated string.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. If not set, this header is not returned in CORS
                        responses.
                    </p>
                </dd><dt><span class="term">bearer-only</span></dt><dd>
                    <p>
                        This tells the adapter to only do bearer token authentication. That is, it will not do
                        OAuth 2.0 redirects, but only accept bearer tokens through the
                        <code class="literal">Authorization</code>
                        header.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. The default value is <span class="emphasis"><em>false</em></span>.
                    </p>
                </dd><dt><span class="term">enable-basic-auth</span></dt><dd>
                    <p>
                        This tells the adapter to also support basic authentication. If this option is enabled,
                        then <span class="emphasis"><em>secret</em></span> must also be provided.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. The default value is <span class="emphasis"><em>false</em></span>.
                    </p>
                </dd><dt><span class="term">expose-token</span></dt><dd>
                    <p>
                        If <code class="literal">true</code>, an authenticated browser client (via a Javascript HTTP invocation)
                        can obtain the signed access token via the URL <code class="literal">root/k_query_bearer_token</code>.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>. The default value is <span class="emphasis"><em>false</em></span>.
                    </p>
                </dd><dt><span class="term">credentials</span></dt><dd>
                    <p>
                        Specify the credentials of the application. This is an object notation where the key
                        is the credential type and the value is the value of the credential type. Currently only
                        <code class="literal">password</code>
                        is supported.
                        This is <span class="emphasis"><em>REQUIRED</em></span>.
                    </p>
                </dd><dt><span class="term">connection-pool-size</span></dt><dd>
                    <p>
                        Adapters will make separate HTTP invocations to the Keycloak Server to turn an access code
                        into an access token.  This config option defines how many connections to the Keycloak Server
                        should be pooled.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>.  The default value is <code class="literal">20</code>.
                    </p>
                </dd><dt><span class="term">disable-trust-manager</span></dt><dd>
                    <p>
                        If the Keycloak Server requires HTTPS and this config option is set to <code class="literal">true</code>
                        you do not have to specify a truststore.  While convenient,  this setting is not recommended
                        as you will not be verifying the host name of the Keycloak Server.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>.  The default value is <code class="literal">false</code>.
                    </p>
                </dd><dt><span class="term">allow-any-hostname</span></dt><dd>
                    <p>
                        If the Keycloak Server requires HTTPS and this config option is set to <code class="literal">true</code>
                        the Keycloak Server's certificate is validated via the truststore, but host name validation is
                        not done.  This is not a recommended.  This seting may be useful in test environments
                        This is <span class="emphasis"><em>OPTIONAL</em></span>.  The default value is <code class="literal">false</code>.
                    </p>
                </dd><dt><span class="term">truststore</span></dt><dd>
                    <p>
                        This setting is for Java adapters. The value is the file path to a Java keystore file.  If
                        you prefix the path with <code class="literal">classpath:</code>, then the truststore will be obtained
                        from the deployment's classpath instead.
                        Used for outgoing HTTPS communications to the Keycloak server. Client making HTTPS
                        requests need a way to verify the host of the server they are talking to. This is
                        what the trustore does. The keystore contains one or more trusted
                        host certificates or certificate authorities. You can
                        create this truststore by extracting the public certificate of the Keycloak server's SSL
                        keystore.
                        This is
                        <span class="emphasis"><em>OPTIONAL</em></span>
                        if
                        <code class="literal">ssl-required</code>
                        is
                        <code class="literal">none</code>
                        or
                        <code class="literal">disable-trust-manager</code>
                        is <code class="literal">true</code>.
                    </p>
                </dd><dt><span class="term">truststore-password</span></dt><dd>
                    <p>
                        Password for the truststore keystore.
                        This is
                        <span class="emphasis"><em>REQUIRED</em></span>
                        if
                        <code class="literal">truststore</code>
                        is set.
                    </p>
                </dd><dt><span class="term">client-keystore</span></dt><dd>
                    <p>
                        <span class="emphasis"><em>Not supported yet, but we will support in future versions.</em></span>

                        This setting is for Java adapters. This is the file path to a Java keystore file.
                        This keystore contains client certificate for two-way SSL when the adapter makes
                        HTTPS requests to the Keycloak server.
                        This is <span class="emphasis"><em>OPTIONAL</em></span>.
                    </p>
                </dd><dt><span class="term">client-keystore-password</span></dt><dd>
                    <p>
                        <span class="emphasis"><em>Not supported yet, but we will support in future versions.</em></span>
                        Password for the client keystore.
                        This is
                        <span class="emphasis"><em>REQUIRED</em></span>
                        if
                        <code class="literal">client-keystore</code>
                        is set.
                    </p>
                </dd><dt><span class="term">client-key-password</span></dt><dd>
                    <p>
                        <span class="emphasis"><em>Not supported yet, but we will support in future versions.</em></span>
                        Password for the client's key.
                        This is
                        <span class="emphasis"><em>REQUIRED</em></span>
                        if
                        <code class="literal">client-keystore</code>
                        is set.
                    </p>
                </dd><dt><span class="term">auth-server-url-for-backend-requests</span></dt><dd>
                    <p>
                        Alternative location of auth-server-url used just for backend requests. It must be absolute URI. Useful
                        especially in cluster (see <a class="link" href="applicationClustering.html#relative-uri-optimization" title="29.2. Relative URI optimization">Relative URI Optimization</a>) or if you would like to use <span class="emphasis"><em>https</em></span> for browser requests
                        but stick with <span class="emphasis"><em>http</em></span> for backend requests etc.
                    </p>
                </dd><dt><span class="term">always-refresh-token</span></dt><dd>
                    <p>
                        If <span class="emphasis"><em>true</em></span>, Keycloak will refresh token in every request. More info in <a class="link" href="applicationClustering.html#refresh-token-each-req" title="29.5. Refresh token in each request">Refresh token in each request</a> .
                    </p>
                </dd><dt><span class="term">register-node-at-startup</span></dt><dd>
                    <p>
                        If <span class="emphasis"><em>true</em></span>, then adapter will send registration request to Keycloak. It's <span class="emphasis"><em>false</em></span>
                        by default and useful just in cluster (See <a class="link" href="applicationClustering.html#registration-app-nodes" title="29.4. Registration of application nodes to Keycloak">Registration of application nodes to Keycloak</a>)
                    </p>
                </dd><dt><span class="term">register-node-period</span></dt><dd>
                    <p>
                        Period for re-registration adapter to Keycloak. Useful in cluster. See <a class="link" href="applicationClustering.html#registration-app-nodes" title="29.4. Registration of application nodes to Keycloak">Registration of application nodes to Keycloak</a> for details.
                    </p>
                </dd><dt><span class="term">token-store</span></dt><dd>
                    <p>
                        Possible values are <span class="emphasis"><em>session</em></span> and <span class="emphasis"><em>cookie</em></span>. Default is <span class="emphasis"><em>session</em></span>,
                        which means that adapter stores account info in HTTP Session. Alternative <span class="emphasis"><em>cookie</em></span> means storage of info in cookie.
                        See <a class="link" href="applicationClustering.html#stateless-token-store" title="29.1. Stateless token store">Stateless token store</a> for details.
                    </p>
                </dd><dt><span class="term">principal-attribute</span></dt><dd>
                    <p>
                        OpenID Connection ID Token attribute to populate the UserPrincipal name with.  If token attribute is null, defaults to <code class="literal">sub</code>.
                        Possible values are <code class="literal">sub</code>, <code class="literal">preferred_username</code>, <code class="literal">email</code>, <code class="literal">name</code>, <code class="literal">nickname</code>, <code class="literal">given_name</code>, <code class="literal">family_name</code>.
                    </p>
                </dd></dl></div><p>
    </p>
</div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="jboss-adapter"/>8.2. JBoss/Wildfly Adapter</h2></div></div></div>
    
    <p>
        To be able to secure WAR apps deployed on JBoss AS 7.1.1, JBoss EAP 6.x, or Wildfly, you must install and
        configure the Keycloak Subsystem.  You then have two options to secure your WARs.  You can provide a keycloak
        config file in your WAR and change the auth-method to KEYCLOAK within web.xml.  Alternatively, you don't have
        to crack open your WARs at all and can apply Keycloak via the Keycloak Subsystem configuration in standalone.xml.
        Both methods are described in this section.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="jboss-adapter-installation"/>8.2.1. Adapter Installation</h3></div></div></div>
        
    <p>
        Adapters are no longer included with the appliance or war distribution.Each adapter is a separate download on
        the Keycloak download site.  They are also available as a maven artifact.
    </p>
    <p>
        Install on Wildfly 9:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd $WILDFLY_HOME
$ unzip keycloak-wf9-adapter-dist.zip
</pre><p>
    </p>
    <p>
        Install on Wildfly 8:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd $WILDFLY_HOME
$ unzip keycloak-wf8-adapter-dist.zip
</pre><p>
    </p>
    <p>
        Install on JBoss EAP 6.x:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd $JBOSS_HOME
$ unzip keycloak-eap6-adapter-dist.zip
</pre><p>
    </p>
    <p>
        Install on JBoss AS 7.1.1:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd $JBOSS_HOME
$ unzip keycloak-as7-adapter-dist.zip
</pre><p>
    </p>
    <p>
        This zip file creates new JBoss Modules specific to the Wildfly Keycloak Adapter within your Wildfly distro.
    </p>
    <p>
        After adding the Keycloak modules, you must then enable the Keycloak Subsystem within your app server's server configuration:
        <code class="literal">domain.xml</code> or <code class="literal">standalone.xml</code>.
    </p>
    <p>
        There is a CLI script that will help you modify your server configuration.  Start the server and run the script 
        from the server's bin directory:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd $JBOSS_HOME/bin
$ jboss-cli.sh -c --file=adapter-install.cli
</pre><p>
        The script will add the extension, subsystem, and optional security-domain as described below.
    </p>
    <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;server xmlns="urn:jboss:domain:1.4"&gt;

    &lt;extensions&gt;
        &lt;extension module="org.keycloak.keycloak-adapter-subsystem"/&gt;
          ...
    &lt;/extensions&gt;

    &lt;profile&gt;
        &lt;subsystem xmlns="urn:jboss:domain:keycloak:1.1"/&gt;
         ...
    &lt;/profile&gt;

</pre><p>
    </p>
        <p>
            The keycloak security domain should be used with EJBs and other components when you need the security context created
            in the secured web tier to be propagated to the EJBs (other EE component) you are invoking.  Otherwise
            this configuration is optional.
        </p>
<pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;server xmlns="urn:jboss:domain:1.4"&gt;
 &lt;subsystem xmlns="urn:jboss:domain:security:1.2"&gt;
    &lt;security-domains&gt;
...
      &lt;security-domain name="keycloak"&gt;
         &lt;authentication&gt;
           &lt;login-module code="org.keycloak.adapters.jboss.KeycloakLoginModule"
                         flag="required"/&gt;
          &lt;/authentication&gt;
      &lt;/security-domain&gt;
    &lt;/security-domains&gt;

</pre>
        <p>
            For example, if you have a JAX-RS service that is an EJB within your WEB-INF/classes directory, you'll want
            to annotate it with the @SecurityDomain annotation as follows:
        </p>
<pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
import org.jboss.ejb3.annotation.SecurityDomain;
import org.jboss.resteasy.annotations.cache.NoCache;

import javax.annotation.security.RolesAllowed;
import javax.ejb.EJB;
import javax.ejb.Stateless;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import java.util.ArrayList;
import java.util.List;

@Path("customers")
@Stateless
@SecurityDomain("keycloak")
public class CustomerService {

    @EJB
    CustomerDB db;

    @GET
    @Produces("application/json")
    @NoCache
    @RolesAllowed("db_user")
    public List&lt;String&gt; getCustomers() {
        return db.getCustomers();
    }
}

</pre>
        <p>
            We hope to improve our integration in the future so that you don't have to specify the @SecurityDomain
            annotation when you want to propagate a keycloak security context to the EJB tier.
        </p>

    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e910"/>8.2.2. Required Per WAR Configuration</h3></div></div></div>
        
        <p>
            This section describes how to secure a WAR directly by adding config and editing files within your WAR package.
        </p>
        <p>
            The first thing you must do is create
            a <code class="literal">keycloak.json</code> adapter config file within the <code class="literal">WEB-INF</code> directory
            of your WAR.  The format of this config file is describe in the <a class="link" href="ch08.html#adapter-config" title="8.1. General Adapter Config">general adapter configuration</a>
            section.
        </p>
        <p>
            Next you must set the <code class="literal">auth-method</code> to <code class="literal">KEYCLOAK</code> in <code class="literal">web.xml</code>.  You also
            have to use standard servlet security to specify role-base constraints on your URLs.  Here's an example
            pulled from one of the examples that comes distributed with Keycloak.
        </p>
        <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
      version="3.0"&gt;

	&lt;module-name&gt;customer-portal&lt;/module-name&gt;

    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Admins&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/admin/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;admin&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
        &lt;user-data-constraint&gt;
            &lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;
        &lt;/user-data-constraint&gt;
    &lt;/security-constraint&gt;
    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Customers&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/customers/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;user&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
        &lt;user-data-constraint&gt;
            &lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;
        &lt;/user-data-constraint&gt;
    &lt;/security-constraint&gt;

    &lt;login-config&gt;
        &lt;auth-method&gt;KEYCLOAK&lt;/auth-method&gt;
        &lt;realm-name&gt;this is ignored currently&lt;/realm-name&gt;
    &lt;/login-config&gt;

    &lt;security-role&gt;
        &lt;role-name&gt;admin&lt;/role-name&gt;
    &lt;/security-role&gt;
    &lt;security-role&gt;
        &lt;role-name&gt;user&lt;/role-name&gt;
    &lt;/security-role&gt;
&lt;/web-app&gt;

</pre><p>
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e923"/>8.2.3. Securing WARs via Keycloak Subsystem</h3></div></div></div>
        
        <p>
            You do not have to crack open a WAR to secure it with Keycloak.  Alternatively, you can externally secure
            it via the Keycloak Adapter Subsystem.  While you don't have to specify KEYCLOAK as an <code class="literal">auth-method</code>,
            you still have to define the <code class="literal">security-constraints</code> in <code class="literal">web.xml</code>.  You do
            not, however, have to create a <code class="literal">WEB-INF/keycloak.json</code> file.  This metadata is instead defined
            within XML in your server's <code class="literal">domain.xml</code> or <code class="literal">standalone.xml</code> subsystem
            configuration section.
        </p>
<p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;extensions&gt;
  &lt;extension module="org.keycloak.keycloak-adapter-subsystem"/&gt;
&lt;/extensions&gt;

&lt;profile&gt;
  &lt;subsystem xmlns="urn:jboss:domain:keycloak:1.1"&gt;
     &lt;secure-deployment name="WAR MODULE NAME.war"&gt;
        &lt;realm&gt;demo&lt;/realm&gt;
        &lt;realm-public-key&gt;MIGfMA0GCSqGSIb3DQEBAQUAA&lt;/realm-public-key&gt;
        &lt;auth-server-url&gt;http://localhost:8081/auth&lt;/auth-server-url&gt;
        &lt;ssl-required&gt;external&lt;/ssl-required&gt;
        &lt;resource&gt;customer-portal&lt;/resource&gt;
        &lt;credential name="secret"&gt;password&lt;/credential&gt;
     &lt;/secure-deployment&gt;
  &lt;/subsystem&gt;
&lt;/profile&gt;

</pre><p>
</p>
        <p>
            The <code class="literal">secure-deployment</code> <code class="literal">name</code> attribute identifies the WAR you want
            to secure.  Its value is the <code class="literal">module-name</code> defined in <code class="literal">web.xml</code> with
            <code class="literal">.war</code> appended.  The rest of the configuration corresponds pretty much one to one
            with the <code class="literal">keycloak.json</code> configuration options defined in <a class="link" href="ch08.html#adapter-config" title="8.1. General Adapter Config">general adapter configuration</a>.
            The exception is the <code class="literal">credential</code> element.
        </p>
        <p>
            To make it easier for you, you can go to the Keycloak Adminstration Console and go to the Application/Installation
            tab of the application this WAR is aligned with.  It provides an example XML file you can cut and paste.
        </p>
        <p>
            There is an additional convenience format for this XML if you have multiple WARs you are deployment that
            are secured by the same domain.  This format allows you to define common configuration items in one place
            under the <code class="literal">realm</code> element.
        </p>
        <p>
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;subsystem xmlns="urn:jboss:domain:keycloak:1.1"&gt;
    &lt;realm name="demo"&gt;
        &lt;realm-public-key&gt;MIGfMA0GCSqGSIb3DQEBA&lt;/realm-public-key&gt;
        &lt;auth-server-url&gt;http://localhost:8080/auth&lt;/auth-server-url&gt;
        &lt;ssl-required&gt;external&lt;/ssl-required&gt;
    &lt;/realm&gt;
    &lt;secure-deployment name="customer-portal.war"&gt;
        &lt;realm&gt;demo&lt;/realm&gt;
        &lt;resource&gt;customer-portal&lt;/resource&gt;
        &lt;credential name="secret"&gt;password&lt;/credential&gt;
    &lt;/secure-deployment&gt;
    &lt;secure-deployment name="product-portal.war"&gt;
        &lt;realm&gt;demo&lt;/realm&gt;
        &lt;resource&gt;product-portal&lt;/resource&gt;
        &lt;credential name="secret"&gt;password&lt;/credential&gt;
    &lt;/secure-deployment&gt;
    &lt;secure-deployment name="database.war"&gt;
        &lt;realm&gt;demo&lt;/realm&gt;
        &lt;resource&gt;database-service&lt;/resource&gt;
        &lt;bearer-only&gt;true&lt;/bearer-only&gt;
    &lt;/secure-deployment&gt;
&lt;/subsystem&gt;

            </pre><p>
        </p>
    </div>

</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="tomcat-adapter"/>8.3. Tomcat 6, 7 and 8 Adapters</h2></div></div></div>
    
    <p>
        To be able to secure WAR apps deployed on Tomcat 6, 7 and 8 you must install the Keycloak Tomcat 6, 7 or 8 adapter
        into your Tomcat installation.  You then have to provide some extra configuration in each WAR you deploy to
        Tomcat.  Let's go over these steps.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="tomcat-adapter-installation"/>8.3.1. Adapter Installation</h3></div></div></div>
        
        <p>
            Adapters are no longer included with the appliance or war distribution.  Each adapter is a separate download on
            the Keycloak download site.  They are also available as a maven artifact.
        </p>
    <p>
        You must unzip the adapter distro into Tomcat's <code class="literal">lib/</code> directory.  Including
        adapter's jars within your WEB-INF/lib directory will not work!  The Keycloak adapter is implemented as a Valve
        and valve code must reside in Tomcat's main lib/ directory.
    </p>
    <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd $TOMCAT_HOME/lib
$ unzip keycloak-tomcat6-adapter-dist.zip
    or
$ unzip keycloak-tomcat7-adapter-dist.zip
    or
$ unzip keycloak-tomcat8-adapter-dist.zip
</pre><p>
    </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e958"/>8.3.2. Required Per WAR Configuration</h3></div></div></div>
        
        <p>
            This section describes how to secure a WAR directly by adding config and editing files within your WAR package.
        </p>
        <p>
            The first thing you must do is create a <code class="literal">META-INF/context.xml</code> file in your WAR package.  This is
            a Tomcat specific config file and you must define a Keycloak specific Valve.
        </p>
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;Context path="/your-context-path"&gt;
    &lt;Valve className="org.keycloak.adapters.tomcat.KeycloakAuthenticatorValve"/&gt;
&lt;/Context&gt;
        </pre>
        <p>
            Next you must create
            a <code class="literal">keycloak.json</code> adapter config file within the <code class="literal">WEB-INF</code> directory
            of your WAR.  The format of this config file is describe in the <a class="link" href="ch08.html#adapter-config" title="8.1. General Adapter Config">general adapter configuration</a>
            section.
        </p>
        <p>
            Finally you must specify both a <code class="literal">login-config</code> and use standard servlet security to specify
            role-base constraints on your URLs.  Here's an example:
        </p>
        <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
      version="3.0"&gt;

	&lt;module-name&gt;customer-portal&lt;/module-name&gt;

    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Customers&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;user&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
    &lt;/security-constraint&gt;

    &lt;login-config&gt;
        &lt;auth-method&gt;BASIC&lt;/auth-method&gt;
        &lt;realm-name&gt;this is ignored currently&lt;/realm-name&gt;
    &lt;/login-config&gt;

    &lt;security-role&gt;
        &lt;role-name&gt;admin&lt;/role-name&gt;
    &lt;/security-role&gt;
    &lt;security-role&gt;
        &lt;role-name&gt;user&lt;/role-name&gt;
    &lt;/security-role&gt;
&lt;/web-app&gt;

</pre><p>
        </p>
    </div>
</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="jetty9-adapter"/>8.4. Jetty 9.x Adapters</h2></div></div></div>
    
    <p>
        Keycloak has a separate adapter for Jetty 9.1.x and Jetty 9.2.x that you will have to install into your Jetty
        installation.  You then have to provide some extra configuration in each WAR you deploy to
        Jetty.  Let's go over these steps.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="jetty9-adapter-installation"/>8.4.1. Adapter Installation</h3></div></div></div>
        
        <p>
            Adapters are no longer included with the appliance or war distribution.Each adapter is a separate download on
            the Keycloak download site.  They are also available as a maven artifact.
        </p>
        <p>
            You must unzip the Jetty 9.x  distro into Jetty 9.x's root directory.  Including
            adapter's jars within your WEB-INF/lib directory will not work!
        </p>
    <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd $JETTY_HOME
$ unzip keycloak-jetty92-adapter-dist.zip
</pre><p>
    </p>
    <p>
        Next, you will have to enable the keycloak module for your jetty.base.
    </p>
        <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd your-base
$ java -jar $JETTY_HOME/start.jar --add-to-startd=keycloak
</pre><p>

        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="jetty9_per_war"/>8.4.2. Required Per WAR Configuration</h3></div></div></div>
        
        <p>
            This section describes how to secure a WAR directly by adding config and editing files within your WAR package.
        </p>
        <p>
            The first thing you must do is create a <code class="literal">WEB-INF/jetty-web.xml</code> file in your WAR package.  This is
            a Jetty specific config file and you must define a Keycloak specific authenticator within it.
        </p>
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE Configure PUBLIC "-//Mort Bay Consulting//DTD Configure//EN" "http://www.eclipse.org/jetty/configure_9_0.dtd"&gt;
&lt;Configure class="org.eclipse.jetty.webapp.WebAppContext"&gt;
    &lt;Get name="securityHandler"&gt;
        &lt;Set name="authenticator"&gt;
            &lt;New class="org.keycloak.adapters.jetty.KeycloakJettyAuthenticator"&gt;
            &lt;/New&gt;
        &lt;/Set&gt;
    &lt;/Get&gt;
&lt;/Configure&gt;
        </pre>
        <p>
            Next you must create
            a <code class="literal">keycloak.json</code> adapter config file within the <code class="literal">WEB-INF</code> directory
            of your WAR.  The format of this config file is describe in the <a class="link" href="ch08.html#adapter-config" title="8.1. General Adapter Config">general adapter configuration</a>
            section.
        </p>
        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2>
            <p>
                The Jetty 9.1.x adapter will not be able to find the <code class="literal">keycloak.json</code> file.  You will have to define
                all adapter settings within the <code class="literal">jetty-web.xml</code> file as described below.
            </p>
        </div>
        <p>
            Instead of using keycloak.json, you can define everything within the <code class="literal">jetty-web.xml</code>.  You'll
            just have to figure out how the json settings match to the <code class="literal">org.keycloak.representations.adapters.config.AdapterConfig</code>
            class.
        </p>
        <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE Configure PUBLIC "-//Mort Bay Consulting//DTD Configure//EN" "http://www.eclipse.org/jetty/configure_9_0.dtd"&gt;
&lt;Configure class="org.eclipse.jetty.webapp.WebAppContext"&gt;
  &lt;Get name="securityHandler"&gt;
    &lt;Set name="authenticator"&gt;
        &lt;New class="org.keycloak.adapters.jetty.KeycloakJettyAuthenticator"&gt;
            &lt;Set name="adapterConfig"&gt;
                &lt;New class="org.keycloak.representations.adapters.config.AdapterConfig"&gt;
                    &lt;Set name="realm"&gt;tomcat&lt;/Set&gt;
                    &lt;Set name="resource"&gt;customer-portal&lt;/Set&gt;
                    &lt;Set name="authServerUrl"&gt;http://localhost:8081/auth&lt;/Set&gt;
                    &lt;Set name="sslRequired"&gt;external&lt;/Set&gt;
                    &lt;Set name="credentials"&gt;
                        &lt;Map&gt;
                            &lt;Entry&gt;
                                &lt;Item&gt;secret&lt;/Item&gt;
                                &lt;Item&gt;password&lt;/Item&gt;
                            &lt;/Entry&gt;
                        &lt;/Map&gt;
                    &lt;/Set&gt;
                    &lt;Set name="realmKey"&gt;MIGfMA0GCSqGSIb3DQEBAQUAA4&lt;/Set&gt;
                &lt;/New&gt;
            &lt;/Set&gt;
        &lt;/New&gt;
    &lt;/Set&gt;
  &lt;/Get&gt;
&lt;/Configure&gt;

</pre><p>
        </p>
        <p>
            You do not have to crack open your WAR to secure it with keycloak.  Instead create the jetty-web.xml file
            in your webapps directory with the name of yourwar.xml.  Jetty should pick it up.  In this mode, you'll have
            to declare keycloak.json configuration directly within the xml file.
        </p>
        <p>
            Finally you must specify both a <code class="literal">login-config</code> and use standard servlet security to specify
            role-base constraints on your URLs.  Here's an example:
        </p>
        <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
      version="3.0"&gt;

	&lt;module-name&gt;customer-portal&lt;/module-name&gt;

    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Customers&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;user&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
        &lt;user-data-constraint&gt;
            &lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;
        &lt;/user-data-constraint&gt;
    &lt;/security-constraint&gt;

    &lt;login-config&gt;
        &lt;auth-method&gt;BASIC&lt;/auth-method&gt;
        &lt;realm-name&gt;this is ignored currently&lt;/realm-name&gt;
    &lt;/login-config&gt;

    &lt;security-role&gt;
        &lt;role-name&gt;admin&lt;/role-name&gt;
    &lt;/security-role&gt;
    &lt;security-role&gt;
        &lt;role-name&gt;user&lt;/role-name&gt;
    &lt;/security-role&gt;
&lt;/web-app&gt;

</pre><p>
        </p>
    </div>
</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="jetty8-adapter"/>8.5. Jetty 8.1.x Adapter</h2></div></div></div>
    
    <p>
        Keycloak has a separate adapter for Jetty 8.1.x that you will have to install into your Jetty
        installation.  You then have to provide some extra configuration in each WAR you deploy to
        Jetty.  Let's go over these steps.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="jetty8-adapter-installation"/>8.5.1. Adapter Installation</h3></div></div></div>
        
        <p>
            Adapters are no longer included with the appliance or war distribution.Each adapter is a separate download on
            the Keycloak download site.  They are also available as a maven artifact.
        </p>
    <p>
        You must unzip the Jetty 8.1.x  distro into Jetty 8.1.x's root directory.  Including
        adapter's jars within your WEB-INF/lib directory will not work!
    </p>
    <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
$ cd $JETTY_HOME
$ unzip keycloak-jetty81-adapter-dist.zip
</pre><p>
    </p>
    <p>
        Next, you will have to enable the keycloak option.  Edit start.ini and add keycloak to the options
    </p>
        <p>
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

#===========================================================
# Start classpath OPTIONS.
# These control what classes are on the classpath
# for a full listing do
#   java -jar start.jar --list-options
#-----------------------------------------------------------
OPTIONS=Server,jsp,jmx,resources,websocket,ext,plus,annotations,keycloak

</pre><p>

        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1020"/>8.5.2. Required Per WAR Configuration</h3></div></div></div>
        
        <p>
            Enabling Keycloak for your WARs is the same as the Jetty 9.x adapter.  Our 8.1.x adapter supports both keycloak.json
            and the jboss-web.xml advanced configuration.  See <a class="link" href="ch08.html#jetty9_per_war" title="8.4.2. Required Per WAR Configuration">Required Per WAR Configuration</a>
        </p>
     </div>
</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e1024"/>8.6. Java Servlet Filter Adapter</h2></div></div></div>
    
    <p>
        If you want to use Keycloak with a Java servlet application that doesn't have an adapter for that servlet
        platform, you can opt to use the servlet filter adapter that Keycloak has.  This adapter works a little
        differently than the other adapters.  You do not define security constraints in web.xml.  Instead you define
        a filter mapping using the Keycloak servlet filter adapter to secure the url patterns you want to secure.
    </p>
    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2>
        <p>
            Backchannel logout works a bit differently than the standard adapters.  Instead of invalidating the http session
            it instead marks the session id as logged out.  There's just no way of arbitrarily invalidating an http session
            based on a session id.
        </p>
    </div>

    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
        
&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
      version="3.0"&gt;

	&lt;module-name&gt;customer-portal&lt;/module-name&gt;

    &lt;filter&gt;
        &lt;filter-name&gt;Keycloak Filter&lt;/filter-name&gt;
        &lt;filter-class&gt;org.keycloak.adapters.servlet.KeycloakOIDCFilter&lt;/filter-class&gt;
    &lt;/filter&gt;
    &lt;filter-mapping&gt;
        &lt;filter-name&gt;Keycloak Filter&lt;/filter-name&gt;
        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;
&lt;/web-app&gt;

    </pre>
    <p>
        The Keycloak filter has the same configuration parameters available as the other adapters except you must define
        them as filter init params instead of context params.
    </p>
    <p>
        To use this filter, include this maven artifact in your WAR poms
    </p>
    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
           &lt;dependency&gt;
                &lt;groupId&gt;org.keycloak&lt;/groupId&gt;
                &lt;artifactId&gt;keycloak-servlet-filter-adapter&lt;/artifactId&gt;
                &lt;version&gt;&amp;project.version;&lt;/version&gt;
            &lt;/dependency&gt;
</pre>
</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="fuse-adapter"/>8.7. JBoss Fuse and Apache Karaf Adapter</h2></div></div></div>
    
    <p>
        Currently Keycloak supports securing your web applications running inside <a class="ulink" href="http://www.jboss.org/products/fuse/overview/">JBoss Fuse</a>
        or <a class="ulink" href="http://karaf.apache.org/">Apache Karaf</a> . It leverages <a class="link" href="ch08.html#jetty8-adapter" title="8.5. Jetty 8.1.x Adapter">Jetty 8 adapter</a> as both JBoss Fuse 6.1
        and Apache Karaf 3 are bundled with <a class="ulink" href="http://eclipse.org/jetty/">Jetty 8.1 server</a> under the covers and Jetty is used for running various kinds of web applications.
    </p>
    <p>
        What is supported for Fuse/Karaf is:
        </p><div class="itemizedlist"><ul><li>
                <p>
                    Security for classic WAR applications deployed on Fuse/Karaf with <a class="ulink" href="https://ops4j1.jira.com/wiki/display/ops4j/Pax+Web+Extender+-+War">Pax Web War Extender</a>.
                </p>
            </li><li>
                <p>
                    Security for servlets deployed on Fuse/Karaf as OSGI services with <a class="ulink" href="https://ops4j1.jira.com/wiki/display/ops4j/Pax+Web+Extender+-+Whiteboard">Pax Web Whiteboard Extender</a>.
                </p>
            </li><li>
                <p>
                    Security for <a class="ulink" href="http://camel.apache.org/">Apache Camel</a> Jetty endpoints running with
                    <a class="ulink" href="http://camel.apache.org/jetty.html">Camel Jetty</a> component.
                </p>
            </li><li>
                <p>
                    Security for <a class="ulink" href="http://cxf.apache.org/">Apache CXF</a> endpoints running on their own separate
                    <a class="ulink" href="http://cxf.apache.org/docs/jetty-configuration.html">Jetty engine</a>.
                </p>
            </li><li>
                <p>
                    Security for <a class="ulink" href="http://cxf.apache.org/">Apache CXF</a> endpoints running on default engine provided by CXF servlet.
                </p>
            </li><li>
                <p>
                    Security for SSH and JMX admin access.
                </p>
            </li><li>
                <p>
                    Security for <a class="ulink" href="http://hawt.io/">Hawt.io admin console</a> .
                </p>
            </li></ul></div><p>
    </p>
    <p>The best place to start is look at Fuse demo bundled as part of Keycloak examples in directory <code class="literal">examples/fuse</code> .</p>
</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="javascript-adapter"/>8.8. Javascript Adapter</h2></div></div></div>
    
    <p>
        The Keycloak Server comes with a Javascript library you can use to secure HTML/Javascript applications.  This
        library is referencable directly from the keycloak server.  You can also download the adapter from Keycloak's download
        site if you want a static copy of this library.  It
        works in the same way as other application adapters except that your browser is driving the OAuth redirect protocol
        rather than the server.
    </p>
    <p>
        The disadvantage of using this approach is that you have a non-confidential, public client. This makes it more
        important that you register valid redirect URLs and make sure your domain name is secured.
    </p>
    <p>
        To use this adapter, you must first configure an application (or client) through the <code class="literal">Keycloak Admin Console</code>.
        You should select <code class="literal">public</code> for the <code class="literal">Client Type</code> field. As public clients can't
        be verified with a client secret you are required to configure one or more valid redirect uris as well.
        Once you've configured the application click on the <code class="literal">Installation</code> tab and download the <code class="literal">keycloak.json</code>
        file. This file should be hosted in your web-server at the same root as your HTML pages. Alternatively you can either
        specify the URL for this file, or manually configure the adapter.
    </p>
    <p>
        Next you have to initialize the adapter in your application. An example on how to do this is shown below.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;head&gt;
    &lt;script src="http://&lt;keycloak server&gt;/auth/js/keycloak.js"&gt;&lt;/script&gt;
    &lt;script&gt;
        var keycloak = Keycloak();
        keycloak.init().success(function(authenticated) {
            alert(authenticated ? 'authenticated' : 'not authenticated');
        }).error(function() {
            alert('failed to initialize');
        });
    &lt;/script&gt;
&lt;/head&gt;
</pre><p>
        To specify the location of the keycloak.json file:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
var keycloak = Keycloak('http://localhost:8080/myapp/keycloak.json'));
</pre><p>
        Or finally to manually configure the adapter:
        </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
var keycloak = Keycloak({
    url: 'http://keycloak-server/auth',
    realm: 'myrealm',
    clientId: 'myapp'
});
</pre><p>
        You can also pass <code class="literal">login-required</code> or <code class="literal">check-sso</code> to the init function. Login
        required will redirect to the login form on the server, while check-sso will redirect to the auth server to check
        if the user is already logged in to the realm. For example:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
keycloak.init({ onLoad: 'login-required' })
</pre><p>
    </p>

    <p>
        After you login, your application will be able to make REST calls using bearer token authentication.  Here's
        an example pulled from the <code class="literal">customer-portal-js</code> example that comes with the distribution.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
&lt;script&gt;
    var loadData = function () {
        document.getElementById('username').innerText = keycloak.username;

        var url = 'http://localhost:8080/database/customers';

        var req = new XMLHttpRequest();
        req.open('GET', url, true);
        req.setRequestHeader('Accept', 'application/json');
        req.setRequestHeader('Authorization', 'Bearer ' + keycloak.token);

        req.onreadystatechange = function () {
            if (req.readyState == 4) {
                if (req.status == 200) {
                    var users = JSON.parse(req.responseText);
                    var html = '';
                    for (var i = 0; i &lt; users.length; i++) {
                        html += '&lt;p&gt;' + users[i] + '&lt;/p&gt;';
                    }
                    document.getElementById('customers').innerHTML = html;
                    console.log('finished loading data');
                }
            }
        }

        req.send();
    };

    var loadFailure = function () {
        document.getElementById('customers').innerHTML = '&lt;b&gt;Failed to load data.  Check console log&lt;/b&gt;';

    };

    var reloadData = function () {
        keycloak.updateToken().success(loadData).error(loadFailure);
    }
&lt;/script&gt;

&lt;button onclick="loadData()"&gt;Submit&lt;/button&gt;
</pre><p>
     </p>
    <p>
        The <code class="literal">loadData()</code> method builds an HTTP request setting the <code class="literal">Authorization</code>
        header to a bearer token.  The <code class="literal">keycloak.token</code> points to the access token the browser obtained
        when it logged you in.  The <code class="literal">loadFailure()</code> method is invoked on a failure.  The <code class="literal">reloadData()</code>
        function calls <code class="literal">keycloak.onValidAccessToken()</code> passing in the <code class="literal">loadData()</code> and
        <code class="literal">loadFailure()</code> callbacks.  The <code class="literal">keycloak.onValidAcessToken()</code> method checks to
        see if the access token hasn't expired.  If it hasn't, and your oauth login returned a refresh token, this method
        will refresh the access token.  Finally, if successful, it will invoke the success callback, which in this case
        is the <code class="literal">loadData()</code> method.
    </p>

    <p>
        To refresh the token if it's expired call the <code class="literal">updateToken</code> method. This method returns a promise
        object which can be used to invoke a function on success or failure. This method can be used to wrap functions
        that should only be called with a valid token. For example the following method will refresh the token if it
        expires within 30 seconds, and then invoke the specified function. If the token is valid for more than 30 seconds it
        will just call the specified function.
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
keycloak.updateToken(30).success(function() {
    // send request with valid token
}).error(function() {
    alert('failed to refresh token');
);
</pre><p>
    </p>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1100"/>8.8.1. Session status iframe</h3></div></div></div>
        

        <p>
            By default the JavaScript adapter creates a non-visible iframe that is used to detect if a single-sign out has occured.
            This does not require any network traffic, instead the status is retrieved from a special status cookie. This feature can be disabled
            by setting <code class="literal">checkLoginIframe: false</code> in the options passed to the <code class="literal">init</code>
            method.
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1105"/>8.8.2. Older browsers</h3></div></div></div>
        

        <p>
            The JavaScript adapter depends on Base64 (window.btoa and window.atob) and HTML5 History API. If you need to
            support browsers that don't provide those (for example IE9) you'll need to add polyfillers. Example polyfill
            libraries:

            </p><div class="itemizedlist"><ul><li>Base64 - <a class="ulink" href="https://github.com/davidchambers/Base64.js">https://github.com/davidchambers/Base64.js</a></li><li>HTML5 History - <a class="ulink" href="https://github.com/devote/HTML5-History-API">https://github.com/devote/HTML5-History-API</a></li></ul></div><p>
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1113"/>8.8.3. JavaScript Adapter reference</h3></div></div></div>
        

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e1115"/>8.8.3.1. Constructor</h4></div></div></div>
            
<pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
new Keycloak();
new Keycloak('http://localhost/keycloak.json');
new Keycloak({ url: 'http://localhost/auth', realm: 'myrealm', clientId: 'myApp' });
</pre>
        </div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e1118"/>8.8.3.2. Properties</h4></div></div></div>
            

            <div class="itemizedlist"><ul><li>authenticated - true if the user is authenticated</li><li>token - the base64 encoded token that can be sent in the <code class="literal">Authorization</code> header in requests to services</li><li>tokenParsed - the parsed token</li><li>subject - the user id</li><li>idToken - the id token if claims is enabled for the application, null otherwise</li><li>idTokenParsed - the parsed id token</li><li>realmAccess - the realm roles associated with the token</li><li>resourceAccess - the resource roles assocaited with the token</li><li>refreshToken - the base64 encoded token that can be used to retrieve a new token</li><li>refreshTokenParsed - the parsed refresh token</li><li>timeSkew - estimated skew between local time and Keycloak server in seconds</li></ul></div>
        </div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e1133"/>8.8.3.3. Methods</h4></div></div></div>
            

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1135"/>init(options)</h5></div></div></div>
                

                <p>Called to initialize the adapter.</p>
                <p>Options is an Object, where:
                    </p><div class="itemizedlist"><ul><li>onLoad - specifies an action to do on load, can be either 'login-required' or 'check-sso'</li><li>token - set an initial value for the token</li><li>refreshToken - set an initial value for the refresh token</li><li>checkLoginIframe - set to enable/disable monitoring login state (default is true)</li><li>checkLoginIframeInterval - set the interval to check login state (default is 5 seconds)</li></ul></div><p>
                </p>
                <p>Returns promise to set functions to be invoked on success or error.</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1146"/>login(options)</h5></div></div></div>
                

                <p>Redirects to login form on (options is an optional object with redirectUri and/or prompt fields)</p>
                <p>Options is an Object, where:
                    </p><div class="itemizedlist"><ul><li>redirectUri - specifies the uri to redirect to after login</li><li>prompt - can be set to 'none' to check if the user is logged in already (if not logged in, a login form is not displayed)</li><li>loginHint - used to pre-fill the username/email field on the login form</li><li>action - if value is 'register' then user is redirected to registration page, otherwise to login page</li></ul></div><p>
                </p>
            </div>
            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1155"/>createLoginUrl(options)</h5></div></div></div>
                

                <p>Returns the url to login form on (options is an optional object with redirectUri and/or prompt fields)</p>
                <p>Options is an Object, where:
                    </p><div class="itemizedlist"><ul><li>redirectUri - specifies the uri to redirect to after login</li><li>prompt - can be set to 'none' to check if the user is logged in already (if not logged in, a login form is not displayed)</li></ul></div><p>
                </p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1162"/>logout(options)</h5></div></div></div>
                

                <p>Redirects to logout</p>
                <p>Options is an Object, where:
                    </p><div class="itemizedlist"><ul><li>redirectUri - specifies the uri to redirect to after logout</li></ul></div><p>
                </p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1168"/>createLogoutUrl(options)</h5></div></div></div>
                

                <p>Returns logout out</p>
                <p>Options is an Object, where:
                    </p><div class="itemizedlist"><ul><li>redirectUri - specifies the uri to redirect to after logout</li></ul></div><p>
                </p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1174"/>register(options)</h5></div></div></div>
                

                <p>Redirects to registration form. It's a shortcut for doing login with option action = 'register'</p>
                <p>Options are same as login method but 'action' is overwritten to 'register'</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1178"/>createRegisterUrl(options)</h5></div></div></div>
                

                <p>Returns the url to registration page. It's a shortcut for doing createRegisterUrl with option action = 'register'</p>
                <p>Options are same as createLoginUrl method but 'action' is overwritten to 'register'</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1182"/>accountManagement()</h5></div></div></div>
                

                <p>Redirects to account management</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1185"/>createAccountUrl()</h5></div></div></div>
                

                <p>Returns the url to account management</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1188"/>hasRealmRole(role)</h5></div></div></div>
                

                <p>Returns true if the token has the given realm role</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1191"/>hasResourceRole(role, resource)</h5></div></div></div>
                

                <p>Returns true if the token has the given role for the resource (resource is optional, if not specified clientId is used)</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1194"/>loadUserProfile()</h5></div></div></div>
                

                <p>Loads the users profile</p>

                <p>Returns promise to set functions to be invoked on success or error.</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1198"/>isTokenExpired(minValidity)</h5></div></div></div>
                

                <p>Returns true if the token has less than minValidity seconds left before it expires (minValidity is optional, if not specified 0 is used)</p>
            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1201"/>updateToken(minValidity)</h5></div></div></div>
                

                <p>If the token expires within minValidity seconds (minValidity is optional, if not specified 0 is used) the token is refreshed.
                    If the session status iframe is enabled, the session status is also checked.
                </p>

                <p>Returns promise to set functions that can be invoked if the token is still valid, or if the token is no longer valid. For example:</p>

                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
keycloak.updateToken(5).success(function(refreshed) {
        if (refreshed) {
            alert('token was successfully refreshed');
        } else {
            alert('token is still valid');
        }
    }).error(function() {
        alert('failed to refresh the token, or the session has expired');
    });
</pre>

            </div>

            <div class="simplesect" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d4e1206"/>clearToken()</h5></div></div></div>
                

                <p>
                    Clear authentication state, including tokens. This can be useful if application has detected the session
                    has expired, for example if updating token fails. Invoking this results in onAuthLogout callback listener
                    being invoked.
                </p>

                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
keycloak.updateToken(5).error(function() {
    keycloak.clearToken();
});
</pre>

            </div>
        </div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e1210"/>8.8.3.4. Callback Events</h4></div></div></div>
            

            <p>The adapter supports setting callback listeners for certain events. For example:
</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
keycloak.onAuthSuccess = function() { alert('authenticated'); }
</pre><p>
            </p>

            <div class="itemizedlist"><ul><li>onReady(authenticated) - called when the adapter is initialized</li><li>onAuthSuccess - called when a user is successfully authenticated</li><li>onAuthError - called if there was an error during authentication</li><li>onAuthRefreshSuccess - called when the token is refreshed</li><li>onAuthRefreshError - called if there was an error while trying to refresh the token</li><li>onAuthLogout - called if the user is logged out (will only be called if the session status iframe is enabled, or in Cordova mode)</li></ul></div>
        </div>
    </div>
</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="spring-boot-adapter"/>8.9. Spring Boot Adapter</h2></div></div></div>
    
    <p>
        To be able to secure Spring Boot apps you must add the Keycloak Spring Boot adapter
        JAR to your app. You then have to provide some extra configuration via normal Spring
        Boot configuration (<code class="literal">application.properties</code>).  Let's go over these steps.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="spring-boot-adapter-installation"/>8.9.1. Adapter Installation</h3></div></div></div>
        
        <p>
            The Keycloak Spring Boot adapter takes advantage of Spring Boot's autoconfiguration so all
            you need to do is add the Keycloak Spring Boot adapter JAR to your project. Depending on
            what container you are using with Spring Boot, you also need to add the appropriate
            Keycloak container adapter. If you are using Maven, add the following to your pom.xml (using
            Tomcat as an example):
        </p>
        <p>
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

&lt;dependency&gt;
    &lt;groupId&gt;org.keycloak&lt;/groupId&gt;
    &lt;artifactId&gt;keycloak-spring-boot-adapter&lt;/artifactId&gt;
    &lt;version&gt;&amp;project.version;&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.keycloak&lt;/groupId&gt;
    &lt;artifactId&gt;keycloak-tomcat8-adapter&lt;/artifactId&gt;
    &lt;version&gt;&amp;project.version;&lt;/version&gt;
&lt;/dependency&gt;

            </pre><p>
        </p>
    </div>

    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="spring-boot-adapter-configuration"/>8.9.2. Required Spring Boot Adapter Configuration</h3></div></div></div>
        
        <p>
            This section describes how to configure your Spring Boot app to use Keycloak.
        </p>
        <p>
            Instead of a <code class="literal">keycloak.json</code> file, you configure the realm for the Spring
            Boot Keycloak adapter via the normal Spring Boot configuration. For example:
        </p>
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

keycloak.realm = demorealm
keycloak.realmKey = MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCLCWYuxXmsmfV+Xc9Ik8QET8lD4wuHrJAXbbutS2O/eMjQQLNK7QDX/k/XhOkhxP0YBEypqeXeGaeQJjCxDhFjJXQuewUEMlmSja3IpoJ9/hFn4Cns4m7NGO+rtvnfnwgVfsEOS5EmZhRddp+40KBPPJfTH6Vgu6KjQwuFPj6DTwIDAQAB
keycloak.auth-server-url = http://127.0.0.1:8080/auth
keycloak.ssl-required = external
keycloak.resource = demoapp
keycloak.credentials.secret = 11111111-1111-1111-1111-111111111111
keycloak.use-resource-role-mappings = true

        </pre>
        <p>
            You also need to specify the J2EE security config that would normally go in the <code class="literal">web.xml</code>.
            Here's an example configuration:
        </p>
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">

keycloak.securityConstraints[0].securityCollections[0].name = insecure stuff
keycloak.securityConstraints[0].securityCollections[0].authRoles[0] = admin
keycloak.securityConstraints[0].securityCollections[0].authRoles[0] = user
keycloak.securityConstraints[0].securityCollections[0].patterns[0] = /insecure

keycloak.securityConstraints[0].securityCollections[1].name = admin stuff
keycloak.securityConstraints[0].securityCollections[1].authRoles[0] = admin
keycloak.securityConstraints[0].securityCollections[1].patterns[0] = /admin

        </pre>
    </div>
</div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="spring-security-adapter"/>8.10. Spring Security Adapter</h2></div></div></div>
    
    <p>
        To to secure an application with Spring Security and Keyloak, add this adapter as a dependency to your project.
        You then have to provide some extra beans in your Spring Security configuration file and add the Keycloak security
        filter to your pipeline.
    </p>
    <p>
        Unlike the other Keycloak Adapters, you should not configure your security in web.xml. However, keycloak.json is still required.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1243"/>8.10.1. Adapter Installation</h3></div></div></div>
        
        <p>
            Add Keycloak Spring Security adapter as a dependency to your Maven POM or Gradle build.
        </p>
        <p>
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                
&lt;dependency&gt;
    &lt;groupId&gt;org.keycloak&lt;/groupId&gt;
    &lt;artifactId&gt;keycloak-spring-security-adapter&lt;/artifactId&gt;
    &lt;version&gt;&amp;project.version;&lt;/version&gt;
&lt;/dependency&gt;

            </pre><p>
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1248"/>8.10.2. Spring Security Configuration</h3></div></div></div>
        
        <p>
            The Keycloak Spring Security adapter takes advantage of Spring Security's flexible security configuration syntax.
        </p>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e1251"/>8.10.2.1. Java Configuration</h4></div></div></div>
            
            <p>
                Keycloak provides a KeycloakWebSecurityConfigurerAdapter as a convenient base class for creating a
                <a class="ulink" href="http://docs.spring.io/spring-security/site/docs/4.0.x/apidocs/org/springframework/security/config/annotation/web/WebSecurityConfigurer.html">WebSecurityConfigurer</a>
                instance. The implementation allows customization by overriding methods. While its use is not required, it greatly simplifies your security context configuration.
            </p>
            <p>
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                    
@Configuration
@EnableWebSecurity
@ComponentScan(basePackageClasses = KeycloakSecurityComponents.class)
public class SecurityConfig extends KeycloakWebSecurityConfigurerAdapter
{
    /**
     * Registers the KeycloakAuthenticationProvider with the authentication manager.
     */
    @Autowired
    public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
        auth.authenticationProvider(keycloakAuthenticationProvider());
    }

    /**
     * Defines the session authentication strategy.
     */
    @Bean
    @Override
    protected SessionAuthenticationStrategy sessionAuthenticationStrategy() {
        return new RegisterSessionAuthenticationStrategy(new SessionRegistryImpl());
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception
    {
        super.configure(http);
        http
                .authorizeRequests()
                .antMatchers("/customers*").hasRole("USER")
                .antMatchers("/admin*").hasRole("ADMIN")
                .anyRequest().permitAll();
    }
}

                </pre><p>
            </p>
            <p>
                You must provide a session authentication strategy bean which should be of type
                <code class="code">RegisterSessionAuthenticationStrategy</code> for public or confidential applications and
                <code class="code">NullAuthenticatedSessionStrategy</code> for bearer-only applications.
            </p>
            <p>
                Spring Security's <code class="code">SessionFixationProtectionStrategy</code> is currently not supported because it changes
                the session identifier after login via Keycloak. If the session identifier changes, universal log out will not
                work because Keycloak is unaware of the new session identifier.
            </p>
        </div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d4e1262"/>8.10.2.2. XML Configuration</h4></div></div></div>
            
            <p>
                While Spring Security's XML namespace simplifies configuration, customizing the configuration can be a bit
                verbose.
            </p>
            <p>
                </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                    
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:security="http://www.springframework.org/schema/security"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/security
       http://www.springframework.org/schema/security/spring-security.xsd"&gt;

    &lt;context:component-scan base-package="org.keycloak.adapters.springsecurity" /&gt;

    &lt;security:authentication-manager alias="authenticationManager"&gt;
        &lt;security:authentication-provider ref="keycloakAuthenticationProvider" /&gt;
    &lt;/security:authentication-manager&gt;

    &lt;bean id="adapterDeploymentContextBean" class="org.keycloak.adapters.springsecurity.AdapterDeploymentContextBean" /&gt;
    &lt;bean id="keycloakAuthenticationEntryPoint" class="org.keycloak.adapters.springsecurity.authentication.KeycloakAuthenticationEntryPoint" /&gt;
    &lt;bean id="keycloakAuthenticationProvider" class="org.keycloak.adapters.springsecurity.authentication.KeycloakAuthenticationProvider" /&gt;
    &lt;bean id="keycloakPreAuthActionsFilter" class="org.keycloak.adapters.springsecurity.filter.KeycloakPreAuthActionsFilter" /&gt;
    &lt;bean id="keycloakAuthenticationProcessingFilter" class="org.keycloak.adapters.springsecurity.filter.KeycloakAuthenticationProcessingFilter"&gt;
        &lt;constructor-arg name="authenticationManager" ref="authenticationManager" /&gt;
    &lt;/bean&gt;

    &lt;bean id="keycloakLogoutHandler" class="org.keycloak.adapters.springsecurity.authentication.KeycloakLogoutHandler"&gt;
            &lt;constructor-arg ref="adapterDeploymentContextBean" /&gt;
    &lt;/bean&gt;

    &lt;bean id="logoutFilter" class="org.springframework.security.web.authentication.logout.LogoutFilter"&gt;
        &lt;constructor-arg name="logoutSuccessUrl" value="/" /&gt;
        &lt;constructor-arg name="handlers"&gt;
            &lt;list&gt;
                &lt;ref bean="keycloakLogoutHandler" /&gt;
                &lt;bean class="org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler" /&gt;
            &lt;/list&gt;
        &lt;/constructor-arg&gt;
        &lt;property name="logoutRequestMatcher"&gt;
            &lt;bean class="org.springframework.security.web.util.matcher.AntPathRequestMatcher"&gt;
                &lt;constructor-arg name="pattern" value="/sso/logout**" /&gt;
                &lt;constructor-arg name="httpMethod" value="GET" /&gt;
            &lt;/bean&gt;
        &lt;/property&gt;
    &lt;/bean&gt;

    &lt;security:http auto-config="false" entry-point-ref="keycloakAuthenticationEntryPoint"&gt;
        &lt;security:custom-filter ref="keycloakPreAuthActionsFilter" before="LOGOUT_FILTER" /&gt;
        &lt;security:custom-filter ref="keycloakAuthenticationProcessingFilter" before="FORM_LOGIN_FILTER" /&gt;
        &lt;security:intercept-url pattern="/customers**" access="ROLE_USER" /&gt;
        &lt;security:intercept-url pattern="/admin**" access="ROLE_ADMIN" /&gt;
        &lt;security:custom-filter ref="logoutFilter" position="LOGOUT_FILTER" /&gt;
    &lt;/security:http&gt;

&lt;/beans&gt;

                </pre><p>
            </p>
        </div>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1267"/>8.10.3. Naming Security Roles</h3></div></div></div>
        
        <p>
            Spring Security, when using role-based authentication, requires that role names start with <code class="code">ROLE_</code>.
            For example, an administrator role must be declared in Keycloak as <code class="code">ROLE_ADMIN</code> or similar, not simply
            <code class="code">ADMIN</code>.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1273"/>8.10.4. Client to Client Support</h3></div></div></div>
        
        <p>
            To simplify communication between clients, Keycloak provides an extension of Spring's <code class="code">RestTemplate</code> that
            handles bearer token authentication for you. To enable this feature your security configuration must add the
            <code class="code">KeycloakRestTemplate</code> bean. Note that it must be scoped as a prototype to function correctly.
        </p>
        <p>
            For Java configuration:
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                
@Configuration
@EnableWebSecurity
@ComponentScan(basePackageClasses = KeycloakSecurityComponents.class)
public class SecurityConfig extends KeycloakWebSecurityConfigurerAdapter {

    ...

    @Autowired
    public KeycloakClientRequestFactory keycloakClientRequestFactory;

    @Bean
    @Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)
    public KeycloakRestTemplate keycloakRestTemplate() {
        return new KeycloakRestTemplate(keycloakClientRequestFactory);
    }

    ...
}

            </pre><p>
        </p>
        <p>
            For XML configuration:
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                
&lt;bean id="keycloakRestTemplate" class="org.keycloak.adapters.springsecurity.client.KeycloakRestTemplate" scope="prototype"&gt;
    &lt;constructor-arg name="factory" ref="keycloakClientRequestFactory" /&gt;
&lt;/bean&gt;

            </pre><p>
        </p>
        <p>
            Your application code can then use <code class="code">KeycloakRestTemplate</code> any time it needs to make a call to another
            client. For example:
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                

@Service
public class RemoteProductService implements ProductService {

    @Autowired
    private KeycloakRestTemplate template;

    private String endpoint;

    @Override
    public List&lt;String&gt; getProducts() {
        ResponseEntity&lt;String[]&gt; response = template.getForEntity(endpoint, String[].class);
        return Arrays.asList(response.getBody());
    }
}


            </pre><p>
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d4e1285"/>8.10.5. Spring Boot Configuration</h3></div></div></div>
        
        <p>
            Spring Boot attempts to eagerly register filter beans with the web application context. Therefore,
            when running the Keycloak Spring Security adapter in a Spring Boot environment, it may be necessary to add two
            <code class="code">FilterRegistrationBean</code>s to your security configuration to prevent the Keycloak filters from being
            registered
            twice.
        </p>
        <p>
            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                
@Configuration
@EnableWebSecurity
public class SecurityConfig extends KeycloakWebSecurityConfigurerAdapter
{
    ...

    @Bean
    public FilterRegistrationBean keycloakAuthenticationProcessingFilterRegistrationBean(
            KeycloakAuthenticationProcessingFilter filter) {
        FilterRegistrationBean registrationBean = new FilterRegistrationBean(filter);
        registrationBean.setEnabled(false);
        return registrationBean;
    }

    @Bean
    public FilterRegistrationBean keycloakPreAuthActionsFilterRegistrationBean(
            KeycloakPreAuthActionsFilter filter) {
        FilterRegistrationBean registrationBean = new FilterRegistrationBean(filter);
        registrationBean.setEnabled(false);
        return registrationBean;
    }

    ...
}

            </pre><p>
        </p>
    </div>
</div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="installed-applications"/>8.11. Installed Applications</h2></div></div></div>
    
    <p>
        Keycloak provides two special redirect uris for installed applications.
    </p>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="installed-applications-url"/>8.11.1. http://localhost</h3></div></div></div>
        
        <p>
            This returns the code to a web server on the client as a query parameter. Any port number is allowed.
            This makes it possible to start a web server for the installed application on any free port number without
            requiring changes in the <code class="literal">Admin Console</code>.
        </p>
    </div>
    <div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="installed-applications-urn"/>8.11.2. urn:ietf:wg:oauth:2.0:oob</h3></div></div></div>
        
        <p>
            If its not possible to start a web server in the client (or a browser is not available) it is possible to
            use the special <code class="literal">urn:ietf:wg:oauth:2.0:oob</code> redirect uri. When this redirect uri is used
            Keycloak displays a page with the code in the title and in a box on the page. The application can either
            detect that the browser title has changed, or the user can copy/paste the code manually to the application.
            With this redirect uri it is also possible for a user to use a different device to obtain a code to paste
            back to the application.
        </p>
    </div>
</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d4e1302"/>8.12. Logout</h2></div></div></div>
    
    <p>
        There are multiple ways you can logout from a web application.  For Java EE servlet containers, you can call
        HttpServletRequest.logout().
        For any other browser application, you can point the browser at the url <code class="literal">http://auth-server/auth/realms/{realm-name}/tokens/logout?redirect_uri=encodedRedirectUri</code>.
        This will log you out if you have an SSO session with your browser.
    </p>
</div>
        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="multi_tenancy"/>8.13. Multi Tenancy</h2></div></div></div>
    
    <p>
        Multi Tenancy, in our context, means that one single target application (WAR) can be secured by a single (or clustered) Keycloak server, authenticating
        its users against different realms. In practice, this means that one application needs to use different <code class="literal">keycloak.json</code> files.
        For this case, there are two possible solutions:
        </p><div class="itemizedlist"><ul><li>
                The same WAR file deployed under two different names, each with its own Keycloak configuration (probably via the Keycloak Subsystem).
                This scenario is suitable when the number of realms is known in advance or when there's a dynamic provision of application instances.
                One example would be a service provider that dynamically creates servers/deployments for their clients, like a PaaS.
            </li><li>
                A WAR file deployed once (possibly in a cluster), that decides which realm to authenticate against based on the request parameters.
                This scenario is suitable when there are an undefined number of realms. One example would be a SaaS provider that have only one deployment
                (perhaps in a cluster) serving several companies, differentiating between clients based on the hostname
                (<code class="literal">client1.acme.com</code>, <code class="literal">client2.acme.com</code>) or path (<code class="literal">/app/client1/</code>,
                <code class="literal">/app/client2/</code>) or even via a special HTTP Header.
            </li></ul></div><p>

        This chapter of the reference guide focus on this second scenario.
    </p>

    <p>
        Keycloak provides an extension point for applications that need to evaluate the realm on a request basis. During the authentication
        and authorization phase of the incoming request, Keycloak queries the application via this extension point and expects the application
        to return a complete representation of the realm. With this, Keycloak then proceeds the authentication and authorization process,
        accepting or refusing the request based on the incoming credentials and on the returned realm.

        For this scenario, an application needs to:

        </p><div class="itemizedlist"><ul><li>
                Add a context parameter to the <code class="literal">web.xml</code>, named <code class="literal">keycloak.config.resolver</code>.
                The value of this property should be the fully qualified name of the class extending
                <code class="literal">org.keycloak.adapters.KeycloakConfigResolver</code>.
            </li><li>
                A concrete implementation of <code class="literal">org.keycloak.adapters.KeycloakConfigResolver</code>. Keycloak will call the
                <code class="literal">resolve(org.keycloak.adapters.spi.HttpFacade.Request)</code> method and expects a complete
                <code class="literal">org.keycloak.adapters.KeycloakDeployment</code> in response. Note that Keycloak will call this for every request,
                so, take the usual performance precautions.
            </li></ul></div><p>
    </p>
    <p>
        An implementation of this feature can be found in the examples.
    </p>
</div>

        <div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="jaas-adapter"/>8.14. JAAS plugin</h2></div></div></div>
    
    <p>
        It's generally not needed to use JAAS for most of the applications, especially if they are HTTP based, but directly choose one of our adapters.
        However some applications and systems may still rely on pure legacy JAAS solution. Keycloak provides couple of login modules
        to help with such use cases. Some login modules provided by Keycloak are:
    </p>
    <p>
        </p><div class="variablelist"><dl><dt><span class="term">org.keycloak.adapters.jaas.DirectAccessGrantsLoginModule</span></dt><dd>
                    <p>
                        This login module allows to authenticate with username/password from Keycloak database. It's using
                        <a class="link" href="direct-access-grants.html" title="Chapter 15. Direct Access Grants">Direct Access Grants</a> Keycloak endpoint to validate on Keycloak side if provided username/password is valid.
                        It's useful especially for non-web based systems, which need to rely on JAAS and want to use Keycloak credentials, but can't use classic browser based
                        authentication flow due to their non-web nature. Example of such application could be messaging application or SSH system.
                    </p>
                </dd><dt><span class="term">org.keycloak.adapters.jaas.BearerTokenLoginModule</span></dt><dd>
                    <p>
                        This login module allows to authenticate with Keycloak access token passed to it through CallbackHandler as password.
                        It may be useful for example in case, when you have Keycloak access token from classic web based authentication flow
                        and your web application then needs to talk to external non-web based system, which rely on JAAS. For example to JMS/messaging system.
                    </p>
                </dd></dl></div><p>
    </p>
    <p>
        Both login modules have configuration property <code class="literal">keycloak-config-file</code> where you need to provide location of keycloak.json configuration file.
        It could be either provided from filesystem or from classpath (in that case you may need value like <code class="literal">classpath:/folder-on-classpath/keycloak.json</code> ).
    </p>
    <p>
        Second property <code class="literal">role-principal-class</code> allows to specify alternative class for Role principals attached to JAAS Subject. Default
        value for Role principal is <code class="literal">org.keycloak.adapters.jaas.RolePrincipal</code> . Note that class should have constructor
        with single String argument.
    </p>
</div>
    </div><ul xmlns:d="http://docbook.org/ns/docbook" class="docnav"><li class="previous"><a accesskey="p" href="per-realm-admin-permissions.html"><strong>Prev</strong>Chapter 7. Per Realm Admin Access Control</a></li><li class="up"><a accesskey="u" href="#"><strong>Top of page</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Front page</strong></a></li><li class="next"><a accesskey="n" href="identity-broker.html"><strong>Next</strong>Chapter 9. Identity Broker</a></li></ul></body></html>